<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Man-at-Arms' Life - 100 Years War</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        :root {
            --bg: #120b07;
            --panel: rgba(0,0,0,.78);
            --card: rgba(255,255,255,.04);
            --line: rgba(212,175,55,.22);
            --text: rgba(212,175,55,.92);
            --muted: rgba(212,175,55,.62);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: radial-gradient(1200px 700px at 20% 30%, rgba(212,175,55,.06), transparent 60%),
                        radial-gradient(1200px 700px at 80% 80%, rgba(212,175,55,.04), transparent 55%),
                        var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 18px 60px rgba(0,0,0,.65);
        }
        
        .header {
            text-align: center;
            border-bottom: 1px solid var(--line);
            padding-bottom: 18px;
            margin-bottom: 18px;
            position: relative;
        }
        
        .header .stats-panel {
            margin-top: 18px;
            margin-bottom: 0;
        }
        
        #version-display {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--muted);
            font-size: 11px;
            font-family: 'Crimson Text', serif;
            opacity: 0.7;
            font-weight: normal;
            letter-spacing: 0.5px;
        }
        
        .header::after {
            display: none;
        }
        
        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(28px, 3.4vw, 44px);
            letter-spacing: .08em;
            text-shadow: 0 2px 10px rgba(0,0,0,.7);
            margin: 0;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            background: var(--card);
            padding: 12px 14px;
            border-radius: 12px;
            margin-bottom: 0;
            font-size: 1em;
            border: 1px solid rgba(255,255,255,.06);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-item span {
            color: rgba(255,255,255,.78);
        }
        
        .status-item strong {
            color: var(--text);
        }
        
        .story-text {
            background: var(--card);
            padding: 22px;
            margin: 18px 0;
            line-height: 1.9;
            font-size: 1.15em;
            min-height: 200px;
            border-radius: 12px;
            color: rgba(255,255,255,.82);
        }
        
        .story-text h2 {
            color: var(--text);
        }
        
        .scene-artwork {
            width: 100%;
            max-width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            border: 3px solid #8b6914;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8), inset 0 0 10px rgba(212, 175, 55, 0.1);
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .scene-artwork.visible {
            display: block;
            opacity: 1;
        }
        
        .scene-artwork img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 5px;
        }
        
        .artwork-caption {
            text-align: center;
            color: #8b6914;
            font-size: 0.85em;
            font-style: italic;
            margin-top: 8px;
            padding: 0 10px;
        }
        
        .story-text p {
            margin-bottom: 15px;
        }
        
        .story-text p:last-child {
            margin-bottom: 0;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 18px 0;
        }
        
        .header .stats-panel {
            margin-top: 18px;
            margin-bottom: 0;
            gap: 12px;
        }
        
        .stat-item {
            background: var(--card);
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 12px;
            padding: 12px;
        }
        
        .header .stat-item {
            padding: 12px;
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.75em;
            color: var(--text);
        }
        
        .stat-bar {
            background: #1a0f08;
            height: 14px;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid rgba(212,175,55,.25);
            position: relative;
        }
        
        .header .stat-bar {
            height: 14px;
            border-radius: 999px;
            margin-top: 5px;
        }
        
        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b6914, #d4af37, #f4d03f);
            transition: width 0.5s ease;
            box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .stat-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            font-size: 12px;
            opacity: .9;
        }
        
        .stat-special {
            font-size: 0.75em;
            margin-top: 5px;
            color: var(--text);
        }
        
        .choices {
            margin-top: 18px;
        }
        
        .choices-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4em;
            margin-bottom: 18px;
            text-align: center;
            color: var(--text);
        }
        
        .choice-button {
            display: block;
            width: 100%;
            background: rgba(255,255,255,.04);
            border: 1px solid rgba(212,175,55,.25);
            color: rgba(255,255,255,.82);
            padding: 16px 18px;
            margin: 12px 0;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.05em;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
        }
        
        .choice-button::before {
            display: none;
        }
        
        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(0,0,0,.35);
            border-color: rgba(212,175,55,.45);
            background: rgba(255,255,255,.06);
        }
        
        .choice-button:active {
            transform: translateY(0);
        }
        
        .choice-effects {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 8px;
            font-style: italic;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .control-button {
            background: rgba(139, 105, 20, 0.3);
            border: 1px solid #8b6914;
            color: #d4af37;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s;
        }
        
        .control-button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #d4af37;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification h3 {
            margin-bottom: 8px;
            color: #f4d03f;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .condition-badge {
            display: inline-block;
            background: rgba(139, 69, 19, 0.3);
            border: 1px solid #8b4513;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px;
        }
        
        .condition-badge.positive {
            background: rgba(34, 139, 34, 0.3);
            border-color: #228b22;
        }
        
        .condition-badge.negative {
            background: rgba(139, 0, 0, 0.3);
            border-color: #8b0000;
        }
        
        .rank-display {
            font-size: 1.1em;
            color: #f4d03f;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .dice-roll {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Cinzel', serif;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-panel {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
                font-size: 0.9em;
                gap: 5px;
            }
            
            .stats-summary {
                font-size: 0.9em;
            }
            
            .choice-button {
                font-size: 1em;
                padding: 12px;
            }
            
            .story-text {
                font-size: 1em;
                padding: 20px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .control-button {
                font-size: 0.9em;
                padding: 8px 15px;
            }
        }
        
        /* ===== EQUIPMENT SCREEN STYLES ===== */
        .equipment-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }
        
        .equipment-screen.hidden {
            display: none;
        }
        
        .equipment-screen-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            color: #d4af37;
        }
        
        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 10px;
        }
        
        .equipment-layout {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .equipment-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== COMBAT SYSTEM STYLES ===== */
        .action-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-button {
            padding: 20px;
            background: #2a2a2a;
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Crimson Text', serif;
            transition: all 0.2s;
            text-align: center;
        }
        
        .action-button:hover:not(:disabled) {
            background: #3a3a3a;
            border-color: #f4d03f;
            color: #f4d03f;
            transform: translateY(-2px);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-button.selected {
            background: #d4af37;
            color: #1a0f08;
            font-weight: bold;
        }
        
        .action-button.flurry {
            border-color: #f00;
            color: #f00;
        }
        
        .action-button.flurry:hover:not(:disabled) {
            border-color: #f80;
            color: #f80;
        }
        
        .action-button.flurry.selected {
            background: #f00;
            color: white;
        }
        
        .action-details {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        
        .actions-remaining {
            text-align: center;
            color: #f4d03f;
            font-size: 20px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
        }
        
        .combat-log {
            margin-top: 20px;
            padding: 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid #d4af37;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .combat-log h3 {
            color: #f4d03f;
            margin-bottom: 15px;
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .log-entry.success {
            border-left: 3px solid #0f0;
        }
        
        .log-entry.failure {
            border-left: 3px solid #f00;
        }
        
        .log-entry.info {
            border-left: 3px solid #d4af37;
        }
        
        /* Combat Overlay - Must be above equipment screen (z-index 2000+) */
        #minigame-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2500;
            align-items: center;
            justify-content: center;
        }
        
        #minigame-content {
            background: #1a0f08;
            border: 3px solid #d4af37;
            padding: 40px;
            border-radius: 10px;
            max-width: 700px;
            text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        }
        
        #minigame-title {
            color: #f4d03f;
            margin-bottom: 10px;
            font-size: 28px;
            font-family: 'Cinzel', serif;
        }
        
        #minigame-subtitle {
            color: #888;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        #minigame-display {
            margin: 20px 0;
        }
        
        #minigame-instructions {
            color: #d4af37;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .combat-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
        }
        
        .progress-item {
            text-align: center;
        }
        
        .progress-item.active {
            color: #f4d03f;
            font-weight: bold;
        }
        
        /* QTE Styles */
        .qte-bar-container {
            width: 600px;
            height: 50px;
            background: #333;
            border: 3px solid #666;
            position: relative;
            margin: 30px auto;
            border-radius: 5px;
        }
        
        .qte-green-zone {
            position: absolute;
            height: 100%;
            background: rgba(0, 255, 0, 0.4);
            border: 2px solid #0f0;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            transition: left 0.05s linear;
        }
        
        .qte-indicator {
            position: absolute;
            top: 0;
            width: 8px;
            height: 100%;
            background: #f4d03f;
            box-shadow: 0 0 15px #f4d03f;
        }
        
        .health-bars {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .health-bar-container {
            width: 200px;
        }
        
        .health-bar-label {
            color: #d4af37;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .health-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 2px solid #666;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #0f0, #0a0);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .health-fill.low {
            background: linear-gradient(90deg, #f00, #a00);
        }
        
        .health-fill.medium {
            background: linear-gradient(90deg, #fa0, #a50);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>A MAN-AT-ARMS' LIFE</h1>
            <div id="version-display">v1.4.0</div>
            <div class="status-bar">
                <div class="status-item">
                    <span>üìÖ</span>
                    <span>Year: <strong id="year">1337</strong></span>
                </div>
                <div class="status-item">
                    <span>üë§</span>
                    <span>Age: <strong id="age">18</strong></span>
                </div>
                <div class="status-item">
                    <span>üìç</span>
                    <span>Location: <strong id="location">France</strong></span>
                </div>
            </div>
            <div class="stats-panel" id="stats">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>
        
        
        <div class="scene-artwork" id="scene-artwork">
            <img id="artwork-image" src="" alt="Scene artwork">
            <div class="artwork-caption" id="artwork-caption"></div>
        </div>
        <div class="story-text" id="story">
            <p id="loading-message" style="display: none;">Loading...</p>
        </div>
        
        <div class="choices">
            <div class="choices-title">What do you do?</div>
            <div id="choices-container">
                <!-- Choices will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="controls">
            <button class="control-button" onclick="saveGame()">üíæ Save Game</button>
            <button class="control-button" onclick="loadGame()">üìÇ Load Game</button>
            <button class="control-button" onclick="showStats()">üìä Full Stats</button>
            <button class="control-button" onclick="openEquipmentScreen()">üõ°Ô∏è Equipment</button>
        </div>
    </div>
    
    <!-- Equipment Screen -->
    <div id="equipment-screen" class="equipment-screen hidden">
        <div class="equipment-screen-content">
            <div class="equipment-header">
                <h2>Equipment & Inventory</h2>
                <button class="close-button" onclick="closeEquipmentScreen()" aria-label="Close equipment screen">√ó</button>
            </div>
            <div class="equipment-layout">
                <div class="equipment-left">
                    <div id="inventory-container"></div>
                </div>
                <div class="equipment-center">
                    <div id="paper-doll-container"></div>
                </div>
                <div class="equipment-right">
                    <div id="kit-stats-container"></div>
                </div>
            </div>
        </div>
        <div id="equipment-aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>
    
    <div id="notification" class="notification hidden"></div>
    
    <!-- Equipment System Scripts -->
    <script src="man-at-arms-equipment-system.js"></script>
    <script src="man-at-arms-equipment-ui.js"></script>
    <script src="man-at-arms-enemy-profiles.js"></script>
    
    <!-- Combat Overlay -->
    <div id="minigame-overlay">
        <div id="minigame-content">
            <h3 id="minigame-title"></h3>
            <div id="minigame-subtitle"></div>
            <div class="health-bars">
                <div class="health-bar-container">
                    <div class="health-bar-label">Your Health</div>
                    <div class="health-bar">
                        <div class="health-fill" id="player-health-bar" style="width: 100%;">100</div>
                    </div>
                </div>
                <div class="health-bar-container">
                    <div class="health-bar-label">Enemy Health</div>
                    <div class="health-bar">
                        <div class="health-fill" id="enemy-health-bar" style="width: 100%;">100</div>
                    </div>
                </div>
            </div>
            <div class="combat-progress" id="combat-progress"></div>
            <div id="minigame-display"></div>
            <div id="minigame-instructions"></div>
            <div class="combat-log" id="combat-log" style="margin-top: 20px; max-height: 200px; overflow-y: auto;">
                <h3 style="color: #f4d03f; margin-bottom: 10px; font-size: 16px;">Combat Log</h3>
            </div>
        </div>
    </div>

    <script>
        // Settings
        // Effects are always shown by default
        const showEffectsPreview = true;
        
        // Game State
        const gameState = {
            stats: {
                strength: 5,
                agility: 5,
                endurance: 5,
                charisma: 5,
                luck: 5,
                wits: 5, // Intelligence, tactical thinking
                wealth: 120, // 10 shillings = 120 pence (typical starting wealth for a man-at-arms)
                reputation: 0,
                morale: 5,
                stress: 0, // Stress/fatigue meter (separate from conditions)
                experience: 0,
                patronFavor: 0
            },
            faction: "English", // Player faction
            age: 27, // Default to prime age (will be set by ageRange)
            ageRange: null,
            year: 1337,
            location: "England",
            currentScene: "character_creation",
            chapter: null, // Current chapter: "chevauch√©e", "calais", "plague", "poitiers"
            chapterProgress: {
                chevauch√©e: { started: false, completed: false },
                calais: { started: false, completed: false },
                plague: { started: false, completed: false },
                poitiers: { started: false, completed: false }
            },
            characterCreationStep: 1, // Track which step of character creation (1-6)
            characterName: "",
            patronId: null, // Patron selection ID (james_olooney, lord_david, duke_caley, count_charles, ashkhan)
            patron: null, // Legacy field for backward compatibility
            patronEventPath: null, // Convenience copy of PATRONS[patronId].eventPath
            startingKitTier: null, // Resolved after priorities + patron
            background: null,
            scenesVisited: [],
            enteredScenes: new Set(), // Track scenes that have had onEnter called
            inventory: [],
            equipment: {
                head: {},
                torso: {},
                arms: {},
                legs: {},
                weapon: {},
                missile: {},
                accessory: {},
                bag: []
            },
            region: "England", // Normalized region for equipment availability
            conditions: [], // wounds, fatigue, etc.
            flags: {}, // story flags: Resentment, Dishonor, Shaken, etc.
            rank: "Common Soldier",
            relationships: { wat: 0, cook: 0, oana: 0 }, // NPC relationships (clamped -5..+5)
            campfire: {
                cooldownScenes: 2, // Must pass at least N scenes before another campfire
                chance: 0.35, // After cooldown, chance to insert
                lastInsertedAtIndex: 0,
                seenIds: [], // Vignette IDs seen
                returnScene: null, // Where to go after campfire
                currentVignetteId: null, // Currently active vignette
                currentStep: 0, // Current step in multi-step exchange (0 = opening, 1+ = follow-ups)
                stepHistory: [] // Track choices made in this exchange
            },
            randomEncounter: {
                cooldown: 0, // Scene cooldown before next random encounter
                lastInsertedAt: -1,
                returnScene: null // Where to go after random encounter
            },
            career: {
                battles: 0,
                wounds: 0,
                promotions: 0
            },
            chapter: null, // Current chapter: "chevauch√©e", "calais", "plague", "poitiers"
            chapterProgress: {
                chevauch√©e: { started: false, completed: false },
                calais: { started: false, completed: false },
                plague: { started: false, completed: false },
                poitiers: { started: false, completed: false }
            }
        };
        
        // ===== CHAPTER SYSTEM =====
        // Historical chapters that structure the game's narrative arc
        const CHAPTERS = {
            chevauch√©e: {
                id: "chevauch√©e",
                name: "The Chevauch√©e",
                year: 1346,
                description: "Scorched earth raids through Normandy to provoke French knights.",
                startYear: 1346,
                endYear: 1346,
                victoryCondition: "Survive the raids and reach Calais",
                deathRate: 0.70, // 70% death rate during brutal raids
                specialMechanics: ["raiding", "scorched_earth", "high_mortality"]
            },
            calais: {
                id: "calais",
                name: "Siege of Calais",
                year: 1346,
                description: "The subsequent grinding siege after Cr√©cy.",
                startYear: 1346,
                endYear: 1347,
                victoryCondition: "Survive the siege until Calais falls",
                deathRate: 0.75, // 75% death rate during siege (disease, starvation, combat)
                specialMechanics: ["siege", "starvation", "disease", "boredom"]
            },
            plague: {
                id: "plague",
                name: "The Black Death",
                year: 1348,
                description: "The pause/plague phase.",
                startYear: 1348,
                endYear: 1353,
                victoryCondition: "Survive the plague years",
                deathRate: 0.80, // 80% death rate during plague (highest!)
                specialMechanics: ["plague", "arbitrary_death", "isolation", "despair"]
            },
            poitiers: {
                id: "poitiers",
                name: "Poitiers/Tours",
                year: 1356,
                description: "The Black Prince's chevauch√©e culminating in capture of King John II.",
                startYear: 1356,
                endYear: 1356,
                victoryCondition: "Survive the campaign and witness the capture of the French king",
                deathRate: 0.65, // 65% death rate (slightly better, but still brutal)
                specialMechanics: ["chevauch√©e", "major_battle", "glory"]
            }
        };
        
        // Check if player should transition to next chapter
        function checkChapterTransition() {
            // Chapter 1: Chevauch√©e (1346)
            if (gameState.year >= 1346 && gameState.year < 1347 && gameState.chapter !== 'chevauch√©e') {
                if (!gameState.chapterProgress.chevauch√©e.started) {
                    gameState.chapter = 'chevauch√©e';
                    gameState.chapterProgress.chevauch√©e.started = true;
                    showNotification('Chapter 1', CHAPTERS.chevauch√©e.name + ': ' + CHAPTERS.chevauch√©e.description, 'info');
                }
            }
            
            // Chapter 2: Siege of Calais (1346-1347)
            if (gameState.year >= 1346 && gameState.year <= 1347 && gameState.chapter !== 'calais') {
                // Transition to Calais after Chevauch√©e or if year is 1347
                if (gameState.chapter === 'chevauch√©e' || (gameState.year === 1347 && !gameState.chapterProgress.calais.started)) {
                    gameState.chapter = 'calais';
                    gameState.chapterProgress.chevauch√©e.completed = true;
                    gameState.chapterProgress.calais.started = true;
                    showNotification('Chapter 2', CHAPTERS.calais.name + ': ' + CHAPTERS.calais.description, 'info');
                }
            }
            
            // Chapter 3: The Black Death (1348-1353)
            if (gameState.year >= 1348 && gameState.year <= 1353 && gameState.chapter !== 'plague') {
                if (!gameState.chapterProgress.plague.started) {
                    gameState.chapter = 'plague';
                    gameState.chapterProgress.calais.completed = true;
                    gameState.chapterProgress.plague.started = true;
                    showNotification('Chapter 3', CHAPTERS.plague.name + ': ' + CHAPTERS.plague.description, 'info');
                    // Increase arbitrary death chance during plague
                    // This is handled by the arbitrary death system
                }
            }
            
            // Chapter 4: Poitiers/Tours (1356)
            if (gameState.year >= 1356 && gameState.chapter !== 'poitiers') {
                if (!gameState.chapterProgress.poitiers.started) {
                    gameState.chapter = 'poitiers';
                    gameState.chapterProgress.plague.completed = true;
                    gameState.chapterProgress.poitiers.started = true;
                    showNotification('Chapter 4', CHAPTERS.poitiers.name + ': ' + CHAPTERS.poitiers.description, 'info');
                }
            }
        }
        
        // Get current chapter info
        function getCurrentChapter() {
            if (!gameState.chapter) return null;
            return CHAPTERS[gameState.chapter] || null;
        }
        
        // Modify arbitrary death chances based on chapter
        function getChapterDeathModifier() {
            const chapter = getCurrentChapter();
            if (!chapter) return 1.0;
            
            // Plague chapter has much higher death rates
            if (chapter.id === 'plague') {
                return 2.0; // Double all death chances
            }
            
            // Calais siege also increases death rates
            if (chapter.id === 'calais') {
                return 1.5; // 50% increase
            }
            
            return 1.0; // Normal rates for other chapters
        }
        
        // Patron definitions with stat modifiers
        // Kit tier mapping: plan names -> actual tier names
        const KIT_TIER_MAP = {
            "poor": "Ragged",
            "standard": "Standard",
            "well_equipped": "Good",
            "veteran": "Fine",
            "raider": "Superior"
        };
        
        const PATRONS = {
            james_olooney: {
                id: "james_olooney",
                name: 'Sir James "The Reaver" de Looney',
                type: "Free Company",
                blurb: "Wildcard captain known for murder and pillage. Profitable. Unstable.",
                statMods: { strength: 1, agility: 1, morale: -1, wealth: 2 },
                kitTier: "raider",  // maps to "Superior"
                eventPath: "patron_path_olooney"
            },
            lord_david: {
                id: "lord_david",
                name: "Sir David de Montfort",
                type: "Noble Household",
                blurb: "Timid but fair third son; values his men's lives. Safer, slower.",
                statMods: { charisma: 1, morale: 1, wits: 1, wealth: -2 },
                kitTier: "standard",  // maps to "Standard"
                eventPath: "patron_path_david"
            },
            duke_caley: {
                id: "duke_caley",
                name: "Baron Caley of Tournai",
                type: "Noble Household",
                blurb: "Indifferent to your life; higher glory and plunder if you survive.",
                statMods: { wealth: 3, reputation: 1, morale: -1, stress: 1 },
                kitTier: "well_equipped",  // maps to "Good"
                eventPath: "patron_path_caley"
            },
            count_charles: {
                id: "count_charles",
                name: 'Count Charles "The Grim" of Suffolk',
                type: "Noble Household",
                blurb: "Grizzled leader, drinking hard; veterans, volatility, hard lessons.",
                statMods: { strength: 1, endurance: 1, morale: -1, stress: 1, wits: -1 },
                kitTier: "veteran",  // maps to "Fine"
                eventPath: "patron_path_charles"
            },
            ashkhan: {
                id: "ashkhan",
                name: "Ashkhan of the Mamluk Guard",
                type: "Mercenary Company",
                blurb: "Respected mercenary from the Levant with tactical expertise. Professional and disciplined.",
                statMods: { agility: 1, wits: 1, reputation: 1 },
                kitTier: "veteran",  // maps to "Fine"
                eventPath: "patron_path_ashkhan"
            }
        };
        
        // Stat limits
        const statLimits = {
            strength: { min: 0, max: 10 },
            agility: { min: 0, max: 10 },
            endurance: { min: 0, max: 10 },
            charisma: { min: 0, max: 10 },
            luck: { min: 0, max: 10 },
            wits: { min: 0, max: 10 },
            morale: { min: 0, max: 10 },
            stress: { min: 0, max: 10 },
            initiative: { min: 5, max: 10 },
            wealth: { min: 0, max: 24000 }, // Max 100 pounds (24000 pence)
            reputation: { min: -20, max: 50 },
            experience: { min: 0, max: 1000 },
            patronFavor: { min: 0, max: 20 }
        };
        
        // ===== HISTORICAL CURRENCY SYSTEM (100 Years War - 1340s-1350s) =====
        // English currency: 12 pence (d) = 1 shilling (s), 20 shillings = 1 pound (¬£)
        // French currency: 12 deniers = 1 sou, 20 sous = 1 livre tournois
        // English soldiers were paid in English currency, but encountered French currency in France
        // Exchange rate varied, but roughly: 1 livre tournois ‚âà 1 pound sterling
        // For simplicity, we track wealth in English pence (what you're paid in)
        // When plundering in France, French coins are converted to equivalent English value
        // Wealth is stored in pence (smallest unit) for precision
        
        // Format currency for display (converts pence to readable format)
        function formatCurrency(pence) {
            if (pence === 0) return "0d";
            
            const pounds = Math.floor(pence / 240);
            const remainingAfterPounds = pence % 240;
            const shillings = Math.floor(remainingAfterPounds / 12);
            const remainingPence = remainingAfterPounds % 12;
            
            let result = "";
            if (pounds > 0) {
                result += "¬£" + pounds;
                if (shillings > 0 || remainingPence > 0) result += " ";
            }
            if (shillings > 0) {
                result += shillings + "s";
                if (remainingPence > 0) result += " ";
            }
            if (remainingPence > 0) {
                result += remainingPence + "d";
            }
            return result;
        }
        
        // Convert currency string to pence (for easy input)
        // Format: "¬£1 5s 3d" or "5s 3d" or "3d" or "60" (assumes pence)
        function parseCurrency(str) {
            if (typeof str === 'number') return str; // Already pence
            if (!str) return 0;
            
            let pence = 0;
            const poundsMatch = str.match(/¬£(\d+)/);
            const shillingsMatch = str.match(/(\d+)s/);
            const penceMatch = str.match(/(\d+)d/);
            
            if (poundsMatch) pence += parseInt(poundsMatch[1]) * 240;
            if (shillingsMatch) pence += parseInt(shillingsMatch[1]) * 12;
            if (penceMatch) pence += parseInt(penceMatch[1]);
            
            // If no currency symbols, assume it's pence
            if (!poundsMatch && !shillingsMatch && !penceMatch) {
                pence = parseInt(str) || 0;
            }
            
            return pence;
        }
        
        // Get current wealth in formatted currency
        function getFormattedWealth() {
            const pence = gameState.stats.wealth || 0;
            return formatCurrency(pence);
        }
        
        // Clamp stat to limits
        function clampStat(key, value) {
            const limits = statLimits[key];
            if (!limits) return value;
            return Math.max(limits.min, Math.min(limits.max, value));
        }
        
        // Apply stat change with clamping
        function applyStatChange(key, delta, opts = {}) {
            if (gameState.stats[key] === undefined) return 0;
            const oldValue = gameState.stats[key];
            gameState.stats[key] = clampStat(key, oldValue + delta);
            const actualChange = gameState.stats[key] - oldValue;
            
            // Only show notification if not silent and there was a change
            if (!opts.silent && actualChange !== 0) {
                // Notification logic can be added here if needed
                // Currently notifications are handled elsewhere in the codebase
            }
            
            return actualChange; // Return actual change
        }
        
        // Sanitize HTML to prevent XSS attacks
        function escapeHTML(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // ===== CAMPFIRE SYSTEM FUNCTIONS =====
        
        /** Clamp relationship value to -5..+5 */
        function clampRel(n) {
            return Math.max(-5, Math.min(5, Number(n) || 0));
        }
        
        /** Change relationship with Wat or Cook */
        function changeRel(who, delta) {
            if (!gameState.relationships) {
                gameState.relationships = { wat: 0, cook: 0, oana: 0 };
            }
            gameState.relationships[who] = clampRel((gameState.relationships[who] || 0) + delta);
        }
        
        /** Check if campfire should be inserted */
        function shouldInsertCampfire(nextSceneKey) {
            // Never interrupt:
            // - character creation scenes
            // - combat overlay/active combat
            // - already-a-campfire scene
            // - explicit "noCampfire" flagged scenes/choices
            // - critical scenes like death/ending
            
            if (gameState.currentScene === 'character_creation' || 
                gameState.currentScene === 'campfire_interlude' ||
                nextSceneKey === 'character_creation' ||
                nextSceneKey === 'campfire_interlude') {
                return false;
            }
            
            // Check if scene has noCampfire flag
            const nextScene = scenes[nextSceneKey];
            if (nextScene && nextScene.noCampfire) {
                return false;
            }
            
            const idx = gameState.scenesVisited ? gameState.scenesVisited.length : 0;
            const cf = gameState.campfire || {};
            const since = idx - (cf.lastInsertedAtIndex || 0);
            
            // Must pass cooldown
            if (since < (cf.cooldownScenes || 2)) {
                return false;
            }
            
            // Chance check
            return Math.random() < (cf.chance || 0.35);
        }
        
        /** Insert campfire interlude if conditions are met */
        function maybeInsertCampfire(nextSceneKey) {
            if (!shouldInsertCampfire(nextSceneKey)) {
                return nextSceneKey;
            }
            
            // Set return scene and mark insertion
            gameState.campfire.returnScene = nextSceneKey;
            gameState.campfire.lastInsertedAtIndex = (gameState.scenesVisited ? gameState.scenesVisited.length : 0);
            
            return "campfire_interlude";
        }
        
        // Roll dice (1d10 + modifier)
        function rollDice(modifier = 0) {
            const roll = Math.floor(Math.random() * 10) + 1;
            return roll + modifier;
        }
        
        // Resolution system: roll against difficulty (uses effective stat)
        // Morale/stress can modify difficulty instead of stat for clearer feedback
        function resolveAction(stat, difficulty = 7, bonus = 0) {
            const effectiveStat = getEffectiveStat(stat);
            
            // Morale/stress modify difficulty (easier to succeed with high morale, harder with high stress)
            let adjustedDifficulty = difficulty;
            if (gameState.stats.morale >= 8) {
                adjustedDifficulty -= 1; // High morale makes checks easier
            } else if (gameState.stats.morale <= 2) {
                adjustedDifficulty += 1; // Low morale makes checks harder
            }
            if (gameState.stats.stress >= 7) {
                adjustedDifficulty += 1; // High stress makes checks harder
            }
            
            const roll = rollDice(effectiveStat + bonus);
            const success = roll >= adjustedDifficulty;
            return { 
                roll, 
                success, 
                margin: roll - adjustedDifficulty,
                effectiveStat: effectiveStat,
                baseStat: gameState.stats[stat] || 0,
                difficulty: adjustedDifficulty,
                baseDifficulty: difficulty
            };
        }
        
        // Add condition (wound, fatigue, etc.)
        function addCondition(name, type = 'negative', duration = -1) {
            gameState.conditions.push({
                name,
                type,
                duration,
                added: gameState.year
            });
        }
        
        // Remove condition
        function removeCondition(name) {
            gameState.conditions = gameState.conditions.filter(c => c.name !== name);
        }
        
        // Check if has condition
        function hasCondition(name) {
            return gameState.conditions.some(c => c.name === name);
        }
        
        // Update conditions (heal over time, etc.)
        function updateConditions() {
            gameState.conditions = gameState.conditions.filter(condition => {
                if (condition.duration === -1) return true; // Permanent
                const yearsPassed = gameState.year - condition.added;
                return yearsPassed < condition.duration;
            });
        }
        
        // ===== BRUTAL ROGUELIKE MECHANICS =====
        
        // Calculate armor protection (0-20, reduces bad outcome chance)
        function calculateArmorProtection() {
            let protection = 0;
            const slots = ['head', 'torso', 'arms', 'legs'];
            slots.forEach(slot => {
                const item = gameState.equipment[slot]?.item;
                if (item) {
                    // Get item quality/tier (0-10 scale, approximate from item data)
                    // For now, assume better items have higher protection values
                    // Equipment system should provide quality/defense values
                    const quality = item.defense || item.quality || 0;
                    protection += quality * 0.5; // Each armor piece adds protection
                }
            });
            return Math.min(20, Math.max(0, protection));
        }
        
        // Calculate bad outcome chance (modified by luck and equipment)
        function calculateBadOutcomeChance(baseChance, stupidity, luck, equipment) {
            // Base chance: smart=5%, neutral=15%, stupid=40%
            let chance = baseChance || (stupidity === 'smart' ? 5 : stupidity === 'stupid' ? 40 : 15);
            
            // Luck reduces chance: -0.5% per luck point
            const luckMod = (gameState.stats.luck || 0) * 0.5;
            chance -= luckMod;
            
            // Equipment reduces chance: armor protection * 2%
            const armorProtection = calculateArmorProtection();
            chance -= armorProtection * 2; // Up to -40% from full plate
            
            // Clamp to 1-50%
            return Math.max(1, Math.min(50, chance));
        }
        
        // Select which bad outcome triggers (if any)
        function selectBadOutcome(badOutcomes, baseChance) {
            if (!badOutcomes || badOutcomes.length === 0) return null;
            
            // Sort by chance (highest first) and check each
            const sorted = [...badOutcomes].sort((a, b) => (b.chance || 0) - (a.chance || 0));
            
            for (const outcome of sorted) {
                const outcomeChance = calculateBadOutcomeChance(
                    outcome.chance || baseChance,
                    outcome.stupidity || 'neutral',
                    gameState.stats.luck,
                    gameState.equipment
                );
                
                if (Math.random() * 100 < outcomeChance) {
                    return outcome;
                }
            }
            
            return null;
        }
        
        // Apply bad outcome (permanent debuffs, conditions, etc.)
        function applyBadOutcome(outcome) {
            if (!outcome) return;
            
            // Add condition (permanent if specified)
            if (outcome.condition) {
                const duration = outcome.permanent ? -1 : (outcome.duration || 2);
                addCondition(outcome.condition, 'negative', duration);
                
                // Apply permanent stat debuffs
                if (outcome.statDebuffs && outcome.permanent) {
                    Object.entries(outcome.statDebuffs).forEach(([stat, debuff]) => {
                        // Permanent stat reduction
                        gameState.stats[stat] = Math.max(0, (gameState.stats[stat] || 0) + debuff);
                        gameState.stats[stat] = clampStat(stat, gameState.stats[stat]);
                    });
                }
                
                // Chance of infection for wounds
                if ((outcome.condition.includes('Wound') || outcome.condition.includes('Cut') || outcome.condition.includes('Injury')) && 
                    !outcome.condition.includes('Infected')) {
                    const infectionChance = 0.15; // 15% chance
                    if (Math.random() < infectionChance) {
                        const infectedCondition = outcome.condition + ' (Infected)';
                        addCondition(infectedCondition, 'negative', -1); // Permanent
                        // Additional permanent debuffs from infection
                        applyStatChange('strength', -2, { silent: true });
                        applyStatChange('endurance', -3, { silent: true });
                        showNotification('Infection', 'The wound becomes infected. The pain is constant.', 'error');
                    }
                }
            }
            
            // Apply temporary stat debuffs (if not permanent)
            if (outcome.statDebuffs && !outcome.permanent) {
                Object.entries(outcome.statDebuffs).forEach(([stat, debuff]) => {
                    applyStatChange(stat, debuff);
                });
            }
            
            // Show outcome text
            if (outcome.text) {
                showNotification('Bad Outcome', outcome.text, 'error');
            }
        }
        
        // Arbitrary death events (camp fever, sepsis, etc.)
        const ARBITRARY_DEATH_EVENTS = [
            {
                id: 'camp_fever',
                chance: 0.02, // 2% per scene if stress > 5
                condition: () => gameState.stats.stress > 5,
                text: "Camp fever takes you. The flux. The fever. It doesn't matter what you call it. You're dead in three days.",
                nextScene: 'death_camp_fever',
                avoidCost: 240, // Cost to avoid death (20 shillings = 240 pence)
                avoidScene: 'avoid_camp_fever'
            },
            {
                id: 'septic_wound',
                baseChance: 0.05, // 5% if wounded (modified by chapter)
                condition: () => {
                    return gameState.conditions.some(c => 
                        c.name.includes('Wound') || 
                        c.name.includes('Injury') || 
                        c.name.includes('Cut')
                    );
                },
                text: "The wound turns black. The smell is wrong. Sepsis. Your arm swells. The surgeon takes it. You don't survive the amputation.",
                nextScene: 'death_sepsis',
                avoidCost: 360, // Cost for proper medical care (30 shillings = 360 pence)
                avoidScene: 'avoid_sepsis'
            },
            {
                id: 'horse_fall',
                baseChance: 0.03, // 3% if mounted (modified by chapter)
                condition: () => gameState.equipment.mount && gameState.equipment.mount.item,
                text: "Your horse spooks. You're thrown. Both legs break. The campaign is over. You're left behind.",
                nextScene: 'forced_retirement_broken_legs',
                avoidCost: 300, // Cost for better horse/equipment (25 shillings = 300 pence)
                avoidScene: 'avoid_horse_fall'
            },
            {
                id: 'dysentery',
                baseChance: 0.03, // 3% if stress > 7 (modified by chapter)
                condition: () => gameState.stats.stress > 7,
                text: "The shits. The bloody shits. You can't keep water down. You're dead in a week.",
                nextScene: 'death_dysentery',
                avoidCost: 180, // Cost for clean water/food (15 shillings = 180 pence)
                avoidScene: 'avoid_dysentery'
            },
            {
                id: 'pneumonia',
                baseChance: 0.02, // 2% if fatigued and stress > 6 (modified by chapter)
                condition: () => hasCondition('Fatigued') && gameState.stats.stress > 6,
                text: "The cough won't stop. Your chest burns. Pneumonia. You're dead before the week is out.",
                nextScene: 'death_pneumonia',
                avoidCost: 216, // Cost for shelter/medicine (18 shillings = 216 pence)
                avoidScene: 'avoid_pneumonia'
            },
            {
                id: 'plague',
                baseChance: 0.15, // 15% during plague chapter ONLY (modified by chapter = 30%!)
                condition: () => gameState.chapter === 'plague',
                text: "The black boils appear. The fever. The coughing blood. The Black Death. You're dead in days.",
                nextScene: 'death_plague',
                avoidCost: 600, // Very expensive to avoid plague (50 shillings = 600 pence = ¬£2 10s)
                avoidScene: 'avoid_plague'
            },
            {
                id: 'starvation',
                baseChance: 0.04, // 4% during siege (modified by chapter)
                condition: () => gameState.chapter === 'calais' && gameState.stats.stress > 6,
                text: "The rations run out. You starve. Your body gives up. You die in the siege lines.",
                nextScene: 'death_starvation',
                avoidCost: 300, // Cost for food (25 shillings = 300 pence = ¬£1 5s)
                avoidScene: 'avoid_starvation'
            },
            {
                id: 'broke_death',
                baseChance: 0.04, // 4% if completely broke (increased risk)
                condition: () => (gameState.stats.wealth || 0) <= 0,
                text: "You have nothing. No coin. No favors. No way to buy your way out of trouble. When sickness comes, when injury strikes, when hunger gnaws‚Äîyou have no recourse. Broke men die.",
                nextScene: 'death_broke',
                avoidCost: 0, // Can't avoid if already broke
                avoidScene: null
            }
        ];
        
        // Check for arbitrary death events
        function checkArbitraryDeath() {
            // Never check during character creation, campfires, or death scenes
            if (gameState.currentScene === 'character_creation' || 
                gameState.currentScene === 'campfire_interlude' ||
                gameState.currentScene.startsWith('death_') ||
                gameState.currentScene.startsWith('forced_retirement_') ||
                gameState.currentScene.startsWith('avoid_')) {
                return null;
            }
            
            // Get chapter death modifier (plague = 2x, calais = 1.5x, etc.)
            const chapterModifier = getChapterDeathModifier();
            
            // Increase death risk if broke (wealth = 0)
            const wealth = gameState.stats.wealth || 0;
            const brokeModifier = wealth <= 0 ? 1.5 : 1.0; // 50% higher death risk when broke
            
            // Check each death event
            for (const event of ARBITRARY_DEATH_EVENTS) {
                if (event.condition && event.condition()) {
                    // Use baseChance if available, otherwise fall back to chance (for backward compatibility)
                    const baseChance = event.baseChance !== undefined ? event.baseChance : (event.chance || 0);
                    const finalChance = baseChance * chapterModifier * brokeModifier;
                    const roll = Math.random();
                    if (roll < finalChance) {
                        // Store the death event for potential avoidance
                        gameState.pendingDeathEvent = event;
                        return event;
                    }
                }
            }
            return null;
        }
        
        // Psychological disorders at stress cap (10)
        const PSYCHOLOGICAL_DISORDERS = [
            {
                id: 'nightmares',
                name: 'Nightmares',
                text: "You can't sleep. When you do, you see the dead. Every night. Every dream.",
                statDebuffs: { morale: -2, stress: 0 }, // Stress stays at 10
                condition: 'Nightmares'
            },
            {
                id: 'paranoia',
                name: 'Paranoia',
                text: "You trust no one. Every shadow is an enemy. Every whisper is a plot against you.",
                statDebuffs: { charisma: -2, wits: -1 },
                condition: 'Paranoia'
            },
            {
                id: 'rage',
                name: 'Uncontrollable Rage',
                text: "The anger comes without warning. You break things. You hurt people. You can't stop it.",
                statDebuffs: { charisma: -3, morale: -1 },
                condition: 'Uncontrollable Rage'
            },
            {
                id: 'despair',
                name: 'Despair',
                text: "Nothing matters. Not victory. Not survival. Not tomorrow. You're already dead.",
                statDebuffs: { morale: -3, initiative: -2 },
                condition: 'Despair'
            }
        ];
        
        // Check for psychological disorders at stress cap
        function checkStressCapDisorders() {
            if (gameState.stats.stress >= 10) {
                // Check if already has a disorder
                const hasDisorder = gameState.conditions.some(c => 
                    c.name === 'Nightmares' || 
                    c.name === 'Paranoia' || 
                    c.name === 'Uncontrollable Rage' || 
                    c.name === 'Despair'
                );
                
                if (!hasDisorder) {
                    // Randomly assign a disorder
                    const disorder = PSYCHOLOGICAL_DISORDERS[Math.floor(Math.random() * PSYCHOLOGICAL_DISORDERS.length)];
                    addCondition(disorder.condition, 'negative', -1); // Permanent
                    
                    // Apply stat debuffs
                    Object.entries(disorder.statDebuffs).forEach(([stat, debuff]) => {
                        applyStatChange(stat, debuff, { silent: true });
                    });
                    
                    showNotification('Psychological Disorder', disorder.text, 'error');
                }
            }
        }
        
        // Get condition effects on stats
        function getConditionEffects() {
            let effects = {};
            gameState.conditions.forEach(condition => {
                if (condition.name === 'Wounded') {
                    effects.strength = (effects.strength || 0) - 1;
                    effects.endurance = (effects.endurance || 0) - 1;
                } else if (condition.name === 'Fatigued') {
                    effects.endurance = (effects.endurance || 0) - 1;
                    effects.agility = (effects.agility || 0) - 1;
                } else if (condition.name === 'Inspired') {
                    effects.morale = (effects.morale || 0) + 1;
                } else if (condition.name === 'Seriously Wounded') {
                    effects.strength = (effects.strength || 0) - 2;
                    effects.endurance = (effects.endurance || 0) - 2;
                    effects.agility = (effects.agility || 0) - 1;
                } else if (condition.name === 'Shaken') {
                    effects.morale = (effects.morale || 0) - 1;
                    effects.wits = (effects.wits || 0) - 1;
                } else if (condition.name === 'Sick') {
                    effects.endurance = (effects.endurance || 0) - 2;
                    effects.strength = (effects.strength || 0) - 1;
                }
            });
            return effects;
        }
        
        // Set or clear a story flag
        function setFlag(name, value = true) {
            gameState.flags[name] = value;
        }
        
        // Check if a flag is set
        function hasFlag(name) {
            return gameState.flags[name] === true;
        }
        
        // Get equipment bonuses
        function getEquipmentBonus(stat) {
            // Use EquipmentManager if available (preferred method)
            if (window.equipmentManager && typeof window.equipmentManager.getStatModifiers === 'function') {
                try {
                    const mods = window.equipmentManager.getStatModifiers();
                    return mods[stat] || 0;
                } catch (e) {
                    console.warn('Error getting equipment modifiers:', e);
                    // Fall through to fallback
                }
            }
            
            // Fallback to old system for compatibility
            let bonus = 0;
            // Weapon quality affects strength/agility in combat
            if (stat === 'strength' || stat === 'agility') {
                bonus += gameState.equipment?.weapon?.quality || 0;
            }
            // Armor quality affects endurance (protection)
            if (stat === 'endurance') {
                bonus += gameState.equipment?.armor?.quality || 0;
            }
            return bonus;
        }
        
        // Get effective stat value (base + conditions + equipment + stress/morale modifiers)
        function getEffectiveStat(stat) {
            const baseValue = gameState.stats[stat] || 0;
            const conditionEffects = getConditionEffects();
            const conditionMod = conditionEffects[stat] || 0;
            const equipmentMod = getEquipmentBonus(stat);
            
            // Stress reduces all stats slightly, morale helps
            let stressMod = 0;
            let moraleMod = 0;
            if (gameState.stats.stress >= 7) {
                stressMod = -1; // High stress hurts performance
            }
            if (gameState.stats.morale >= 8) {
                moraleMod = 1; // High morale helps
            } else if (gameState.stats.morale <= 2) {
                moraleMod = -1; // Low morale hurts
            }
            
            return baseValue + conditionMod + equipmentMod + stressMod + moraleMod;
        }
        
        // Game Scenes with explicit timeline
        // ===== CAMPFIRE VIGNETTES =====
        const CAMPFIRE_VIGNETTES = [
            {
                id: "wat_knife_humor",
                focus: "wat",
                title: "Wat Watches the Fire",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            const name = gs.characterName || "Soldier";
                            return `
                                <p>Wat sits with his back to a stump. Knife in hand. Not carving. Just holding it like a thought.</p>
                                <p>He spits into the coals. <em>"You keep your boots close. A man wakes barefoot, he wakes dead."</em></p>
                                <p>He looks at you without kindness. Without hate. Like weighing iron.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Nod and check your boots anyway.", 
                                response: function(gs) {
                                    return `<p>Wat grunts. <em>"Good. You listen. Most men don't. They think they know better. Then they wake up with their boots gone and their throat cut."</em></p>
                                            <p>He turns the knife in his hand. <em>"I've seen it happen. More than once. Men who thought they were safe. Men who thought the war wouldn't touch them."</em></p>
                                            <p><em>"The war touches everyone. Sooner or later."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Ask him what happened to his first pair.", 
                                response: function(gs) {
                                    return `<p>Wat's face darkens. <em>"First pair? I've lost more boots than I can count. But the first pair..."</em></p>
                                            <p>He pauses. The knife stops moving. <em>"That was at Bannockburn. The Scots came in the night. We were sleeping. I woke up to screaming. Grabbed my sword. Ran out of the tent."</em></p>
                                            <p><em>"Left my boots behind. Fought barefoot in the mud. The cold. The stones cutting my feet. But I lived. Others didn't."</em></p>
                                            <p>He looks at you. <em>"That's why I keep them close now. Always."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_boot_story = true; }
                            },
                            { 
                                text: "Say nothing. Let him have his silence.", 
                                response: function(gs) {
                                    return `<p>You sit in silence. Wat watches the fire. The knife moves in his hand. Slow. Methodical.</p>
                                            <p>After a while, he speaks. <em>"Silence is good. Most men talk too much. Give themselves away. Give their position away."</em></p>
                                            <p><em>"You learn to be quiet. You learn to listen. That's how you stay alive."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 0); applyStatChange("stress", -1, {silent:true}); }
                            },
                            { 
                                text: "\"I don't give a shit, Wat.\"", 
                                response: function(gs) {
                                    return `<p>Wat stops. The knife stops. He looks at you. Really looks. For a long moment, you think he might gut you.</p>
                                            <p>Then he laughs. A harsh, barking laugh. <em>"You don't give a shit? Good. That's honest. Most men lie. Say they care when they don't."</em></p>
                                            <p>He spits. <em>"But here's the thing: the war gives a shit about you. Whether you care or not. It'll kill you just the same."</em></p>
                                            <p><em>"So you can not give a shit all you want. But keep your boots close anyway. Or don't. Your choice."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", -1); applyStatChange("stress", -2, {silent:true}); applyStatChange("morale", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask him about Bannockburn.",
                                response: function(gs) {
                                    return `<p>Wat's eyes get distant. <em>"Bannockburn. That was a slaughter. The Scots knew the ground. We didn't. They had the high ground. We had mud."</em></p>
                                            <p><em>"The king's horse got stuck. The whole army got stuck. Then the Scots came down. Like wolves on sheep."</em></p>
                                            <p>He spits. <em>"I was young then. Thought I knew what war was. I didn't. Not really. Not until I saw what happened that day."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_bannockburn = true; }
                            },
                            {
                                text: "Nod and let the silence return.",
                                response: function(gs) {
                                    return `<p>The fire crackles. Wat watches it. You watch it too. Sometimes words aren't needed.</p>
                                            <p>After a moment, Wat speaks again. <em>"You're learning. That's good. Most men don't."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_salt_01",
                focus: "cook",
                title: "The Cook Counts the Salt",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>The Cook pours salt into his palm and counts it under his breath. Not prayer. Measure.</p>
                                <p><em>"Too little and men hate you. Too much and they thirst. Hunger is loud. Thirst is louder."</em></p>
                                <p>He offers you the pinch like it is evidence.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Taste it and tell him it's right.", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"Good. You have a tongue. Most men just swallow. Don't taste. Don't notice."</em></p>
                                            <p>He takes the salt back. Adds it to the pot. <em>"Cooking is balance. Too much of anything and it's ruined. Too little and it's nothing."</em></p>
                                            <p><em>"War is the same. Too much anger and you break. Too little and you die. Balance. Always balance."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Ask how he learned that.", 
                                response: function(gs) {
                                    return `<p>The Cook smiles. A rare thing. <em>"I was an apprentice. In a kitchen. A real kitchen. Not this."</em></p>
                                            <p>He gestures at the camp. <em>"I learned from a master. A man who knew every herb. Every spice. Every measure. He taught me that cooking is mathematics. Precision. Not guesswork."</em></p>
                                            <p><em>"Then the war came. The master closed his kitchen. I took up the sword. But I kept what I learned. The precision. The balance."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); if (!gs.flags) gs.flags = {}; gs.flags.cook_apprentice_hint = true; }
                            },
                            { 
                                text: "\"This salt speech is bullshit, Cook.\"", 
                                response: function(gs) {
                                    return `<p>The Cook looks at you. Really looks. <em>"Bullshit? You think caring about food is bullshit?"</em></p>
                                            <p>He holds up the salt. <em>"This. This keeps men alive. Too little, they hate you. Too much, they thirst. You think that's bullshit?"</em></p>
                                            <p><em>"Fine. It's bullshit. But it's the bullshit that keeps you fed. That keeps you healthy. That keeps you alive."</em></p>
                                            <p>He throws the salt in the pot. <em>"You want to call it bullshit? Go ahead. But don't complain when the food tastes like shit. Because I stopped caring."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Joke about boiling your belt instead.", 
                                response: function(gs) {
                                    return `<p>The Cook doesn't smile. <em>"I've done that. Boiled leather. Boiled roots. Boiled things you wouldn't believe."</em></p>
                                            <p><em>"When you're hungry enough, you'll eat anything. When you're desperate enough, you'll try anything."</em></p>
                                            <p>He stirs the pot. <em>"But that's not cooking. That's survival. There's a difference."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 0); applyStatChange("morale", 1, {silent:true}); applyStatChange("stress", 1, {silent:true}); }
                            },
                            { 
                                text: "\"You're a fucking idiot, Cook.\"", 
                                response: function(gs) {
                                    return `<p>The Cook stops. The spoon stops. Everything stops.</p>
                                            <p>He looks at you. Really looks. <em>"A fucking idiot? For counting salt? For caring about the food?"</em></p>
                                            <p>He sets the spoon down. Carefully. <em>"You know what? Fine. I'm a fucking idiot. But I'm the fucking idiot who keeps you fed. Who keeps you alive."</em></p>
                                            <p><em>"You want to call me names? Go ahead. But when you're hungry. When you're starving. When the food tastes like shit because I stopped caring‚Äîremember this moment."</em></p>
                                            <p>He picks up the spoon. Goes back to stirring. <em>"Your choice. Your stomach."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 2, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask about the master's kitchen.",
                                response: function(gs) {
                                    return `<p>The Cook's eyes get distant. <em>"It was in London. A big house. The master cooked for nobles. Rich men. Men who'd never known hunger."</em></p>
                                            <p><em>"I learned to make dishes that would make a king weep. Pastries. Sauces. Things that took days to prepare."</em></p>
                                            <p>He looks at the pot. <em>"Now I cook for soldiers. Men who'd eat their own boots if they were hungry enough. But I still use what I learned. The precision. The care."</em></p>
                                            <p><em>"Even in war, there's room for skill. For doing things right."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_master_kitchen = true; }
                            },
                            {
                                text: "Ask why he left the kitchen.",
                                response: function(gs) {
                                    return `<p>The Cook is quiet for a long time. <em>"The master died. Plague. The kitchen closed. I had no place to go."</em></p>
                                            <p><em>"A man needs to eat. A man needs coin. The army offered both. So I took up the sword. But I kept the skills. The knowledge."</em></p>
                                            <p>He stirs the pot. <em>"Cooking is still cooking. Whether it's for nobles or soldiers. The principles are the same."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_left_kitchen = true; }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_vulgar_02",
                focus: "wat",
                title: "Wat on Officers",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat watches the dark beyond the tents. Like it owes him money.</p>
                                <p><em>"Officers talk about honor. Honor don't stop an arrow. You learn that early or you learn it bleeding."</em></p>
                                <p>He spits again. Angry at the world for being the world.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask what he'd do differently in command.", 
                                response: function(gs) {
                                    return `<p>Wat laughs. A harsh sound. <em>"In command? I'd keep men alive. That's what I'd do."</em></p>
                                            <p><em>"Officers send men to die for glory. For honor. For stupid reasons. I'd send them to live. To win. To come home."</em></p>
                                            <p><em>"But that's why I'll never be an officer. They don't want men who think. They want men who obey."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_command_thoughts = true; }
                            },
                            { 
                                text: "Say you still want honor anyway.", 
                                response: function(gs) {
                                    return `<p>Wat's eyes flash. <em>"Honor? You want honor? Honor is a word rich men use to make poor men die."</em></p>
                                            <p><em>"I've seen honorable men die. I've seen dishonorable men live. Which do you think matters more?"</em></p>
                                            <p>He spits. <em>"You want honor? Fine. But don't expect it to save you. It won't."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", -1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Change the subject to tomorrow's march.", 
                                response: function(gs) {
                                    return `<p>Wat nods. <em>"Tomorrow. Always tomorrow. Another march. Another battle. Another day closer to home or closer to death."</em></p>
                                            <p><em>"The march will be hard. The ground is rough. The French are close. But we'll make it. We always do."</em></p>
                                            <p>He looks at you. <em>"Just keep your boots on. Keep your eyes open. That's all you need to do."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 0); applyStatChange("stress", -1, {silent:true}); }
                            },
                            { 
                                text: "\"I don't give a shit about your honor speech, Wat.\"", 
                                response: function(gs) {
                                    return `<p>Wat's eyes flash. He stands. Towers over you. <em>"You don't give a shit? Fine. You don't have to."</em></p>
                                            <p>He sits back down. Hard. <em>"But I've seen men who didn't give a shit. Seen them die. Seen them bleed out in the mud because they thought they knew better."</em></p>
                                            <p><em>"You want to not give a shit? Go ahead. But don't come crying to me when an arrow finds you because you weren't paying attention."</em></p>
                                            <p>He spits. <em>"Your funeral."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask him if he's ever been in command.",
                                response: function(gs) {
                                    return `<p>Wat is quiet. <em>"Once. Small group. Ten men. We got cut off. Separated from the main force."</em></p>
                                            <p><em>"I got them back. All of them. Alive. But the officers didn't like it. I didn't follow orders. I followed sense."</em></p>
                                            <p><em>"That's the problem. Sense and orders don't always match. And when they don't, you have to choose."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_commanded = true; }
                            },
                            {
                                text: "Nod and let the conversation end.",
                                response: function(gs) {
                                    return `<p>You sit in silence. Wat watches the fire. Sometimes words aren't needed.</p>
                                            <p>After a while, Wat speaks. <em>"You're learning. That's good."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_story_home_02",
                focus: "cook",
                title: "A Question Asked Plainly",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>The Cook stirs the pot until it makes the same sound twice. Then he stops.</p>
                                <p><em>"Where did you sleep when you were small."</em> he says. Not <em>why</em>. Not <em>with whom</em>. Just the fact.</p>
                                <p>Wat snorts like the question insults him. The Cook waits anyway.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "\"In a crowded room. Always noise.\"", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"Crowded. Many voices. Many sounds. You learned to sleep through it. To find peace in chaos."</em></p>
                                            <p><em>"That's useful. In war, there's always noise. Always chaos. Men who need quiet don't last long."</em></p>
                                            <p>He stirs the pot. <em>"You adapted. That's what matters. Adaptation. Survival."</em></p>`;
                                },
                                effects: function(gs) { if (!gs.flags) gs.flags = {}; gs.flags.backstory_home = "crowded"; changeRel("cook", 2); }
                            },
                            { 
                                text: "\"In a place that was quiet.\"", 
                                response: function(gs) {
                                    return `<p>The Cook looks at you. Really looks. <em>"Quiet. That's rare. Most men never know quiet. Not really."</em></p>
                                            <p><em>"Quiet is a luxury. In war, you lose it. The noise. The chaos. It never stops."</em></p>
                                            <p><em>"But if you knew quiet once, you can find it again. Inside. Even when everything around you is loud."</em></p>`;
                                },
                                effects: function(gs) { if (!gs.flags) gs.flags = {}; gs.flags.backstory_home = "quiet"; changeRel("cook", 2); applyStatChange("stress", -1, {silent:true}); }
                            },
                            { 
                                text: "\"Does it matter.\"", 
                                response: function(gs) {
                                    return `<p>The Cook is quiet. Wat snorts again. <em>"See? Some men don't want to talk. Don't want to remember."</em></p>
                                            <p>The Cook stirs. <em>"It matters. Everything matters. Where you came from. What you remember. It shapes who you are."</em></p>
                                            <p><em>"But if you don't want to talk, that's your choice. I won't force it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", -1); changeRel("wat", 1); }
                            },
                            { 
                                text: "\"Fuck off with your questions, Cook.\"", 
                                response: function(gs) {
                                    return `<p>The Cook stops. Wat looks at you. Really looks.</p>
                                            <p>The Cook speaks. Quietly. <em>"Fuck off? You want me to fuck off? Fine. I'll fuck off."</em></p>
                                            <p>He sets down the spoon. <em>"But remember. I'm the one who feeds you. I'm the one who keeps you alive. You want to tell me to fuck off? That's your choice."</em></p>
                                            <p>Wat grunts. <em>"That was stupid. But honest. I'll give you that."</em></p>
                                            <p>The Cook goes back to stirring. But something's changed. The warmth is gone.</p>`;
                                },
                                effects: function(gs) { changeRel("cook", -2); changeRel("wat", 0); applyStatChange("stress", 2, {silent:true}); applyStatChange("morale", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask the Cook where he slept.",
                                response: function(gs) {
                                    return `<p>The Cook smiles. A sad smile. <em>"In the kitchen. On the floor. By the fire."</em></p>
                                            <p><em>"The master let me sleep there. Said the fire would keep me warm. Said I'd learn to cook in my sleep."</em></p>
                                            <p><em>"I did. I learned everything there. The sounds. The smells. The rhythm of it. It became home."</em></p>
                                            <p><em>"Then the war came. The kitchen closed. I lost my home. But I kept the knowledge. The skills."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); if (!gs.flags) gs.flags = {}; gs.flags.cook_home_story = true; }
                            },
                            {
                                text: "Nod and let the silence return.",
                                response: function(gs) {
                                    return `<p>The fire crackles. The Cook stirs. Wat watches the dark.</p>
                                            <p>Sometimes questions don't need answers. Sometimes the asking is enough.</p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "odd_couple_03",
                focus: "both",
                title: "Wat and the Cook Argue About Knives",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat sharpens his blade like he means to cut the whole war open and look inside it.</p>
                                <p>The Cook says, calm as a ledger: <em>"That edge will fold. You're rushing."</em></p>
                                <p>Wat growls. <em>"I've killed with worse."</em> The Cook nods. <em>"I know."</em></p>
                                <p>For a moment the fire is the only thing that speaks.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Side with Wat: \"If it cuts, it cuts.\"", 
                                response: function(gs) {
                                    return `<p>Wat grunts. <em>"See? He understands. A blade is a blade. If it cuts, it works."</em></p>
                                            <p>The Cook shakes his head. <em>"A blade that folds is a blade that fails. When you need it most. When your life depends on it."</em></p>
                                            <p>Wat stops sharpening. Looks at the Cook. <em>"I've never had a blade fail me. Not when it mattered."</em></p>
                                            <p><em>"Not yet,"</em> the Cook says quietly.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); changeRel("cook", -1); }
                            },
                            { 
                                text: "Side with the Cook: \"Let him show you.\"", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"Thank you. A proper edge takes time. Takes care. Rushing ruins it."</em></p>
                                            <p>Wat scowls. <em>"I don't need lessons. I've been sharpening blades longer than you've been cooking."</em></p>
                                            <p>The Cook takes the blade. Examines it. <em>"Time doesn't mean skill. I've seen men who've done things wrong for years. Still wrong."</em></p>
                                            <p>He hands it back. <em>"But it's your blade. Your choice."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); changeRel("wat", -1); }
                            },
                            { 
                                text: "Defuse it: \"Both of you are right.\"", 
                                response: function(gs) {
                                    return `<p>Wat and the Cook both look at you. The tension breaks.</p>
                                            <p>Wat grunts. <em>"Maybe. Maybe we're both right. Maybe we're both wrong."</em></p>
                                            <p>The Cook stirs the pot. <em>"There's truth in that. Different methods. Different needs. Both valid."</em></p>
                                            <p>Wat resumes sharpening. Slower now. More careful. <em>"I'll think about it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 0); changeRel("cook", 0); applyStatChange("morale", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask Wat why he sharpens so aggressively.",
                                response: function(gs) {
                                    return `<p>Wat doesn't look up. <em>"Anger. That's why. I sharpen when I'm angry. When I need to do something. When I can't sit still."</em></p>
                                            <p><em>"The blade needs to be sharp. Always. But the sharpening? That's for me. Keeps my hands busy. Keeps my mind focused."</em></p>
                                            <p><em>"The Cook's right. I rush. But rushing is better than sitting. Better than thinking. Better than remembering."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_sharpening_reason = true; }
                            },
                            {
                                text: "Ask the Cook about proper blade care.",
                                response: function(gs) {
                                    return `<p>The Cook sets down his spoon. <em>"A blade is a tool. Like a pot. Like a fire. It needs care. Needs respect."</em></p>
                                            <p><em>"You don't rush a meal. You don't rush a blade. Both will fail you if you do."</em></p>
                                            <p><em>"Wat's method works. For him. But there's a better way. A way that preserves the blade. That makes it last."</em></p>
                                            <p><em>"But some men need the anger. Need the rush. I understand that."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_blade_care = true; }
                            },
                            {
                                text: "Let the silence return.",
                                response: function(gs) {
                                    return `<p>The fire crackles. Wat sharpens. The Cook stirs. The tension fades.</p>
                                            <p>Sometimes peace comes from letting things be. From not forcing resolution.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 0); changeRel("cook", 0); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_scars_04",
                focus: "wat",
                title: "Counting Scars",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat rolls his sleeve and there are old marks on him like tally lines.</p>
                                <p><em>"This one was a billhook. This one was a dog. This one was my own fault."</em></p>
                                <p>He puts the sleeve back down like shutting a door.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask which one was 'your own fault.'", 
                                response: function(gs) {
                                    return `<p>Wat is quiet. Then he rolls the sleeve back up. Points to a long scar on his forearm.</p>
                                            <p><em>"This one. I was drunk. Angry. Got into a fight I shouldn't have. With a man I shouldn't have."</em></p>
                                            <p><em>"He had a knife. I didn't. Stupid. But I was young. Thought I was invincible."</em></p>
                                            <p><em>"I learned. The hard way. But I learned."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_fault = true; }
                            },
                            { 
                                text: "Say you're glad he's still here.", 
                                response: function(gs) {
                                    return `<p>Wat looks at you. Really looks. <em>"Glad? You're glad I'm here?"</em></p>
                                            <p>He's quiet for a moment. <em>"Most men aren't glad. Most men are afraid. Of me. Of what I've done. Of what I've seen."</em></p>
                                            <p><em>"But you're glad. That's... that's something."</em></p>
                                            <p>He pulls the sleeve down. <em>"Thank you."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Look away. Give him dignity.", 
                                response: function(gs) {
                                    return `<p>You look away. At the fire. At the dark. Anywhere but at Wat's scars.</p>
                                            <p>After a moment, Wat speaks. <em>"Thank you. Most men stare. Ask questions. Want to know the stories."</em></p>
                                            <p><em>"But you looked away. Gave me my dignity. That's rare. That's... that's good."</em></p>
                                            <p>He pulls the sleeve down. <em>"I appreciate that."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask about the other scars.",
                                response: function(gs) {
                                    return `<p>Wat considers. Then he points. <em>"The billhook. That was at a village. French farmer. Desperate. Fought like a demon."</em></p>
                                            <p><em>"The dog. That was in Scotland. Wild thing. Attacked me in the dark. Nearly took my arm."</em></p>
                                            <p><em>"Each one has a story. Each one taught me something. About war. About survival. About myself."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_scar_stories = true; }
                            },
                            {
                                text: "Nod and let the silence return.",
                                response: function(gs) {
                                    return `<p>You sit in silence. Wat watches the fire. The scars are hidden now. But they're still there. Still part of him.</p>
                                            <p>Sometimes silence is the right response. Sometimes it's the only response.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_rations_04",
                focus: "cook",
                title: "Bread Like Stones",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>The bread is hard enough to strike sparks. The Cook breaks it anyway.</p>
                                <p><em>"Men complain. Then they eat. Complaining is a habit. Eating is a law."</em></p>
                                <p>He hands you the larger piece without looking proud of it.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Take it. Don't insult the gift.", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"Good. You understand. A gift is a gift. Even if it's hard bread. Even if it's not much."</em></p>
                                            <p><em>"I've seen men refuse. Seen them throw it back. Seen them complain. But they still eat it. Eventually. When hunger wins."</em></p>
                                            <p><em>"Better to accept with grace. Better to be grateful. Even for little things."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Trade pieces anyway.", 
                                response: function(gs) {
                                    return `<p>The Cook looks surprised. <em>"You'd trade? Give me the larger piece?"</em></p>
                                            <p>He takes it. Looks at it. <em>"That's... that's kind. Unnecessary. But kind."</em></p>
                                            <p><em>"Most men take what they can get. You give. That's rare. That's good."</em></p>
                                            <p>He breaks the bread. Shares it back. <em>"We'll share. Both of us. That's fair."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 3); changeRel("wat", 0); }
                            },
                            { 
                                text: "Give it to Wat instead.", 
                                response: function(gs) {
                                    return `<p>The Cook watches you give the bread to Wat. Wat looks surprised. Takes it. Nods.</p>
                                            <p>The Cook speaks. <em>"You gave it away. To him. Why?"</em></p>
                                            <p>Wat grunts. <em>"Because he's a good man. That's why."</em></p>
                                            <p>The Cook looks at you. <em>"Yes. Yes, he is."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); changeRel("cook", 0); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask why the bread is so hard.",
                                response: function(gs) {
                                    return `<p>The Cook sighs. <em>"Old bread. Stale bread. Bread that's been carried for days. Weeks maybe."</em></p>
                                            <p><em>"I do what I can. Soak it. Soften it. But sometimes there's nothing to soak it in. No water. No broth. Nothing."</em></p>
                                            <p><em>"So it stays hard. Like stone. But it's still food. Still nourishment. Still life."</em></p>
                                            <p><em>"Hard bread is better than no bread. Always."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_bread_story = true; }
                            },
                            {
                                text: "Thank him for the bread.",
                                response: function(gs) {
                                    return `<p>The Cook smiles. A rare thing. <em>"You're welcome. It's not much. But it's what I have."</em></p>
                                            <p><em>"Gratitude. That's rare too. Most men just take. Don't thank. Don't appreciate."</em></p>
                                            <p><em>"But you do. That means something. To me. It means something."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "both_watch_05",
                focus: "both",
                title: "Night Watch",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>You draw watch with Wat and the Cook. An odd draw. A hard man and a quiet man and you between them.</p>
                                <p>Wat listens for trouble. The Cook listens for the wind changing. Both kinds of listening feel useful.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask Wat what he listens for.", 
                                response: function(gs) {
                                    return `<p>Wat doesn't look at you. Keeps watching the dark. <em>"Footsteps. Voices. The sound of metal. The sound of men moving who shouldn't be moving."</em></p>
                                            <p><em>"I listen for the enemy. For danger. For anything that means we're not alone out here."</em></p>
                                            <p><em>"Most men don't listen. They hear. But they don't listen. There's a difference. Listening means understanding. Hearing is just noise."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_listening = true; }
                            },
                            { 
                                text: "Ask the Cook what the wind means.", 
                                response: function(gs) {
                                    return `<p>The Cook closes his eyes. Listens. <em>"The wind tells you things. Weather. Direction. Distance."</em></p>
                                            <p><em>"A change in wind means a change in weather. Rain coming. Or cold. Or clear skies."</em></p>
                                            <p><em>"The direction tells you where you are. Where you're going. The sound tells you how far things are. How close."</em></p>
                                            <p><em>"Everything speaks. If you know how to listen."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); if (!gs.flags) gs.flags = {}; gs.flags.cook_wind = true; }
                            },
                            { 
                                text: "Say nothing. Just keep watch.", 
                                response: function(gs) {
                                    return `<p>You keep watch. Silent. Listening. Watching.</p>
                                            <p>After a while, Wat speaks. <em>"Good. You're learning. Silence is a weapon. Listening is a skill."</em></p>
                                            <p>The Cook nods. <em>"You understand. Not everything needs words. Sometimes the watching is enough."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask how they learned to listen so well.",
                                response: function(gs) {
                                    return `<p>Wat grunts. <em>"Survival. That's how. You learn or you die. Simple."</em></p>
                                            <p>The Cook nods. <em>"Experience. Years of it. Paying attention. Noticing things others miss."</em></p>
                                            <p><em>"Wat listens for danger. I listen for change. Both are important. Both keep you alive."</em></p>
                                            <p>Wat looks at you. <em>"You'll learn. If you live long enough. If you pay attention."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); changeRel("cook", 1); }
                            },
                            {
                                text: "Continue keeping watch in silence.",
                                response: function(gs) {
                                    return `<p>The three of you keep watch. Silent. Together. Each listening in your own way.</p>
                                            <p>There's comfort in that. In the shared silence. In the shared duty.</p>
                                            <p>After a while, the watch ends. But the memory of it remains. The peace of it.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); changeRel("cook", 1); applyStatChange("stress", -2, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_fury_06",
                focus: "wat",
                title: "Wat's Temper",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat curses at a loose strap. At damp wood. At a pot that won't boil.</p>
                                <p>Small things. But his anger is real. He stays sharp by staying angry. Complacency kills men. He's seen it.</p>
                                <p>He looks at you. <em>"Don't drift,"</em> he says. <em>"Drifting gets you killed."</em></p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Promise you won't drift.", 
                                response: function(gs) {
                                    return `<p>Wat grunts. <em>"Good. Keep that promise. Men who drift end up dead. Or worse. They end up broken."</em></p>
                                            <p>He adjusts his sword. The firelight catches the edge. <em>"You see that? Sharp. Always sharp. Because I check. Every day. Every night. That's not drifting."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Tell him he's burning himself out.", 
                                response: function(gs) {
                                    return `<p>Wat's eyes flash. <em>"Burning out? You think I'm burning out?"</em></p>
                                            <p>He stands. Towers over you. <em>"I've seen men who 'relaxed.' I've seen them die. You want to burn out? Fine. But don't tell me I'm wrong."</em></p>
                                            <p>He sits back down. The anger doesn't leave. It just settles deeper.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", -1); if (!gs.flags) gs.flags = {}; gs.flags.wat_called_out = true; }
                            },
                            { 
                                text: "Make a small joke to break the edge.", 
                                response: function(gs) {
                                    return `<p>Wat stares. Then a sound comes out. Not a laugh. Something between a cough and a curse.</p>
                                            <p><em>"Jokes,"</em> he says. <em>"Jokes are fine. But remember. The enemy doesn't joke. The enemy doesn't drift. The enemy kills."</em></p>
                                            <p>He looks back at the fire. <em>"Keep your edge. Even when you joke."</em></p>`;
                                },
                                effects: function(gs) { applyStatChange("morale", 1, {silent:true}); changeRel("wat", 0); applyStatChange("stress", 1, {silent:true}); }
                            },
                            { 
                                text: "\"Fuck off with your drifting speech, Wat.\"", 
                                response: function(gs) {
                                    return `<p>Wat stops. Everything stops. The fire seems to hold its breath.</p>
                                            <p>He turns. Slowly. Looks at you. <em>"Fuck off? You want me to fuck off?"</em></p>
                                            <p>He stands. The knife is in his hand. You're not sure when it got there. <em>"Fine. I'll fuck off. But when you drift. When you get lazy. When you die because you weren't paying attention‚Äîdon't say I didn't warn you."</em></p>
                                            <p>He sits. Hard. <em>"Your choice. Your funeral."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", -2); applyStatChange("stress", 2, {silent:true}); applyStatChange("morale", 2, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            // This will be set by the previous choice's response
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            { 
                                text: "Ask him what happened to make him this way.", 
                                response: function(gs) {
                                    return `<p>Wat is quiet for a long time. The fire pops. Sparks fly.</p>
                                            <p><em>"I watched my brother drift,"</em> he says. <em>"One moment he was there. Next moment he wasn't. Arrow through the throat. He'd stopped paying attention. Just for a second."</em></p>
                                            <p>He spits. <em>"That's all it takes. One second."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_brother_story = true; }
                            },
                            { 
                                text: "Nod and say nothing.", 
                                response: function(gs) {
                                    return `<p>You sit in silence. Wat watches the fire. The anger fades. Just a little.</p>
                                            <p>Sometimes silence is the right answer.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            { 
                                text: "Tell him you understand.", 
                                response: function(gs) {
                                    return `<p>Wat looks at you. Really looks. Like he's measuring something.</p>
                                            <p><em>"Maybe you do,"</em> he says. <em>"Maybe you don't. Time will tell."</em></p>
                                            <p>He turns back to the fire. But something in his posture has changed. Slightly. Like a weight shifted.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("morale", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_names_06",
                focus: "cook",
                title: "Names and Reasons",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>The Cook asks, very simply, <em>"Do you like your name."</em></p>
                                <p>Wat scoffs like names are luxuries. The Cook doesn't argue. He just waits.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "\"It's all I've got.\"", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"A name is a name. It's yours. That's what matters."</em></p>
                                            <p><em>"Some men have grand names. Names that mean something. Names that carry weight."</em></p>
                                            <p><em>"But a simple name? A name that's just yours? That's enough. That's more than enough."</em></p>`;
                                },
                                effects: function(gs) { if (!gs.flags) gs.flags = {}; gs.flags.backstory_name = "only"; changeRel("cook", 2); }
                            },
                            { 
                                text: "\"I took it from someone.\"", 
                                response: function(gs) {
                                    return `<p>The Cook looks at you. Really looks. <em>"You took it. From someone. That's... that's a story."</em></p>
                                            <p>Wat stops scoffing. Listens. <em>"A man takes a name, he takes a life. Or he takes a memory. Which is it?"</em></p>
                                            <p>The Cook waits. Wat waits. Both want to know.</p>`;
                                },
                                effects: function(gs) { if (!gs.flags) gs.flags = {}; gs.flags.backstory_name = "taken"; changeRel("cook", 1); changeRel("wat", 1); applyStatChange("stress", 1, {silent:true}); }
                            },
                            { 
                                text: "\"I don't think about it.\"", 
                                response: function(gs) {
                                    return `<p>The Cook nods. <em>"Some men don't. Some men just are. Their name is just a sound. Nothing more."</em></p>
                                            <p>Wat grunts. <em>"Names don't matter. Actions do. What you do. Not what you're called."</em></p>
                                            <p>The Cook stirs the pot. <em>"Maybe. But a name can be a burden. Or a gift. Depends on the man."</em></p>`;
                                },
                                effects: function(gs) { if (!gs.flags) gs.flags = {}; gs.flags.backstory_name = "none"; changeRel("cook", 0); changeRel("wat", 1); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask the Cook about his name.",
                                response: function(gs) {
                                    return `<p>The Cook smiles. A sad smile. <em>"My name? It was given to me. By the master. In the kitchen."</em></p>
                                            <p><em>"Before that, I had another name. A different name. But that man is gone. The kitchen man is who I am now."</em></p>
                                            <p><em>"Names change. Men change. That's how it is."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); if (!gs.flags) gs.flags = {}; gs.flags.cook_name_story = true; }
                            },
                            {
                                text: "Ask Wat about his name.",
                                response: function(gs) {
                                    return `<p>Wat spits. <em>"Wat. That's it. Just Wat. No more. No less."</em></p>
                                            <p><em>"I've had other names. Names men gave me. Names I earned. But Wat? That's the one that stuck."</em></p>
                                            <p><em>"It's short. Simple. Like me."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_name_story = true; }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "both_song_07",
                focus: "both",
                title: "A Song That Dies Early",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Someone tries to sing. It goes badly and ends fast.</p>
                                <p>Wat mutters something crude. The Cook, without judgment, says: <em>"Wrong key."</em></p>
                                <p>And that is the closest thing to laughter you get all week.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Add a verse anyway.", 
                                response: function(gs) {
                                    return `<p>You start singing. Badly. But you keep going. Wat stares. The Cook listens.</p>
                                            <p>After a moment, Wat grunts. <em>"That's... that's terrible. But I'll give you this: you've got guts."</em></p>
                                            <p>The Cook nods. <em>"The key is still wrong. But the spirit is right. That counts for something."</em></p>
                                            <p>Someone else joins in. Then another. The song gets worse. But the mood gets better.</p>`;
                                },
                                effects: function(gs) { applyStatChange("morale", 2, {silent:true}); changeRel("wat", 1); changeRel("cook", 1); }
                            },
                            { 
                                text: "Ask the Cook what key it should be.", 
                                response: function(gs) {
                                    return `<p>The Cook looks surprised. <em>"You want to know? Really?"</em></p>
                                            <p>He thinks. <em>"It should be in a minor key. Something sad. Something that fits the war. The loss. The distance from home."</em></p>
                                            <p><em>"But most men don't care about keys. They just want to sing. To feel something. Even if it's wrong."</em></p>
                                            <p>Wat grunts. <em>"Keys. Notes. It's all noise to me. But if it matters to you, Cook, then it matters."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); changeRel("wat", 0); if (!gs.flags) gs.flags = {}; gs.flags.cook_music = true; }
                            },
                            { 
                                text: "Sit it out. Rest your voice.", 
                                response: function(gs) {
                                    return `<p>You sit. Watch. Listen. The song dies. The silence returns.</p>
                                            <p>Wat looks at you. <em>"Smart. Sometimes the best thing to do is nothing. Let others make fools of themselves."</em></p>
                                            <p>The Cook stirs the pot. <em>"Rest is good. Your voice will thank you. Your ears will thank you."</em></p>
                                            <p>The peace is welcome. The quiet is welcome.</p>`;
                                },
                                effects: function(gs) { applyStatChange("stress", -2, {silent:true}); changeRel("wat", 0); changeRel("cook", 0); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask the Cook if he can sing.",
                                response: function(gs) {
                                    return `<p>The Cook smiles. A rare thing. <em>"I can. A little. Songs from the kitchen. Songs from home."</em></p>
                                            <p><em>"But I don't sing here. Not in the camp. The songs are too sad. Too full of memory."</em></p>
                                            <p><em>"Some things are better kept inside. Some memories are better left alone."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_singing = true; }
                            },
                            {
                                text: "Ask Wat if he knows any songs.",
                                response: function(gs) {
                                    return `<p>Wat spits. <em>"Songs? I know drinking songs. Fighting songs. Songs that'll make your mother cry."</em></p>
                                            <p><em>"But I don't sing them. Not anymore. Songs remind you of things. Things you'd rather forget."</em></p>
                                            <p><em>"I'd rather forget. So I don't sing."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_songs = true; }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_mercy_08",
                focus: "wat",
                title: "Mercy, Wat Says",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat stares at the dark and says, like it costs him: <em>"Sometimes you let a man run."</em></p>
                                <p><em>"Not for him,"</em> he adds. <em>"For you."</em></p>
                                <p>The Cook nods once, as if this is a rule in a book he's read.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Agree. Keep your hands clean when you can.", 
                                response: function(gs) {
                                    return `<p>Wat looks at you. Really looks. <em>"You understand. Good. Most men don't."</em></p>
                                            <p><em>"Killing is easy. Not killing? That's harder. That takes something. Takes strength."</em></p>
                                            <p><em>"Every man you kill, you carry. Every death, you remember. Let one go, you carry less. Remember less."</em></p>
                                            <p>The Cook nods. <em>"Mercy is a choice. A hard choice. But a good one."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Disagree. \"No loose ends.\"", 
                                response: function(gs) {
                                    return `<p>Wat's eyes flash. <em>"Loose ends? You think letting a man go is a loose end?"</em></p>
                                            <p><em>"A man you let go, he remembers. He might come back. But he might not. A man you kill, he's gone. But so is a piece of you."</em></p>
                                            <p>The Cook shakes his head. <em>"Killing isn't always the answer. Sometimes mercy is stronger."</em></p>
                                            <p>Wat spits. <em>"Maybe. But loose ends get you killed. I've seen it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 0); changeRel("cook", -1); applyStatChange("reputation", 1, {silent:true}); }
                            },
                            { 
                                text: "Ask who Wat let run.", 
                                response: function(gs) {
                                    return `<p>Wat is quiet. For a long time. Then he speaks. <em>"A boy. Just a boy. Maybe sixteen. Maybe younger."</em></p>
                                            <p><em>"He came at me with a pitchfork. Desperate. Scared. I could have killed him. Easy. But I didn't."</em></p>
                                            <p><em>"I let him run. Watched him go. He looked back once. Then he was gone."</em></p>
                                            <p><em>"That was years ago. I still remember. But I don't regret it. Not for a second."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_mercy_story = true; }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask if he's ever regretted showing mercy.",
                                response: function(gs) {
                                    return `<p>Wat thinks. <em>"Regretted? No. Not really. Some men came back. Some didn't. But I don't regret letting them go."</em></p>
                                            <p><em>"Regret is for things you did wrong. Mercy isn't wrong. It's just... hard."</em></p>
                                            <p><em>"Harder than killing. But sometimes harder is better."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            {
                                text: "Ask the Cook about mercy.",
                                response: function(gs) {
                                    return `<p>The Cook stirs the pot. <em>"Mercy. It's a choice. Like cooking. Like living."</em></p>
                                            <p><em>"You can choose to be hard. To be cruel. Or you can choose to be kind. To show mercy."</em></p>
                                            <p><em>"Both are valid. Both are necessary. But mercy? That's harder. That takes more."</em></p>
                                            <p><em>"Wat understands that. Not many men do."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); changeRel("wat", 0); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_embers_01",
                focus: "wat",
                title: "Wat Watches the Embers",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat watches the fire die. He doesn't feed it. Just watches.</p>
                                <p><em>"Fire's honest. Burns what you give it. Doesn't lie. Doesn't promise."</em></p>
                                <p>He spits. The embers hiss.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Feed the fire yourself.", 
                                response: function(gs) {
                                    return `<p>You add wood to the fire. The flames grow. The light returns.</p>
                                            <p>Wat watches. Doesn't stop you. Doesn't thank you. Just watches.</p>
                                            <p>After a moment, he speaks. <em>"You fed it. Good. Fire needs feeding. Like everything else."</em></p>
                                            <p><em>"But you understand. Fire doesn't thank you. It just burns. That's its nature. That's its honesty."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Ask what he means.", 
                                response: function(gs) {
                                    return `<p>Wat looks at you. Really looks. <em>"Fire is honest. It burns. It consumes. It dies. That's it. No lies. No promises."</em></p>
                                            <p><em>"Men lie. Men promise. Men break their word. But fire? Fire just is. It burns what you give it. Nothing more. Nothing less."</em></p>
                                            <p><em>"That's why I watch it. It reminds me. Of what's real. Of what matters."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("wits", 1, {silent:true}); }
                            },
                            { 
                                text: "Say nothing. Watch with him.", 
                                response: function(gs) {
                                    return `<p>You watch. Wat watches. The fire dies. The embers glow. Then fade.</p>
                                            <p>After a long time, Wat speaks. <em>"You watched. You understood. Most men don't. They want to talk. Want to do something."</em></p>
                                            <p><em>"But sometimes watching is enough. Sometimes silence is enough."</em></p>
                                            <p><em>"You're learning. That's good."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask if he's always been this way.",
                                response: function(gs) {
                                    return `<p>Wat is quiet. <em>"Always? No. I learned. Over time. Over years."</em></p>
                                            <p><em>"I used to talk. Used to promise. Used to lie. Like everyone else."</em></p>
                                            <p><em>"But then I learned. Learned that words don't matter. Actions do. Fire taught me that."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_fire_philosophy = true; }
                            },
                            {
                                text: "Nod and let the silence return.",
                                response: function(gs) {
                                    return `<p>You nod. Wat nods. The fire dies. The night deepens.</p>
                                            <p>Sometimes understanding doesn't need words. Sometimes watching is enough.</p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_knife_02",
                focus: "cook",
                title: "The Cook's Knife",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>The Cook sharpens his knife. Slow. Methodical. Each stroke the same.</p>
                                <p><em>"A dull knife is dangerous. It slips. Cuts wrong. Hurts more than it should."</em></p>
                                <p>He tests the edge. Nods. Puts it away.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask if you can borrow it to sharpen yours.", 
                                response: function(gs) {
                                    return `<p>The Cook looks at you. Then at your blade. <em>"You want to sharpen yours? Good. A sharp blade is a safe blade."</em></p>
                                            <p>He hands you the stone. <em>"Use this. But watch. Learn. Sharpening is a skill. Like cooking. Like fighting."</em></p>
                                            <p><em>"Take your time. Don't rush. Rushing ruins the edge. Ruins the blade."</em></p>
                                            <p>He watches you work. Guides you. Shows you the right angle. The right pressure.</p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); applyStatChange("wits", 1, {silent:true}); }
                            },
                            { 
                                text: "Comment on his technique.", 
                                response: function(gs) {
                                    return `<p>The Cook smiles. A rare thing. <em>"You noticed. Most men don't. They just see a knife. See sharpening."</em></p>
                                            <p><em>"But there's technique. There's skill. Every stroke matters. Every angle matters."</em></p>
                                            <p><em>"I learned this in the kitchen. From the master. He taught me that tools matter. That care matters."</em></p>
                                            <p><em>"A well-maintained tool is a reliable tool. A sharp knife is a safe knife."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); if (!gs.flags) gs.flags = {}; gs.flags.cook_knife_technique = true; }
                            },
                            { 
                                text: "Watch silently.", 
                                response: function(gs) {
                                    return `<p>You watch. The Cook sharpens. The stone moves. The blade glints.</p>
                                            <p>After a while, the Cook speaks. <em>"You watch. That's good. Most men don't. They look. But they don't see."</em></p>
                                            <p><em>"Watching is learning. Seeing is understanding. You're doing both."</em></p>
                                            <p>He finishes. Tests the edge. Nods. <em>"A good edge. A safe edge. That's what matters."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask about the master's teaching.",
                                response: function(gs) {
                                    return `<p>The Cook's eyes get distant. <em>"The master. He was strict. Demanding. But fair."</em></p>
                                            <p><em>"He taught me that everything has a purpose. Every tool. Every technique. Every moment."</em></p>
                                            <p><em>"A knife isn't just a knife. It's an extension of your hand. Of your will. It needs care. Needs respect."</em></p>
                                            <p><em>"I learned that. I never forgot it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_master_teaching = true; }
                            },
                            {
                                text: "Ask if you can learn to sharpen like that.",
                                response: function(gs) {
                                    return `<p>The Cook looks at you. <em>"You want to learn? Really learn?"</em></p>
                                            <p>He nods. <em>"Good. I can teach you. But it takes time. Takes practice. Takes patience."</em></p>
                                            <p><em>"Most men don't have patience. They want it fast. Want it easy. But sharpening isn't fast. Isn't easy."</em></p>
                                            <p><em>"If you're willing to learn, I'm willing to teach."</em></p>`;
                                },
                                effects: function(gs) { changeRel("cook", 2); applyStatChange("wits", 1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "wat_dreams_03",
                focus: "wat",
                title: "Wat's Dreams",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Wat wakes with a start. Hand on his knife. Eyes wild.</p>
                                <p>He sees you watching. Relaxes. Just a little.</p>
                                <p><em>"Dreams are lies your head tells you. Don't trust them."</em></p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask what he dreamed.", 
                                response: function(gs) {
                                    return `<p>Wat is quiet. For a long time. Then he speaks. <em>"I dreamed of Bannockburn. Of the mud. Of the blood. Of the screams."</em></p>
                                            <p><em>"I dreamed of my brother. Of the arrow. Of the moment he fell."</em></p>
                                            <p><em>"I dreamed of things I've done. Things I've seen. Things I can't forget."</em></p>
                                            <p><em>"Dreams are memories. Memories that won't leave. That's why they're lies. They show you what was. Not what is."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); if (!gs.flags) gs.flags = {}; gs.flags.wat_dreams = true; }
                            },
                            { 
                                text: "Say you have bad dreams too.", 
                                response: function(gs) {
                                    return `<p>Wat looks at you. Really looks. <em>"You do? What do you dream of?"</em></p>
                                            <p>You tell him. The dreams. The nightmares. The things that won't leave.</p>
                                            <p>Wat nods. <em>"We all do. Every man here. Every soldier. Dreams are the price we pay."</em></p>
                                            <p><em>"But they're just dreams. Just memories. They can't hurt you. Not really. Not if you don't let them."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); applyStatChange("stress", -1, {silent:true}); }
                            },
                            { 
                                text: "Say nothing. Let him settle.", 
                                response: function(gs) {
                                    return `<p>You say nothing. Just watch. Wait. Let Wat settle.</p>
                                            <p>After a while, he speaks. <em>"Thank you. For not asking. For not prying."</em></p>
                                            <p><em>"Most men want to know. Want to hear the stories. But you just... let it be."</em></p>
                                            <p><em>"That's rare. That's good."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask if the dreams ever stop.",
                                response: function(gs) {
                                    return `<p>Wat shakes his head. <em>"Stop? No. They don't stop. They just... change. Get easier. Or harder. Depends on the day."</em></p>
                                            <p><em>"But they're always there. Always waiting. In the dark. In the quiet."</em></p>
                                            <p><em>"You learn to live with them. Learn to ignore them. But they never really go away."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", 1, {silent:true}); }
                            },
                            {
                                text: "Offer to keep watch so he can rest.",
                                response: function(gs) {
                                    return `<p>Wat looks surprised. <em>"You'd do that? Keep watch so I can sleep?"</em></p>
                                            <p>He thinks. Nods. <em>"Thank you. That's... that's kind. Unnecessary. But kind."</em></p>
                                            <p><em>"I'll take you up on that. But just this once. I don't need charity."</em></p>`;
                                },
                                effects: function(gs) { changeRel("wat", 2); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "cook_memory_03",
                focus: "cook",
                title: "The Old Recipe",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The Cook talks about a recipe from home. A broth. Barley. A little herb.</p>
                        <p><em>"People think food is just fuel. It is not. It is memory you can swallow."</em></p>
                        <p>Wat rolls his eyes but doesn't interrupt.</p>
                    `;
                },
                choices: [
                    { text: "Ask what home tastes like.", effects: function(gs) { changeRel("cook", 2); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Say you miss home cooking.", effects: function(gs) { changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Change the subject.", effects: function(gs) { changeRel("cook", -1); applyStatChange("stress", 1, {silent:true}); } },
                    { text: "\"Fuck your memory food speech, Cook. It's just food.\"", effects: function(gs) { changeRel("cook", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); } }
                ]
            },
            {
                id: "both_rain_04",
                focus: "both",
                title: "The Rain",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Rain comes. Not hard. Just steady. The kind that soaks through.</p>
                        <p>Wat curses. The Cook moves the pot to keep it dry. Practical.</p>
                        <p>You huddle under what cover you can find.</p>
                    `;
                },
                choices: [
                    { text: "Help The Cook move things.", effects: function(gs) { changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Share your cover with Wat.", effects: function(gs) { changeRel("wat", 1); } },
                    { text: "Just endure it.", effects: function(gs) { applyStatChange("endurance", 1, {silent:true}); applyStatChange("stress", 1, {silent:true}); } }
                ]
            },
            {
                id: "wat_weapon_05",
                focus: "wat",
                title: "Wat's Blade",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Wat shows you his blade. Old. Notched. But clean.</p>
                        <p><em>"This has killed more men than I can count. Some deserved it. Some didn't. The blade don't care."</em></p>
                        <p>He sheathes it. Like closing a book.</p>
                    `;
                },
                choices: [
                    { text: "Ask how long he's had it.", effects: function(gs) { changeRel("wat", 1); if (!gs.flags) gs.flags = {}; gs.flags.wat_weapon_story = true; } },
                    { text: "Say it's a good blade.", effects: function(gs) { changeRel("wat", 1); } },
                    { text: "Say nothing. Respect the moment.", effects: function(gs) { applyStatChange("stress", -1, {silent:true}); } },
                    { text: "\"Fuck your blade speech, Wat. It's just a sword.\"", effects: function(gs) { changeRel("wat", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); } }
                ]
            },
            {
                id: "cook_measure_05",
                focus: "cook",
                title: "The Measure",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The Cook measures water. Counts. Measures again.</p>
                        <p><em>"Too much water and it's thin. Too little and it burns. The measure matters."</em></p>
                        <p>He looks at you. <em>"Everything has a measure. Even war."</em></p>
                    `;
                },
                choices: [
                    { text: "Ask what he means.", effects: function(gs) { changeRel("cook", 1); applyStatChange("wits", 1, {silent:true}); } },
                    { text: "Nod. You understand.", effects: function(gs) { changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Say war has no measure.", effects: function(gs) { changeRel("cook", -1); changeRel("wat", 1); } },
                    { text: "\"This measure bullshit again? Fuck off, Cook.\"", effects: function(gs) { changeRel("cook", -2); changeRel("wat", 1); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); } }
                ]
            },
            {
                id: "wat_fear_06",
                focus: "wat",
                title: "Wat on Fear",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Wat talks about fear. Not his. Yours.</p>
                        <p><em>"Fear keeps you alive. Too much and you freeze. Too little and you die stupid."</em></p>
                        <p>He spits. <em>"Find the middle. That's where you live."</em></p>
                    `;
                },
                choices: [
                    { text: "Ask how he found his middle.", effects: function(gs) { changeRel("wat", 1); applyStatChange("wits", 1, {silent:true}); } },
                    { text: "Say you're not afraid.", effects: function(gs) { changeRel("wat", -1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Admit you're afraid sometimes.", effects: function(gs) { changeRel("wat", 1); applyStatChange("stress", -1, {silent:true}); } },
                    { text: "\"Fuck your fear speech, Wat. I'm fine.\"", effects: function(gs) { changeRel("wat", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 2, {silent:true}); } }
                ]
            },
            {
                id: "cook_quiet_06",
                focus: "cook",
                title: "The Quiet",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The Cook works in silence. Wat is loud. The Cook is not.</p>
                        <p><em>"Noise doesn't help the cooking. Noise doesn't help the thinking."</em></p>
                        <p>He stirs. Watches. Waits.</p>
                    `;
                },
                choices: [
                    { text: "Ask if he likes the quiet.", effects: function(gs) { changeRel("cook", 1); } },
                    { text: "Say you prefer quiet too.", effects: function(gs) { changeRel("cook", 1); applyStatChange("stress", -1, {silent:true}); } },
                    { text: "Say nothing. Match his silence.", effects: function(gs) { changeRel("cook", 0); applyStatChange("stress", -1, {silent:true}); } },
                    { text: "\"Fuck your quiet speech, Cook. Sometimes noise is good.\"", effects: function(gs) { changeRel("cook", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); } }
                ]
            },
            {
                id: "both_death_07",
                focus: "both",
                title: "The Dead Man",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Someone died today. Not in battle. Sickness. The kind that takes men slow.</p>
                        <p>Wat says nothing. The Cook says: <em>"He is done. We are not."</em></p>
                        <p>The fire burns. The night passes.</p>
                    `;
                },
                choices: [
                    { text: "Say a prayer for him.", effects: function(gs) { applyStatChange("morale", 1, {silent:true}); changeRel("cook", 0); changeRel("wat", 0); } },
                    { text: "Ask if you knew him.", effects: function(gs) { changeRel("cook", 1); applyStatChange("stress", 1, {silent:true}); } },
                    { text: "Say nothing. Just sit.", effects: function(gs) { applyStatChange("stress", -1, {silent:true}); } }
                ]
            },
            {
                id: "wat_luck_08",
                focus: "wat",
                title: "Wat on Luck",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Wat talks about luck. Spits.</p>
                        <p><em>"Luck is for fools. Skill is for men. You want to live? Get skill."</em></p>
                        <p>He looks at you. <em>"Luck runs out. Skill don't."</em></p>
                    `;
                },
                choices: [
                    { text: "Agree. Skill matters more.", effects: function(gs) { changeRel("wat", 1); applyStatChange("wits", 1, {silent:true}); } },
                    { text: "Say luck has saved you before.", effects: function(gs) { changeRel("wat", -1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Ask how to get more skill.", effects: function(gs) { changeRel("wat", 1); applyStatChange("wits", 1, {silent:true}); } }
                ]
            },
            {
                id: "cook_time_08",
                focus: "cook",
                title: "Time and Patience",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The Cook talks about time. How things take the time they take.</p>
                        <p><em>"Rush the bread and it's raw inside. Rush the stew and it tastes like nothing. Rush the war and men die for no reason."</em></p>
                        <p>Wat grunts. Doesn't disagree.</p>
                    `;
                },
                choices: [
                    { text: "Ask if war can be rushed.", effects: function(gs) { changeRel("cook", 1); applyStatChange("wits", 1, {silent:true}); } },
                    { text: "Say sometimes you have to rush.", effects: function(gs) { changeRel("cook", -1); changeRel("wat", 1); } },
                    { text: "\"Fuck your patience speech, Cook. Sometimes you need to move fast.\"", effects: function(gs) { changeRel("cook", -2); changeRel("wat", 1); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Nod. You understand.", effects: function(gs) { changeRel("cook", 1); applyStatChange("stress", -1, {silent:true}); } }
                ]
            },
            {
                id: "both_fire_09",
                focus: "both",
                title: "Tending the Fire",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The fire needs tending. Wat won't do it. The Cook does.</p>
                        <p>Wat says: <em>"Fire's your job, Cook."</em></p>
                        <p>The Cook says: <em>"Everything is my job. That is why you are still alive."</em></p>
                        <p>Wat has no answer to that.</p>
                    `;
                },
                choices: [
                    { text: "Help The Cook tend the fire.", effects: function(gs) { changeRel("cook", 1); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Tell Wat to help.", effects: function(gs) { changeRel("wat", -1); changeRel("cook", 1); } },
                    { text: "Say nothing. Watch them work it out.", effects: function(gs) { applyStatChange("stress", -1, {silent:true}); } }
                ]
            },
            {
                id: "wat_truth_10",
                focus: "wat",
                title: "A Hard Truth",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>Wat tells you a truth. Hard. Uncomfortable.</p>
                        <p><em>"Most men die because they believe lies. About honor. About glory. About what matters."</em></p>
                        <p>He looks at you. <em>"Don't be one of them."</em></p>
                    `;
                },
                choices: [
                    { text: "Ask what the truth is.", effects: function(gs) { changeRel("wat", 1); applyStatChange("wits", 1, {silent:true}); } },
                    { text: "Say you already know the truth.", effects: function(gs) { changeRel("wat", 0); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Say nothing. Think on it.", effects: function(gs) { applyStatChange("wits", 1, {silent:true}); applyStatChange("stress", 1, {silent:true}); } },
                    { text: "\"Fuck your truth speech, Wat. I'll figure it out myself.\"", effects: function(gs) { changeRel("wat", -2); applyStatChange("stress", 1, {silent:true}); applyStatChange("morale", 2, {silent:true}); } }
                ]
            },
            {
                id: "cook_hands_10",
                focus: "cook",
                title: "The Cook's Hands",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    return `
                        <p>The Cook shows you his hands. Scars. Burns. Old wounds.</p>
                        <p><em>"These hands have done many things. Cooked. Mended. Held. Killed."</em></p>
                        <p>He puts them back to work. Like it's nothing.</p>
                    `;
                },
                choices: [
                    { text: "Ask when he killed.", effects: function(gs) { changeRel("cook", 1); if (!gs.flags) gs.flags = {}; gs.flags.cook_killed = true; } },
                    { text: "Say his hands have done good work.", effects: function(gs) { changeRel("cook", 2); applyStatChange("morale", 1, {silent:true}); } },
                    { text: "Say nothing. Respect his past.", effects: function(gs) { changeRel("cook", 0); applyStatChange("stress", -1, {silent:true}); } }
                ]
            },
            {
                id: "oana_carving_01",
                focus: "oana",
                title: "Oana Carves",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Oana sits by the fire, a Breton girl with dark hair and quick hands. She carves a wooden bracelet, the knife moving in practiced strokes.</p>
                                <p><em>"They sell better than you'd think,"</em> she says without looking up. <em>"Men buy them for sweethearts back home. Or for themselves. Luck charms."</em></p>
                                <p>The wood curls away from her blade. She works like she's done this a thousand times. Maybe she has.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask how she learned to carve.", 
                                response: function(gs) {
                                    return `<p>Oana doesn't stop carving. <em>"My father. He was a woodworker. Made furniture. Made tools. Made things that lasted."</em></p>
                                            <p><em>"He taught me. Said a woman should have a trade. Something to fall back on. Something that couldn't be taken away."</em></p>
                                            <p><em>"He was right. When the war came. When everything else was taken. I still had this. The skill. The knowledge."</em></p>
                                            <p>She looks up. Just for a moment. <em>"It's kept me alive. This carving. This trade."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); if (!gs.flags) gs.flags = {}; gs.flags.oana_carving_story = true; }
                            },
                            { 
                                text: "Offer to buy one.", 
                                response: function(gs) {
                                    return `<p>Oana looks up. Smiles. A small smile. <em>"You want one? Good. They bring luck. Or so men say."</em></p>
                                            <p>She finishes the bracelet. Holds it out. <em>"Here. This one's yours. May it bring you home safe."</em></p>
                                            <p>She takes your coin. Counts it. Nods. <em>"Fair price. Thank you."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("wealth", -12, {silent:true}); applyStatChange("morale", 1, {silent:true}); } // 1 shilling = 12 pence
                            },
                            { 
                                text: "Watch in silence.", 
                                response: function(gs) {
                                    return `<p>You watch. Oana carves. The fire crackles. The silence is comfortable. Not awkward.</p>
                                            <p>After a while, she speaks. <em>"You're quiet. I like that. Most men talk. Too much. About things that don't matter."</em></p>
                                            <p><em>"But you watch. You listen. That's rare. That's good."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask about her father.",
                                response: function(gs) {
                                    return `<p>Oana's hands slow. <em>"My father. He's gone. The war took him. Or the plague. I don't know which."</em></p>
                                            <p><em>"But he left me this. The skill. The knowledge. The ability to make something from nothing."</em></p>
                                            <p><em>"That's more than most people have. More than most people get."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); if (!gs.flags) gs.flags = {}; gs.flags.oana_father = true; }
                            },
                            {
                                text: "Ask if the bracelets really bring luck.",
                                response: function(gs) {
                                    return `<p>Oana laughs. A real laugh. <em>"Do they bring luck? I don't know. But men believe they do. That's what matters."</em></p>
                                            <p><em>"Belief is powerful. If a man thinks a bracelet will keep him safe, maybe it will. Maybe belief is enough."</em></p>
                                            <p><em>"Or maybe it's just wood. Just carving. Just something to hold onto when everything else is gone."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("morale", 1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "oana_breton_02",
                focus: "oana",
                title: "Breton Words",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Oana hums something under her breath. The words are Breton. You don't understand them, but the melody is old. Sad.</p>
                                <p>She catches you listening. <em>"A lullaby,"</em> she says. <em>"My mother sang it. Her mother before her. Now I sing it to myself when the nights are long."</em></p>
                                <p>She goes back to carving. The knife doesn't stop. The song doesn't stop. Both keep her company.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask what the words mean.", 
                                response: function(gs) {
                                    return `<p>Oana stops carving. Looks at you. <em>"The words? They're about home. About family. About things that are gone."</em></p>
                                            <p><em>"My mother sang it to me. When I was small. When I was safe. When home was still home."</em></p>
                                            <p><em>"Now I sing it to remember. To keep the memory alive. Even if the home is gone. Even if the family is gone."</em></p>
                                            <p>She goes back to carving. The song continues. Quieter now.</p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); if (!gs.flags) gs.flags = {}; gs.flags.oana_breton_story = true; }
                            },
                            { 
                                text: "Say it sounds beautiful.", 
                                response: function(gs) {
                                    return `<p>Oana smiles. A real smile. <em>"Thank you. Most men don't notice. Don't care. But you do."</em></p>
                                            <p><em>"It is beautiful. Even if it's sad. Even if it's about loss. There's beauty in memory. In remembering."</em></p>
                                            <p><em>"My mother had a beautiful voice. Like honey. Like home. I try to remember that. When I sing."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 3); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Listen without speaking.", 
                                response: function(gs) {
                                    return `<p>You listen. Oana sings. The words are foreign. But the feeling isn't. The sadness. The memory. That's universal.</p>
                                            <p>After a while, she stops. Looks at you. <em>"You listened. Really listened. Most men don't. They hear. But they don't listen."</em></p>
                                            <p><em>"Thank you. For listening. For hearing."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask about her mother.",
                                response: function(gs) {
                                    return `<p>Oana is quiet for a long time. <em>"My mother. She was strong. Stronger than anyone I've ever known."</em></p>
                                            <p><em>"She raised three children. Alone. After my father died. She worked. She fought. She survived."</em></p>
                                            <p><em>"Then the war came. The plague. I don't know which took her. But she's gone. Like everything else."</em></p>
                                            <p><em>"But the song remains. The memory remains. That's something."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); if (!gs.flags) gs.flags = {}; gs.flags.oana_mother = true; }
                            },
                            {
                                text: "Ask her to sing it again.",
                                response: function(gs) {
                                    return `<p>Oana looks surprised. Then she smiles. <em>"You want me to sing? Really?"</em></p>
                                            <p>She sets down the knife. Closes her eyes. Sings. The words are still foreign. But the melody is clear. Beautiful. Haunting.</p>
                                            <p>When she finishes, she opens her eyes. <em>"Thank you. For asking. For wanting to hear it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("morale", 2, {silent:true}); applyStatChange("stress", -1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "oana_trade_03",
                focus: "oana",
                title: "The Trade",
                minYear: 1337,
                maxYear: null,
                text: function(gs) {
                    const hasWealth = (gs.stats && gs.stats.wealth && gs.stats.wealth > 0) || gs.wealth > 0;
                    if (hasWealth) {
                        return `
                            <p>Oana looks up from her carving. Her eyes are sharp. Assessing.</p>
                            <p><em>"I have other things to sell,"</em> she says. <em>"Not just bracelets. If you have coin."</em></p>
                            <p>She doesn't say what. She doesn't need to. You know what she means. The camp follows its own rules. Its own economy.</p>
                        `;
                    } else {
                        return `
                            <p>Oana looks at you. Really looks. Then she shakes her head.</p>
                            <p><em>"You're broke,"</em> she says. Not unkind. Just fact. <em>"I can't help you. Not that way. But I can carve you something. For free. This once."</em></p>
                            <p>She picks up a new piece of wood. Starts working. The offer stands.</p>
                        `;
                    }
                },
                choices: function(gs) {
                    const hasWealth = (gs.stats && gs.stats.wealth && gs.stats.wealth > 0) || gs.wealth > 0;
                    if (hasWealth) {
                        return [
                            { text: "Pay for her company.", effects: function(gs) { changeRel("oana", 1); applyStatChange("wealth", -2, {silent:true}); applyStatChange("morale", 2, {silent:true}); applyStatChange("stress", -1, {silent:true}); }, nextScene: "start" },
                            { text: "Just buy a bracelet.", effects: function(gs) { changeRel("oana", 0); applyStatChange("wealth", -1, {silent:true}); applyStatChange("morale", 1, {silent:true}); }, nextScene: "start" },
                            { text: "Decline politely.", effects: function(gs) { changeRel("oana", 0); }, nextScene: "start" }
                        ];
                    } else {
                        return [
                            { text: "Accept the free bracelet.", effects: function(gs) { changeRel("oana", 2); applyStatChange("morale", 1, {silent:true}); }, nextScene: "start" },
                            { text: "Refuse. You don't need charity.", effects: function(gs) { changeRel("oana", -1); applyStatChange("stress", 1, {silent:true}); }, nextScene: "start" },
                            { text: "Ask why she's being kind.", effects: function(gs) { changeRel("oana", 1); if (!gs.flags) gs.flags = {}; gs.flags.oana_kindness = true; }, nextScene: "start" }
                        ];
                    }
                }
            },
            {
                id: "oana_wounds_04",
                focus: "oana",
                title: "Oana's Hands",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Oana shows you her hands. Calluses from the knife. Small scars. Old cuts that healed wrong.</p>
                                <p><em>"Every bracelet costs something,"</em> she says. <em>"Not just the wood. The time. The cuts. The nights I could have been sleeping."</em></p>
                                <p>She flexes her fingers. The joints are stiff. From carving. From cold. From work that never ends.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask if it's worth it.", 
                                response: function(gs) {
                                    return `<p>Oana looks at her hands. Really looks. <em>"Worth it? I don't know. Sometimes I think yes. Sometimes I think no."</em></p>
                                            <p><em>"The hands hurt. The fingers ache. The scars remind me of every mistake. Every cut. Every night I spent carving instead of sleeping."</em></p>
                                            <p><em>"But it's kept me alive. The carving. The selling. The coin. That's worth something. That's worth everything."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); if (!gs.flags) gs.flags = {}; gs.flags.oana_worth_it = true; }
                            },
                            { 
                                text: "Say her work is beautiful.", 
                                response: function(gs) {
                                    return `<p>Oana looks surprised. Then she smiles. A real smile. <em>"Beautiful? You think so?"</em></p>
                                            <p>She holds up a bracelet. Turns it in the firelight. <em>"I try. I really try. To make them beautiful. To make them mean something."</em></p>
                                            <p><em>"But most men don't see that. They just see a trinket. A thing to buy. Not the work. Not the skill. Not the... the beauty."</em></p>
                                            <p><em>"Thank you. For seeing it. For saying it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 3); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Offer to help with the carving.", 
                                response: function(gs) {
                                    return `<p>Oana looks at you. Really looks. <em>"You'd help? Really?"</em></p>
                                            <p>She considers. <em>"I appreciate the offer. But carving... it's not just skill. It's... it's personal. It's mine."</em></p>
                                            <p><em>"I've been doing this for years. Alone. It's how I survive. How I cope. I don't know if I could share that."</em></p>
                                            <p><em>"But thank you. For offering. That means something."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask if her hands will ever heal.",
                                response: function(gs) {
                                    return `<p>Oana flexes her fingers. <em>"Heal? Some of them will. Some won't. The old cuts? They're scars now. They'll always be scars."</em></p>
                                            <p><em>"The stiffness? That might get better. If I stop carving. If I rest. But I can't stop. I can't rest."</em></p>
                                            <p><em>"So the hands will hurt. The fingers will ache. That's the price. That's what it costs."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", 1, {silent:true}); }
                            },
                            {
                                text: "Ask to see one of her bracelets up close.",
                                response: function(gs) {
                                    return `<p>Oana picks up a bracelet. Holds it out. <em>"Here. Look at it. Really look."</em></p>
                                            <p>You examine it. The carving is intricate. Detailed. Beautiful. <em>"This is amazing. The detail. The skill."</em></p>
                                            <p>Oana smiles. <em>"Thank you. I put everything into each one. Every cut. Every stroke. It's all there. In the wood."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            },
            {
                id: "oana_camp_life_05",
                focus: "oana",
                title: "Camp Life",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Oana sits by the fire, carving. Around her, the camp moves. Men. Women. The business of survival.</p>
                                <p><em>"You think this is hard?"</em> she asks. <em>"Try being a woman in a war camp. Try being Breton in an English army."</em></p>
                                <p>She doesn't look up. The knife keeps moving. Like it's the only thing that makes sense.</p>
                            `;
                        },
                        choices: [
                            {
                                text: "Ask what she means.",
                                response: function(gs) {
                                    return `<p>Oana pauses. The knife stops. Just for a moment.</p>
                                           <p><em>"I mean I'm always a foreigner here. Always an outsider. Even when I'm useful. Even when I'm needed."</em></p>
                                           <p>She goes back to carving. The subject is closed.</p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); if (!gs.flags) gs.flags = {}; gs.flags.oana_outsider = true; }
                            },
                            {
                                text: "Say you understand.",
                                response: function(gs) {
                                    return `<p>Oana looks at you. Really looks. Like she's measuring your words.</p>
                                           <p><em>"Do you?"</em> she says. <em>"Maybe. Maybe not. But it's nice that you say it."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            {
                                text: "Change the subject to her bracelets.",
                                response: function(gs) {
                                    return `<p>Oana smiles. A real smile. The first you've seen.</p>
                                           <p><em>"Now that's a subject I can talk about,"</em> she says. <em>"Each one is different. Each one tells a story. Even if no one knows what the story is."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", -1, {silent:true}); }
                            }
                        ]
                    }
                ]
            },
            {
                id: "oana_memory_06",
                focus: "oana",
                title: "A Memory",
                minYear: 1337,
                maxYear: null,
                stages: [
                    {
                        text: function(gs) {
                            return `
                                <p>Oana carves a bracelet. This one is different. More careful. More deliberate.</p>
                                <p><em>"This one's for my sister,"</em> she says. <em>"Or it would be. If I could get it to her. If I knew where she was. If she's still alive."</em></p>
                                <p>She holds it up to the firelight. The wood glows. The carving catches the light. It's beautiful. And it will never be delivered.</p>
                            `;
                        },
                        choices: [
                            { 
                                text: "Ask about her sister.", 
                                response: function(gs) {
                                    return `<p>Oana's hands slow. Stop. <em>"My sister. Her name was Elen. She was younger. Prettier. Smarter."</em></p>
                                            <p><em>"When the war came, we were separated. I went one way. She went another. I don't know where. I don't know if she's alive."</em></p>
                                            <p><em>"I carve these bracelets. For her. Even though I'll never give them to her. Even though she'll never see them."</em></p>
                                            <p><em>"It's stupid. I know it's stupid. But it's all I have. All I can do."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); if (!gs.flags) gs.flags = {}; gs.flags.oana_sister_story = true; applyStatChange("stress", 1, {silent:true}); }
                            },
                            { 
                                text: "Say you hope she finds her.", 
                                response: function(gs) {
                                    return `<p>Oana looks at you. Really looks. <em>"You hope? Really?"</em></p>
                                            <p>She smiles. A sad smile. <em>"I hope too. Every day. Every night. I hope."</em></p>
                                            <p><em>"But hope doesn't find people. Hope doesn't bring them back. Hope is just... hope."</em></p>
                                            <p><em>"Still. It's nice to hear. Nice to know someone else hopes. Even if it's just words."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("morale", 1, {silent:true}); }
                            },
                            { 
                                text: "Offer to help deliver it someday.", 
                                response: function(gs) {
                                    return `<p>Oana looks surprised. <em>"You'd do that? Really? Help me find her? Deliver it?"</em></p>
                                            <p>She considers. <em>"That's... that's kind. More than kind. That's... that's something I never expected."</em></p>
                                            <p><em>"I don't know if it's possible. I don't know if she's alive. But the offer... the offer means something."</em></p>
                                            <p><em>"Thank you. For offering. For caring. That's rare. That's good."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 2); applyStatChange("stress", 1, {silent:true}); }
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Ask what Elen was like.",
                                response: function(gs) {
                                    return `<p>Oana's eyes get distant. <em>"Elen. She was... she was everything. Bright. Happy. Full of life."</em></p>
                                            <p><em>"She could make anyone laugh. Could make anyone smile. Even in the worst times. Even when everything was falling apart."</em></p>
                                            <p><em>"She was my light. My hope. My reason to keep going. And then she was gone."</em></p>
                                            <p><em>"I miss her. Every day. Every night. I miss her."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); applyStatChange("stress", 1, {silent:true}); }
                            },
                            {
                                text: "Ask if there's any way to find her.",
                                response: function(gs) {
                                    return `<p>Oana shakes her head. <em>"Find her? I don't know. The war scattered everyone. Families. Friends. Everyone."</em></p>
                                            <p><em>"I've asked. I've searched. I've looked. But there's nothing. No trace. No sign."</em></p>
                                            <p><em>"Maybe she's dead. Maybe she's alive. I don't know. I'll never know."</em></p>
                                            <p><em>"But I keep carving. Keep hoping. That's all I can do."</em></p>`;
                                },
                                effects: function(gs) { changeRel("oana", 1); if (!gs.flags) gs.flags = {}; gs.flags.oana_search_sister = true; }
                            },
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    },
                    {
                        text: function(gs) {
                            return gs.campfire.currentResponse || '';
                        },
                        choices: [
                            {
                                text: "Turn in for the night.",
                                effects: function(gs) { applyStatChange("stress", -1, {silent:true}); },
                                isExit: true
                            }
                        ]
                    }
                ]
            }
        ];
        
        // ===== RANDOM ENCOUNTER SYSTEM =====
        // Small, silly encounters to add texture and breathing room
        
        const RANDOM_ENCOUNTERS = [
            'random_drunken_song',
            'random_lost_boot',
            'random_gambling_debt',
            'random_campfire_tale',
            'random_broken_sword',
            'random_stolen_socks',
            'random_bad_stew',
            'random_weather_complaint',
            'random_insult_battle',
            'random_dice_game',
            'random_cooking_disaster',
            'random_sleepwalking',
            'random_animal_encounter'
        ];
        
        // Guardrails: prevent random encounters in inappropriate contexts
        function shouldInsertRandomEncounter(nextSceneKey) {
            // Initialize random encounter state if needed
            if (!gameState.randomEncounter) {
                gameState.randomEncounter = {
                    cooldown: 0,
                    lastInsertedAt: -1
                };
            }
            
            const re = gameState.randomEncounter;
            
            // Cooldown: don't insert if recently inserted
            if (re.cooldown > 0) {
                re.cooldown--;
                return false;
            }
            
            // Don't insert if player is wounded/stressed
            const hasWound = gameState.conditions.some(c => c.name === 'Wounded' || c.name === 'Seriously Wounded');
            if (hasWound) return false;
            if (gameState.stats.stress >= 7) return false;
            
            // Exclude major scenes
            const excludedPrefixes = [
                'character_creation',
                'death_',
                'between_years_',
                'battle_',
                'crecy_',
                'calais_',
                'chevauch√©e_',
                'campfire_',
                'indenture_',
                'marriage_',
                'forced_retirement_'
            ];
            
            if (excludedPrefixes.some(prefix => nextSceneKey.startsWith(prefix))) {
                return false;
            }
            
            // Exclude resolution scenes
            if (nextSceneKey.endsWith('_resolve')) {
                return false;
            }
            
            // Exclude scenes that require resolution (combat, etc.)
            // Note: scenes object may not be defined yet, so check safely
            if (typeof scenes !== 'undefined' && scenes[nextSceneKey]) {
                const nextScene = scenes[nextSceneKey];
                if (nextScene && nextScene.choices) {
                    const choices = typeof nextScene.choices === 'function' 
                        ? nextScene.choices(gameState) 
                        : nextScene.choices;
                    if (Array.isArray(choices) && choices.some(c => c.requiresResolution)) {
                        return false;
                    }
                }
            }
            
            // Random chance: 15% base chance
            const roll = Math.random() * 100;
            if (roll < 15) {
                return true;
            }
            
            return false;
        }
        
        // Insert random encounter if conditions are met
        function maybeInsertRandomEncounter(nextSceneKey) {
            if (!shouldInsertRandomEncounter(nextSceneKey)) {
                return nextSceneKey;
            }
            
            // Pick random encounter
            const encounterId = RANDOM_ENCOUNTERS[Math.floor(Math.random() * RANDOM_ENCOUNTERS.length)];
            
            // Set return scene and update cooldown
            if (!gameState.randomEncounter) {
                gameState.randomEncounter = { cooldown: 0, lastInsertedAt: -1 };
            }
            gameState.randomEncounter.returnScene = nextSceneKey;
            gameState.randomEncounter.cooldown = 3; // 3 scene cooldown
            gameState.randomEncounter.lastInsertedAt = gameState.scenesVisited ? gameState.scenesVisited.length : 0;
            
            return encounterId;
        }
        
        const scenes = {
            character_creation: {
                title: "Character Creation",
                year: 1337,
                age: 18,
                location: "England",
                artwork: "artwork/character-creation.jpg", // Medieval town square scene
                artworkCaption: "Forge your path in the Hundred Years' War",
                text: function() {
                    // Ensure gameState.stats exists (safety check)
                    if (!gameState.stats) {
                        console.error("gameState.stats is not defined in character creation!");
                        return '<div style="padding: 20px; color: red;"><p>Error: Game state not initialized. Please refresh the page.</p></div>';
                    }
                    
                    // Initialize step if not set
                    if (!gameState.characterCreationStep) {
                        gameState.characterCreationStep = 1;
                    }
                    
                    const currentStep = gameState.characterCreationStep || 1;
                    const nameDisplay = gameState.characterName || "William Thatcher";
                    const currentAgeRange = gameState.ageRange || null;
                    const currentCulture = gameState.culture || "";
                    
                    // Route to appropriate step renderer
                    let stepContent = '';
                    switch(currentStep) {
                        case 1:
                            stepContent = renderCharacterCreationStep1(nameDisplay, currentCulture);
                            break;
                        case 2:
                            stepContent = renderCharacterCreationStep2(currentAgeRange);
                            break;
                        case 3:
                            stepContent = renderCharacterCreationStep3();
                            break;
                        case 4:
                            stepContent = renderCharacterCreationStep4();
                            break;
                        case 5:
                            stepContent = renderCharacterCreationStep5();
                            break;
                        case 6:
                            stepContent = renderCharacterCreationStep6();
                            break;
                        default:
                            stepContent = renderCharacterCreationStep1(nameDisplay, currentCulture);
                    }
                    
                    // Add step navigation
                    const navigation = renderStepNavigation(currentStep, 6);
                    
                    return '<div style="max-width: 800px; margin: 0 auto;">' +
                        '<h2 style="color: #f4d03f; text-align: center; margin-bottom: 30px;">Create Your Character</h2>' +
                        stepContent +
                        navigation +
                        '</div>';
                },
                choices: [
                    {
                        text: "Begin Your Journey",
                        effects: {},
                        nextScene: "start",
                        requiresOrigin: true,
                        requiresPatron: true,
                        onChoose: function() {
                            // Only allow if on final step
                            if (gameState.characterCreationStep !== 6) {
                                showNotification('Character Creation', 'Please complete all steps before beginning your journey.');
                                return false;
                            }
                            
                            // Validate required fields
                            if (!gameState.characterName || gameState.characterName.trim() === '') {
                                gameState.characterName = "William Thatcher";
                            }
                            if (!gameState.culture) {
                                showNotification('Character Creation', 'Please select your region.');
                                return false;
                            }
                            if (!gameState.ageRange) {
                                showNotification('Character Creation', 'Please select your age range.');
                                return false;
                            }
                            if (!gameState.origin) {
                                showNotification('Character Creation', 'Please select your origin.');
                                return false;
                            }
                            
                            // Validate priorities
                            const priorityValidation = validatePrioritiesCompleteAndUnique();
                            if (!priorityValidation.ok) {
                                showNotification('Character Creation', priorityValidation.message);
                                return false;
                            }
                            
                            // Resolve final starting kit tier and grant kit if not already granted
                            if (!gameState.startingKitGranted) {
                                // Ensure all stats are recalculated (includes kit tier resolution)
                                recalculateCharacterCreationDerivedStats();
                                const origin = gameState.origin || 'rural_peasant';
                                grantStartingKit(origin, gameState.startingKitTier);
                            }
                        }
                    }
                ]
            },
            quick_start_review: {
                title: "Quick Start Character",
                year: 1337,
                age: function() { return gameState.age || 27; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    const region = gameState.culture || "Unknown";
                    const ageRange = gameState.ageRange || 'prime';
                    const origin = gameState.origin || 'rural_peasant';
                    const patron = gameState.patron || 'lord_david';
                    const preset = gameState.quickStartPreset || 'brawny';
                    
                    const ageLabels = {
                        'youth': 'Youth (16-19)',
                        'young_adult': 'Young Adult (20-24)',
                        'prime': 'Prime (25-30)',
                        'veteran': 'Veteran (31-35)',
                        'old_hand': 'Old Hand (36-40)'
                    };
                    
                    const originLabels = {
                        'rural_peasant': 'Rural Peasant',
                        'manor_retainer': 'Manor Retainer',
                        'craftsman_apprentice': "Craftsman's Apprentice",
                        'squire': 'Squire to a Knight',
                        'minor_noble': 'Minor Noble or Garrison\'s Son/Daughter'
                    };
                    
                    const patronLabels = {
                        'james_olooney': 'Sir James "The Reaver" de Looney',
                        'lord_david': 'Sir David de Montfort',
                        'duke_caley': 'Baron Caley of Tournai',
                        'count_charles': 'Count Charles "The Grim" of Suffolk',
                        'ashkhan': 'Ashkhan of the Mamluk Guard'
                    };
                    
                    const presetLabels = {
                        'brawny': 'üí™ Brawny Footman',
                        'cunning': 'üß† Cunning Scout',
                        'court': 'üëë Court-Leaned',
                        'lucky': 'üé≤ Lucky Bastard'
                    };
                    
                    const playstyleDescriptions = {
                        'brawny': 'A physical powerhouse focused on strength and endurance. You excel in direct combat and can take punishment. Best for players who want to charge into battle and rely on raw power.',
                        'cunning': 'A quick and intelligent fighter. You excel at tactics, agility, and outmaneuvering enemies. Best for players who prefer clever solutions and avoiding direct confrontation.',
                        'court': 'A charismatic leader with political connections. You excel at social situations, leadership, and navigating noble circles. Best for players who want to influence others and build reputation.',
                        'lucky': 'A well-rounded character with exceptional fortune. You have balanced stats but superior luck and wealth. Best for players who want flexibility and to rely on good fortune.'
                    };
                    
                    const patronDescriptions = {
                        'james_olooney': 'A wildcard free company known for murder and pillage. High risk, high reward. Expect brutal combat and rich plunder, but little regard for your safety.',
                        'lord_david': 'A fair and even-handed commander who values his men\'s lives. Lower risk, steady rewards. Expect protection and care, but less opportunity for glory.',
                        'duke_caley': 'A powerful lord who is indifferent to your wellbeing but offers great opportunities for plunder and advancement. High reward potential, but you\'re expendable.',
                        'count_charles': 'A grizzled battlefield leader who has taken to drinking heavily. Unpredictable leadership, but strong in combat. Expect both chaos and moments of brilliance.',
                        'ashkhan': 'A respected mercenary from the Levant with tactical expertise. Professional and disciplined. Expect well-planned operations and fair treatment, but strict standards.'
                    };
                    
                    const stats = gameState.stats || {};
                    
                    return `
                        <div style="max-width: 800px; margin: 0 auto;">
                            <h2 style="color: #f4d03f; text-align: center; margin-bottom: 30px;">Your Quick Start Character</h2>
                            
                            <div style="padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="color: #f4d03f; margin-bottom: 15px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Character Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div><strong style="color: #d4af37;">Name:</strong> <span style="color: #f4d03f;">${escapeHTML(name)}</span></div>
                                    <div><strong style="color: #d4af37;">Region:</strong> <span style="color: #f4d03f;">${region}</span></div>
                                    <div><strong style="color: #d4af37;">Age:</strong> <span style="color: #f4d03f;">${ageLabels[ageRange]}</span></div>
                                    <div><strong style="color: #d4af37;">Origin:</strong> <span style="color: #f4d03f;">${originLabels[origin]}</span></div>
                                    <div><strong style="color: #d4af37;">Patron:</strong> <span style="color: #f4d03f;">${patronLabels[patron]}</span></div>
                                    <div><strong style="color: #d4af37;">Build:</strong> <span style="color: #f4d03f;">${presetLabels[preset]}</span></div>
                                </div>
                                
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #555;">
                                    <div style="color: #d4af37; font-weight: bold; margin-bottom: 10px;">Starting Stats:</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 14px;">
                                        <div><strong>Strength:</strong> <span style="color: #f4d03f;">${stats.strength || 5}</span></div>
                                        <div><strong>Agility:</strong> <span style="color: #f4d03f;">${stats.agility || 5}</span></div>
                                        <div><strong>Endurance:</strong> <span style="color: #f4d03f;">${stats.endurance || 5}</span></div>
                                        <div><strong>Charisma:</strong> <span style="color: #f4d03f;">${stats.charisma || 5}</span></div>
                                        <div><strong>Wits:</strong> <span style="color: #f4d03f;">${stats.wits || 5}</span></div>
                                        <div><strong>Luck:</strong> <span style="color: #f4d03f;">${stats.luck || 5}</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="color: #f4d03f; margin-bottom: 15px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Playstyle</h3>
                                <div style="color: #d4af37; line-height: 1.6; margin-bottom: 15px;">
                                    <p><strong style="color: #f4d03f;">Build:</strong> ${playstyleDescriptions[preset]}</p>
                                </div>
                                <div style="color: #d4af37; line-height: 1.6;">
                                    <p><strong style="color: #f4d03f;">Patron:</strong> ${patronDescriptions[patron]}</p>
                                </div>
                            </div>
                            
                            <div style="padding: 15px; background: rgba(139, 105, 20, 0.2); border: 1px dashed #8b6914; border-radius: 5px; text-align: center; color: #888; font-size: 13px; font-style: italic;">
                                Ready to begin your journey? Click below to start the game.
                            </div>
                        </div>
                    `;
                },
                choices: [
                    {
                        text: "Begin Your Journey",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            start: {
                title: "The Beginning",
                year: 1337,
                age: function() { return gameState.age || 18; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    const region = gameState.culture || "";
                    const ageRange = gameState.ageRange || 'prime';
                    const ageLabels = {
                        'youth': 'young',
                        'young_adult': 'young',
                        'prime': '',
                        'veteran': 'veteran',
                        'old_hand': 'veteran'
                    };
                    const ageText = ageLabels[ageRange] || '';
                    return `<p>It is the year 1337. The war between England and France has just begun.</p>
                           <p><strong>${name}</strong>, you are a ${ageText ? ageText + " " : ""}${region} man, ready to make your mark on history. The call to arms has reached you, and you've decided to join a lord's retinue.</p>
                           <p>Your training begins now...</p>`;
                },
                choices: [
                    {
                        text: "Begin Training",
                        effects: {},
                        nextScene: function() {
                            const origin = gameState.origin || 'rural_peasant';
                            const originMap = {
                                rural_peasant: "training_rural_peasant",
                                manor_retainer: "training_manor_retainer",
                                craftsman_apprentice: "training_craftsman_apprentice",
                                squire: "training_squire",
                                minor_noble: "training_minor_noble"
                            };
                            return originMap[origin] || "training_rural_peasant";
                        }
                    }
                ],
                onEnter: function() {
                    const sceneKey = `start_${gameState.year}`;
                    if (!gameState.enteredScenes.has(sceneKey)) {
                        // Grant starting kit if not already granted (backward compatibility)
                        if (!gameState.startingKitGranted) {
                            // Ensure kit tier is resolved
                            if (!gameState.startingKitTier) {
                                resolveStartingKitTier();
                            }
                            const origin = gameState.origin || 'rural_peasant';
                            grantStartingKit(origin, gameState.startingKitTier);
                        }
                        
                        // Apply origin bonuses if not already applied
                        if (!gameState.flags.originApplied) {
                            const origin = gameState.origin || 'rural_peasant';
                            
                            // Starting equipment by origin
                            const startingEquipment = {
                                rural_peasant: [
                                    { id: 'rusty_sword', condition: 80, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'padded_jack', condition: 75, fit: 'off-the-rack', stackCount: 1 }
                                ],
                                manor_retainer: [
                                    { id: 'spear', condition: 85, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'padded_jack', condition: 80, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'kettle_hat', condition: 80, fit: 'off-the-rack', stackCount: 1 }
                                ],
                                craftsman_apprentice: [
                                    { id: 'arming_sword', condition: 90, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'padded_jack', condition: 85, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'rondel_dagger', condition: 90, fit: 'off-the-rack', stackCount: 1 }
                                ],
                                squire: [
                                    { id: 'arming_sword', condition: 95, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'padded_jack', condition: 90, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'kettle_hat', condition: 90, fit: 'off-the-rack', stackCount: 1 },
                                    { id: 'buckler', condition: 85, fit: 'off-the-rack', stackCount: 1 }
                                ],
                                minor_noble: [
                                    { id: 'arming_sword', condition: 100, fit: 'tailored', stackCount: 1 },
                                    { id: 'padded_jack', condition: 95, fit: 'tailored', stackCount: 1 },
                                    { id: 'kettle_hat', condition: 95, fit: 'tailored', stackCount: 1 },
                                    { id: 'buckler', condition: 90, fit: 'tailored', stackCount: 1 }
                                ]
                            };
                            
                            // Give starting equipment
                            if (!gameState.inventory) gameState.inventory = [];
                            const equipment = startingEquipment[origin] || [];
                            equipment.forEach(function(item) {
                                if (!gameState.inventory.find(function(i) { return i.id === item.id; })) {
                                    gameState.inventory.push(item);
                                }
                            });
                            
                            // Apply stat bonuses
                            switch(origin) {
                                case 'rural_peasant':
                                    applyStatChange('endurance', 2);
                                    applyStatChange('wealth', -5);
                                    break;
                                case 'manor_retainer':
                                    applyStatChange('strength', 1);
                                    applyStatChange('charisma', 1);
                                    break;
                                case 'craftsman_apprentice':
                                    applyStatChange('wits', 1);
                                    applyStatChange('agility', 1);
                                    break;
                                case 'squire':
                                    applyStatChange('strength', 1);
                                    applyStatChange('wits', 1);
                                    break;
                                case 'minor_noble':
                                    applyStatChange('charisma', 1);
                                    applyStatChange('wits', 1);
                                    applyStatChange('reputation', 5);
                                    break;
                            }
                            gameState.flags.originApplied = true;
                        }
                        
                        // Apply patron stat modifiers if not already applied (final application at game start)
                        // Note: Stats should already be correct from recalculateCharacterCreationDerivedStats(),
                        // but we apply here as a final guard to ensure they're set
                        if (!gameState.flags.patronApplied) {
                            // Recalculate to ensure all mods are applied (idempotent)
                            recalculateCharacterCreationDerivedStats();
                            gameState.flags.patronApplied = true;
                        }
                        
                        gameState.enteredScenes.add(sceneKey);
                    }
                }
            },
            training_rural_peasant: {
                title: "Training Begins",
                year: 1338,
                age: function() { return (gameState.age || 18) + 1; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>You've joined a lord's retinue. The training is harsh, but you're used to hard work from the fields. Your endurance serves you well, though you lack the formal training of those born to higher stations.</p>
                           <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`;
                },
                choices: [
                    {
                        text: "Volunteer for the vanguard",
                        effects: { strength: 1, reputation: 1 },
                        nextScene: "first_battle_brave"
                    },
                    {
                        text: "Stay with the main force",
                        effects: { endurance: 1 },
                        nextScene: "first_battle_cautious"
                    }
                ]
            },
            training_manor_retainer: {
                title: "Service and Duty",
                year: 1338,
                age: function() { return (gameState.age || 18) + 1; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Your service on the manor has prepared you for this. You understand the bonds of fealty and duty, and your strength from years of labor serves you well.</p>
                           <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`;
                },
                choices: [
                    {
                        text: "Serve faithfully in the ranks",
                        effects: { charisma: 1, patronFavor: 1 },
                        nextScene: "first_battle_cautious"
                    },
                    {
                        text: "Prove your worth in the front",
                        effects: { strength: 1, reputation: 1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            training_craftsman_apprentice: {
                title: "A Craftsman's War",
                year: 1338,
                age: function() { return (gameState.age || 18) + 1; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Your time as an apprentice has sharpened your wits and agility. You see problems others miss and can repair what others break.</p>
                           <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`;
                },
                choices: [
                    {
                        text: "Use your skills to help the camp",
                        effects: { wits: 1, patronFavor: 1 },
                        nextScene: "first_battle_tactical"
                    },
                    {
                        text: "Focus on combat training",
                        effects: { strength: 1, agility: 1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            training_squire: {
                title: "A Knight's Service",
                year: 1338,
                age: function() { return (gameState.age || 18) + 1; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Your service as a squire has given you martial training and access to better gear. Your knight's reputation follows you, for good or ill.</p>
                           <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`;
                },
                choices: [
                    {
                        text: "Lead a small unit",
                        effects: { reputation: 2, strength: 1 },
                        nextScene: "first_battle_leader"
                    },
                    {
                        text: "Prove yourself in the front ranks",
                        effects: { strength: 1, morale: 1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            training_minor_noble: {
                title: "Noble Expectations",
                year: 1338,
                age: function() { return (gameState.age || 18) + 1; },
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>As a minor noble, much is expected of you. Your education and political connections give you advantages, but errors carry greater weight.</p>
                           <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord expects you to lead the response.</p>`;
                },
                choices: [
                    {
                        text: "Lead a small unit",
                        effects: { reputation: 2, strength: 1 },
                        nextScene: "first_battle_leader"
                    },
                    {
                        text: "Prove yourself in the front ranks",
                        effects: { strength: 1, morale: 1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            training_peasant: {
                title: "Training Begins",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>You've joined a lord's retinue. The training is harsh. Brutal. Endless. But you're used to hard work. The fields taught you that. Taught you endurance. Taught you to keep going when everything hurts. When nothing matters but survival.</p>
                       <p>Months pass. Training. Drilling. Learning the ways of war. The ways of death. The ways of survival. Your endurance serves you well. Your strength grows. Your skill sharpens. You're ready. Or think you are. For what comes next.</p>
                       <p>Your first campaign approaches. The French are raiding the coast. The villages. Your lord prepares to respond. To fight. You'll be part of it. Whether you want to be or not. Whether you're ready or not. That's how it works. In war. In life.</p>`,
                choices: [
                    {
                        text: "Volunteer for the vanguard",
                        effects: { strength: 1, reputation: 1 },
                        nextScene: "first_battle_brave"
                    },
                    {
                        text: "Stay with the main force",
                        effects: { endurance: 1 },
                        nextScene: "first_battle_cautious"
                    }
                ]
            },
            training_merchant: {
                title: "A Different Path",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>Your family's wealth has secured you better equipment. Better armor. Better weapons. And education. Books. Learning. Tactics. Strategy. The ways of war. The ways of thinking. You understand tactics better than most. Better than the peasants. Better than the common soldiers. But understanding isn't always enough.</p>
                       <p>Your first campaign approaches. The French are raiding the coast. The villages. Your lord prepares to respond. To fight. You'll be part of it. Whether you want to be or not. Whether you're ready or not. That's how it works. But you have advantages. Education. Equipment. Tactics. They might help. Might save you. Or might not. In war, nothing is certain.</p>`,
                choices: [
                    {
                        text: "Suggest a tactical approach",
                        effects: { charisma: 1, reputation: 2 },
                        nextScene: "first_battle_tactical"
                    },
                    {
                        text: "Follow orders like everyone else",
                        effects: { strength: 1 },
                        nextScene: "first_battle_cautious"
                    }
                ]
            },
            training_noble: {
                title: "Noble Expectations",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>As a noble's son, much is expected of you. By your family. By your lord. By everyone. Your reputation precedes you. Your name. Your blood. But so do the expectations. The pressure. The weight of being noble. Of being better. Of being more than common men. But you're not. Not really. Not yet. Maybe never. But you have to try. Have to become what they expect.</p>
                       <p>Your first campaign approaches. The French are raiding the coast. The villages. Your lord expects you to lead. To command. The pressure is real. The weight is heavy. You'll be part of it. Whether you want to be or not. Whether you're ready or not. That's how it works. But you have advantages. Name. Reputation. Training. They might help. Might save you. Or might not. In war, nothing is certain.</p>`,
                choices: [
                    {
                        text: "Lead a small unit",
                        effects: { reputation: 2, strength: 1 },
                        nextScene: "first_battle_leader"
                    },
                    {
                        text: "Prove yourself in the front ranks",
                        effects: { strength: 2, endurance: -1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            first_battle_brave: {
                title: "First Blood",
                year: 1338,
                age: 19,
                location: "Northern France",
                artwork: "artwork/battle-scene-1.jpg", // French vs English battle scene
                artworkCaption: "The clash of arms on the field of battle",
                text: `<p>You charge into battle. With courage. Or what passes for it. Or what you hope is courage. But might be fear. Might be desperation. Might be everything that makes men run toward death. But you charge anyway. Because you have to. Because there's no other choice.</p>
                       <p>The clash of steel rings in your ears. The sound is terrible. Beautiful. Terrifying. Men scream. Die. Fall around you. But you keep going. Keep charging. Keep fighting. Because that's what you do. That's what you're trained to do. The first battle. The first blood. It changes you. Breaks you. Makes you into what you'll become. What war makes you.</p>`,
                choices: [
                    {
                        text: "Fight with all your might",
                        effects: {},
                        nextScene: "first_battle_brave_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8
                    }
                ]
            },
            first_battle_brave_resolve: {
                title: "First Blood",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The battle rages around you. The sound is terrible. The sight is worse. Men die. Scream. Fall everywhere. But you fight. Keep fighting. Keep going. Because you have to. Because there's no other choice.</p>
                                           <p>Your first battle. Your first blood. It changes you. Breaks you. Makes you into what you'll become. What war makes you. You fight with all your might. With everything you have. Because that's what you do. That's what you're trained to do.</p>`;
                    
                    const difficulty = result.baseDifficulty || 6;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    
                    if (result.success) {
                        return `${rollDisplay}<p>You fight well. Drive back the French. Hold your ground. Your bravery shows. Is noted. By your comrades. By your captain. You take a minor wound. But you survive. The French retreat. The battle ends. For now. That's something. That's enough.</p>
                               <p>You've survived your first battle. Your first blood. It changes you. Breaks you. Makes you into what you'll become. What war makes you. Your comrades respect you. Your courage. Your skill. That matters. That helps.</p>`;
                    } else {
                        return `${rollDisplay}<p>The battle is fierce. Terrible. Deadly. You take a serious wound. But manage to survive. Barely. The French retreat. But you're left bleeding. Hurting. Broken. By the wound. By the battle. By everything. By nothing. By the knowledge that war is real. That death is real. That everything is real. And terrible. And permanent.</p>
                               <p>You've learned. That war is not glorious. Not like the songs. Not like the stories. Not like anything you imagined. It's brutal. Terrible. Deadly. Real. You've learned the hard way. The only way that matters. The only way that sticks. The knowledge weighs. Heavy. Real. Permanent. You did what you could. But it wasn't enough. It never is.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 10);
                        applyStatChange('reputation', 1);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1); // Battle is stressful
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_cautious: {
                title: "First Battle",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>You fight in formation. Stay close to your comrades. To your shield. To your safety. Or what passes for it. But you hold. Keep formation. Keep discipline. Keep going. Because that's what you do. That's what you're trained to do.</p>
                       <p>The battle is fierce. Terrible. Deadly. But you emerge unscathed. For now. That's something. That's enough. Your caution served you well. Your discipline. Your care. You've learned the value of discipline and formation. Of staying together.</p>
                       <p>Your first battle. Your first blood. It changes you. Breaks you. Makes you into what you'll become. What war makes you. But you survived. That's something. That's enough. Sometimes survival is enough.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 5);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_tactical: {
                title: "A Tactical Mind",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>Your suggestion works. To flank the French position. Attack from the side. From behind. Where they're not expecting it. Your lord takes notice of your thinking. Of your strategy. Not just another sword arm. Someone who sees the field. Who understands how battles are won.</p>
                       <p>You've earned respect through intelligence. Through strategy. Not just force. Not just strength. But thinking and planning. Seeing what others miss. You've done right. Done well. Done what needed doing. That's something. That's enough.</p>
                       <p>Your first battle. Your first blood. It changes you. Breaks you. Makes you into what you'll become. What war makes you. But you survived through thinking. Through strategy. Through everything that makes you different. Makes you more than just a soldier. More than just a killer.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 10);
                    applyStatChange('reputation', 2);
                    applyStatChange('wits', 1);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_leader: {
                title: "Leading Men",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>You lead them into battle. Your unit. Your men. Your responsibility. But you lead with skill and courage. They follow you and trust you because you lead and because you care. Because you do what needs doing when no one else will.</p>
                       <p>You emerge victorious. Together. As a unit. As a team. You've done right. Done well. Done what needed doing. That's something. That's enough.</p>
                       <p>Your leadership is recognized by your lord and your captain. By everyone who matters. You're given more. Responsibility. Men. Trust. You've earned it through leadership and skill. Through everything that makes you different. Makes you more than just a soldier. More than just a killer.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 15);
                    applyStatChange('reputation', 2);
                    applyStatChange('patronFavor', 1);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            winter_quarters: {
                title: "Winter Quarters",
                year: 1340,
                age: 21,
                location: "Northern France",
                text: function() {
                    const pay = Math.floor(5 + gameState.stats.reputation / 5);
                    return `<p>The war has quieted for the winter. You're billeted in a small village. Your pay arrives: ${pay} silver coins.</p>
                           <p>The local blacksmith's daughter, Marie, has been bringing you food. She's pretty, and you've noticed she's been making eyes at you. Your comrades joke about settling down. They laugh. You don't understand why. Not yet.</p>`;
                },
                choices: [
                    {
                        text: "Court Marie seriously",
                        effects: { charisma: 1 },
                        nextScene: "marriage_joke"
                    },
                    {
                        text: "Keep it casual",
                        effects: {},
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Focus on training",
                        effects: { strength: 1, agility: 1 },
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Spend coin on better equipment",
                        effects: { wealth: -10 },
                        nextScene: "equipment_upgrade_1340"
                    }
                ],
                onEnter: function() {
                    // Grant winter pay
                    const pay = Math.floor(5 + gameState.stats.reputation / 5);
                    applyStatChange('wealth', pay);
                    // Rest reduces stress
                    applyStatChange('stress', -2);
                }
            },
            equipment_upgrade_1340: {
                title: "Better Gear",
                year: 1340,
                age: 21,
                text: `<p>The blacksmith's forge glows. Hot. Bright. The sound of hammer on steel rings. Steady. Rhythmic. Like a heartbeat. Like war.</p>
                       <p>You invest. Coins on the table. Metal in your hands. A sturdier sword. Reinforced leather. Better gear. Better protection. Better chance of survival. Of victory. Of living through the next fight. The next battle.</p>
                       <p>Your gear quality improves. The weight feels different. The balance. The confidence. This will serve you well. In future battles. In future dangers. In everything that comes.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "between_years_1341"
                    }
                ],
                onEnter: function() {
                    const sceneKey = `equipment_upgrade_1340_${gameState.year}`;
                    if (!gameState.enteredScenes.has(sceneKey)) {
                        // Add equipment to inventory
                        if (!gameState.inventory) gameState.inventory = [];
                        
                        // Add mail haubergeon if not already in inventory
                        if (!gameState.inventory.find(i => i.id === 'mail_haubergeon')) {
                            gameState.inventory.push({
                                id: 'mail_haubergeon',
                                condition: 85,
                                fit: 'off-the-rack',
                                stackCount: 1
                            });
                            showNotification('Equipment Acquired', 'You purchased a Mail Haubergeon!');
                        }
                        
                        // Old format compatibility
                        if (gameState.equipment && gameState.equipment.weapon) {
                            gameState.equipment.weapon.quality = 1;
                        }
                        if (gameState.equipment && gameState.equipment.armor) {
                            gameState.equipment.armor.quality = 1;
                        }
                        
                        gameState.enteredScenes.add(sceneKey);
                    }
                }
            },
            between_years_1341: {
                title: "The Years Pass",
                year: 1341,
                age: 22,
                location: "Northern France",
                text: `<p>Winter quarters. Spring campaign. Summer raids. The rhythm becomes familiar. Predictable almost. You march. You fight. You survive. The years blur into seasons. Seasons into months. Months into days.</p>
                       <p>You've learned the patterns. When to push forward. When to hold back. When to keep your head down. Your lord notices. Your comrades trust you. Experience is the only teacher that matters.</p>
                       <p>But each season takes something. A friend. A piece of yourself. The man you were fades. The man you're becoming takes shape. Harder. Colder. More careful.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { experience: 20, patronFavor: 1 },
                        nextScene: "between_years_1342"
                    }
                ]
            },
            between_years_1342: {
                title: "Rising Through the Ranks",
                year: 1342,
                age: 23,
                location: "Northern France",
                text: `<p>The captain calls you forward. Five men. That's what you get. Five faces looking to you for orders. For decisions. For leadership you're not sure you have.</p>
                       <p>But you've earned this. Through service. Through survival. Through doing what needed doing when others wouldn't. The pay is better. Not much. But better. The responsibility is heavier. Much heavier.</p>
                       <p>You look at your men. They look back. Waiting. Trusting. Or pretending to. Either way, they're yours now. Their lives. Their deaths. That weight settles on you. You carry it. Because you have to.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { wealth: 5, reputation: 2 },
                        nextScene: "between_years_1343"
                    }
                ],
                onEnter: function() {
                    if (gameState.stats.patronFavor >= 3 && gameState.rank === "Common Soldier") {
                        gameState.rank = "Sergeant";
                        gameState.career.promotions++;
                        showNotification('Promotion!', 'You have been promoted to Sergeant!');
                    }
                }
            },
            between_years_1343: {
                title: "Minor Campaigns",
                year: 1343,
                age: 24,
                location: "Northern France",
                text: `<p>Raids. Skirmishes. Patrols. The French come. You respond. They retreat. You advance. It's become routine. Almost comfortable. Almost.</p>
                       <p>But routine doesn't mean safe. You've seen men die from arrows. From disease. From a horse that stumbled. From a blade that found a gap. From nothing at all. Just bad luck. Just being in the wrong place at the wrong time.</p>
                       <p>Each death teaches you something. Each year makes you more careful. Or more resigned. You can't tell which anymore. Maybe both. Maybe that's what survival means. Learning to accept what you can't change. Learning to change what you can.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { experience: 15 },
                        nextScene: "between_years_1344"
                    }
                ]
            },
            between_years_1344: {
                title: "The Calm Before the Storm",
                year: 1344,
                age: 25,
                location: "England",
                text: `<p>Rumors. Always rumors. But these feel different. More urgent. More real. King Edward is gathering men. Real men. Real armies. Not the small bands you've been fighting with. Something big is coming.</p>
                       <p>You hear it in taverns. In camps. In the way officers talk. Something is being planned. Something that will change everything. The war. Your life. The way you think about what you do.</p>
                       <p>You prepare. Check your gear. Sharpen your blade. Say your prayers. Because you know. This won't be a skirmish. This won't be routine. This will be real. This will be history. And you'll be part of it. Whether you want to be or not.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "between_years_1345"
                    }
                ]
            },
            between_years_1345: {
                title: "Final Preparations",
                year: 1345,
                age: 26,
                location: "England",
                text: `<p>King Edward's army gathers. You check your equipment one last time.</p>
                       <p>Tomorrow, you sail to France. The biggest campaign of your life awaits.</p>`,
                choices: [
                    {
                        text: "March to battle",
                        effects: {},
                        nextScene: "spring_campaign"
                    }
                ]
            },
            marriage_joke: {
                title: "The Joke",
                year: 1340,
                age: 21,
                location: "Northern France",
                text: `<p>You approach Marie. Speak to her. Tell her how you feel. What you want. What you hope for. She listens. Smiles. Nods. But there's something in her eyes. Something you don't see. Not yet.</p>
                       <p>Her father watches. The blacksmith. Big man. Hard hands. He laughs. Not at you. With you. Or so you think. He approves. Offers his daughter's hand. You're happy. Proud. Foolish.</p>
                       <p>Then you hear it. The laughter. Your comrades. Behind you. Around you. Everywhere. They're laughing. At you. At the joke. At everything you believed. Everything you hoped for.</p>
                       <p>Marie laughs too. Not the kind laugh you thought. The cruel one. The mocking one. The one that cuts deeper than any blade. She was never interested. Never serious. It was all a game. A joke. A way to pass the winter. To amuse themselves. At your expense.</p>
                       <p>You're a fool. A mark. A story they'll tell for years. The soldier who thought a blacksmith's daughter would marry him. Who thought he was special. Who thought he mattered. You don't. Not to them. Not to her. Not to anyone.</p>`,
                choices: [
                    {
                        text: "Walk away in silence",
                        effects: { stress: 3, morale: -2 },
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Confront them",
                        effects: { stress: 2, reputation: -1 },
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Laugh with them, pretend it doesn't hurt",
                        effects: { stress: 4, morale: -1 },
                        nextScene: "between_years_1341"
                    }
                ]
            },
            // ============================================================================
            // COMBAT ENCOUNTERS - Batch 1: Forest Ambush & Siege Defense
            // ============================================================================
            forest_ambush_1340: {
                title: "Ambush in the Woods",
                year: 1340,
                age: 22,
                location: "Northern France",
                artworkCaption: "French archers emerge from the trees",
                text: `<p>The forest goes still the wrong way. No birds. No chatter. Just boots on leaf-mold and the small clink of mail. Men keep walking anyway. Because marching is what you do until it isn't.</p>
                       <p>An arrow hits the man beside you. He drops like his knees were cut out. Someone shouts. Then there's more arrows. French archers in the trees. Close. Higher than you. Hard to see until they move.</p>
                       <p>Soot-Eyed Billy hisses, "Left side. Up. Don't bunch." He's already backing toward a trunk, eyes on the canopy.</p>
                       <p>Fiddle Jack ducks low, gripping his bow like he wants to wring it. "I can't see them. I can hear them," he says, breath fast.</p>
                       <p>Granny Six-Teeth is behind the line with the baggage, voice sharp as any captain's. "Heads down. If you stand there like a post, you'll get used like one."</p>
                       <p>You're in the open. Leaves jump with impacts. Men shout names. Some stop shouting. You have a few heartbeats to pick a way through it.</p>`,
                choices: [
                    {
                        text: "Charge the archers in the trees",
                        effects: {},
                        nextScene: "forest_ambush_1340_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Take cover and return fire",
                        effects: {},
                        nextScene: "forest_ambush_1340_resolve",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Lead a retreat to better ground",
                        effects: {},
                        nextScene: "forest_ambush_1340_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    }
                ]
            },
            forest_ambush_1340_resolve: {
                title: "After the Ambush",
                year: 1340,
                age: 22,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The forest settles back down like it didn't do anything. Men breathe hard. Someone coughs and won't stop.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You move when others freeze. You get under wood and root and shadow. You put steel where it needs to go, or you put arrows back into the trees until the shooting falters.</p>
                            <p>Billy points with two fingers. "There. One more." He's calm, like this is work he's done before. He probably has.</p>
                            <p>Harry barrels in from the right with a man at his shoulder, smashing through brush. "Keep moving," he grunts. "Don't stop to look."</p>
                            <p>The French break once it costs them. A few run deeper into the trees. A few don't get up. The column drags itself back together. Men check each other's straps, count heads, find the ones that are missing.</p>
                            <p>Jack exhales like he's been holding it since the first arrow. "I hate woods," he says. "Never trust woods."</p>
                            <p>You move on with the taste of leaves and fear in your mouth, and you keep Billy's warnings in your head the way you keep water when you're thirsty.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>You try to move and the forest punishes it. An arrow catches you‚Äîhard enough to make your arm go slack, or to make your leg forget what it's for. You stumble into cover more by luck than sense.</p>
                            <p>Jack grabs your belt and hauls. "Down. Down," he says, not loud, just urgent. He's shaking with it. He tries not to show.</p>
                            <p>Billy's voice comes through the noise. "Hold still. Let them waste shots."</p>
                            <p>Harry takes a hit off a shield and keeps going, jaw locked. "If you can breathe, you can crawl," he says, like he's giving you permission.</p>
                            <p>The ambush ends the ugly way most things end‚Äîby running out of will. The French peel off when your men stop panicking. The column survives. You survive. But you're leaking and sore and angry, and it's going to be a long march.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 8);
                        applyStatChange('reputation', 1);
                        applyStatChange('stress', 1);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue the march",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            siege_defense_1345: {
                title: "The Walls Hold",
                year: 1345,
                age: 26,
                location: "Gascony",
                artworkCaption: "French forces assault the castle walls",
                text: `<p>The siege has gone on long enough that everyone's sick of the sound of stone. The French throw rocks. You throw rocks back. Men die in bits you don't want to look at too hard.</p>
                       <p>Up on the ramparts the air smells of piss, smoke, and old sweat. The captain points where he wants bodies. "Gate. Wall. Anywhere they touch. Hold it."</p>
                       <p>Hammer-Hand Harry pats his weapon like it's a tool. "Gate's a door," he says. "Doors break. Men break first."</p>
                       <p>Soot-Eyed Billy peers out from behind a crenel. "They're stacking ladders on the left. Three at once," he says. "They're timing it."</p>
                       <p>Fiddle Jack swallows and tightens his grip. "If they come over, it's close work," he says. "No room to be clever."</p>
                       <p>Below, the first ladder slams into the stone. Wood scrapes. Men shout. The assault finally starts.</p>`,
                choices: [
                    {
                        text: "Defend the main gate with all your strength",
                        effects: {},
                        nextScene: "siege_defense_1345_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Hold your position on the walls",
                        effects: {},
                        nextScene: "siege_defense_1345_resolve",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Coordinate the defense from a vantage point",
                        effects: {},
                        nextScene: "siege_defense_1345_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    }
                ]
            },
            siege_defense_1345_resolve: {
                title: "The Assault Ends",
                year: 1345,
                age: 26,
                location: "Gascony",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The assault keeps coming in waves. Arms ache. Throats go raw. The wall shakes and holds.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You do the job in front of you. You keep hands off the wall where hands shouldn't be. You shove ladders. You put steel into faces that pop up over stone. You keep the gate line tight.</p>
                            <p>Billy calls it clean: "Left ladder's empty. Next one's coming." He keeps feeding you the small facts that stop men from dying stupid.</p>
                            <p>Harry plants himself where the press is worst. "Here," he grunts. "Not back there." He takes the hit that would've taken another man's teeth.</p>
                            <p>Jack's breathing hard, but he stays. "Don't let them sit on the wall," he says, and it's the closest thing to advice he's got.</p>
                            <p>The French finally pull away, dragging their wounded, leaving their dead where they fell. The wall is slick and chipped and still yours. Men slump wherever they can. Someone laughs once, short and ugly, because it's over for the moment.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>They find the weak spot. A ladder lands where no one wanted it. A knot of French gets a foothold. For a minute the wall feels like it's tilting under you.</p>
                            <p>You fight close. Elbows, knife, shield edge. No space. No clean swings. Someone's breath in your face and you don't know whose it is.</p>
                            <p>You take a hard cut or a crushing hit. Your arm goes numb. Your legs wobble. Jack sees it and grabs you by the strap. "Stay up," he says through his teeth. "Stay up."</p>
                            <p>Harry shoulders into the crush and buys a few seconds. "Move," he barks. "Move now."</p>
                            <p>The French are driven off eventually, but it's not neat. It's not heroic. It's bodies piled where the ladder was and men staring at their own hands like they don't recognize them. When it's done you're left hurting and patched and quieter than you were.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 12);
                        applyStatChange('reputation', 2);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Seriously Wounded', 'negative', 3);
                        applyStatChange('endurance', -2);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Tend to your wounds",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            // ============================================================================
            // COMBAT ENCOUNTERS - Batch 2: Cavalry Skirmish & Night Raid
            // ============================================================================
            cavalry_skirmish_1342: {
                title: "Horsemen on the Road",
                year: 1342,
                age: 23,
                location: "Aquitaine",
                artworkCaption: "French cavalry charges across the field",
                text: `<p>You're marching in a long column when the sound changes. Not boots. Not carts. Hooves. Fast. Many of them. It comes up from behind a low rise like a storm you can't step aside from.</p>
                       <p>French cavalry‚Äîhelmets bright, lances down. The men near you start shouting at once. Some start running. That makes it worse.</p>
                       <p>Billy looks over his shoulder and spits. "Too close. If you run, they'll ride you down."</p>
                       <p>Jack's hands are already on a strap. "Where do you want me?" he asks. No poetry. Just trying to live.</p>
                       <p>Harry steps into the road like it belongs to him. "Get your shields up," he says. "Or get out of my way."</p>
                       <p>The ground starts to shake under the hooves. There's no time to argue with it.</p>`,
                choices: [
                    {
                        text: "Form a shield wall with your comrades",
                        effects: {},
                        nextScene: "cavalry_skirmish_1342_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Scatter and take cover",
                        effects: {},
                        nextScene: "cavalry_skirmish_1342_resolve",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Stand your ground and hope for the best",
                        effects: {},
                        nextScene: "cavalry_skirmish_1342_resolve",
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 8
                    }
                ]
            },
            cavalry_skirmish_1342_resolve: {
                title: "After the Charge",
                year: 1342,
                age: 23,
                location: "Aquitaine",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The dust hangs in the air. Men cough. Someone is crying and trying to hide it.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You pick something that works and commit to it. Shields lock or men spill into ditches at the right moment. The first lance glances off wood instead of flesh.</p>
                            <p>Harry is a wall with hands. He shoves one man back into line. "Hold," he growls. "Hold or die." Simple as that.</p>
                            <p>Billy points past the riders. "They're turning wide. Don't chase." He's right. The moment you chase, you die tired.</p>
                            <p>The cavalry breaks off when it stops being easy. They wheel away, kicking up dust and curses. You're left with splintered shields, a few crushed bodies, and the sick relief of still standing.</p>
                            <p>Jack wipes his mouth with his sleeve. "I'm going to hear that sound in my sleep," he says, and no one laughs because it's true.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>The charge hits like a dropped cart. Horses slam into men. The road becomes screaming and dust and weight. You go down under it, not even sure how.</p>
                            <p>Something clips you‚Äîhoof, lance, shield rim. Pain blooms and then everything is just getting air back into your lungs.</p>
                            <p>Jack drags you by the collar into a shallow ditch. "Don't stand," he snaps. "Just breathe."</p>
                            <p>Harry hauls another man upright and shoves him forward. "Move," he says. "If you're alive, move."</p>
                            <p>The cavalry rides through and out the far side, leaving you in the churned mess. You're alive. You're hurt. The column regroups with a smaller count than it had a minute ago.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 10);
                        applyStatChange('reputation', 1);
                        applyStatChange('stress', 1);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue the march",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            night_raid_1347: {
                title: "Darkness and Steel",
                year: 1347,
                age: 28,
                location: "Normandy",
                artworkCaption: "Shadows move in the darkness",
                text: `<p>Night in camp is never quiet. Men cough. Horses shift. Someone argues in a whisper. The fire burns low because no one wants to be a beacon.</p>
                       <p>You're on watch when you see movement where there shouldn't be any. Not a man going to piss. Not a dog. Shapes slipping between tents.</p>
                       <p>Billy is already beside you, voice low. "Not ours," he says. "Too many. Knives."</p>
                       <p>Jack's awake on the ground with his hand on his gear. "Tell me what to do," he whispers.</p>
                       <p>Granny Six-Teeth sits up near the baggage like she never slept at all. "If you're going to shout, shout now," she says. "If you're going to stab, do that."</p>
                       <p>Steel flashes once. A man grunts. Then everything starts at once.</p>`,
                choices: [
                    {
                        text: "Sound the alarm and rally the camp",
                        effects: {},
                        nextScene: "night_raid_1347_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Engage them silently in the dark",
                        effects: {},
                        nextScene: "night_raid_1347_resolve",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Try to slip past and find help",
                        effects: {},
                        nextScene: "night_raid_1347_resolve",
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 8
                    }
                ]
            },
            night_raid_1347_resolve: {
                title: "Dawn Breaks",
                year: 1347,
                age: 28,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The night drags on. Men don't sleep. The dark keeps its teeth out for now.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You do the right thing fast enough. You get men moving. You get blades out. You keep the raiders from turning the camp into a slaughter pen.</p>
                            <p>Billy puts you where you need to be. "There," he says, pointing into the gap between tents. "That's their path."</p>
                            <p>Harry comes in half-dressed, furious, and effective. He drops one man with a single ugly swing and then barks, "Back. Keep them out of the horses."</p>
                            <p>Jack doesn't do anything fancy. He stays close, follows orders, keeps his hands from shaking by staying busy.</p>
                            <p>The raiders run when they stop getting easy kills. Dawn comes slow and gray. The camp stinks of smoke and sweat and spilled blood, but it's still standing. You're still standing.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>It goes wrong fast. Someone shouts too late or in the wrong direction. The raiders get into the tents. Men wake up with knives already on them.</p>
                            <p>You fight in the dark with half-seen shapes. You catch a blade you didn't see coming, or you take a hit while dragging someone out of their blanket.</p>
                            <p>Jack's voice is close. "Hold on," he says, rough and scared. He ties something tight around you with shaking hands and swears at the knot.</p>
                            <p>Billy keeps moving, pulling men awake, pushing them toward light. "Wake up. Wake up," he repeats like it'll bring the dead back.</p>
                            <p>The raiders pull off before sunrise, carrying what they can. The camp survives, but it's thinner. Dawn shows what the dark took.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 12);
                        applyStatChange('reputation', 2);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Tend to the wounded",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            // ============================================================================
            // COMBAT ENCOUNTERS - Batch 3: Town Fighting & Archery Duel
            // ============================================================================
            town_fighting_1348: {
                title: "Streets of Calais",
                year: 1348,
                age: 29,
                location: "Calais",
                artworkCaption: "Combat in the narrow streets",
                text: `<p>Calais is tight stone and narrow lanes. The air is bad‚Äîsmoke, rot, old fish. Everything echoes. A shout becomes ten shouts. A footstep becomes a warning.</p>
                       <p>Your unit pushes into a street and the street pushes back. A bolt from a window. A man drops. A door bursts open and there's a Frenchman in it, just as surprised as you are.</p>
                       <p>Billy presses himself to a wall and listens. "Two on the roof," he says. "One in that doorway. Don't stand in the open."</p>
                       <p>Jack's breathing through his mouth. "I hate towns," he says. "Too many corners."</p>
                       <p>Harry shoulders past, impatient. "Corners are fine," he grunts. "Men hiding in them aren't."</p>
                       <p>You have to clear the block. Not because it matters. Because you've been told to. Because you'll be killed if you don't.</p>`,
                choices: [
                    {
                        text: "Charge forward and clear the street",
                        effects: {},
                        nextScene: "town_fighting_1348_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Move through the alleys and flank them",
                        effects: {},
                        nextScene: "town_fighting_1348_resolve",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Coordinate with your unit to clear buildings",
                        effects: {},
                        nextScene: "town_fighting_1348_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    }
                ]
            },
            town_fighting_1348_resolve: {
                title: "The Street is Clear",
                year: 1348,
                age: 29,
                location: "Calais",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The street is still contested. Men press forward by inches and fear.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You clear it the hard way‚Äîdoor by door, corner by corner. You keep men together. You keep someone watching the roofs. You don't let panic split the line.</p>
                            <p>Billy taps your shoulder and points, quick. "Now," he says. You move on the cue and it saves you from a shot meant for your chest.</p>
                            <p>Harry takes a door with his shoulder and goes in like he's late to work. "Next," he says when he comes out, and his voice doesn't change.</p>
                            <p>Jack covers a window, hands steady enough. "Clear," he calls, and it sounds like relief trying not to show.</p>
                            <p>When it's done, the street is yours. The silence after is worse than the noise. Men look at walls like the walls might stab them.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>The town punishes mistakes. You take a corner too wide, or a door opens where you didn't expect it. A blade finds you, or a bolt takes you low.</p>
                            <p>You go down in the filth of the street and you taste old smoke and grit. Someone hauls you back by your straps.</p>
                            <p>Jack is there, face tight. "Stay awake," he says. "Just stay awake."</p>
                            <p>Harry plants himself between you and the doorway and takes the next swing meant for you. "Move him," he barks. "Move."</p>
                            <p>The block is cleared eventually, but you don't feel like a winner. You feel like a man who got lucky enough to keep breathing.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 12);
                        applyStatChange('reputation', 2);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue clearing the town",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            archery_duel_1339: {
                title: "The Archers' Stand",
                year: 1339,
                age: 20,
                location: "Northern France",
                artworkCaption: "Arrows fly across the field",
                text: `<p>The French hold a ridge and they won't stop shooting. All day it's been the same: a man steps out, a man drops. Your side curses the wind and keeps moving corpses off the line.</p>
                       <p>You're ordered forward with the archers. Not to be brave. To be useful. You string an arrow. Your fingers are stiff. Your mouth is dry.</p>
                       <p>Jack checks his string, then yours. "Your knot's loose," he says. "Fix it or it'll slap you bloody."</p>
                       <p>Billy squints at the ridge. "They're aiming for movement," he says. "Don't dance around. Pick a spot and shoot."</p>
                       <p>Granny Six-Teeth is behind you with the spare shafts, counting like it's bread. "Stop wasting arrows," she mutters. "We're not made of them."</p>
                       <p>You draw. You aim. You try to make the ridge pay attention to someone else for a change.</p>`,
                choices: [
                    {
                        text: "Focus on accuracy and pick your targets",
                        effects: {},
                        nextScene: "archery_duel_1339_resolve",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Coordinate volleys with your unit",
                        effects: {},
                        nextScene: "archery_duel_1339_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Rapid fire and hope for the best",
                        effects: {},
                        nextScene: "archery_duel_1339_resolve",
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 8
                    }
                ]
            },
            archery_duel_1339_resolve: {
                title: "The Archers Break",
                year: 1339,
                age: 20,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>Arrows keep trading places in the air. Men keep falling. No one calls it fair.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You slow down enough to hit what you're aiming at, or you keep your volley tight enough that the ridge starts to flinch. A Frenchman drops. Then another. Heads duck. Their shooting loses its rhythm.</p>
                            <p>Jack gives a short nod. "That one counted," he says, like he's marking a tally.</p>
                            <p>Billy points. "They're backing off the crest."</p>
                            <p>Granny hands you another shaft without looking at you. "Good. Keep doing that. Don't get proud."</p>
                            <p>The French archers pull back, not running, just deciding they've had enough for the day. The ridge is quieter. Your side breathes again. It's not a victory song. It's just less dying.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>You shoot and it doesn't matter enough. The ridge keeps biting. An arrow finds you‚Äîarm, thigh, anywhere that makes you swear and lose your grip.</p>
                            <p>Jack grabs your elbow. "Hold it still," he says, voice tight. "Don't yank it."</p>
                            <p>Granny is already there with cloth. "Sit," she snaps. "You're no use falling over."</p>
                            <p>Billy keeps shooting while you bleed. "Keep their heads down," he mutters, like he's talking to himself as much as anyone.</p>
                            <p>The French eventually ease off, but you pay for the time it took. You're alive. You're hurt. You're going to feel it every time you draw a string.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 8);
                        applyStatChange('reputation', 1);
                        applyStatChange('stress', 1);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 1);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue the advance",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            // ============================================================================
            // COMBAT ENCOUNTERS - Batch 4: River Crossing & Last Stand
            // ============================================================================
            river_crossing_1344: {
                title: "The River Runs Red",
                year: 1344,
                age: 25,
                location: "Gascony",
                artworkCaption: "Men struggle across the river under fire",
                text: `<p>The river is wide, cold, and fast. The far bank is lined with French archers. You can see the draw of their bows even before you hear the strings.</p>
                       <p>Men step in and the water grabs them. Packs drag. Boots slip in the mud. An arrow hits a man midstream and he goes under like he's been pulled.</p>
                       <p>Billy watches the ripples like he can read them. "Don't go where it looks smooth," he says. "That's the deep."</p>
                       <p>Jack keeps his bow high and his mouth shut, saving breath. "Just tell me when," he says.</p>
                       <p>Harry spits and steps in like he hates the river personally. "If we're crossing, we're crossing," he growls. "No standing around getting shot."</p>
                       <p>The order comes. Forward. Into the water. Into the arrows. There's no clean way to do it.</p>`,
                choices: [
                    {
                        text: "Push through the current with all your strength",
                        effects: {},
                        nextScene: "river_crossing_1344_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Move slowly and carefully to avoid arrows",
                        effects: {},
                        nextScene: "river_crossing_1344_resolve",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 8
                    },
                    {
                        text: "Find a better crossing point upstream",
                        effects: {},
                        nextScene: "river_crossing_1344_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    }
                ]
            },
            river_crossing_1344_resolve: {
                title: "On the Far Bank",
                year: 1344,
                age: 25,
                location: "Gascony",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The river keeps taking what it can. Men keep trying anyway.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>You pick a line and stick to it. You keep your feet under you, keep your head down, keep your pack from dragging you sideways. You hit the far bank with your lungs on fire.</p>
                            <p>Billy is already there, grabbing wrists, hauling men up. "Don't stop in the shallows," he snaps. "Get up the bank."</p>
                            <p>Harry hits the mud like a bull and then climbs like he's offended by gravity. "Move," he growls at a man frozen on the slope. "Move now."</p>
                            <p>Jack gets across with his bow still usable, which feels like a miracle. He coughs and says, "Never doing that again."</p>
                            <p>You push into the French line and they give ground. Not because you're noble. Because you're wet and angry and right in front of them. The bank becomes yours. The river is behind you. You don't look back until it's done.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>You step wrong once and the river takes the rest. You slip. Your pack drags. Water fills your mouth. An arrow hits close enough to make you flinch and lose your footing again.</p>
                            <p>Something catches you‚Äîarrow, rock, boot. Pain and cold together. You claw forward because there's no other choice.</p>
                            <p>Jack grabs you when you reach the bank and yanks, nearly tearing you out of your own skin. "Up," he says. "Up."</p>
                            <p>Billy's face is tight with it. "Keep going," he says. "Don't sit down. You'll never stand back up."</p>
                            <p>You make the far side. You fight because you have to. You win the bank because the men behind you keep coming. Later, when the shaking starts, you realize how close it was.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 12);
                        applyStatChange('reputation', 2);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue the advance",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            last_stand_1350: {
                title: "No Retreat",
                year: 1350,
                age: 31,
                location: "Northern France",
                artworkCaption: "Outnumbered and surrounded",
                text: `<p>The day goes wrong and then keeps going wrong. Your unit gets cut off. The captain goes down. The line breaks. You end up with a handful of men and no clean way out.</p>
                       <p>The French are everywhere. Not in a grand way. In a practical way. You turn your head and there's more of them. You step back and there's more of them. The ground feels smaller.</p>
                       <p>Billy looks around once, quick, like he's counting exits. "We're boxed," he says. "There's a thin spot by that hedge, maybe."</p>
                       <p>Jack's face is gray. "If we run, they'll cut us down," he says. Not a complaint. Just the math.</p>
                       <p>Harry wipes his hand on his coat and nods at you like you're the only thing left that counts as a plan. "Say it," he says. "We're doing something or we're dying standing still."</p>
                       <p>Granny Six-Teeth is nowhere near the fighting, but you can hear her voice behind the scramble of men‚Äîsharp, scolding, alive. "Don't drop the bandage bundle, you idiot. Hold it tight." Even now she's keeping someone from bleeding out.</p>
                       <p>This is the moment where you pick a shape for the end.</p>`,
                choices: [
                    {
                        text: "Form a circle and fight to the last",
                        effects: {},
                        nextScene: "last_stand_1350_resolve",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Lead a desperate charge to break through",
                        effects: {},
                        nextScene: "last_stand_1350_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Try to find a weak point and escape",
                        effects: {},
                        nextScene: "last_stand_1350_resolve",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 8
                    }
                ]
            },
            last_stand_1350_resolve: {
                title: "Survival",
                year: 1350,
                age: 31,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The French close in. Men tighten grips. Breath gets loud inside helmets.</p>`;

                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;

                    if (result.success) {
                        return `${rollDisplay}
                            <p>It works because you make it work. You keep men together, or you hit the thin spot before it thickens, or you turn a hedge and a ditch into a wall for a few minutes that matter.</p>
                            <p>Billy's voice is right in your ear. "Now. Now." He doesn't say why. He doesn't need to. You move on the cue and it's the gap you needed.</p>
                            <p>Harry breaks the first man in the way and keeps going, breathing like a bellows. "Keep up," he grunts. "Don't fall behind me."</p>
                            <p>Jack stays close and does exactly what he's told. When it's over he sits down hard, shaking. "That was‚Ä¶ close," he says. Understatement of the year.</p>
                            <p>You get out with fewer men than you started with. You don't feel lucky. You feel used up. But you're alive. And that is, for now, enough.</p>`;
                    } else {
                        return `${rollDisplay}
                            <p>You try it and it doesn't come clean. The circle buckles, or the charge stalls, or the "weak spot" turns out to be wishful thinking. The French don't need poetry. They just need numbers.</p>
                            <p>You take a heavy wound. Not a scratch. Something that makes your arm stop working right, or makes your leg drag. You keep moving because stopping is the same as dying.</p>
                            <p>Harry grabs you and hauls. "Not here," he growls. "Not now." He's bleeding too. He doesn't mention it.</p>
                            <p>Jack is swearing as he pulls another man by the strap. "Move. Move," he repeats, like words can carry weight.</p>
                            <p>Billy gets you to cover the ugly way‚Äîcrawling, dragging, stumbling. "Keep your eyes open," he says. "Just keep them open."</p>
                            <p>You survive the moment. You don't win it. Later you'll find out how much it cost.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 15);
                        applyStatChange('reputation', 3);
                        applyStatChange('patronFavor', 2);
                        applyStatChange('stress', 3);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Seriously Wounded', 'negative', 4);
                        applyStatChange('endurance', -2);
                        applyStatChange('stress', 4);
                        gameState.career.wounds++;
                        if (Math.random() < 0.15) {
                            gameState.career.deathRate += 0.1;
                        }
                    }
                },
                choices: [
                    {
                        text: "Tend to your wounds and regroup",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            spring_campaign: {
                title: "The Campaign of 1346",
                year: 1346,
                age: 27,
                location: "England",
                text: `<p>Spring arrives, and with it, the call to arms. King Edward III prepares to invade France with a large army.</p>
                       <p>Your lord calls for all available men. This will be a major campaign...</p>`,
                choices: [
                    {
                        text: "Prepare for what's coming",
                        effects: {},
                        nextScene: "indenture_table"
                    }
                ]
            },
            indenture_table: {
                title: "The Indenture Table",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: `<p><strong>June 1346 ‚Äî Portsmouth</strong></p>
                       <p>A clerk reads the contract terms aloud while your captain watches faces for hesitation. You're not swearing fealty for life‚Äîyou're signing for a term, a wage, and a share of what can be lawfully taken. The ink smells like iron. Someone nearby is already drunk enough to mis-hear his own name.</p>`,
                choices: [
                    {
                        text: "Negotiate for clarity (not more pay)",
                        effects: {},
                        nextScene: "indenture_negotiate",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Ask what happens to prisoners",
                        effects: {},
                        nextScene: "indenture_prisoners",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Sign fast and shut up",
                        effects: {},
                        nextScene: "indenture_sign",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    }
                ]
            },
            indenture_negotiate: {
                title: "Negotiating Terms",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the clerk...</p>`;
                    if (result.success) {
                        return `<p>You ask careful questions about payment schedules and prize distribution. The captain nods‚Äîyou're thinking like a professional, not a troublemaker.</p>
                               <p>You've earned respect and clarity. This will serve you well.</p>`;
                    } else {
                        return `<p>Your questions come across as challenging the captain's authority. His expression hardens.</p>
                               <p>You've marked yourself as difficult. This will cost you favor.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        setFlag('Shorted Wages', false); // Clear risk flag
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            indenture_prisoners: {
                title: "Prisoners and Ransoms",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You consider the question...</p>`;
                    if (result.success) {
                        return `<p>You ask about prisoner rights and ransoms. The older hands nod‚Äîyou're learning the real economics of war.</p>
                               <p>You understand the system now. This knowledge could be valuable.</p>`;
                    } else {
                        return `<p>Your question marks you as na√Øve. The veterans exchange knowing looks.</p>
                               <p>You'll learn the hard way, or not at all.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wits', 1);
                        setFlag('Ransom Claim', true);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            indenture_sign: {
                title: "Signing the Contract",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take the quill...</p>`;
                    if (result.success) {
                        return `<p>You sign with confidence. The terms are what they are‚Äîyou've made your choice and you'll see it through.</p>
                               <p>Your certainty strengthens your resolve.</p>`;
                    } else {
                        return `<p>You sign quickly, but later you realize you missed a clause about wage deductions.</p>
                               <p>This oversight may cost you later.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Shorted Wages', true);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            purveyance: {
                title: "Purveyance",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: `<p><strong>Late June 1346 ‚Äî Southern England</strong></p>
                       <p>Wagons arrive with hard bread and salted meat‚Äîthen stop arriving. A royal warrant appears. "Purveyance," they call it: taking supplies at set prices (or less), and letting villagers complain to someone who isn't here. Your unit is told to "assist."</p>`,
                choices: [
                    {
                        text: "Pay fair and write receipts",
                        effects: {},
                        nextScene: "purveyance_fair",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Take what's needed, quickly",
                        effects: {},
                        nextScene: "purveyance_take",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Refuse and let others do it",
                        effects: {},
                        nextScene: "purveyance_refuse",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    }
                ]
            },
            purveyance_fair: {
                title: "Fair Dealing",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The villagers watch you. Hands on tools. Faces hard. They've seen soldiers before. They know what to expect. Taking. Demanding. Threatening.</p>
                                           <p>You approach slowly. Show your hands. No weapons. Just coins. Just paper. Just the promise of fairness in a world that offers little.</p>`;
                    if (result.success) {
                        return `<p>You pay fair prices. Write proper receipts. The villagers stare. Disbelieving at first. Then grateful. One old woman weeps. You didn't expect that. Didn't expect how much a small kindness could mean.</p>
                               <p>Your integrity is noted. The captain sees. The villagers remember. This will matter. Later. When you need it. When they need it. Small acts. Small debts. They add up.</p>`;
                    } else {
                        return `<p>You try to be fair. Count coins carefully. Write receipts. But someone accuses you of skimming. Of taking more than you paid. The captain questions you. Your honesty. Your judgment.</p>
                               <p>Your reputation suffers. Even if you're innocent. Even if you did right. Perception matters. Trust matters. And you've lost both.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    const payCost = 5;
                    if (result && result.success) {
                        applyStatChange('wealth', -payCost);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            purveyance_take: {
                title: "Taking What's Needed",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move quickly. No time for negotiation. No time for fairness. The unit needs food. The unit needs supplies. That's what matters. That's all that matters.</p>
                                           <p>The villagers watch. Silent. Resigned. They've seen this before. They'll see it again. This is how war works. Taking. Always taking.</p>`;
                    if (result.success) {
                        return `<p>You take what's needed. Efficiently. Quickly. The unit is fed. Extra supplies secured. The job is done. No fuss. No delay.</p>
                               <p>But the villagers' eyes follow you. Their faces hard. Their hands clenched. Resentment grows. Hatred takes root. You've fed your men. But you've planted seeds. Seeds that will grow. That will bear fruit. Bitter fruit.</p>`;
                    } else {
                        return `<p>You take supplies. Clumsily. Too fast. Too rough. You break things. Spill things. Waste things. The villagers' anger is palpable. Their rage barely contained.</p>
                               <p>You've made enemies. Real enemies. People who will remember. Who will wait. Who will find ways to make you pay. This will come back. It always does.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 3);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Resentment', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            purveyance_refuse: {
                title: "Refusing the Order",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The order comes. Take what's needed. Pay what you can. Or don't pay. The warrant covers it. The law allows it. But your conscience doesn't.</p>
                                           <p>You hesitate. Look at the villagers. Look at your men. Look at the captain. Everyone waiting. Everyone watching. What you do next will define you. To them. To yourself.</p>`;
                    if (result.success) {
                        return `<p>You refuse. Politely. Quietly. Let others handle it. Step back. Let the weight fall on someone else. You avoid the moral burden. The guilt. The shame.</p>
                               <p>But the captain notices. Your reluctance. Your hesitation. Your unwillingness to do what needs doing. You've avoided creating resentment. But you've lost favor. Lost trust. Lost respect. Sometimes the price of a clean conscience is everything else.</p>`;
                    } else {
                        return `<p>The captain forces you. No choice. No argument. You do it. Take the supplies. Ignore the protests. Pretend you don't see the tears. Pretend you don't hear the curses.</p>
                               <p>But something breaks. Inside you. A piece of who you were. A piece of who you wanted to be. You're shaken. Not by danger. Not by fear. By what you've been made to do. By what you've become.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', -1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            channel_crossing: {
                title: "Channel Crossing: Vomit and Rope",
                year: 1346,
                age: 27,
                location: "English Channel",
                artwork: "artwork/naval-battle-1.jpg", // Naval battle scene with ships
                artworkCaption: "The crossing to France",
                text: `<p><strong>Early July 1346 ‚Äî At sea</strong></p>
                       <p>Men retch over the gunwale until there's nothing left to give. Horses scream when the deck shifts. The ship's bilge stinks. Someone drops a bow-case into seawater; someone else pretends not to see.</p>`,
                choices: [
                    {
                        text: "Guard the horses through the night",
                        effects: {},
                        nextScene: "channel_horses",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Secure your gear against salt",
                        effects: {},
                        nextScene: "channel_gear",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Help the sick and keep order",
                        effects: {},
                        nextScene: "channel_help",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    }
                ]
            },
            channel_horses: {
                title: "Tending the Horses",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The horses scream. Panic in their eyes. The deck rolls. They stumble. Fall. Get up. Fall again. They don't understand. Can't understand. This isn't their world. This isn't their war.</p>
                                           <p>You approach the stalls. The smell of fear. Of sweat. Of animal terror. They need someone. Someone to calm them. To steady them. To keep them alive until land. Until they can run again. Until they can be useful again.</p>`;
                    if (result.success) {
                        return `<p>You guard them through the night. Long hours. Dark hours. Talking. Soothing. Keeping them calm. Keeping them secure. They settle. Trust you. Or at least stop fighting you.</p>
                               <p>Dawn comes. The horses are ready. Calm. Steady. They'll carry you when you need them. They'll carry you into battle. Into death. But for now, they're alive. They're yours. Your dedication is noted. The captain sees. Reliable men are rare. You're one of them.</p>`;
                    } else {
                        return `<p>The night is endless. Exhausting. You do your best. Try to keep them calm. Try to keep them safe. But the ship rolls. One horse falls. Breaks a leg. Or maybe just panics. Either way, it's done. Can't be saved. Can't be fixed.</p>
                               <p>You're fatigued. Empty. And you'll be without a mount when you need one. When the fighting starts. When speed matters. When a horse could save your life. But you tried. That's something. Even if it doesn't feel like enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 1);
                        setFlag('Lame Mount', true);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            channel_gear: {
                title: "Securing Your Gear",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>Saltwater everywhere. Spray. Mist. Waves crashing over the side. Your gear is exposed. Vulnerable. Your bow. Your strings. Your arrows. Everything that keeps you alive. Everything that makes you useful.</p>
                                           <p>You check your equipment. Wrap it. Cover it. Protect it. Because you know. When you land. When the fighting starts. Your gear is all you have. All that stands between you and death. Between you and failure.</p>`;
                    if (result.success) {
                        return `<p>You protect it carefully. Wrap the bow. Cover the strings. Keep everything dry. Safe. Secure. Your gear will be ready. When you need it. When your life depends on it. When everything depends on it.</p>
                               <p>Your foresight preserves your equipment. Your quality. Your edge. In a world where everything breaks. Everything fails. Everything rusts. You've kept something whole. Something useful. Something that might save you.</p>`;
                    } else {
                        return `<p>You try. Wrap it. Cover it. Protect it. But saltwater finds a way. Always finds a way. Your bowstrings soak. Stretch. Weaken. Your equipment suffers. Your edge dulls. Your advantage fades.</p>
                               <p>You'll need to repair. Or replace. When you land. If you land. If you have time. If you have coin. If you have luck. But for now, you're weaker. Less ready. Less able. And you know it.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        gameState.equipment.weapon.quality = Math.min(2, gameState.equipment.weapon.quality + 1);
                    } else if (result) {
                        gameState.equipment.weapon.quality = Math.max(0, gameState.equipment.weapon.quality - 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            channel_help: {
                title: "Helping the Sick",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>Men retch. Over the side. On the deck. Everywhere. The smell is terrible. The sound is worse. Groans. Curses. Prayers. The ship rolls. They roll with it. Helpless. Hopeless. Just trying to survive.</p>
                                           <p>You move among them. The sick. The weak. The broken. Someone has to help. Someone has to keep order. Someone has to keep them from giving up. From giving in. From letting the sea take them.</p>`;
                    if (result.success) {
                        return `<p>You help them. Give them water. Keep them calm. Maintain order. Your leadership holds. Your voice steadies. The men focus. Despite the misery. Despite the fear. Despite everything.</p>
                               <p>Morale improves. Slowly. Gradually. But it improves. The risk of desertion decreases. The risk of panic fades. You've done something. Something small. Something important. Something that might save lives. Might save the mission. Might save yourself.</p>`;
                    } else {
                        return `<p>You try to help. Move among them. Give water. Offer comfort. But the chaos overwhelms you. Too many sick. Too much suffering. Too little you can do. Too little that matters.</p>
                               <p>You're shaken. Not by danger. Not by fear. By helplessness. By the weight of suffering you can't ease. By the faces of men you can't save. By the knowledge that sometimes trying isn't enough. Sometimes nothing is enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            saint_vaast_landing: {
                title: "Saint-Vaast Landing",
                year: 1346,
                age: 27,
                location: "Saint-Vaast-la-Hougue, Normandy",
                artwork: "artwork/naval-battle-2.png", // Naval battle with ships and coastal city
                artworkCaption: "Landing at Saint-Vaast-la-Hougue",
                text: `<p><strong>12 July 1346 ‚Äî Saint-Vaast-la-Hougue / Cotentin</strong></p>
                       <p>The shoreline looks quiet until you notice how many doors are barred. Men spill out and form ranks. The order is simple: move inland, take what can be taken, and keep moving.</p>`,
                choices: [
                    {
                        text: "Scout the first mile inland",
                        effects: {},
                        nextScene: "landing_scout",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Join the first raid party",
                        effects: {},
                        nextScene: "landing_raid",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Stay with the banner",
                        effects: {},
                        nextScene: "landing_banner",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    }
                ]
            },
            landing_scout: {
                title: "Scouting Inland",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move forward. Cautiously. Every step measured. Every sound noted. The land is foreign. Unknown. Dangerous. You don't know what's ahead. What's waiting. What's watching.</p>
                                           <p>You scout. Look for water. Look for threats. Look for anything that might help. Or hurt. Because in this land, everything can be either. Everything can be both.</p>`;
                    if (result.success) {
                        return `<p>You find it. A stream. Clean water. Good ground for a camp. Safe. Or safe enough. You mark the route. Remember the landmarks. The dangers. The advantages.</p>
                               <p>You return. Report. The unit benefits. Your reconnaissance saves time. Saves lives. Maybe. Your initiative improves morale. Keeps everyone safer. For now. For this moment. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You stumble into them. French scouts. Three of them. Maybe four. You don't have time to count. Just fight. Just survive. You fight your way out. But not without cost. Not without blood.</p>
                               <p>You've learned. The land is not empty. Not safe. Not yours. The enemy is here. Watching. Waiting. Ready. You've learned the hard way. The only way that matters. The only way that sticks.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        const woundRoll = Math.random();
                        if (woundRoll < 0.4) {
                            addCondition('Wounded', 'negative', 2);
                        }
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            landing_raid: {
                title: "The First Raid",
                year: 1346,
                age: 27,
                location: "Normandy",
                artwork: "artwork/naval-battle-3.png", // Another naval battle scene
                artworkCaption: "The first raid on French soil",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You join the raiders. Move fast. Move hard. No time for mercy. No time for thought. Just action. Just taking. Just doing what soldiers do. What you've been trained to do. What you're paid to do.</p>
                                           <p>The village ahead. Small. Defenseless. Full of things you need. Things you want. Things that will make you richer. Make you safer. Make you better. That's what you tell yourself. That's what you have to believe.</p>`;
                    if (result.success) {
                        return `<p>You take what you can. Silver. Food. Cloth. Anything of value. Anything that might help. Anything that might be worth something. You fill your pack. Fill your pockets. Fill your hands.</p>
                               <p>You're richer. Better equipped. Better prepared. But the villagers' hatred follows you. Their eyes. Their curses. Their silent promises. Resentment grows. Hatred takes root. You've fed yourself. But you've planted seeds. Seeds that will grow. That will bear fruit. Bitter fruit.</p>`;
                    } else {
                        return `<p>The chaos swallows you. Too many men. Too much noise. Too much confusion. You get separated. Lost. Alone in enemy land. You find your way back. Eventually. But you're shaken. The experience haunts you.</p>
                               <p>The raid was more chaotic than you expected. More brutal. More real. You thought you were ready. You weren't. You thought you understood. You didn't. War is always worse than you imagine. Always more. Always less.</p>`;
                    }
                },
                onEnter: function() {
                    const sceneKey = `landing_raid_${gameState.year}`;
                    if (!gameState.enteredScenes.has(sceneKey)) {
                        const result = gameState.lastResolution;
                        if (result && result.success) {
                            applyStatChange('wealth', 5);
                            setFlag('Resentment', true);
                            applyStatChange('stress', 1);
                            
                            // Small chance to find equipment
                            if (Math.random() < 0.3) {
                                if (!gameState.inventory) gameState.inventory = [];
                                if (!gameState.inventory.find(i => i.id === 'buckler')) {
                                    gameState.inventory.push({
                                        id: 'buckler',
                                        condition: 70,
                                        fit: 'salvage',
                                        stackCount: 1
                                    });
                                    showNotification('Equipment Found', 'You salvaged a Buckler from the raid!');
                                }
                            }
                        } else if (result) {
                            addCondition('Shaken', 'negative', 1);
                            applyStatChange('stress', 1);
                        }
                        gameState.enteredScenes.add(sceneKey);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            landing_banner: {
                title: "Staying with the Banner",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The banner waves. Your anchor. Your guide. Your reason. You stay close. Stay disciplined. Stay where you're supposed to be. Where you're ordered to be. Where you're safe.</p>
                                           <p>Others break ranks. Run forward. Chase plunder. Chase glory. Chase death. But you stay. Hold your position. Do your duty. Because that's what soldiers do. That's what you do. That's who you are.</p>`;
                    if (result.success) {
                        return `<p>You stay disciplined. Stay close. Stay ready. The captain notices. Your reliability. Your steadiness. Your willingness to do what's needed. Not what's wanted. Not what's easy. What's needed.</p>
                               <p>You've earned favor. Avoided chaos. Avoided danger. Avoided the things that kill men. The things that break them. You've done right. Done well. Done what you should. That's something. That's enough.</p>`;
                    } else {
                        return `<p>They mock you. Call you timid. Call you coward. Call you names that cut. That hurt. That make you doubt. The taunts get under your skin. Into your head. Into your heart. You made the safe choice. The smart choice. But it doesn't feel that way.</p>
                               <p>Your morale suffers. Your confidence wavers. Your certainty fades. You did right. You know you did right. But knowing doesn't help. Doesn't stop the doubt. Doesn't stop the shame. Sometimes doing right feels wrong. Sometimes being safe feels like failure.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            chevauch√©e_burn: {
                title: "Chevauch√©e: The Burn Line",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: `<p><strong>Mid-July 1346 ‚Äî Normandy villages</strong></p>
                       <p>You smell smoke before you see it. The raid is not "battle," it's pressure: make the countryside bleed wealth and confidence, force the enemy to respond, and keep the army fed while doing it.</p>`,
                choices: [
                    {
                        text: "Torch barns to deny supplies",
                        effects: {},
                        nextScene: "chevauch√©e_torch",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Take hostages for safe passage",
                        effects: {},
                        nextScene: "chevauch√©e_hostages",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Spare a church and move on",
                        effects: {},
                        nextScene: "chevauch√©e_spare",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    }
                ]
            },
            chevauch√©e_torch: {
                title: "The Burn Line",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The barns stand ahead. Full of grain. Full of hay. Full of everything the enemy needs. Everything the villagers need. Everything that keeps people alive. Keeps them fed. Keeps them going.</p>
                                           <p>You approach. Torch in hand. Orders in mind. Duty in heart. But something else too. Something you don't want to name. Something you don't want to feel. But you feel it anyway. You always feel it.</p>`;
                    if (result.success) {
                        return `<p>You torch them. Efficiently. Quickly. The fire spreads. Takes hold. Burns bright. Burns hot. Burns everything. The grain. The hay. The hope. The future. You've denied supplies to the enemy. Done your job. Done what you were told.</p>
                               <p>The captain approves. Nods. Moves on. But you watched it burn. Watched the smoke rise. Watched the light fade. The weight of what you've done settles on you. Heavy. Real. Permanent. Your morale suffers. Your soul suffers. But you did it. You always do it.</p>`;
                    } else {
                        return `<p>You torch the barns. But the wind shifts. Changes direction. Turns against you. Your own baggage train catches fire. Your own supplies. Your own food. Your own hope. You've cost the unit. Cost yourself. Cost everything.</p>
                               <p>Your mistake is costly. In wealth. In reputation. In trust. In everything that matters. Everything you need. You tried to do right. Did what you were told. But it went wrong. It always goes wrong. Eventually. Always.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('wealth', -3);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            chevauch√©e_hostages: {
                title: "Taking Hostages",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The villagers stand before you. Fearful. Resigned. Waiting. They know what's coming. They've seen it before. Heard the stories. Lived the nightmares. Now it's their turn. Their moment. Their fate.</p>
                                           <p>You approach. Sword in hand. Purpose in mind. But something else too. Something you don't want to think about. The faces. The eyes. The humanity. The people. Not enemies. Not targets. People. Just people.</p>`;
                    if (result.success) {
                        return `<p>You take them. Hostages. Bargaining chips. Currency. You negotiate. Safe passage. Their freedom. Their lives. They'll pay. They always pay. Because they have to. Because they want to live. Because there's no other choice.</p>
                               <p>You've established a network. A system. A way to profit from fear. From desperation. From the simple human need to survive. This could be profitable. Very profitable. But it comes with a cost. A weight. A burden. The knowledge of what you've done. What you've become.</p>`;
                    } else {
                        return `<p>You try to take them. Grab them. Hold them. But one escapes. Slippery. Fast. Desperate. He runs. Disappears. Gets away. He'll tell others. Warn them. Prepare them. Make them ready. Make them dangerous.</p>
                               <p>The risk of ambush increases. The risk of death grows. You've made enemies. Real enemies. People who know your face. Who remember. Who wait. Who plan. Who will find you. Eventually. Always. That's how it works. That's how it always works.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 8);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        setFlag('Ambush Risk', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            chevauch√©e_spare: {
                title: "Sparing the Church",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The church stands. Stone. Ancient. Sacred. Or supposed to be. Supposed to mean something. Supposed to be protected. Respected. Left alone. But war doesn't respect. War doesn't protect. War doesn't care.</p>
                                           <p>You look at it. The cross. The walls. The silence. The peace. Or what's left of it. What war hasn't taken. What soldiers haven't destroyed. Yet. Because everything gets destroyed. Eventually. Everything gets taken. Everything gets broken.</p>`;
                    if (result.success) {
                        return `<p>You spare it. Order your men to move on. Leave it alone. Leave it whole. Leave it sacred. Some of your men respect the gesture. Nod. Understand. Or pretend to. Others don't. Others grumble. Others resent. But you did it. You made the choice. The right choice. The hard choice.</p>
                               <p>Your mercy improves morale. Reduces resentment. Makes you human. Makes you different. Makes you better. Or at least less worse. That's something. That's enough. Sometimes that's all you can hope for. All you can be.</p>`;
                    } else {
                        return `<p>You try to spare it. Give the order. Make the gesture. But your squad ignores you. Laughs. Moves past. Takes what they want. Does what they want. Does what soldiers do. What you're all supposed to do. What you're all trained to do.</p>
                               <p>You've lost control. Lost favor. Lost respect. The captain sees you as weak. Your men see you as weak. You see yourself as weak. Because you tried to be good. Tried to be better. Tried to be human. But in war, humanity is weakness. Mercy is failure. And you've failed. Again. Always.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        if (hasFlag('Resentment')) {
                            setFlag('Resentment', false);
                        }
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            caen_bridge: {
                title: "Caen: The Bridge Rush",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: `<p><strong>26 July 1346 ‚Äî Caen</strong></p>
                       <p>Orders exist. Then the first men sprint, and the town becomes a magnet for hunger, bravado, and unpaid grudges. Bridges choke with bodies. Someone shouts that the castle is still holding. Someone else shouts about silver in the new town.</p>`,
                choices: [
                    {
                        text: "Hold your file and push the bridge",
                        effects: {},
                        nextScene: "caen_bridge_hold",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Break ranks for loot",
                        effects: {},
                        nextScene: "caen_bridge_loot",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Take a noble prisoner instead of killing",
                        effects: {},
                        nextScene: "caen_bridge_prisoner",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    }
                ]
            },
            caen_bridge_hold: {
                title: "Holding the Bridge",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The bridge chokes with bodies. Men pushing. Shoving. Fighting. Dying. The crush is terrible. The noise is worse. Steel on steel. Screams. Curses. Prayers. Everything mixed. Everything loud.</p>
                                           <p>You push forward. Hold your file. Keep formation. Keep discipline. Keep moving. Because that's what you do. That's what you're trained to do. That's what keeps you alive. Keeps your men alive.</p>`;
                    if (result.success) {
                        return `<p>You hold. Push. Break through. Your unit follows. Your discipline holds. Your courage shows. Your leadership matters. You break through. Get across. Get to the other side. Get to safety. Or what passes for safety.</p>
                               <p>Your leadership earns favor. Significant favor. Your men respect you. Trust you. Follow you. Because you did it. You got them through. You kept them alive. For now. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You push forward. Try to hold. Try to break through. But the crush is too much. Bodies everywhere. Weapons everywhere. Death everywhere. Something finds you. A blade. A spear. A piece of metal. It doesn't matter what. Just that it does. Just that you're wounded.</p>
                               <p>You've taken a serious injury. In the chaos. In the fight. In the bridge. You're bleeding. Hurting. Broken. But you're alive. For now. That's something. That's enough. Sometimes that's all you get.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            caen_bridge_loot: {
                title: "Breaking for Loot",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The town opens. Houses. Shops. Wealth. Everything you've been promised. Everything you've been fighting for. Everything that makes this worth it. Worth the risk. Worth the death. Worth the blood.</p>
                                           <p>You break ranks. Run forward. Grab what you can. Because you can. Because you want to. Because you need to. Because this is your chance. Your moment. Your reward. For everything. For all of it.</p>`;
                    if (result.success) {
                        return `<p>You grab it. Silver. Cloth. Jewelry. Anything valuable. Anything worth something. You fill your hands. Fill your pack. Fill your pockets. You're richer. Better off. Better equipped. Better prepared. For what comes next. For what always comes next.</p>
                               <p>But you've broken discipline. Broken formation. Broken trust. This will be remembered. Noted. Held against you. When you need it. When it matters. When the captain decides. When your fate is decided. You've gained wealth. But you've lost something. Something that might matter more. Eventually. Always.</p>`;
                    } else {
                        return `<p>You're caught. Breaking ranks. Grabbing loot. Doing what you're not supposed to do. What you're not allowed to do. The captain sees. Gets furious. Calls you out. Makes you pay. Makes you regret. Makes you remember.</p>
                               <p>You've lost favor. Significant favor. And maybe your health. Maybe your life. Because in the chaos, something happened. Something bad. Something that might kill you. Might break you. Might end you. All for loot. All for greed. All for nothing. Everything.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 10);
                        setFlag('Discipline', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -2);
                        const woundChance = Math.random();
                        if (woundChance < 0.5) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            caen_bridge_prisoner: {
                title: "Taking a Noble Prisoner",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see him in the chaos. A noble. Fine armor. Rich clothes. Worth something. Worth everything. Worth a fortune. Worth your future. Worth your life. If you can take him. If you can keep him. If you can make him pay.</p>
                                           <p>The choice is simple. Kill him. Or take him. One ends a life. The other starts a fortune. One is final. The other is opportunity. One is war. The other is business. You have to decide. Now. Before someone else does. Before it's too late.</p>`;
                    if (result.success) {
                        return `<p>You take him. Prisoner. Captive. Currency. He's worth a fortune. In ransom. In connections. In everything that matters. In everything you need. You've secured him. Kept him alive. Kept him whole. For now. For later. For when you need him.</p>
                               <p>You've established yourself. In the ransom trade. In the business of war. In the economy of survival. This could change everything. Your wealth. Your status. Your future. If you can keep him. If you can make him pay. If you can survive long enough to collect.</p>`;
                    } else {
                        return `<p>You try to take him. Grab him. Hold him. But the chaos swallows you. Others grab him. Drag him away. Claim him. Take what's yours. What could have been yours. What should have been yours. But isn't. Not anymore. Not ever.</p>
                               <p>You're shaken. By the missed opportunity. By the violence. By the loss. By everything you've seen. Everything you've done. Everything you've failed to do. The chance is gone. The fortune is lost. The future is dimmer. But you're alive. That's something. That's all you have.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 20);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            prisoner_argument: {
                title: "The Prisoner Argument",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: `<p><strong>Late July 1346 ‚Äî Outside Caen</strong></p>
                       <p>A captured man-at-arms sits on the ground, helmet off, eyes flat. Two of your men both claim him. The law here is not clean. The stakes are not abstract: ransoms can change a life, and disputes can end in knives behind tents.</p>`,
                choices: [
                    {
                        text: "Demand a formal witness and division",
                        effects: {},
                        nextScene: "prisoner_formal",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Split the claim",
                        effects: {},
                        nextScene: "prisoner_split",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Steal the purse and walk away",
                        effects: {},
                        nextScene: "prisoner_steal",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            prisoner_formal: {
                title: "Formal Division",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>Two men. One prisoner. Two claims. One truth. Or maybe no truth. Just greed. Just want. Just the need to profit from another man's capture. Another man's life.</p>
                                           <p>You step forward. Into the dispute. Into the danger. Because someone has to. Because if you don't, blood will flow. Lives will be lost. And you can't let that happen.</p>`;
                    if (result.success) {
                        return `<p>You demand it. Formal witnesses. Fair division. Proper law. Proper order. The dispute resolves. Without blood. Without death. Without everything that could have gone wrong.</p>
                               <p>Your leadership prevents a feud. Stops a war. Saves lives. The captain sees. Appreciates. Notices your judgment. Your courage. Your willingness to do what's right. Even when it's hard. Even when it's dangerous.</p>`;
                    } else {
                        return `<p>Both sides turn on you. Against you. Your attempt at fairness makes enemies. Your attempt at justice makes targets. Your attempt at right makes wrong. Everything backfires. Everything goes bad.</p>
                               <p>Your morale suffers. From the conflict. From the failure. From the knowledge that trying isn't enough. That doing right isn't enough. Sometimes nothing is enough. Sometimes everything fails.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            prisoner_split: {
                title: "Splitting the Claim",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The solution is simple. Obvious. Split it. Divide it. Share it. Everyone gets something. No one gets everything. No one gets nothing. Fair. Or fair enough. Or as fair as war allows.</p>
                                           <p>You propose it. The split. The division. The compromise. Because compromise is better than conflict. Because sharing is better than fighting. Because something is better than nothing.</p>`;
                    if (result.success) {
                        return `<p>You split it. The claim. The ransom. The fortune. Between the two men. Everyone gets something. A share. A piece. The dispute ends. The conflict stops. The blood doesn't flow. For now. That's something. That's enough.</p>
                               <p>You've avoided escalation. Prevented death. Saved lives. And secured a share for yourself. Small. But something. A reward for doing right. For doing well. For doing what needed doing when no one else would.</p>`;
                    } else {
                        return `<p>The scuffle breaks out. Before you can resolve it. Before you can stop it. The prisoner dies. In the chaos. In the fight. In the greed. You're left with nothing. But guilt. But shame. But the knowledge of what you failed to prevent.</p>
                               <p>You're shaken. By the death. By the senselessness. By the waste. By everything that went wrong. Everything you couldn't stop. A man died. For nothing. For greed. For everything that makes war terrible.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 3);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            prisoner_steal: {
                title: "Stealing the Purse",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see it. An opportunity. A chance. The purse. Full. Heavy. Valuable. Worth something. Worth taking. Worth stealing. If you're fast. If you're careful. If you're willing.</p>
                                           <p>The choice is simple. Take it. Or leave it. Steal it. Or respect it. Betray them. Or honor them. The purse calls. The greed calls. Louder than honor. Louder than loyalty. Louder than everything that should matter.</p>`;
                    if (result.success) {
                        return `<p>You steal it. Take it. Slip away. Fast. Quiet. Gone. You're richer. Better off. Better equipped. For what comes next.</p>
                               <p>But you've betrayed them. Your comrades. Your friends. Your brothers. The men who trust you. The men who depend on you. And you've stolen from them. Betrayed them. For wealth. For greed.</p>
                               <p>You've gained wealth. But lost honor. Lost trust. Lost everything that matters. Everything that makes you human. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    } else {
                        return `<p>You're caught. Stealing. Taking. Betraying. The punishment is severe. The reputation is ruined. The trust is lost. Everything you've built. Everything you've earned. Everything you've become. Gone. In a moment. In a choice. In a mistake. That you can't take back. That you can't undo. That you can't fix.</p>
                               <p>You've lost favor. Significant favor. And trust. The trust of your unit. The trust of your captain. The trust of everyone who matters. Everyone who cared. Everyone who believed in you. They don't anymore. They won't. Not ever. Not again. You've broken it. Destroyed it. Killed it. For nothing. For greed. For everything that doesn't matter. But does. Always does.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 5);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -3);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            denuded_country: {
                title: "Denuded Country",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: `<p><strong>Early‚ÄìMid August 1346 ‚Äî Northward march</strong></p>
                       <p>The French have stripped the land ahead: grain hauled off, wells fouled, bridges watched or broken. The army gets ragged. Men eat things they won't name. Someone suggests slaughtering baggage horses. Someone else suggests hanging thieves. Both are called "discipline."</p>`,
                choices: [
                    {
                        text: "Forage with restraint (pay or barter)",
                        effects: {},
                        nextScene: "denuded_forage",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Slaughter a horse for the pot",
                        effects: {},
                        nextScene: "denuded_horse",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Make an example of a thief",
                        effects: {},
                        nextScene: "denuded_thief",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    }
                ]
            },
            denuded_forage: {
                title: "Foraging with Restraint",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The villagers watch you. Fearful. Resigned. They've seen soldiers before. They know what to expect. Taking. Demanding. Threatening. That's how it works.</p>
                                           <p>You approach slowly. Show your hands. No weapons. Just coins. Just barter. Just the promise of fairness. In a world that offers little. In a war that takes everything. You try to be different. Try to be better.</p>`;
                    if (result.success) {
                        return `<p>You forage with restraint. Pay. Barter. Trade fairly. The villagers stare. Disbelieving. Then grateful. One old man weeps. You didn't expect that. Didn't expect how much a small kindness could mean.</p>
                               <p>You've reduced resentment. Secured supplies. Without violence. Without blood. Without everything that makes war terrible. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>They lie. About what they have. About what they need. You find nothing. Search. Look. Dig. But nothing. Empty. Barren. Stripped. Like the land. Like the people. Your unit goes hungry. You go hungry.</p>
                               <p>Your morale suffers. From the failure. From the hunger. From the knowledge that trying isn't enough. That being fair isn't enough. Sometimes nothing is enough. Sometimes everything fails.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        if (hasFlag('Resentment')) {
                            setFlag('Resentment', false);
                        }
                    } else if (result) {
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            denuded_horse: {
                title: "Slaughtering a Horse",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The horse stands. Tired. Thin. But alive. Still useful. Still valuable. Still a friend. Or supposed to be. Supposed to mean something. But hunger changes things. Changes priorities. Changes what you're willing to do.</p>
                                           <p>You look at it. The eyes. The trust. The bond. Or what's left of it. What war hasn't broken. What hunger hasn't destroyed. Yet. Because everything gets destroyed. Eventually. Everything gets used. For food. For survival.</p>`;
                    if (result.success) {
                        return `<p>You do it. Slaughter it. Kill it. For the pot. For the men. For survival. The men are fed. Morale improves. Hunger fades. For now. That's something. That's enough.</p>
                               <p>But you've lost a mount. A friend. A companion. You'll be on foot. When speed matters. When escape matters. You've traded one advantage for another. One life for others. That's how it works.</p>`;
                    } else {
                        return `<p>You can't do it. Can't bring yourself to kill it. To end it. Or you watch someone else do it. Someone else make the choice. Someone else bear the weight. The sight shakes you. The sound. The smell. It all shakes you. Breaks you.</p>
                               <p>You're shaken. By what you've seen. By what you've failed to do. By what you've allowed. The guilt. The shame. The knowledge that you're part of this. That you're complicit. For the death. For the waste. For everything that makes war terrible.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Lame Mount', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            denuded_thief: {
                title: "Making an Example",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>They catch him. A thief. Stealing rations. Taking what isn't his. What he needs. What everyone needs. But he took it. Stole it. Betrayed them. For hunger. For greed. For survival.</p>
                                           <p>You see him. Caught. Helpless. Waiting for judgment. For punishment. For death. Maybe. Or maybe something worse. Something that makes an example. Something that teaches. Something that's supposed to prevent. Supposed to stop. But never does.</p>`;
                    if (result.success) {
                        return `<p>You make an example. Harsh. Public. Terrible. Desertion decreases. Discipline improves. Fear grows. Respect fades. But order holds. For now. That's something. That's enough.</p>
                               <p>Your harsh justice earns favor. With the captain. With the officers. With everyone who matters. Everyone who decides. You've done what they wanted. What they needed. That's something.</p>`;
                    } else {
                        return `<p>Your attempt backfires. The squad turns cold. Sees you as a tyrant. As a monster. As everything they fear. Everything they hate. But you are. You've become. You've made yourself into this.</p>
                               <p>Your morale suffers. From the isolation. From the fear. From the knowledge that you've lost them. Lost their trust. Lost their respect. Lost everything that matters. You've gained favor. But lost yourself. For nothing. For order.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            blanchetaque_ford: {
                title: "Blanchetaque: Tidal Ford",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: `<p><strong>24 August 1346 ‚Äî Somme crossing at Blanchetaque</strong></p>
                       <p>The ford is wide, the mud grabs ankles, and the tide is a clock you can't argue with. Crossbow bolts skip off the water like stones. Men try to keep powder-dry things dry in a world made of river.</p>`,
                choices: [
                    {
                        text: "Wade first with the forward file",
                        effects: {},
                        nextScene: "blanchetaque_wade",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Hold formation and cover others",
                        effects: {},
                        nextScene: "blanchetaque_cover",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Drag a drowning man out",
                        effects: {},
                        nextScene: "blanchetaque_rescue",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    }
                ]
            },
            blanchetaque_wade: {
                title: "Wading First",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The water is cold. Deep. Dangerous. The mud grabs. Pulls. Holds. The tide is coming. Rising. Threatening. Crossbow bolts skip off the water. Off the mud. Death is everywhere. Waiting. Watching.</p>
                                           <p>You step into it. The water. The danger. Because someone has to. Because if you don't, no one will. And someone will die. That's certain. That's war.</p>`;
                    if (result.success) {
                        return `<p>You wade first. Lead the way. Across the ford. Through the danger. Through the death. The forward file follows. Your courage shows. Your leadership matters. Your example inspires. Your comrades follow. Trust you. Because you did it. You went first. You risked everything.</p>
                               <p>Your courage earns favor. Significant favor. And respect. And trust. You've done it. Done right. Done well. Done what needed doing when no one else would. That's something. That's enough.</p>`;
                    } else {
                        return `<p>The crossing is brutal. Terrible. Deadly. You take a bolt. Or fall in the mud. Or something else. Something bad. You're injured. Wounded. Broken. But you're alive. For now. That's something. That's all you have.</p>
                               <p>You've been wounded. In the crossing. In the danger. You're hurt. But you're across. On the other side. Safe. Or safe enough. As safe as war allows.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        const woundRoll = Math.random();
                        if (woundRoll < 0.6) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            blanchetaque_cover: {
                title: "Covering Others",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take position. Shield raised. Eyes forward. Watching. Waiting. Ready. Others cross behind you. Trusting you. Depending on you. To hold. To cover. To protect. To keep them alive.</p>
                                           <p>The water churns. The mud grabs. The bolts fly. Death is everywhere. Waiting. Watching. But you hold. You cover. You do your job. Because that's what you do. That's what you're trained to do.</p>`;
                    if (result.success) {
                        return `<p>You hold formation. Cover others. Keep them safe. Your tactical sense shows. Reduces injuries. Saves lives. Makes a difference. In the chaos. In the danger. When only survival matters.</p>
                               <p>Your leadership improves morale. Saves lives. Makes you human. Makes you good. Or at least less bad. Less terrible. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>Chaos erupts. Despite your efforts. Despite your best. The crossing becomes a disaster. Men fall. Die. Drown. In the water. In the mud. In the danger. You couldn't stop it. Couldn't prevent it. Couldn't save them.</p>
                               <p>You're shaken. By the failure. By the suffering. By everything you couldn't prevent. Everything you couldn't stop. The guilt. The shame. The knowledge that you failed. That you weren't enough. Sometimes nothing is enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            blanchetaque_rescue: {
                title: "Rescuing a Drowning Man",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see him. Struggling. In the water. In the mud. In the danger. Drowning. Dying. Fighting for air. For life. Just trying to survive. Like you. Like everyone.</p>
                                           <p>The choice is simple. Help him. Or leave him. Save him. Or let him die. Risk yourself. Or save yourself. The water is cold. The danger is real. The choice is yours.</p>`;
                    if (result.success) {
                        return `<p>You drag him to safety. To life. He'll remember. This moment. This choice. This debt. You've gained an ally. A friend. A brother. Someone who owes you. Someone who will help you when you need it.</p>
                               <p>Your heroism improves morale. Saves a life. Makes a difference. May help you later. May save you. In the future. In the danger. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You try to rescue him. To save him. To help him. But the effort exhausts you. Drains you. Breaks you. You lose time. Lose ground. The enemy pressure increases. The danger grows. The chance is gone.</p>
                               <p>You're fatigued. Empty. Broken. And the enemy is coming. The danger is growing. You tried. That's something. But trying isn't enough. Sometimes nothing is enough. Sometimes everything fails.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Ally', true);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            battle_crecy: {
                title: "The Battle of Cr√©cy, 1346",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                artwork: "artwork/battle-scene-2.jpg", // Mountainous battle scene with French vs English
                artworkCaption: "The Battle of Cr√©cy - 26 August 1346",
                text: `<p><strong>‚ö†Ô∏è HISTORICAL EVENT: The Battle of Cr√©cy - 26 August 1346</strong></p>
                       <p>A sudden rain breaks, then stops. Bowstrings are handled like lifelines. The French come on late, crowded, impatient. You hear the word "oriflamme" and understand what that implies for anyone taken alive. The first line wavers; the second line steps on them.</p>`,
                choices: [
                    {
                        text: "Stay planted in the defensive line",
                        effects: {},
                        nextScene: "crecy_defensive",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Run forward to strip a fallen noble",
                        effects: {},
                        nextScene: "crecy_loot",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Pull wounded back under fire",
                        effects: {},
                        nextScene: "crecy_rescue",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    }
                ]
            },
            crecy_defensive: {
                title: "Holding the Line",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take your position. In the line. In the formation. The French come. Thousands. Too many. More than you can count. More than you can imagine. But you hold. You stand. You do your job. Because that's what you do. That's what you're trained to do.</p>
                                           <p>The longbowmen ready. Arrows nocked. Strings drawn. Waiting for the signal. For the order. For the moment when everything changes. When everything breaks.</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You stay planted. In the line. In the formation. Holding your position. With discipline. With courage. With everything you have. The longbowmen do their work. Arrows fly. Death comes. But not for you. Not today. Not here.</p>
                               <p>You survive. The battle. The danger. Your courage earns favor. Significant favor. Your discipline shows. Your morale is strong. Your will holds. For now. That's something. That's enough.</p>`;
                    } else {
                        return `${rollDisplay}<p>The battle is fierce. Terrible. Deadly. You hold. As long as you can. As hard as you can. As well as you can. But something finds you. A blade. An arrow. A piece of metal. It doesn't matter what. Just that it does. Just that you're wounded. Just that you're hurt.</p>
                               <p>You've been wounded. But you survived. Cr√©cy. The battle. The danger. You're alive. For now. That's something. That's all you have. Sometimes that's all you get.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('experience', 20);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_loot: {
                title: "Stripping the Fallen",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see him. A fallen noble. Rich armor. Fine clothes. Worth something. Worth everything. Worth a fortune. Worth your future. If you can take it. If you can keep it. If you can make it yours. Before someone else does. Before it's too late. Before the moment passes.</p>
                                           <p>The choice is simple. Strip him. Or leave him. Take his wealth. Or respect his death. Profit from his fall. Or honor his memory. The arrows still fly. The danger is real. But the opportunity calls. The greed calls. The need calls. Louder than honor. Louder than respect. Louder than everything that should matter. But doesn't. Not now. Not here. Not in this moment.</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You run forward. Fast. Desperate. Greedy. Strip him. Take his valuables. His wealth. You're richer. Better off. Better equipped. For what comes next.</p>
                               <p>But you've dishonored yourself. Lost your honor. Lost your respect. Lost everything that makes you human. You've gained wealth. But lost honor. Lost trust. Lost yourself. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    } else {
                        return `${rollDisplay}<p>You're nearly hit. By arrows. By danger. Or injured. In the attempt. In the greed. You're shaken. Possibly wounded. Definitely scared. By the risk. By the failure. By everything that went wrong.</p>
                               <p>You've risked everything. For nothing. For greed. For want. You tried. That's something. But trying isn't enough. Sometimes nothing is enough. Sometimes everything fails.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 15);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 2);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        const woundChance = Math.random();
                        if (woundChance < 0.4) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 3);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_rescue: {
                title: "Pulling Wounded Back",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see them. Wounded men. Bleeding. Dying. Calling. For help. For mercy. For someone. For you. Maybe. If you're willing. If you're able. If you're brave enough. Or stupid enough. Or human enough. To risk yourself. To save them. To do what's right. Even when it's wrong. Even when it's dangerous. Even when it costs you.</p>
                                           <p>The arrows still fly. The danger is real. The moment is now. The choice is yours. Help them. Or leave them. Save them. Or let them die. Risk yourself. Or save yourself. The decision is everything. Or nothing. Always.</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You pull them back. Under fire. Through danger. Through death. Your heroism shows. Saves lives. Reduces losses. Makes a difference. In the chaos. When only survival matters.</p>
                               <p>Your courage improves morale. Earns respect. Makes you human. Makes you good. Or at least less bad. Less terrible. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `${rollDisplay}<p>You try to rescue them. To save them. To help them. But you're wounded. In the attempt. In the danger. And exhausted. Drained. Broken. By the effort. By the risk. By the knowledge that trying isn't enough.</p>
                               <p>You've been wounded. And fatigued. But you tried. To do the right thing. To be human. To be good. That's something. That's enough. Sometimes trying is enough. Sometimes being human is enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        applyStatChange('experience', 15);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_night: {
                title: "Night on the Field",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: `<p><strong>Night of 26 August 1346 ‚Äî Outside Cr√©cy</strong></p>
                       <p>The field isn't quiet; it's busy in a different way. You can hear metal being unbuckled in the dark. Some men look for friends. Some look for profit. Some look for a way to sleep without dreaming.</p>`,
                choices: [
                    {
                        text: "Focus on wounded and water",
                        effects: {},
                        nextScene: "crecy_night_wounded",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Strip gear carefully (not greedily)",
                        effects: {},
                        nextScene: "crecy_night_gear",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Hunt for captives worth ransom",
                        effects: {},
                        nextScene: "crecy_night_ransom",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    }
                ]
            },
            crecy_night_wounded: {
                title: "Tending the Wounded",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move among the wounded...</p>`;
                    if (result.success) {
                        return `<p>You focus on the wounded and securing water. Your care helps many, and you find some peace in useful work.</p>
                               <p>You've removed shaken or fatigued conditions and improved morale through service.</p>`;
                    } else {
                        return `<p>You try to help, but you miss a curable wound that becomes infected. Your failure haunts you.</p>
                               <p>Infection spreads. This will cause problems later.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        if (hasCondition('Shaken')) removeCondition('Shaken');
                        if (hasCondition('Fatigued')) removeCondition('Fatigued');
                        applyStatChange('morale', 1);
                        applyStatChange('stress', -1);
                    } else if (result) {
                        setFlag('Infection', true);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            crecy_night_gear: {
                title: "Stripping Gear Carefully",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                artwork: "artwork/battle-aftermath.jpg", // Post-battle scene with fallen soldiers
                artworkCaption: "The aftermath of battle",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You search the field...</p>`;
                    if (result.success) {
                        return `<p>You strip gear carefully from the fallen. Your careful approach pays off.</p>`;
                    } else {
                        return `<p>You're accused of theft. Your reputation suffers, even though you meant no harm.</p>
                               <p>You've lost favor through misunderstanding.</p>`;
                    }
                },
                onEnter: function() {
                    const sceneKey = `crecy_night_gear_${gameState.year}`;
                    if (!gameState.enteredScenes.has(sceneKey)) {
                        const result = gameState.lastResolution;
                        if (result && result.success) {
                            // Add equipment to inventory
                            if (!gameState.inventory) gameState.inventory = [];
                            
                            // Chance to find various equipment
                            const equipmentChance = Math.random();
                            if (equipmentChance < 0.5) {
                                // Find a better weapon or armor piece
                                const items = ['arming_sword', 'padded_jack', 'kettle_hat'];
                                const foundItem = items[Math.floor(Math.random() * items.length)];
                                if (!gameState.inventory.find(i => i.id === foundItem)) {
                                    gameState.inventory.push({
                                        id: foundItem,
                                        condition: 60 + Math.floor(Math.random() * 30),
                                        fit: 'salvage',
                                        stackCount: 1
                                    });
                                    const itemName = foundItem.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    showNotification('Equipment Found', `You salvaged a ${itemName} from the battlefield!`);
                                }
                            }
                            
                            // Old format compatibility
                            const gearRoll = Math.random();
                            if (gearRoll < 0.5 && gameState.equipment && gameState.equipment.weapon) {
                                gameState.equipment.weapon.quality = Math.min(3, (gameState.equipment.weapon.quality || 0) + 1);
                            } else {
                                applyStatChange('wealth', 8);
                            }
                        } else if (result) {
                            applyStatChange('patronFavor', -1);
                        }
                        gameState.enteredScenes.add(sceneKey);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            crecy_night_ransom: {
                title: "Hunting for Captives",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You search for valuable captives...</p>`;
                    if (result.success) {
                        return `<p>You find a captive worth a fortune in ransom. Your network pays off.</p>
                               <p>You've secured significant wealth and established yourself in the ransom trade.</p>`;
                    } else {
                        return `<p>You're threatened by others hunting the same prize. The danger shakes you.</p>
                               <p>You're shaken by the close call.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 25);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            calais_siege: {
                title: "Calais: The Siege Town",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: `<p><strong>4 September 1346 ‚Äî Calais</strong></p>
                       <p>The work is endless: ditches, stakes, palisades, watch rotations, and the slow mathematics of starvation. A whole little city of tents grows outside the walls. The first weeks feel almost orderly‚Äîuntil the latrines overflow and the water tastes wrong.</p>`,
                choices: [
                    {
                        text: "Dig proper latrines and enforce distance from water",
                        effects: { reputation: 1 },
                        stressCost: 2, // Smart action = costs stress
                        badOutcomeChance: 8, // Low chance (smart action)
                        badOutcomeStupidity: 'smart',
                        badOutcomes: [
                            {
                                chance: 8,
                                condition: 'Infected Foot Cut',
                                statDebuffs: { strength: -2, endurance: -3 },
                                permanent: true,
                                text: "You cut your foot on a sharp stone while digging. The cut becomes infected. You're limping now. The pain is constant.",
                                nextScene: "calais_latrines"
                            }
                        ],
                        nextScene: "calais_latrines",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Volunteer for dangerous night duty",
                        effects: {},
                        nextScene: "calais_night",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Skim from supply wagons",
                        effects: { wealth: 5 },
                        stressCost: 0, // Stupid action = no stress cost
                        badOutcomeChance: 35, // High chance (stupid action)
                        badOutcomeStupidity: 'stupid',
                        badOutcomes: [
                            {
                                chance: 30,
                                condition: 'Caught Stealing',
                                statDebuffs: { reputation: -2, morale: -1 },
                                text: "You're caught. The quartermaster has you flogged. Your reputation suffers.",
                                nextScene: "calais_skim"
                            },
                            {
                                chance: 10,
                                condition: 'Severely Punished',
                                statDebuffs: { reputation: -3, morale: -2, endurance: -1 },
                                text: "You're caught and severely punished. The quartermaster makes an example of you.",
                                nextScene: "calais_skim"
                            }
                        ],
                        nextScene: "calais_skim",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            calais_latrines: {
                title: "Improving Sanitation",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You look at the camp. The filth. The stench. The disease. The death. Everything that kills men. Slowly. Quietly. Without glory. Without honor. Just sickness. Just waste.</p>
                                           <p>The latrines overflow. The water tastes wrong. The air smells of death. Of decay. You know what needs doing. What should be done. What might save lives. If anyone listens. If anyone cares.</p>`;
                    if (result.success) {
                        return `<p>You dig them. Proper latrines. Deep. Far from water. Enforced. Maintained. Clean. Or clean enough. Or as clean as war allows. Disease decreases. In your area. In your section. Lives are saved. Health improves. Hope returns. For now. That's something. That's enough.</p>
                               <p>Your foresight reduces sickness. Earns favor. Makes a difference. In the chaos. In the death. You've done right. Done well. Done what needed doing when no one else would. That's something. That's enough.</p>`;
                    } else {
                        return `<p>They ignore you. Your suggestions. Your efforts. The camp remains unhealthy. Unclean. Unsafe. Men still die. Still get sick. Still suffer. Because no one listened. No one cared. No one was willing.</p>
                               <p>You've tried. That's something. But trying isn't enough. Sometimes nothing is enough. Sometimes everything fails. The knowledge weighs. Heavy. Real. Permanent. You did what you could. But it wasn't enough. It never is.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            calais_night: {
                title: "Night Duty",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>Night duty. Dangerous. Dark. Deadly. The enemy watches. Waits. Plans. Attacks. In the dark. In the silence. In the moment when you're weakest. When you're tired. When you're alone.</p>
                                           <p>You volunteer. Step forward. Take the risk. Because someone has to. Because if you don't, someone else will. And they might not be ready. Might not be able. Might not survive. But you might. You hope. You try.</p>`;
                    if (result.success) {
                        return `<p>You perform well. On the duty. In the danger. Your courage shows. Is noted. Is remembered. By the captain. By your men. By everyone who matters. You've done right. Done well. That's something. That's enough.</p>
                               <p>You've earned favor. Significant favor. And improved morale. Through service. Through courage. Through everything that makes you human. Makes you good. Or at least less bad. Less terrible. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>Night duty is dangerous. Terrible. Deadly. You're wounded. In a skirmish. Or an accident. Or something else. Something bad. You're hurt. But you're alive. For now. That's something. That's all you have.</p>
                               <p>You've been wounded. But you tried. To serve. To do right. To be good. That's something. That's enough. Sometimes trying is enough. Sometimes being human is enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            calais_skim: {
                title: "Skimming Supplies",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You watch them. The wagons. Full. Heavy. Valuable. Worth something. Worth taking. Worth stealing. If you're fast. If you're careful. If you're willing. To risk everything. For nothing. For greed.</p>
                                           <p>The opportunity calls. The greed calls. Louder than honor. Louder than loyalty. Louder than everything that should matter. The choice is simple. Take it. Or leave it. Steal it. Or respect it. The decision is yours.</p>`;
                    if (result.success) {
                        return `<p>You skim from them. The wagons. The supplies. Without being caught. Fast. Quiet. Gone. You're richer. Better off. Better equipped. For what comes next.</p>
                               <p>But you've dishonored yourself. Lost your honor. Lost your respect. Lost everything that makes you human. You've gained wealth. But lost honor. Lost trust. Lost yourself. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    } else {
                        return `<p>You're caught. Stealing. Taking. Betraying. The punishment is severe. The reputation is ruined. The trust is lost. Everything you've built. Everything you've earned. Everything you've become. Gone. In a moment. In a choice. In a mistake. That you can't take back. That you can't undo. That you can't fix.</p>
                               <p>You've lost favor. Significant favor. And trust. The trust of your unit. The trust of your captain. The trust of everyone who matters. Everyone who cared. Everyone who believed in you. They don't anymore. They won't. Not ever. Not again. You've broken it. Destroyed it. Killed it. For nothing. For greed. For everything that doesn't matter. But does. Always does.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 10);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -3);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            winter_flux: {
                title: "Winter 1346‚Äì47: The Flux",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p><strong>Winter 1346‚Äì47 ‚Äî Calais lines / Neuville area</strong></p>
                       <p>Men call it "bad water" until it isn't a joke. The camp shrinks. Rotations get longer. A cook is found watering the stew. A man hangs himself from a wagon frame before dawn and no one claims to have heard anything.</p>`,
                choices: [
                    {
                        text: "Boil water, enforce cleanliness",
                        effects: {},
                        nextScene: "flux_clean",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Buy better food at ruinous prices",
                        effects: {},
                        nextScene: "flux_food"
                    },
                    {
                        text: "Look away and survive",
                        effects: {},
                        nextScene: "flux_survive",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    }
                ]
            },
            flux_clean: {
                title: "Enforcing Cleanliness",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You start boiling it. The water. Because you know what happens if you don't. What happens when men drink bad water. When they get sick. When they die. Slowly. Quietly. Without glory. Without honor. Just sickness. Just waste.</p>
                                           <p>You enforce it. Cleanliness. Distance. Order. Everything that might help. Everything that might save lives. Health. Hope. If anyone listens. If anyone cares.</p>`;
                    if (result.success) {
                        return `<p>You boil it. Enforce it. Maintain it. The water. The cleanliness. The order. You avoid the sickness. That claims so many. That kills so many. You survive. Stay healthy. Stay whole. For now. That's something. That's enough.</p>
                               <p>Your discipline saves you. From the flux. From the death. And earns favor. From the captain. From your men. From everyone who matters. You've done right. Done well. Done what needed doing. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You try to boil it. To enforce it. To maintain it. But you get sick anyway. The flux finds you. Weakens you. Breaks you. Despite your efforts. Despite your best. You're sick. Tired. Broken. By the illness. By the failure. By the knowledge that trying isn't enough.</p>
                               <p>You're fatigued. From the illness. From the weakness. You tried. That's something. But trying isn't enough. Sometimes nothing is enough. Sometimes everything fails. The knowledge weighs. Heavy. Real. Permanent. You did what you could. But it wasn't enough. It never is.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 2);
                        addCondition('Sick', 'negative', 2);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            flux_food: {
                title: "Buying Better Food",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const cost = 15;
                    if (gameState.stats.wealth >= cost) {
                        return `<p>You buy it. Better food. At ruinous prices. Three times what it should cost. Four times. Five. But you pay. Because you have to. Because you need to. Because hunger kills. Slowly. Quietly. Without glory. Without honor. Just weakness. Just waste.</p>
                               <p>You're fed. Your morale improves. Your health holds. For now. That's something. That's enough. You've spent wealth. To prevent fatigue. To maintain health. To stay alive. To stay whole. To stay human. Or what's left of it. What war hasn't broken. Yet.</p>`;
                    } else {
                        return `<p>You can't afford it. Better food. Better health. Better chance of survival. Of living. The hunger grows. The despair deepens. The weakness spreads. Through you. Through your men. The knowledge weighs. Heavy. Real. Permanent. You don't have enough. You never do.</p>
                               <p>You're shaken. By your poverty. By the suffering. By everything you can't change. Everything you can't fix. The guilt. The shame. The knowledge that you're part of this. That you're complicit. For the hunger. For the death. For everything that makes war terrible.</p>`;
                    }
                },
                onEnter: function() {
                    const cost = 15;
                    if (gameState.stats.wealth >= cost) {
                        applyStatChange('wealth', -cost);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', -1);
                    } else {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            flux_survive: {
                title: "Looking Away",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You try to ignore it. The suffering. The death. Because you have to. Because you need to. Because looking means seeing. Seeing means feeling. Feeling means breaking. And you can't break. Not now. Not here. Not when you need to survive. When you need to stay whole. When you need to stay human. Or what's left of it. What war hasn't broken. Yet.</p>
                                           <p>The choice is simple. Look away. Or look. Ignore it. Or see it. Survive through numbness. Or break through feeling. The decision is yours. But you know. Deep down. You know. That looking away costs something. That numbness has a price. That survival comes with a burden. A weight. A debt. That you'll pay. Eventually.</p>`;
                    if (result.success) {
                        return `<p>You look away. Ignore it. Survive through numbness. Through distance. Through everything that keeps you whole. Keeps you alive. Keeps you going. You've hardened yourself. Made yourself cold. Made yourself strong. Or at least strong enough. To survive. To endure. When everything breaks. When everyone dies. When nothing matters but survival.</p>
                               <p>Your emotional distance improves morale. Keeps you whole. Keeps you alive. But at a cost. To your humanity. To your soul. To everything that makes you human. Makes you good. Makes you real. You've gained survival. But lost yourself. Lost your humanity. Lost everything that matters. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    } else {
                        return `<p>You can't look away. Can't ignore it. Can't distance yourself. The suffering shakes you. To your core. To your soul. To everything that makes you human. Makes you good. Makes you real. You see it. Feel it. Break from it. The guilt. The shame. The knowledge that you're part of this. That you're complicit. For the suffering. For the death. For everything that makes war terrible.</p>
                               <p>You're shaken. By what you've witnessed. By what you've seen. By what you've felt. The knowledge weighs. Heavy. Real. Permanent. You can't unsee it. Can't undo it. The suffering. The death. It's part of you now. Until you die. Or until you make it right.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Hardness', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            calais_keys: {
                title: "The Keys of Calais",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p><strong>3‚Äì4 August 1347 ‚Äî Calais surrenders</strong></p>
                       <p>The gates open on terms. Six citizens step out with the keys. You see what starvation does to a wealthy city: not dramatic collapse, just thinning. The king's anger is a thing you can feel in your teeth‚Äîthen it turns, because a queen speaks.</p>`,
                choices: [
                    {
                        text: "Stay disciplined and silent",
                        effects: {},
                        nextScene: "keys_disciplined",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Offer water to a citizen",
                        effects: {},
                        nextScene: "keys_water",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Grab a souvenir (keys/cloth/coin)",
                        effects: {},
                        nextScene: "keys_souvenir",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            keys_disciplined: {
                title: "Staying Disciplined",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You stand at attention. Silent. Still. Professional. Because that's what you do. That's what you're trained to do. That's what keeps you alive. Keeps you whole. Keeps you human. Or what's left of it. What war hasn't broken. Yet.</p>
                                           <p>The citizens step forward. With keys. With surrender. They're thin. Starved. Broken. By the siege. By the hunger. You watch. Silent. Respectful. Or trying to be. Trying to be human. Trying to be good. In a moment. In a world that makes it hard.</p>`;
                    if (result.success) {
                        return `<p>You stay disciplined. Stay silent. During the surrender. Your professionalism shows. Is noted. Is remembered. By the captain. By your men. By everyone who matters. You've done right. Done well. That's something. That's enough.</p>
                               <p>You've earned favor. And maintained honor. Kept your respect. Kept your humanity. Kept yourself. Whole. Good. Human. Or what's left of it. What war hasn't broken. Yet. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You join them. The jeering crowd. The mocking voices. Your lack of discipline shows. Is noted. Is remembered. By the captain. By your men. By everyone who matters. You've done wrong. Done poorly. That's something.</p>
                               <p>You've dishonored yourself. Through poor behavior. Through lack of respect. Through everything that makes you less. Less human. Less good. You've lost honor. Lost respect. Lost yourself. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Dishonor', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            keys_water: {
                title: "Offering Water",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see him. A citizen. Thin. Starved. Broken. By the siege. By the hunger. He stands. With keys. With surrender. Waiting for judgment. For mercy. For death. Maybe. Or maybe something else. Something better. Something human. If you're willing. If you're able. To risk yourself. To help him. To do what's right. Even when it's wrong. Even when it's dangerous.</p>
                                           <p>The choice is simple. Offer water. Or don't. Help him. Or leave him. Show mercy. Or show nothing. The decision is yours. But you know. Deep down. You know. That mercy costs something. That kindness has a price. That humanity comes with a burden. A weight. A debt. That you'll pay. Eventually.</p>`;
                    if (result.success) {
                        return `<p>You offer it. Water. Life. Mercy. To a citizen. To a stranger. To a human. The small act matters. Improves morale. Makes you human. Makes you good. Or at least less bad. Less terrible. You've done right. Done well. That's something. That's enough.</p>
                               <p>You've reduced hardness. Maintained humanity. Kept yourself. Whole. Good. Human. Or what's left of it. What war hasn't broken. Yet. You've done right. Done well. That's something. That's enough.</p>`;
                    } else {
                        return `<p>You're mocked. For showing mercy. For being human. For doing right. The taunts get under your skin. Into your head. Into your heart. They call you weak. Call you soft. Call you names that cut. That hurt. That make you doubt. You did right. You know you did right. But knowing doesn't help. Doesn't stop the doubt. Sometimes doing right feels wrong. Sometimes being human feels like failure.</p>
                               <p>Your morale suffers. From the mockery. From the doubt. The knowledge weighs. Heavy. Real. Permanent. You tried. To be human. To be good. To do right. But it wasn't enough. It never is. Sometimes trying isn't enough. Sometimes being human isn't enough.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        if (hasFlag('Hardness')) {
                            setFlag('Hardness', false);
                        }
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            keys_souvenir: {
                title: "Taking a Souvenir",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see it. An opportunity. A chance. Keys. Cloth. Coin. Worth something. Worth taking. Worth stealing. If you're fast. If you're careful. If you're willing. To risk everything. For nothing. For greed.</p>
                                           <p>The surrender is happening. The moment is now. The opportunity is here. The choice is simple. Take it. Or leave it. Steal it. Or respect it. The decision is yours. But you know. Deep down. You know. That taking costs something. That greed has a price. That dishonor comes with a burden. A weight. A debt. That you'll pay. Eventually.</p>`;
                    if (result.success) {
                        return `<p>You grab it. A souvenir. Keys. Cloth. Coin. Something. Anything. Worth something. You're richer. Better off. Better equipped. For what comes next.</p>
                               <p>But you've dishonored yourself. Lost your honor. Lost your respect. Lost everything that makes you human. You've gained wealth. But lost honor. Lost trust. Lost yourself. This will follow you. Haunt you. Define you. Until you die. Or until you make it right.</p>`;
                    } else {
                        return `<p>You're caught. Taking. Stealing. Betraying. The punishment is severe. The reputation is ruined. The trust is lost. Everything you've built. Everything you've earned. Gone. In a moment. In a choice. In a mistake you can't take back.</p>
                               <p>You've lost favor. Through your greed. Through your want. The knowledge weighs. Heavy. Real. Permanent. You tried. To take. To steal. To profit. But it went wrong. It always goes wrong. Eventually. You've lost everything. For nothing. For greed.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 12);
                        setFlag('Dishonor', true);
                    } else if (result) {
                        applyStatChange('patronFavor', -2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            after_crecy: {
                title: "After Cr√©cy",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p>Cr√©cy was a disaster. For the French. For everyone. Thousands fell. To arrows. To blades. To death. But you survived. You're alive. For now. That's something. That's all you have. Sometimes that's all you get.</p>
                       <p>The war continues. Always continues. Never ends. You've learned. That battles are won. Not just by courage. But by strategy. By knowing when to advance. When to hold. When to retreat. When to survive.</p>
                       <p>Your journey continues. As a man-at-arms. As a soldier. As a survivor. The war has only begun. The years stretch ahead. Full of battles. Full of death. Full of everything that makes war terrible. You'll face it. Endure it. Survive it. That's all you can do. All you can be.</p>`,
                choices: [
                    {
                        text: "Your story continues...",
                        effects: {},
                        nextScene: "end_game"
                    }
                ]
            },
            end_game: {
                title: "Your Legacy",
                year: 1347,
                age: 28,
                text: `<p>This is but the beginning. Of your story. Of the war. The 100 Years War will span your lifetime. And beyond. Decades. Generations. Until it ends. Or doesn't.</p>
                       <p>You have survived Cr√©cy. One of history's great battles. One of history's great slaughters. Your choices have shaped you. Made you. Broken you. Into what you are. Into what you've become.</p>
                       <p><strong>Your Final Stats:</strong></p>
                       <p>You have become a veteran. Of war. Of death. Your story is written. In the choices you made. In the battles you fought. In the men you killed. In the men you saved. The war continues. Without you. With you. Around you. Through you. Until it ends. Or doesn't.</p>`,
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            // ===== DEATH AVOIDANCE SCENES (Spend Money to Avoid Death) =====
            avoid_camp_fever: {
                title: "Buying Your Life",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 240; // 20 shillings = 240 pence
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The fever takes hold. You're burning up. The flux. The fever. It doesn't matter what you call it. You're dying.</p>
                            <p>But you have coin. ${formatCurrency(wealth)}. Enough to buy medicine. To pay a surgeon. To get clean water and food. To buy your way out of death.</p>
                            <p>The merchant has what you need. Herbs. Clean bandages. Wine to clean wounds. But it costs. Everything costs. ${formatCurrency(cost)}. A fortune. But less than your life.</p>
                            <p>You pay. You don't hesitate. Coin for life. The simplest trade there is.</p>`;
                },
                onEnter: function() {
                    const cost = 240; // 20 shillings = 240 pence
                    applyStatChange('wealth', -cost);
                    applyStatChange('stress', -2);
                    applyStatChange('morale', 1);
                    // Remove any conditions that might have caused this
                    if (hasCondition('Fatigued')) {
                        removeCondition('Fatigued');
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_sepsis: {
                title: "The Surgeon's Price",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 360; // 30 shillings = 360 pence
                    return `<p>The wound turns black. The smell is wrong. Sepsis. Your arm swells. You need a surgeon. Now.</p>
                            <p>The surgeon looks at your coin. ${formatCurrency(cost)}, he says. For proper care. Clean tools. Good wine to clean the wound. A chance to live.</p>
                            <p>You pay. You have no choice. The alternative is death on his table. You pay and he works. Carefully. Methodically. The wound is cleaned. The rot cut away. You survive. But you're poorer. And you know how close you came.</p>`;
                },
                onEnter: function() {
                    const cost = 360; // 30 shillings = 360 pence
                    applyStatChange('wealth', -cost);
                    applyStatChange('stress', -1);
                    // Remove wound conditions
                    gameState.conditions = gameState.conditions.filter(c => 
                        !c.name.includes('Wound') && 
                        !c.name.includes('Injury') && 
                        !c.name.includes('Cut')
                    );
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_horse_fall: {
                title: "Better Equipment",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 300; // 25 shillings = 300 pence
                    return `<p>Your horse spooks. You're thrown. But you've spent coin on better tack. Better training. The fall is bad but not fatal. Your legs ache. You're bruised. But you're alive.</p>
                            <p>You spent ${formatCurrency(cost)} on better equipment. It saved your life. Others weren't so lucky. You see them. Broken. Left behind. You could have been one of them. But coin made the difference.</p>`;
                },
                onEnter: function() {
                    const cost = 300; // 25 shillings = 300 pence
                    applyStatChange('wealth', -cost);
                    applyStatChange('endurance', 1);
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_dysentery: {
                title: "Clean Water",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 180; // 15 shillings = 180 pence
                    return `<p>The shits. The bloody shits. You can't keep water down. You're dying. But you have coin.</p>
                            <p>You pay ${formatCurrency(cost)} for clean water. For food that hasn't spoiled. For a place away from the latrines. It's expensive. But it works. You recover. Slowly. But you recover.</p>
                            <p>Others aren't so lucky. They die in the latrines. No one comes to help. But you had coin. Coin bought you life.</p>`;
                },
                onEnter: function() {
                    const cost = 180; // 15 shillings = 180 pence
                    applyStatChange('wealth', -cost);
                    applyStatChange('stress', -2);
                    applyStatChange('endurance', 1);
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_pneumonia: {
                title: "Warm Shelter",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 216; // 18 shillings = 216 pence
                    return `<p>The cough won't stop. Your chest burns. Pneumonia. You're dying. But you have coin.</p>
                            <p>You pay ${formatCurrency(cost)} for a warm place. For blankets. For medicine. For a chance to recover. It works. You survive. Others don't. They die in tents. Alone. Coughing blood. But you had coin.</p>`;
                },
                onEnter: function() {
                    const cost = 216; // 18 shillings = 216 pence
                    applyStatChange('wealth', -cost);
                    applyStatChange('stress', -2);
                    if (hasCondition('Fatigued')) {
                        removeCondition('Fatigued');
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_plague: {
                title: "Fleeing the Plague",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const cost = 600; // 50 shillings = 600 pence (2 pounds 10 shillings)
                    return `<p>The black boils appear. The fever. The coughing blood. The Black Death. You're dying. But you have coin.</p>
                            <p>You pay ${formatCurrency(cost)}. A fortune. To bribe guards. To buy passage away from the plague. To get medicine. To buy your way out of death itself.</p>
                            <p>It works. You survive. The plague takes others. Dozens. Hundreds. But you had coin. Coin bought you life when death was everywhere.</p>`;
                },
                onEnter: function() {
                    const cost = 600; // 50 shillings = 600 pence (2 pounds 10 shillings)
                    applyStatChange('wealth', -cost);
                    applyStatChange('stress', -3);
                    applyStatChange('morale', -1); // Surviving plague is traumatic
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            avoid_starvation: {
                title: "Buying Food",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Calais"; },
                text: function() {
                    const cost = 300; // 25 shillings = 300 pence (1 pound 5 shillings)
                    return `<p>The rations run out. You're starving. Your body gives up. You're dying. But you have coin.</p>
                            <p>You pay ${formatCurrency(cost)} for food. At ruinous prices. But you pay. You eat. You survive. Others starve. They die in the siege lines. But you had coin. Coin bought you life.</p>`;
                },
                onEnter: function() {
                    const cost = 300; // 25 shillings = 300 pence (1 pound 5 shillings)
                    applyStatChange('wealth', -cost);
                    applyStatChange('morale', 1);
                    applyStatChange('stress', -1);
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            
            // ===== DEATH SCENES (Variable Length Based on Circumstances) =====
            death_camp_fever: {
                title: "Camp Fever",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The fever takes you. The flux. The fever. It doesn't matter what you call it.</p>
                            <p>You're dead in three days. ${name} dies in a tent. Alone. No one remembers your name.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">The campaign continues without you.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_sepsis: {
                title: "Sepsis",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The wound turns black. The smell is wrong. Sepsis.</p>
                            <p>Your arm swells. The surgeon takes it. You don't survive the amputation.</p>
                            <p>${name} dies on the surgeon's table. Screaming.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">The war doesn't care.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_dysentery: {
                title: "Dysentery",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The shits. The bloody shits. You can't keep water down.</p>
                            <p>You're dead in a week. ${name} dies in the latrines. No one comes to help.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">This is how most men die.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_pneumonia: {
                title: "Pneumonia",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The cough won't stop. Your chest burns. Pneumonia.</p>
                            <p>You're dead before the week is out. ${name} dies in a tent. Alone. Coughing blood.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">The war continues.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_pitchfork: {
                title: "Pitchfork",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Countryside"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The pitchfork finds your throat. You're dead before you hit the ground.</p>
                            <p>${name} dies in a French field. A farmer's tool in your neck.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">This is not how you wanted to die.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            forced_retirement_broken_legs: {
                title: "Broken Legs",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>Your horse spooks. You're thrown. Both legs break.</p>
                            <p>The campaign is over. You're left behind. ${name} will never walk again.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">At least you're alive.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_plague: {
                title: "The Black Death",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The black boils appear. The fever. The coughing blood.</p>
                            <p>The Black Death. You're dead in days.</p>
                            <p>${name} dies in a tent. Alone. No one comes near. The plague takes you like it takes everyone.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">This is how most men die now.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_starvation: {
                title: "Starvation",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Calais"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>The rations run out. You starve. Your body gives up.</p>
                            <p>You die in the siege lines. ${name} dies hungry. The siege continues.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">The siege doesn't care.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            death_broke: {
                title: "Broke and Dead",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                text: function() {
                    const name = escapeHTML(gameState.characterName || "Soldier");
                    return `<p>You have nothing. No coin. No favors. No way to buy your way out of trouble.</p>
                            <p>When sickness comes, when injury strikes, when hunger gnaws‚Äîyou have no recourse. No medicine. No surgeon. No food. No shelter.</p>
                            <p>${name} dies broke. Alone. No one remembers your name.</p>
                            <p style="color: #d4af37; font-style: italic; margin-top: 20px;">Broke men die. This is the truth of war.</p>`;
                },
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            restart: {
                title: "New Beginning",
                year: null,
                age: null,
                text: `<p>The war ends. Or you do. One way or another. The story closes. The journey stops. The life you lived. The choices you made. The man you became. All of it. Done. Finished. Over. Or supposed to be. Supposed to mean something. But does it. Does any of it.</p>
                       <p>Would you like to start again. A new game. A new life. To try again. To be different. To make different choices. To become someone else. Or the same. Or something in between. The choice is yours.</p>`,
                choices: [
                    {
                        text: "Yes, start over",
                        effects: {},
                        nextScene: "reset"
                    }
                ]
            },
            reset: {
                title: "Starting Over",
                year: 1337,
                age: 18,
                text: `<p>Your journey begins. Anew. Again. From the start. From the beginning. The year is 1337. The war is new. You are young. Or think you are. For what comes next.</p>
                       <p>The path stretches ahead. Full of choices. Full of danger. Full of everything that makes war terrible. You'll face it. Endure it. Survive it. That's all you can do. All you can be. The journey begins. Again.</p>`,
                choices: [
                    {
                        text: "Begin",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            },
            
            // ============================================================================
            // FLAVOR EVENTS - Campaign, Camp Life, Countryside, Personal, Patron-Specific
            // McCarthy-style historical narrative for the Hundred Years' War
            // ============================================================================
            
            march_through_normandy_1: {
                title: "The Road to Caen",
                year: 1346,
                age: function() { return gameState.age; },
                location: "Normandy",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The sun beat down. The column moved through empty fields. The peasants had fled. What remained: a broken cart wheel. A child's toy in the mud. Blackened hayricks. Smoke rose ahead. The smell of burning thatch. Something fouler on the wind.</p>
                           
                           <p>Your boots were caked with mud. Each step a labor. The clay clung to your soles. The mail chafed where the padding had worn thin. You felt the weight of it all. Sword. Shield. The few things you'd kept. Wat walked beside you. A veteran from Yorkshire. He spat into the dust. French wine and English steel, he muttered. His face was weathered. Scars. Lines of hard living. His eyes never stopped moving.</p>
                           
                           <p>The column stretched ahead and behind. A snake of men and horses winding through the Norman landscape. The creak of leather. The jingle of harness. Low voices trying to pass the time. Someone sang a bawdy song. Others joined in. Rough. Off-key. It broke the monotony. Ahead the vanguard had stopped. The word passed back. Something blocks the road.</p>
                           
                           <p>You craned your neck. The press of men. The dust. Your view was obscured. Hold, the sergeant called. Hold in place. The column ground to a halt. In the sudden quiet you heard voices. French voices. Too fast to understand. But the tone was clear. Fear. Anger. Desperation.</p>
                           
                           <p>Wat shifted. His hand moved to his sword. Trouble, he said. It wasn't a question. Around you men checked weapons. Adjusted shields. The easy camaraderie was gone. Replaced by the tension that comes before violence. Your heart beat faster. The familiar mix. Fear and anticipation.</p>
                           
                           <p>The captain rode past. His horse's hooves kicked up dust. Stay alert, he called. We don't know what's ahead. But we'll find out. He didn't slow. Heading toward the vanguard. You looked at Wat. He gave you a grim smile. Well ${name}, he said. Looks like we might earn our pay today after all.</p>`;
                },
                choices: [
                    {
                        text: "Push forward to see what blocks the road",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 6,
                        nextScene: "road_block_encounter"
                    },
                    {
                        text: "Wait with the main column",
                        effects: { endurance: 1 },
                        nextScene: "march_continues"
                    },
                    {
                        text: "Scout around the obstacle",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        effects: { wits: 1 },
                        nextScene: "scout_discovery"
                    }
                ]
            },
            
            marsh_crossing: {
                title: "The Marshlands",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Water. Everywhere water. The ground had turned to marsh two miles back. Now you waded through it. Knee-deep in places. The water was brown. Thick with sediment. It smelled of rot. Of things long dead. Insects swarmed. Biting. Relentless. You swatted at them but more came.</p>
                           
                           <p>The horses struggled. Their hooves sucked at the mud. Some had already foundered. Left behind. Their riders walking now. Carrying what gear they could. The rest abandoned. Sinking slowly into the mire. The column had stretched out. Men finding their own paths. Seeking firmer ground. But there was none.</p>
                           
                           <p>Your legs burned. Each step an effort. Lifting your foot. The mud fighting to keep it. Then forward. Then down. Then again. The water soaked through your boots. Your feet were numb. Cold. The padding under your mail was sodden. The weight doubled. Tripled. Your shoulders ached. Your back. Everything.</p>
                           
                           <p>A man fell ahead. Just disappeared. One moment walking. The next gone. Swallowed by the marsh. Others rushed to him. Grabbed his arms. Hauled him up. He came out coughing. Gasping. Covered in mud. They dragged him to shallower water. He sat there. Shaking. The look in his eyes said he'd seen something down there. In the dark water. Something he didn't want to remember.</p>
                           
                           <p>The sergeant called out. Keep moving. Don't stop. If you stop you sink. It was true. You could feel it. The mud beneath your feet. Always pulling. Always trying to drag you down. The marsh wanted you. All of you. It would take what it could get.</p>`;
                },
                choices: [
                    {
                        text: "Help others through the worst sections",
                        effects: { reputation: 1, endurance: -1 },
                        nextScene: "marsh_exit"
                    },
                    {
                        text: "Focus on getting yourself through",
                        effects: { endurance: 1 },
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 7,
                        nextScene: "marsh_exit"
                    },
                    {
                        text: "Try to find a better path",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 8,
                        nextScene: "better_route"
                    }
                ]
            },
            
            night_march: {
                title: "March Under Stars",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Darkness. The column moved through it like a blind thing. Feeling its way. The moon was new. No light except the stars. Cold and distant. They gave just enough to see the man ahead. His shape. Nothing more. You followed that shape. Trusted it knew where to go.</p>
                           
                           <p>No talking. The order had come down at dusk. Silence. The French were close. Maybe watching. Maybe waiting. Sound carried at night. A voice. The jingle of harness. The cough of a sick man. All of it could give you away. So you walked in silence. The only sounds your breathing. Your footsteps. The creak of leather. The whisper of mail.</p>
                           
                           <p>You stumbled. A rut in the road. Caught your foot. Nearly went down. Caught yourself. Your heart pounded. The fear of falling. Of being left behind. Of being alone in the dark with the enemy out there. Somewhere. You kept walking. Faster now. Catching up.</p>
                           
                           <p>The air was cold. Your breath misted. You couldn't see it but you felt it. The moisture on your face. In your lungs. The chill worked its way through your clothes. Your mail. Into your bones. You shivered. Tried not to. Tried to stay warm through movement. It didn't work.</p>
                           
                           <p>Hours passed. Or maybe minutes. Time had no meaning in the dark. There was only the walking. The following. The trying not to fall. The trying not to be left. Ahead someone tripped. You heard the clatter. Metal on stone. Then cursing. Quickly silenced. The sergeant's voice. Low. Harsh. Watch your step you fool. Then silence again. Just the walking. Just the dark.</p>`;
                },
                choices: [
                    {
                        text: "Stay alert‚Äîwatch for danger",
                        effects: { wits: 1, stress: 1 },
                        nextScene: "dawn_arrival"
                    },
                    {
                        text: "Focus on keeping pace",
                        effects: { endurance: 1 },
                        nextScene: "dawn_arrival"
                    },
                    {
                        text: "Help the man who fell",
                        effects: { reputation: 1, initiative: -1 },
                        nextScene: "dawn_arrival"
                    }
                ]
            },
            
            supply_shortage: {
                title: "Empty Wagons",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The wagons came up empty. No bread. No ale. No salted meat. The quartermaster stood before angry men. His hands spread. Nothing, he said. The supply train hasn't arrived. We wait or we forage. Those were the options. Neither good.</p>
                           
                           <p>Your stomach was hollow. Aching. You'd had nothing since dawn. Stale bread. Moldy cheese. That was twelve hours ago. Now the sun was setting. The cold coming. And no food. Around you men muttered. Dark words. Dangerous words. Some looked at the quartermaster like they might take what he claimed he didn't have. By force if necessary.</p>
                           
                           <p>The sergeant stepped forward. His voice cut through the murmuring. Any man who touches the quartermaster answers to me, he said. His hand was on his sword. Not threatening. Just ready. The men fell silent. But the anger remained. You could see it. In their eyes. In the set of their jaws. Hungry men were dangerous men. Even to each other.</p>
                           
                           <p>Will dispersed the crowd. A man-at-arms from Devon. He walked toward the woods. I'm going hunting, he called back. Anyone who wants to come is welcome. Several men followed. They disappeared into the trees. Their voices fading. You looked at the empty wagons. At the quartermaster. At the remaining men. All of them calculating. How long can we go without food. How long before discipline breaks. How long before someone does something stupid.</p>
                           
                           <p>Your stomach growled. The sound loud in the quiet. Someone laughed. Bitter. Humorless. We all feel it ${name}, a voice said. We all feel it. The question is what we do about it. You had choices. None of them good. But that was the nature of war. No good choices. Only degrees of bad.</p>`;
                },
                choices: [
                    {
                        text: "Join the hunting party",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 6,
                        nextScene: "hunting_expedition"
                    },
                    {
                        text: "Raid a nearby village for supplies",
                        effects: { wealth: 2, reputation: -2, stress: 1 },
                        nextScene: "village_raid"
                    },
                    {
                        text: "Wait it out‚Äîration what you have",
                        effects: { endurance: 1, morale: -1 },
                        nextScene: "supply_arrives"
                    },
                    {
                        text: "Gamble for someone else's rations",
                        effects: { wealth: -1 },
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 7,
                        nextScene: "gambling_outcome"
                    }
                ]
            },
            
            river_crossing: {
                title: "The Swollen River",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The river ran fast. Brown water churning. It had rained for three days. Upstream somewhere. Now the river was high. Angry. The ford that should have been passable was gone. Drowned beneath six feet of rushing water. The column halted at the bank. Men looked at the water. At each other. No one wanted to be first.</p>
                           
                           <p>The current was strong. You could see it in the way debris moved. Whole trees torn from somewhere upstream. Tumbling past. Branches breaking. Roots exposed like grasping hands. A dead cow floated by. Bloated. Revolving slowly. Its legs stuck out stiff. The smell reached you even over the water. Sweet. Rotten. Wrong.</p>
                           
                           <p>The captain called for volunteers. Men to test the crossing. To find the old ford beneath the flood. A few stepped forward. Brave or foolish. Maybe both. They stripped their mail. Their weapons. Anything heavy. They waded in. The water rose to their waists. Their chests. They struggled against the current. Feeling with their feet for the solid ground that should be there.</p>
                           
                           <p>One of them went under. Just like that. His foot found a hole. Or the current took him. He disappeared. Came up twenty yards downstream. Thrashing. The others tried to reach him but the current was too strong. He went under again. This time he didn't come back up. The men at the bank watched. Silent. Another one gone. The river had taken its price.</p>
                           
                           <p>The remaining volunteers came back. Shaking. Cold. They'd found the ford. Barely. It was there but treacherous. The water deep. The current strong. Crossing would be dangerous. But staying meant delay. And delay meant the French might catch up. The captain made his decision. We cross, he said. Now. While we still can.</p>`;
                },
                choices: [
                    {
                        text: "Cross with the first group‚Äîget it over with",
                        effects: { initiative: 1, stress: 1 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 7,
                        nextScene: "successful_crossing"
                    },
                    {
                        text: "Wait for others to go first‚Äîlearn from them",
                        effects: { wits: 1 },
                        nextScene: "safer_crossing"
                    },
                    {
                        text: "Help rope the crossing to make it safer",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "organized_crossing"
                    },
                    {
                        text: "Look for another crossing point",
                        effects: { initiative: -1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 8,
                        nextScene: "alternate_ford"
                    }
                ]
            },
            
            enemy_scouts: {
                title: "Eyes in the Trees",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Movement. There. In the treeline. Brief. Gone. But you saw it. Or thought you did. You stopped. Stared at the trees. The shadows between them. Nothing. Maybe you imagined it. The mind playing tricks. Too many days of marching. Too little sleep. But then you saw it again. Definitely something.</p>
                           
                           <p>You called out. Low. Urgent. The men around you stopped. Looked where you pointed. Some saw it. Others didn't. But everyone went quiet. Hands moved to weapons. Eyes scanned the treeline. The column ahead kept moving. Unaware. Or maybe they'd seen nothing. Maybe there was nothing to see.</p>
                           
                           <p>Robin moved up beside you. A tracker from the Welsh marches. His eyes narrowed. Aye, he said. Someone's there. Watching. He counted under his breath. His lips moving. Three at least. Maybe more. French scouts. Has to be. They're tracking the column. Reporting back. His hand was on his bow. Not drawn. Not yet. But ready.</p>
                           
                           <p>The sergeant came back. What's the delay, he demanded. Robin explained. Pointed to the trees. The sergeant looked. Saw nothing. But he believed. He'd been a soldier too long not to trust his men's eyes. Alright, he said. ${name}. Robin. Two others. Go check it out. But quiet. If they're there we want them alive. Information is worth more than bodies.</p>
                           
                           <p>You looked at the trees. At the shadows. Somewhere in there French eyes watched. French ears listened. They knew you were coming. They knew how many. They'd report it all. Unless you stopped them. But stopping them meant going into those trees. Into their ground. Their country. Where they had all the advantages. Your mouth was dry. Fear or anticipation. Maybe both.</p>`;
                },
                choices: [
                    {
                        text: "Lead the hunt for the scouts",
                        effects: { initiative: 2, reputation: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 8,
                        nextScene: "scout_pursuit"
                    },
                    {
                        text: "Follow Robin's lead‚Äîhe's the tracker",
                        effects: { wits: 1 },
                        nextScene: "robin_tracks"
                    },
                    {
                        text: "Set up an ambush instead",
                        effects: { wits: 2 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        nextScene: "counter_ambush"
                    },
                    {
                        text: "Report to captain‚Äîlet him decide",
                        effects: { reputation: -1 },
                        nextScene: "captain_orders"
                    }
                ]
            },
            
            scorched_earth: {
                title: "The Blackened Land",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Nothing grew here anymore. The fields were ash. Black stubble where wheat should have been. The trees were burned. Skeletal. Their branches reaching up like prayers to an uncaring sky. This was chevauch√©e. The English way of war. Destroy everything. Leave nothing for the enemy. Leave nothing for anyone.</p>
                           
                           <p>You marched through the devastation. Your own making. The column had come through three days ago. Burning. Pillaging. Taking what could be carried. Destroying what couldn't. Now you were coming back. Retreating. The French army was behind you. Larger. Better equipped. You were running. Through the wasteland you'd created.</p>
                           
                           <p>Smoke still rose in places. Embers that wouldn't die. The smell was everywhere. Wood smoke. Burned grain. Something else. Sweeter. More terrible. You tried not to think about what it might be. A farmhouse had collapsed. Just a heap of charred timber. A well stood nearby. Its bucket burned to nothing. The rope a blackened strand hanging into darkness.</p>
                           
                           <p>A dog appeared. Ribs showing. Fur singed. It watched the column pass. Hoping for scraps. Knowing it would get none. This was what you'd done. What war did. It took the green land and made it black. It took the living places and made them dead. And then it moved on. Looking for new places to destroy.</p>
                           
                           <p>Thomas walked beside you. His face was grim. We did this, he said. It wasn't a question. You said nothing. What was there to say. The evidence was all around. Miles of it. Stretching back to the coast. A trail of destruction. Your trail. The column kept moving. Through the ashes. Through the silence. Through the proof of what men could do when war gave them license.</p>`;
                },
                choices: [
                    {
                        text: "Feel the weight of what you've done",
                        effects: { stress: 2, wits: 1 },
                        nextScene: "moral_reckoning"
                    },
                    {
                        text: "This is war‚Äîdon't dwell on it",
                        effects: { stress: -1, morale: 1 },
                        nextScene: "soldier_on"
                    },
                    {
                        text: "Remember this‚Äîit matters",
                        effects: { wits: 2, morale: -1 },
                        nextScene: "memory_burden"
                    }
                ]
            },
            
            french_cavalry_spotted: {
                title: "Horsemen on the Ridge",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>They appeared on the ridgeline. Silhouettes against the sky. Mounted men. Twenty. Maybe more. Too far to see their faces but close enough to know what they were. French cavalry. Watching. Counting. Deciding whether to attack or report. Either way you were in trouble.</p>
                           
                           <p>The column stopped. No order needed. Men just halted. Looked up. At the riders on the ridge. Everyone calculating. Could we reach the trees. Could we form up in time. Could we fight them off if they charged. The answers weren't encouraging. The ground was open. The nearest cover half a mile. The horsemen had every advantage.</p>
                           
                           <p>One of them rode forward. Just a few paces. Looking down at the column. You could see his armor now. Mail haubergeon. Painted shield. The trappings of a minor noble. Maybe a knight. He raised his hand. Whether in greeting or warning you couldn't tell. Then he turned his horse. Rode back to the others. They conferred. Heads together. Pointing. Gesturing.</p>
                           
                           <p>Your sergeant was shouting orders. Form up. Pikes forward. Archers ready. The column contracted. Becoming a defensive formation. Bristling with spears. Bows drawn. But it was ragged. Hasty. You'd been marching. Not expecting battle. The formation had gaps. Weaknesses. The French would see them. If they charged they'd find them.</p>
                           
                           <p>The riders remained on the ridge. Watching. The tension stretched. Seconds became minutes. Your hands were sweating on your weapon. Your breath came quick. Shallow. This was the moment before. The calm before violence. It could break either way. Attack or withdrawal. Life or death. You waited. The whole column waited. And the horsemen just watched.</p>`;
                },
                choices: [
                    {
                        text: "Take position in the spear wall",
                        effects: { endurance: 1 },
                        nextScene: "cavalry_decision"
                    },
                    {
                        text: "Ready your bow‚Äîtry for a long shot",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9,
                        nextScene: "arrow_flight"
                    },
                    {
                        text: "Scout for better defensive ground",
                        effects: { wits: 1 },
                        nextScene: "defensive_position"
                    },
                    {
                        text: "Stand ready‚Äîwatch what they do",
                        effects: { morale: 1 },
                        nextScene: "cavalry_decision"
                    }
                ]
            },
            
            rainstorm_march: {
                title: "Rain Like God's Anger",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Rain. Not the gentle kind. The kind that punished. That beat down like fists. It came with no warning. The sky had been gray all morning. Then the clouds opened. The world turned to water. Within moments you were soaked. Your clothes heavy. Your mail streaming. Water running down your neck. Down your back. Into your boots.</p>
                           
                           <p>The road became a river. Mud and water mixing. Flowing downhill. Taking everything with it. Your feet slipped. Each step uncertain. You fell twice in the first hour. Came up covered in mud. The rain kept falling. No sign of stopping. This could go on for days. You'd seen it before. French weather. Brutal. Uncaring.</p>
                           
                           <p>Visibility dropped. You could barely see ten yards ahead. The men in front were ghosts in the rain. Gray shapes moving through gray water under gray sky. The whole world reduced to shades of nothing. Sound was different too. The rain so loud it drowned everything. Voices. Orders. The creak of carts. All of it lost in the downpour.</p>
                           
                           <p>Someone went down hard. You heard the cry. Saw men gather. A broken ankle. Maybe worse. They tried to help him up. He screamed. The sound thin in the rain. They fashioned a litter. Two spears. A cloak. Laid him on it. Carried him. But he was just one. Others were falling. Sick. Exhausted. Injured. The rain was winning. Beating the column down. Mile by miserable mile.</p>
                           
                           <p>You kept walking. What else could you do. Stopping meant dying. Out here. In the rain. You kept moving. One foot in front of the other. The water streaming down. The mud sucking at your boots. Your body aching. Your mind numb. This was endurance. This was what it meant to be a soldier. Not the glory. Not the plunder. This. The rain. The mud. The endless walking.</p>`;
                },
                choices: [
                    {
                        text: "Push through‚Äîit's just rain",
                        effects: { endurance: 2, stress: 1 },
                        nextScene: "rain_continues"
                    },
                    {
                        text: "Help carry the wounded",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "burden_shared"
                    },
                    {
                        text: "Look for shelter‚Äîeven brief respite helps",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        nextScene: "brief_shelter"
                    }
                ]
            },
            
            abandoned_camp: {
                title: "The French Camp",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The French had left in a hurry. You could tell. Tents still standing. Fires still smoldering. Food half-eaten. They'd heard you coming. Fled before contact. Smart. Or cowardly. Depended how you looked at it. Either way they'd left things behind. Things you could use.</p>
                           
                           <p>The column spread through the camp. Men calling out their finds. Bread here. Wine there. A good sword. Decent mail. Some coins. The plunder was modest but welcome. Every scrap helped. Every coin counted. You moved between the tents. Looking. The ground was churned. Dozens of feet. Maybe a hundred men had been here. Not long ago. Hours maybe.</p>
                           
                           <p>One tent was larger than the rest. An officer's tent. You pushed inside. It was dim. Smelled of wine and sweat. A cot. A table. Maps spread across it. Papers. Seals. You couldn't read French but the maps made sense. Lines. Positions. Troop strengths marked in symbols. This was valuable. This was the kind of thing the captain would want to see.</p>
                           
                           <p>Something moved in the corner. You spun. Hand to sword. A man sat there. French. Young. His leg was bandaged. Blood soaking through. He raised his hands. Empty. Trembling. His eyes were wide. Terrified. The others left me, he said. In French. You caught enough to understand. Left me because I slowed them down. He looked at your sword. At your face. Waiting to see what you'd do.</p>
                           
                           <p>Outside men were laughing. Celebrating the easy plunder. Inside this tent there was just you and this wounded French soldier. This boy really. Couldn't be more than sixteen. He'd been left behind. Abandoned by his own side. Now his fate was in your hands. You could kill him. Take him prisoner. Let him go. Each choice meant something. About you. About what kind of man you were becoming.</p>`;
                },
                choices: [
                    {
                        text: "Take him prisoner‚Äîhe's worth ransom",
                        effects: { wealth: 3, reputation: 1 },
                        nextScene: "prisoner_march"
                    },
                    {
                        text: "Spare him‚Äîlet him go",
                        effects: { morale: 1, reputation: 1 },
                        nextScene: "mercy_shown"
                    },
                    {
                        text: "Question him about French movements",
                        effects: { wits: 2 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "intelligence_gathered"
                    },
                    {
                        text: "Take the maps and leave him‚Äînot your problem",
                        effects: { wits: 1 },
                        nextScene: "maps_retrieved"
                    }
                ]
            },
            
            dead_horse: {
                title: "The Warhorse",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The horse lay in the road. A destrier. Massive. Beautiful even in death. It had been a warhorse once. Trained for battle. Worth more than ten men. Now it was carrion. Flies already gathering. The smell just beginning. Fresh death. A few hours old at most.</p>
                           
                           <p>Its throat was cut. Clean. Efficient. Someone had done this deliberately. Not an accident. Not a wound from battle. Murder. You looked at the ground around it. Tracks. Boot prints. Someone had led it here. Killed it. Left it. But why. Why kill a valuable horse and leave it in the road. The answer came quickly. A message. A warning. The French were close. Watching. They wanted you to know.</p>
                           
                           <p>The saddle was gone. The bridle. Anything of value stripped away. But the horse itself remained. Too large to move. Too valuable to have been abandoned unless necessary. Whoever owned this animal had loved it. Trained it. Ridden it into battle. Now it was dead in a French road. One more casualty of a war that killed everything it touched.</p>
                           
                           <p>Men gathered around. Looking. Some crossed themselves. A warhorse was a noble beast. Killing it seemed wrong somehow. Worse than killing men. The horse hadn't chosen war. Hadn't chosen sides. It had only served. And this was its reward. Death in a foreign land. Food for flies and crows.</p>
                           
                           <p>The column would have to go around. The road was blocked. That meant delay. Meant extra time in enemy territory. Meant more danger. You looked at the dead horse. At its empty eyes. At the blood pooling beneath its throat. Someone had known. Known what this would cost you. Done it anyway. The war was getting meaner. More personal. You could feel it.</p>`;
                },
                choices: [
                    {
                        text: "Move it off the road‚Äîshow respect",
                        effects: { endurance: -1, morale: 1 },
                        nextScene: "respect_shown"
                    },
                    {
                        text: "Just go around‚Äîit's only a horse",
                        effects: { stress: -1 },
                        nextScene: "march_continues"
                    },
                    {
                        text: "Examine the area‚Äîlook for whoever did this",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        nextScene: "tracks_found"
                    }
                ]
            },
            
            forest_ambush_avoided: {
                title: "The Dark Woods",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The forest closed in. Trees pressing close to the road. Old growth. Dense. The canopy blocked the sun. Made everything twilight. Shadow. The kind of place where anything could hide. Where anyone could wait. Your hand stayed near your sword. Not gripping it. Not yet. But ready.</p>
                           
                           <p>Birds had gone quiet. That was the first sign. The forest should be full of sound. Birdsong. Animals moving through brush. But there was nothing. Just silence. The kind of silence that meant predators. Men were predators. The worst kind. They could be anywhere. Behind any tree. In any shadow.</p>
                           
                           <p>The column tightened. Men moving closer together. Weapons loose in their sheaths. Everyone felt it. The wrongness. The watching. Eyes on you from the forest. Counting. Measuring. Deciding. Whether to attack. Whether to let you pass. Whether today was the day they'd try their luck against armed men.</p>
                           
                           <p>Something glinted in the trees. Sunlight on metal. There and gone. But you'd seen it. Others too. The sergeant called a halt. His voice low. Everyone quiet. Listen, he said. You listened. For a long moment nothing. Then you heard it. The creak of a bow being drawn. The whisper of men moving through undergrowth. Not one. Many. You were surrounded. Or about to be.</p>
                           
                           <p>The captain made his decision fast. He'd been a soldier long enough to know. Fighting in the forest favored the ambushers. Better to show strength. Move fast. Give no opening. Column forward, he called. Double pace. Archers to the flanks. Anyone attacks we don't stop. We go through them. The column surged forward. Moving fast. Daring the watchers to try something. They didn't. Cowards or smart. Didn't matter. You made it through.</p>`;
                },
                choices: [
                    {
                        text: "Keep watch on the flanks‚Äîstay alert",
                        effects: { wits: 1, initiative: 1 },
                        nextScene: "forest_exit"
                    },
                    {
                        text: "Focus on moving fast‚Äîget out quickly",
                        effects: { endurance: 1 },
                        nextScene: "forest_exit"
                    },
                    {
                        text: "Watch for an ambush site‚Äîwhere would you attack from",
                        effects: { wits: 2 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        nextScene: "tactical_insight"
                    }
                ]
            },
            
            village_ruins: {
                title: "The Empty Houses",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: "Gascony",
                text: function() {
                    return `<p>The village lay empty. Low stone houses. Thatched roofs sagging. Some already collapsed. The doors hung open. Gaping mouths revealing darkness within. No smoke rose from hearths. No children played in the streets. No animals in the fields. The silence was profound. Broken only by wind. The harsh calling of crows.</p>
                           
                           <p>Signs of hasty departure everywhere. A cooking pot by a doorway. Its contents long spoiled. A child's wooden toy. Half-buried in mud. What was once a street. A door torn from hinges. Wood splintered. Broken. The gardens overgrown. Weeds choking what crops remained. The fields beyond showed stubble. A harvest never completed. Life interrupted. Abandoned to decay.</p>
                           
                           <p>In the center stood a well. Stone rim weathered. Cracked. The bucket still attached to its rope. Hanging motionless in darkness below. A few chickens pecked at dirt. The only living things. They scattered as you approached. Their clucking the only sound of life in this dead place. The smell of decay was faint. Present. Something died here. Recently enough that the scent remained. Rot. Things left to spoil.</p>
                           
                           <p>Your commander rode up. His horse's hooves loud in the silence. He surveyed the village. Practiced eye. Expression grim. Empty, he said. Not a question. They knew we were coming. He dismounted. Boots sinking into mud. Quick search, he called. Take what's useful. Food. Tools. Anything. But be quick. We're not staying.</p>
                           
                           <p>The men spread out. Moving cautiously. Some to houses. Weapons drawn. Others checking outbuildings. Fields beyond. You heard them calling. Voices echoing in empty spaces. Doors forced. Things moved. Examined. But there was tension. A sense that this place was wrong. That something bad happened here. Everyone felt it. This is what war does. Empties places. Leaves them hollow. Moves on to the next village. The next town. The next life to disrupt or destroy.</p>`;
                },
                choices: [
                    {
                        text: "Search the houses for supplies",
                        effects: { wealth: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 5,
                        nextScene: "village_search"
                    },
                    {
                        text: "Investigate the well‚Äîsomething might be in it",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 7,
                        effects: { stress: 1 },
                        nextScene: "well_discovery"
                    },
                    {
                        text: "Stay with the column‚Äîthis place feels wrong",
                        effects: { wits: 1 },
                        nextScene: "march_continues"
                    },
                    {
                        text: "Check the church‚Äîthey might have left offerings",
                        effects: { wealth: 2, reputation: -1 },
                        nextScene: "church_plunder"
                    }
                ]
            },
            
            winter_march: {
                title: "The Frost Road",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Cold. Not the kind you could fight with movement. The kind that settled into your bones. Made them ache. The frost had come in the night. Now everything was white. Crystalline. Beautiful and deadly. Your breath came in clouds. Each exhale a visible thing. Floating. Dissipating. Gone.</p>
                           
                           <p>The road was ice. Treacherous. Men slipped. Fell. Got up cursing. Fell again. The horses fared worse. Their hooves couldn't grip. Several had already gone lame. Left behind. Their riders walking now. Carrying what they could. The frost didn't care. It just kept biting. Finding every gap in your clothing. Every weakness in your defenses.</p>
                           
                           <p>Your hands were numb. Even through gloves. Mittens of wool. Useless against this cold. You flexed your fingers. Trying to keep blood moving. Feeling nothing. That scared you. Couldn't fight if you couldn't feel your sword. Couldn't defend yourself. The cold was an enemy more dangerous than the French. You couldn't negotiate with it. Couldn't run from it. Could only endure.</p>
                           
                           <p>Someone fell and didn't get up. Men rushed to him. Shook him. Called his name. Nothing. He was breathing. But barely. His lips were blue. His skin pale. Frostbite. Exposure. Death by degrees. They carried him to a cart. Wrapped him in what blankets remained. He might live. He might not. The cold would decide. Not you. Not medicine. Just the cold and whether his body could fight it.</p>
                           
                           <p>The column kept moving. Had to. Stopping meant freezing. Meant dying. So you walked. Numb. Aching. Miserable. But alive. For now. The frost glittered around you. Beautiful. Pitiless. Caring nothing for your struggle. This was winter in France. This was war in the cold months. This was what it meant to serve. Not glory. Not honor. This. The frost. The numbness. The endless walking toward some destination that might not even matter.</p>`;
                },
                choices: [
                    {
                        text: "Keep moving‚Äîdon't stop for anything",
                        effects: { endurance: 2, stress: 1 },
                        nextScene: "frost_survival"
                    },
                    {
                        text: "Help the frozen man‚Äîshare your warmth",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "compassion_shown"
                    },
                    {
                        text: "Look for shelter‚Äîeven a brief respite helps",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 8,
                        nextScene: "shelter_found"
                    },
                    {
                        text: "Burn something for heat‚Äîanything",
                        effects: { wealth: -1, morale: 1 },
                        nextScene: "desperate_warmth"
                    }
                ]
            },
            
            camp_dice_game: {
                title: "A Game of Hazard",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>Evening settled. Chill came with it. Around a small fire men huddled over a game of hazard. Faces lit by flames. Dice clattered. Wooden board. Crude markings. Coins changed hands. Metal on metal. The air thick with pipe smoke. Sweet. Earthy. Acrid scent of burning wood. Smell of ale. Fresh and spilled.</p>
                           
                           <p>Veterans with scars. Younger men learning the trade. All drawn together. The need to pass time. To forget. If only for a moment. What tomorrow might bring. Voices were low. Curses. Laughs. Eyes fixed on dice. Tumbling across the board. The game was simple. Roll. Bet. Win or lose. But stakes felt higher. As if each roll carried the weight of fate.</p>
                           
                           <p>Thomas looked up. A bowman from Kent. Ready smile. Quick hands. He grinned. Face flushed. From the fire. From the ale. From excitement. Eyes had that bright focused look. The look that comes with gambling. ${name}, he called. Come join us. The French haven't killed us yet. But this game might finish the job.</p>
                           
                           <p>Other men looked up. Expressions ranged from welcoming to calculating. A big man. Broken nose. Thick beard. He grunted. Shifted to make room. Aye come sit, he said. We could use fresh blood. There was something in his tone. He meant it. Fresh money. Fresh luck. Fresh opportunity to take what you have.</p>
                           
                           <p>You checked your purse. Felt the weight of coins. ${wealth} shillings. Hard-won. From plunder. From pay. The thought of risking it made your stomach tighten. But men were betting heavily. Pot grew with each roll. Silver coins gleaming in firelight. A small fortune. If you were lucky enough to win it.</p>
                           
                           <p>Dice clattered again. Someone groaned. Another laughed. Coins pushed across the board. Game continued. Thomas watched you. Expression expectant. Question in his eyes. Will you join. Or walk away. Fire crackled. Sparks into night sky. In the distance sounds of camp. Horses. Men talking. Noise of an army at rest. But here around this small fire the world had narrowed. To the roll of dice. To the turn of fortune.</p>`;
                },
                choices: [
                    {
                        text: "Join the game (bet 2 shillings)",
                        effects: { wealth: -2, morale: 1 },
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 6,
                        nextScene: function() {
                            if (Math.random() * 10 + gameState.stats.luck >= 6) {
                                applyStatChange('wealth', 4);
                                return "dice_game_win";
                            }
                            return "dice_game_lose";
                        }
                    },
                    {
                        text: "Watch but don't play",
                        effects: { morale: 1 },
                        nextScene: "camp_rest"
                    },
                    {
                        text: "Leave‚Äîgambling is a fool's game",
                        effects: { wits: 1 },
                        nextScene: "camp_rest"
                    },
                    {
                        text: "Try to cheat (risky)",
                        effects: { wealth: 3, reputation: -2 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9,
                        nextScene: "caught_cheating"
                    }
                ]
            },
            
            weapon_maintenance: {
                title: "Steel and Stone",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Your sword was dull. Nicked. The edge that had been sharp three battles ago was now blunt. Useless against mail. Maybe useless against leather. You needed to fix it. Needed to sharpen it. Your life depended on your blade. A dull sword was a death sentence.</p>
                           
                           <p>You sat by your tent. Whetstone in hand. The stone was worn. Smooth. You'd used it a hundred times. A thousand. The motion was familiar. Comforting almost. Pull the blade across the stone. Listen to the sound. Feel the edge coming back. It was meditation. This simple act. This maintenance of the tool that kept you alive.</p>
                           
                           <p>Others were doing the same. All around camp. Men tending their weapons. Sharpening swords. Repairing mail. Checking straps on shields. This was the warrior's work. Not the glorious part. Not the part the minstrels sang about. But the real part. The necessary part. Steel required care. Required attention. Neglect it and it would fail you when you needed it most.</p>
                           
                           <p>Old Geoffrey sat nearby. Working on his spear. The shaft was cracked. He was binding it. Leather strips. Careful. Methodical. His hands were gnarled. Scarred. Decades of this work. He looked up. Caught you watching. A sword is like a woman, he said. Needs constant attention or it'll turn on you. He laughed. The others joined in. Crude humor. But there was truth in it. Everything needed care. Everything needed work.</p>
                           
                           <p>The scrape of stone on steel was soothing. Repetitive. Your mind wandered as your hands worked. Thinking about home. About what you'd left behind. About what you'd become. A killer. That's what a sharp sword made you. A more efficient killer. But that was the job. That was what you'd signed up for. So you kept sharpening. Kept working. Kept preparing for the next time you'd need to use this blade to take a life.</p>`;
                },
                choices: [
                    {
                        text: "Take your time‚Äîdo it right",
                        effects: { initiative: 1, morale: 1 },
                        nextScene: "well_maintained"
                    },
                    {
                        text: "Rush it‚Äîgood enough",
                        effects: { stress: -1 },
                        nextScene: "adequate_edge"
                    },
                    {
                        text: "Ask Geoffrey for advice",
                        effects: { wits: 1, reputation: 1 },
                        nextScene: "veterans_wisdom"
                    },
                    {
                        text: "Offer to help others with their gear",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "companionship_forged"
                    }
                ]
            },
            
            night_watch: {
                title: "The Third Watch",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The third watch. The worst watch. The hours before dawn. When the world was darkest. When men were most vulnerable. When sleep pulled at you like a physical weight. But you had to stay awake. Had to stay alert. The camp depended on it. Lives depended on it.</p>
                           
                           <p>You walked the perimeter. Slow circuit. Eyes scanning the darkness beyond the firelight. Looking for movement. For shapes that didn't belong. For anything that might be a threat. The night was alive with sounds. Animals. Wind. The creak of trees. Your job was to know which sounds mattered. Which ones meant danger.</p>
                           
                           <p>Behind you the camp slept. Men wrapped in blankets. Snoring. Muttering in dreams. A few cried out. Nightmares. The war followed them even into sleep. You envied them. At least they got to rest. Got to escape for a few hours. You had to stay here. In the cold. In the dark. Watching. Always watching.</p>
                           
                           <p>Something moved. Out there. Beyond the light. You froze. Hand to sword. Staring into darkness. Trying to see. To identify. Was it a man. An animal. Your imagination. The darkness played tricks. Made shapes where there were none. Made threats out of shadows. You waited. Breathing shallow. Heart pounding. Ready.</p>
                           
                           <p>A deer stepped into view. Just a deer. Looking for food. It saw you. Froze. Then bounded away. Disappeared into the night. You released your breath. Relaxed your grip on your sword. False alarm. But you'd done your job. Stayed alert. Stayed ready. That was all you could do. Watch. Wait. Hope that when the real threat came you'd see it in time. That your vigilance would be enough.</p>`;
                },
                choices: [
                    {
                        text: "Stay focused‚Äîthis is important",
                        effects: { wits: 1, stress: 1 },
                        nextScene: "watch_ends"
                    },
                    {
                        text: "Try to stay warm‚Äîbuild up the fire",
                        effects: { endurance: 1 },
                        nextScene: "warmth_found"
                    },
                    {
                        text: "Wake your relief early‚Äîyou need sleep",
                        effects: { stress: -1, reputation: -1 },
                        nextScene: "early_relief"
                    },
                    {
                        text: "Scout beyond the perimeter",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7,
                        nextScene: "patrol_findings"
                    }
                ]
            },
            
            camp_argument: {
                title: "Words and Steel",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Voices raised. Angry. You looked up from your meal. Two men squared off. John from Cornwall. Big man. Mean drunk. And Peter. Younger. From somewhere in the Midlands. They were shouting. Something about dice. About cheating. The usual camp nonsense. But it was escalating. Fast.</p>
                           
                           <p>John shoved Peter. Peter stumbled back. His hand went to his knife. The crowd around them shifted. Some moved away. Others moved closer. Eager. Hoping for violence. Anything to break the boredom. To provide entertainment. Men were gathering. Forming a circle. This was going to happen. Unless someone stopped it.</p>
                           
                           <p>You were a blow from home lad, John snarled. Shouldn't play games you don't understand. His fists were clenched. Face red. Drunk or angry or both. Peter was white. Frightened but trying not to show it. He kept his hand on his knife. I saw you palm that die, he said. His voice shook. Everyone saw it. You're the cheat. Not me.</p>
                           
                           <p>The accusation hung in the air. Cheating at dice was serious. Could get you beaten. Could get you killed. John's face went darker. You calling me a liar, he said. It wasn't a question. He took a step forward. Peter backed up. The knife was out now. Glinting in the firelight. The crowd pressed closer. Some calling for blood. Others just watching. Waiting to see what would happen.</p>
                           
                           <p>The sergeant wasn't here. No officers nearby. Just you and the other soldiers. Someone needed to stop this. Or let it play out. Sometimes men needed to settle things. Sometimes intervention made it worse. You had to decide. Fast. Before steel found flesh. Before this turned into something that couldn't be undone.</p>`;
                },
                choices: [
                    {
                        text: "Step between them‚Äîstop this now",
                        effects: { reputation: 1, stress: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7,
                        nextScene: "fight_prevented"
                    },
                    {
                        text: "Let them fight‚Äîthey're grown men",
                        effects: { morale: -1 },
                        nextScene: "fight_occurs"
                    },
                    {
                        text: "Fetch the sergeant",
                        effects: { reputation: -1 },
                        nextScene: "authority_called"
                    },
                    {
                        text: "Side with Peter‚ÄîJohn was cheating",
                        effects: { reputation: 1 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 8,
                        nextScene: "confrontation"
                    }
                ]
            },
            
            sick_tent: {
                title: "The Fevered and the Dying",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The sick tent stank. Sweat. Excrement. Rot. The smell hit you before you entered. Made your stomach turn. But you'd been ordered to help. The surgeon was overwhelmed. Too many sick. Too few hands. You pushed through the flap. Into hell.</p>
                           
                           <p>Men lay on pallets. Groaning. Some delirious with fever. Others silent. Too weak to make sound. The surgeon moved between them. Face grim. Doing what little he could. Which wasn't much. Medieval medicine was prayer and guesswork. Bleeding. Herbs. Hope. Most men who entered this tent didn't leave. Not alive anyway.</p>
                           
                           <p>A young man called out. Reached for you. His eyes were bright with fever. His skin burning. Mother, he said. Is that you mother. You weren't his mother. Weren't anyone's mother. But you knelt beside him. Took his hand. It's alright, you said. You're alright. The lies we tell the dying. The comfort we offer when there's no real comfort to give.</p>
                           
                           <p>The surgeon looked over. Saw you with the dying man. He'll be gone by morning, he said. Matter of fact. Clinical. Flux took his guts. Nothing to be done. He moved on. To the next patient. The next hopeless case. The young man squeezed your hand. His grip surprisingly strong. Don't leave, he whispered. Please don't leave me alone.</p>
                           
                           <p>You had a choice. Stay with him. Comfort him in his final hours. Or leave. Go back to the healthy camp. Where the air was clean and death wasn't so immediate. The surgeon had other tasks for you. Other men who might actually be saved. But this one. This boy. He just wanted someone there. When the end came.</p>`;
                },
                choices: [
                    {
                        text: "Stay with the dying man",
                        effects: { morale: 2, stress: 2 },
                        nextScene: "vigil_kept"
                    },
                    {
                        text: "Help the surgeon with the living",
                        effects: { wits: 1, reputation: 1 },
                        nextScene: "medical_work"
                    },
                    {
                        text: "Leave‚Äîyou can't handle this",
                        effects: { stress: -1, morale: -2 },
                        nextScene: "tent_fled"
                    },
                    {
                        text: "Pray for all of them",
                        effects: { morale: 1 },
                        nextScene: "prayers_offered"
                    }
                ]
            },
            
            camp_sermon: {
                title: "Words of God",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The chaplain called for service. Sunday. Even in war some things continued. Some rituals maintained. Men gathered. Not everyone. Some stayed away. Too tired. Too cynical. Too angry at God to worship. But enough came. Enough to make a congregation. Enough to pretend that faith still mattered.</p>
                           
                           <p>The chaplain was an old man. Gray beard. Stooped shoulders. He'd been a soldier once. Before he found God. Or before God found him. He understood these men. Knew what they'd seen. What they'd done. His sermons didn't judge. Didn't condemn. Just offered what comfort faith could provide. Which wasn't much but was something.</p>
                           
                           <p>He spoke of the Prodigal Son. The parable. A man who left home. Squandered his inheritance. Lived in sin. Then came back. Begging forgiveness. And his father welcomed him. Killed the fatted calf. Celebrated his return. The chaplain's voice was soft. Gentle. You have all left home, he said. All sinned. But God's mercy is infinite. Return to Him and He will welcome you.</p>
                           
                           <p>Some men wept. Openly. The words touching something deep inside them. The guilt they carried. The things they'd done. In God's name. In the king's name. In no name at all. Others sat stone-faced. Unmoved. Either they'd heard it too many times or they'd stopped believing. Stopped hoping that forgiveness was possible for men like them.</p>
                           
                           <p>The service ended. The chaplain gave his blessing. Made the sign of the cross. Men dispersed. Back to their tents. Their fires. Their lives. You sat a moment longer. Thinking about home. About the person you were before the war. About whether that person still existed. Or if war had killed him. Replaced him with this. This killer. This soldier. This thing you'd become.</p>`;
                },
                choices: [
                    {
                        text: "Speak with the chaplain afterward",
                        effects: { morale: 2, stress: -1 },
                        nextScene: "confession"
                    },
                    {
                        text: "Return to camp‚Äîactions matter more than words",
                        effects: { wits: 1 },
                        nextScene: "camp_life"
                    },
                    {
                        text: "Pray alone‚Äîbetween you and God",
                        effects: { morale: 1 },
                        nextScene: "private_prayer"
                    },
                    {
                        text: "Doubt everything‚Äîwhere was God at Cr√©cy",
                        effects: { stress: 1, wits: 1 },
                        nextScene: "crisis_faith"
                    }
                ]
            },
            
            french_peasant_encounter: {
                title: "A Local's Plea",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: "Normandy",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The old man approached slowly. Steps hesitant. As if each one might be his last. He was thin. Gaunt almost. Clothes hung loose. A frame that spoke of hunger. Of hard work. His tunic was patched. Multiple places. Fabric worn thin. Boots were scraps of leather. Bound with twine. Hands were raised. Supplication. The universal gesture of someone who has nothing left but hope. Face was lined. Marks of age. Of worry.</p>
                           
                           <p>He spoke in the Norman dialect. Words tumbling out. Too fast to understand. Accent was thick. Vowels rounded. Different from the English you were used to. Voice was cracked with emotion. He gestured as he spoke. Pointing back the way he came. Toward fields. Village beyond. Movements were desperate. Pleading.</p>
                           
                           <p>Geoffrey stepped forward. A man who'd served in Gascony. Learned enough of the local tongue. He listened. Brow furrowed. Then began to translate. Haltingly. He says the French soldiers came three days ago. Took his son. Press-ganged him. Dragged him away. Boy didn't want to go. But what choice did he have.</p>
                           
                           <p>The old man continued speaking. Voice rising. Geoffrey listened. Nodded. Translated again. His daughter is sick. Fever. Can't get out of bed. Wife died last winter. Now he has no one to tend the fields. Harvest is coming. If he can't bring it in they'll starve. He begs for help. Any help.</p>
                           
                           <p>The old man's eyes were desperate. You could see the fear in them. Not just fear of you. English soldiers in his land. But fear of what will happen. If he can't get help. If he can't bring in harvest. If his daughter doesn't recover. He knows what English soldiers are capable of. What any soldiers are capable of in this war. He's seen the devastation. Burned fields. Empty villages. Bodies by the roadside. But he's come anyway. Because he has no other choice.</p>
                           
                           <p>Around you camp continued. Men tending fires. Checking equipment. Talking. Laughing. But here in this small space there was a moment of stillness. A pause. The old man stood before you. Hands still raised. Eyes fixed on your face. Waiting. Behind him the Norman countryside stretched away. Green and peaceful in the afternoon light. But you knew that peace was an illusion. War had come to this place. Left its mark on everyone it touched.</p>`;
                },
                choices: [
                    {
                        text: "Give him a few coins from your share of plunder",
                        effects: { wealth: -1, reputation: 1, morale: 1 },
                        nextScene: "peasant_grateful"
                    },
                    {
                        text: "Question him about French troop movements",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        effects: { wits: 1 },
                        nextScene: "peasant_information"
                    },
                    {
                        text: "Turn him away‚Äîyou can't help everyone",
                        effects: { stress: 1 },
                        nextScene: "camp_continues"
                    },
                    {
                        text: "Offer to help find his son (if you have high reputation)",
                        requiresResolution: true,
                        resolutionStat: "reputation",
                        resolutionDifficulty: 8,
                        effects: { reputation: 2, stress: 2 },
                        nextScene: function() {
                            if (gameState.stats.reputation >= 8) {
                                return "rescue_mission";
                            }
                            return "peasant_disappointed";
                        }
                    }
                ]
            },
            
            roadside_shrine: {
                title: "The Wayside Cross",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The shrine stood at a crossroads. Stone cross. Weathered by centuries. At its base offerings. Flowers. Wilted. Candles. Burned down to stubs. Small coins. Wooden figures. The devotions of travelers. Of locals. Of people seeking protection. Seeking mercy. Seeking something from God or the saints or whatever power might listen.</p>
                           
                           <p>The cross was old. Pre-Christian some said. A place of power long before Christ. The Church had claimed it. Put their symbol here. But the old power remained. You could feel it. In the way the air moved. In the silence that surrounded this place. As if the world held its breath here. Waiting. Watching.</p>
                           
                           <p>Someone had carved words into the base. Latin. You couldn't read them but you knew what they said. Prayers. Pleas. The desperate words of people at the end of hope. This was a place of last resort. Where you came when there was nowhere else to turn. When human aid had failed. When only divine intervention might help.</p>
                           
                           <p>The column had stopped for water. The crossroads had a well. Men were filling skins. Watering horses. Taking a moment's rest. But no one disturbed the shrine. No one took the offerings. Even the most cynical soldiers left such places alone. Maybe from respect. Maybe from fear. Some things you didn't touch. Some places you didn't defile. Not if you wanted to keep your soul.</p>
                           
                           <p>You stood before the cross. Thinking about what you'd done. What you'd become. The lives taken. The destruction wrought. The sins accumulated. This shrine offered forgiveness. Offered peace. All you had to do was ask. Make an offering. Say the words. But could forgiveness be that simple. Could absolution erase what you'd done. You didn't know. But the cross stood there. Waiting. If you wanted it.</p>`;
                },
                choices: [
                    {
                        text: "Make an offering‚Äîleave a coin",
                        effects: { wealth: -1, morale: 2, stress: -1 },
                        nextScene: "offering_made"
                    },
                    {
                        text: "Pray silently‚Äîbetween you and God",
                        effects: { morale: 1 },
                        nextScene: "silent_prayer"
                    },
                    {
                        text: "Move on‚Äîprayers won't change anything",
                        effects: { stress: 1 },
                        nextScene: "march_continues"
                    },
                    {
                        text: "Carve your own plea into the stone",
                        effects: { morale: 2, reputation: 1 },
                        nextScene: "mark_left"
                    }
                ]
            },
            
            french_merchant: {
                title: "The Wine Seller",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The merchant appeared at the camp's edge. Cart pulled by a tired mule. He was rotund. Well-fed. Unusual in these times of hunger. His clothes were good quality. Wool. Dyed. This was a man who profited from war. Who knew how to survive. How to make coin from misery.</p>
                           
                           <p>He called out. In accented English. Good wine. Best in Gascony. Fair prices for brave soldiers. His smile was wide. Practiced. The smile of a man who'd sold to both sides. Who didn't care which army won. Just that they had coins to spend. War was good for business. His business anyway.</p>
                           
                           <p>Men gathered. Interested. Wine was a rare luxury. Most of the time you drank ale. Or water when there was nothing else. Wine meant celebration. Meant forgetting. Meant a few hours of something other than misery. The merchant knew this. Knew he could charge what he wanted. Supply and demand. He had supply. The soldiers had demand.</p>
                           
                           <p>He pulled back canvas. Revealed his cargo. Casks and bottles. The wine was genuine. You could smell it. Rich. Complex. From vineyards that had been making wine since Roman times. This was the real thing. Not the watered down swill you usually got. But the price. The merchant named it. Twice what it should be. Three times. But men were already reaching for their purses.</p>
                           
                           <p>You had ${wealth} shillings. Enough for a bottle. Maybe two if you haggled. The question was whether it was worth it. Wine wouldn't change anything. Wouldn't end the war. Wouldn't bring you home. But it would make tonight more bearable. Would give you a few hours of not thinking. Not remembering. Not feeling. Sometimes that was worth any price.</p>`;
                },
                choices: [
                    {
                        text: "Buy wine‚Äîyou've earned it (2 shillings)",
                        effects: { wealth: -2, morale: 2, stress: -1 },
                        nextScene: "wine_purchased"
                    },
                    {
                        text: "Try to haggle down the price",
                        effects: { wealth: -1, morale: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7,
                        nextScene: "haggling_success"
                    },
                    {
                        text: "Don't buy‚Äîsave your coins",
                        effects: { wits: 1 },
                        nextScene: "coin_saved"
                    },
                    {
                        text: "Threaten him‚Äîtake it for free",
                        effects: { wealth: 2, reputation: -2 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 6,
                        nextScene: "merchant_robbed"
                    }
                ]
            },
            
            letter_from_home: {
                title: "Word from England",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The letter arrived with the supply train. Carried by a merchant who knew someone who knew someone. The chain of intermediaries that connected soldiers to home. The parchment was worn. Stained. It had traveled far. Passed through many hands. But it had arrived. That was what mattered.</p>
                           
                           <p>You recognized the hand. Your brother. He'd learned to write from the village priest. Never got good at it but good enough. The words were simple. Direct. Mother is well. The harvest was adequate. Your sister married. A blacksmith from the next village. They're asking when you'll come home.</p>
                           
                           <p>When will you come home. The question sat there on the page. Innocent. Impossible. You didn't know. Didn't know if you'd ever go home. If the war would end. If you'd survive it. If anything would be left of the person who'd left England all those years ago. Or if that person was already dead. Killed by the things you'd done. The things you'd seen.</p>
                           
                           <p>The letter continued. More news. Small things. Village gossip. Who had died. Who had been born. The rhythm of ordinary life. Going on without you. The world turning. People living. Loving. Dying. All of it happening while you were here. In France. Fighting someone else's war. For reasons that seemed less clear every day.</p>
                           
                           <p>You folded the letter. Put it with the others. Three now. Three letters in four years. Not much. But something. Proof that home still existed. That you weren't completely alone. That somewhere people remembered you. Cared whether you lived or died. It was a thin thread. But it was all you had. The only thing connecting you to the life you'd left behind.</p>`;
                },
                choices: [
                    {
                        text: "Write back‚Äîtell them you're well (even if you're not)",
                        effects: { morale: 2, wealth: -1 },
                        nextScene: "letter_sent"
                    },
                    {
                        text: "Don't write back‚Äîwhat could you say",
                        effects: { stress: 2 },
                        nextScene: "silence_kept"
                    },
                    {
                        text: "Ask to be sent home‚Äîrequest discharge",
                        effects: { morale: -1, reputation: -2 },
                        nextScene: "discharge_requested"
                    },
                    {
                        text: "Keep the letter‚Äîread it when things get dark",
                        effects: { morale: 1 },
                        nextScene: "treasure_kept"
                    }
                ]
            },
            
            local_church: {
                title: "The Country Church",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The church was small. Stone. Ancient. It had stood here since before the Normans. Before William. Before England and France were separate things. The walls were thick. Windows narrow. Built to last. Built to endure. Wars. Plague. The passage of time. It had seen it all. Survived it all.</p>
                           
                           <p>Inside was cool. Dark. Light filtered through colored glass. Red. Blue. Gold. Painting the stone floor in shifting patterns. The air smelled of incense. Of candle wax. Of age. This was a holy place. You could feel it. The weight of centuries of prayer. Of devotion. Of people seeking something greater than themselves.</p>
                           
                           <p>The priest was old. Bent with age. He regarded you without fear. Without judgment. Just acceptance. English or French. Christian or heathen. In God's house all were welcome. He gestured to the altar. The votive candles. The collection box. Offering what every priest offered. A chance at redemption. A moment of peace. A respite from the world outside.</p>
                           
                           <p>Your men waited outside. Some had come in. Crossed themselves. Muttered prayers. Then left. Others stayed away. Uncomfortable in such places. Feeling unworthy. Or uncaring. You stood alone now. Looking at the altar. At the carved Christ hanging above it. His face serene. Forgiving. Despite the nails. Despite the crown of thorns. Despite everything.</p>
                           
                           <p>You thought about taking. There were silver candlesticks. Offering plates. Small treasures. The Church was rich. This little church probably had more wealth than the entire village. It would be easy. The priest was old. Couldn't stop you. No one would know. Except you. Except God. If He was watching. If He cared about what one soldier did in one small church in the middle of France.</p>`;
                },
                choices: [
                    {
                        text: "Make a proper offering",
                        effects: { wealth: -1, morale: 2, reputation: 1 },
                        nextScene: "blessing_received"
                    },
                    {
                        text: "Pray for the dead‚Äîfor those you've killed",
                        effects: { morale: 1, stress: -1 },
                        nextScene: "prayers_dead"
                    },
                    {
                        text: "Leave‚Äîyou don't belong here",
                        effects: { stress: 1 },
                        nextScene: "church_departed"
                    },
                    {
                        text: "Take what you can‚Äîthe Church has enough",
                        effects: { wealth: 3, morale: -2, reputation: -2 },
                        nextScene: "sacrilege"
                    }
                ]
            },
            
            nightmare_memory: {
                title: "Dreams of Blood",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>You woke gasping. Heart pounding. The dream still vivid. Still real. His face. The French soldier at Cr√©cy. Young. Terrified. Begging. You couldn't understand the words but you understood the tone. Mercy. He was asking for mercy. You gave him steel instead. Watched his eyes go dim. Watched him fall.</p>
                           
                           <p>That was two years ago. But in dreams it was yesterday. Always yesterday. The memory fresh. The guilt immediate. You'd killed before. Would kill again. But that one stayed with you. Maybe because he reminded you of yourself. Maybe because you'd seen his humanity in that moment. And killed him anyway.</p>
                           
                           <p>Around you other men slept. Snoring. Muttering. Some crying out. Everyone had nightmares. Everyone carried ghosts. The dead didn't stay dead. They came back. In dreams. In quiet moments. In the faces of other men. The victims. The ones you'd killed. They haunted you. Would haunt you forever.</p>
                           
                           <p>You sat up. Unwilling to return to sleep. Unwilling to see that face again. That expression. That moment of recognition. When he knew he was going to die. When he accepted it. The resignation in his eyes. That was worse than the fear. The acceptance. As if he'd known this was how it would end. Known and accepted and waited for the blade.</p>
                           
                           <p>Dawn was still hours away. The night stretched before you. Dark. Empty. Full of memories you couldn't escape. This was the price. This was what killing did to you. It carved pieces from your soul. Left holes. Filled them with ghosts. With faces. With moments you could never take back. Never undo. Never escape. You just had to carry them. Until the weight became unbearable. Or until you died. Whichever came first.</p>`;
                },
                choices: [
                    {
                        text: "Accept it‚Äîthis is who you are now",
                        effects: { stress: -1, morale: -1 },
                        nextScene: "acceptance"
                    },
                    {
                        text: "Fight it‚Äîrefuse to let it define you",
                        effects: { wits: 1, stress: 1 },
                        nextScene: "resistance"
                    },
                    {
                        text: "Pray for forgiveness",
                        effects: { morale: 2, stress: -1 },
                        nextScene: "prayer_night"
                    },
                    {
                        text: "Talk to someone about it",
                        effects: { reputation: 1, morale: 1 },
                        nextScene: "confession_peer"
                    }
                ]
            },
            
            bandits_encounter: {
                title: "The Routiers",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>They stepped from the trees. A dozen men. Maybe more. Armed. Armored after a fashion. Piecemeal gear. Scavenged. Stolen. Taken from the dead. These were routiers. Mercenaries. Free Company men. Between contracts. Which made them bandits. Desperados. More dangerous than any French army because they had nothing to lose.</p>
                           
                           <p>Their leader stepped forward. Big man. Scarred face. He'd been a soldier once. A good one probably. Before the wars broke him. Before he decided robbery paid better than service. Now he led this rabble. This collection of killers and thieves. Making a living off the misery of others.</p>
                           
                           <p>You are a long way from your army, he called. His English was good. Better than your French. He smiled. Not friendly. Predatory. We could kill you. Take everything. Leave your bones for the crows. Or. He paused. Letting the word hang. You could pay. A toll. For using our road. Call it protection money.</p>
                           
                           <p>You were four men. They were twelve. Maybe fifteen. The odds weren't good. But running meant showing your back. Meant being cut down like rabbits. Fighting meant dying. Probably. But taking some of them with you. Or you could pay. Give them what they wanted. Live to see another day. Each option had consequences. Each carried risks.</p>
                           
                           <p>Your companions looked to you. Waiting for your call. ${name}, Will whispered. What do we do. His hand was on his sword. Ready to fight if that's what you chose. But hoping you'd find another way. Hoping there was a way out of this that didn't end with blood in the dirt.</p>`;
                },
                choices: [
                    {
                        text: "Pay the toll‚Äîlive to fight another day",
                        effects: { wealth: -3, stress: 1 },
                        nextScene: "toll_paid"
                    },
                    {
                        text: "Fight‚Äîyou don't pay bandits",
                        effects: { reputation: 2 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9,
                        nextScene: "bandit_fight"
                    },
                    {
                        text: "Try to talk your way out",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 8,
                        nextScene: "negotiation"
                    },
                    {
                        text: "Bluff‚Äîclaim your army is right behind you",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7,
                        nextScene: "bluff_attempt"
                    }
                ]
            },
            
            moral_choice: {
                title: "The Prisoner's Fate",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The prisoner knelt before you. French. A common soldier like yourself. He'd surrendered after his unit broke. Thrown down his weapons. Raised his hands. Now he was yours. Your responsibility. Your problem. The question was what to do with him.</p>
                           
                           <p>The sergeant had been clear. No prisoners. Can't feed them. Can't guard them. Can't be bothered. Kill them or let them go. Those were your options. Killing was easier. Safer. A dead man couldn't report your position. Couldn't rejoin his unit. Couldn't come back to kill you later. It was the practical choice. The soldier's choice.</p>
                           
                           <p>But the man kneeling before you was pleading. In French you could barely understand. But the meaning was clear. Please. Mercy. Life. His eyes were desperate. Terrified. He was younger than you. Couldn't be more than twenty. Someone's son. Someone's brother. Maybe someone's husband. A person. Not just an enemy. A person who wanted to live.</p>
                           
                           <p>Your hand was on your sword. The other men had walked away. Giving you privacy. Giving you space to do what needed doing. They'd all done it. At some point. Killed a prisoner. Justified it however they could. Orders. Necessity. War. The reasons didn't matter. The act remained. Taking a life. A helpless life. A surrendered life. That was what being a soldier meant sometimes.</p>
                           
                           <p>You thought about the man you were before the war. Would he understand this. Would he recognize you. This person you'd become. Someone who could kill an unarmed man. Someone who had to make these choices. These impossible choices. Where mercy might mean death. For you. For your comrades. And cruelty might mean survival. You had to decide. Now. What kind of man you were. What kind of man you would be.</p>`;
                },
                choices: [
                    {
                        text: "Kill him‚Äîit's war, not murder",
                        effects: { stress: 2, morale: -2 },
                        nextScene: "prisoner_killed"
                    },
                    {
                        text: "Let him go‚Äîyou're not an executioner",
                        effects: { morale: 2, reputation: 1, stress: 1 },
                        nextScene: "prisoner_freed"
                    },
                    {
                        text: "Take him to the captain‚Äîlet someone else decide",
                        effects: { wits: 1 },
                        nextScene: "responsibility_shifted"
                    },
                    {
                        text: "Question him first‚Äîget information",
                        effects: { wits: 2 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "interrogation"
                    }
                ]
            },
            
            fellow_soldier_story: {
                title: "Tales by Firelight",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The fire burned low. Embers glowing. Men sat around it. Quiet. Reflective. The kind of quiet that comes after a long day. After exhaustion has set in. But before sleep takes you. Someone started talking. Old Robert. A veteran. Been soldiering since before most of you were born.</p>
                           
                           <p>I was at Bannockburn, he said. His voice was soft. Almost dreamy. As if remembering took him somewhere else. Somewhere far from this French field. We thought we'd win easy. English knights against Scottish rabble. But the Scots had pikes. And they had ground. And they had Bruce.</p>
                           
                           <p>He paused. Stared into the fire. Seeing things the rest of you couldn't see. Battles fought decades ago. Friends lost. Defeats suffered. We broke, he continued. The whole army. Just broke and ran. I was young then. Fast. I made it out. Many didn't. I can still hear them. Screaming. Dying. Under those Scottish pikes.</p>
                           
                           <p>The other men listened. Silent. Everyone had stories. Everyone had battles they'd survived. Or barely survived. But hearing them told. Hearing the pain in an old soldier's voice. That made it real. Made it human. Reminded you that beneath the armor. Beneath the weapons. You were all just men. Frightened men. Trying to survive.</p>
                           
                           <p>Robert looked up. His eyes met yours. You'll have your own stories soon enough, he said. If you live long enough. We all collect them. These memories. These ghosts. The faces of the men we killed. The friends we lost. They stay with you. Forever. That's the real price of being a soldier. Not the wounds. Not the scars. The memories. Those hurt worst of all.</p>`;
                },
                choices: [
                    {
                        text: "Share your own story",
                        effects: { morale: 2, reputation: 1 },
                        nextScene: "story_shared"
                    },
                    {
                        text: "Listen‚Äîlearn from his experience",
                        effects: { wits: 2 },
                        nextScene: "wisdom_gained"
                    },
                    {
                        text: "Ask about Bannockburn‚Äîwhat went wrong",
                        effects: { wits: 1, morale: 1 },
                        nextScene: "tactical_lesson"
                    },
                    {
                        text: "Stay silent‚Äîsome things are better not spoken",
                        effects: { stress: 1 },
                        nextScene: "quiet_reflection"
                    }
                ]
            },
            
            spring_landscape: {
                title: "Renewal",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Spring. The word seemed impossible. But there it was. Green shoots pushing through winter-dead earth. Trees budding. Birds returning. Life renewing itself. Indifferent to the war. Indifferent to the men who'd bled and died here. Nature didn't care. It just continued. Season after season. Growing. Dying. Growing again.</p>
                           
                           <p>The fields were mud. But different mud than winter. This mud smelled of growth. Of things coming alive. Not decay. Not death. For the first time in months something other than misery seemed possible. The sun was warmer. The air softer. The days longer. Everything was changing. Becoming what it was meant to be.</p>
                           
                           <p>Flowers appeared. Wildflowers. Blue and yellow. Scattered across the meadows like offerings. Like prayers. Like hope made visible. You stopped to look at them. Actually stopped. Let the column move on without you. Just stood there. Looking at flowers. Feeling the sun on your face. Remembering that beauty existed. That not everything was blood and mud and death.</p>
                           
                           <p>A lark sang. High above. Its song cascading down. Pure. Joyful. Unconcerned with human troubles. You listened. Really listened. Trying to remember the last time you'd heard birdsong. Trying to remember when you'd stopped noticing. When the world had narrowed to just survival. Just the next march. The next battle. The next day.</p>
                           
                           <p>The moment passed. The column was getting ahead. You had to move. Had to keep up. But something had shifted. Inside you. Something small. Fragile. Like those flowers. Like that birdsong. A reminder that the world was more than war. That spring came even to France. Even to battlefields. Even to places where men killed each other for reasons most of them couldn't explain.</p>`;
                },
                choices: [
                    {
                        text: "Embrace it‚Äîenjoy this moment",
                        effects: { morale: 3, stress: -2 },
                        nextScene: "peace_found"
                    },
                    {
                        text: "Remember it‚Äîhold onto beauty",
                        effects: { morale: 2, wits: 1 },
                        nextScene: "memory_treasured"
                    },
                    {
                        text: "Ignore it‚Äîstay focused on survival",
                        effects: { stress: 1 },
                        nextScene: "march_continues"
                    }
                ]
            },
            
            crecy_preparation: {
                title: "Before Cr√©cy",
                year: 1346,
                age: function() { return gameState.age; },
                location: "Cr√©cy-en-Ponthieu",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The order came at dawn. Form up. The French were coming. Everyone knew it. You'd been waiting for this. Days of marching. Maneuvering. Now it would end. Here. On this ridge. Either in victory or death. Those were the only options.</p>
                           
                           <p>The ground was good. King Edward had chosen well. A slope. Gradual but enough to matter. The French would have to charge uphill. Into arrows. Into stakes. Into death. The archers were already in position. Thousands of them. Longbowmen from Wales. From England. The best in the world. Their bows propped before them. Arrows stuck in the ground. Ready.</p>
                           
                           <p>You took your position in the line. Men-at-arms. The backbone. The ones who'd hold when the arrows stopped flying. When it came to steel and muscle and will. Your shield was heavy on your arm. Your sword loose in its sheath. Everything was ready. Everything was prepared. All that remained was waiting. Waiting for the French to come. Waiting to see if you'd live through this day.</p>
                           
                           <p>The sun climbed. Afternoon came. Still no French. The waiting was torture. Worse than fighting. At least in battle you didn't have time to think. To imagine. To fear. But waiting. That gave your mind time to work. To picture everything that could go wrong. Everything that could kill you. The arrows. The horses. The French knights in their fine armor. All of it coming for you.</p>
                           
                           <p>Then you saw them. On the horizon. A mass of men and horses. Banners. Thousands of banners. The French army. So many. Too many. They filled the valley. Edge to edge. Like a river of steel. Moving toward you. Coming to kill you. Or die trying. This was it. The moment. ${name}, Will whispered beside you. God help us all. You didn't answer. Just gripped your sword. And waited. For the battle. For history. For whatever came next.</p>`;
                },
                choices: [
                    {
                        text: "Stand firm‚Äîyou're English, you don't break",
                        effects: { morale: 2, endurance: 1 },
                        nextScene: "crecy_battle"
                    },
                    {
                        text: "Pray‚Äîyou'll need God's help",
                        effects: { morale: 1, stress: -1 },
                        nextScene: "crecy_battle"
                    },
                    {
                        text: "Check your gear one last time",
                        effects: { initiative: 1 },
                        nextScene: "crecy_battle"
                    }
                ]
            },
            
            plunder_decision: {
                title: "The Undefended Manor",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The manor stood alone. Stone walls. Tiled roof. Wealthy once. Maybe still. No signs of defenders. No smoke from fires. No sounds of occupation. Just an empty building. Full of possibilities. Full of plunder. If you were willing to take it.</p>
                           
                           <p>The others were already moving forward. Eager. Eyes bright with greed. This was what soldiers lived for. The chance at loot. At wealth beyond their station. A manor like this could hold silver. Tapestries. Jewelry. Things worth more than a year's wages. Things that could change your life. If you got to them first.</p>
                           
                           <p>But something felt wrong. Too easy. Too convenient. An undefended manor in the middle of a war zone. Either the owners had fled in panic. Leaving everything. Or this was a trap. Bait. Luring greedy soldiers into an ambush. Or maybe there was plague inside. That would explain the abandonment. The silence. The sense of wrongness.</p>
                           
                           <p>Thomas was already at the door. Pushing it open. Others following. You had seconds to decide. Go in. Take your chances. Maybe get rich. Maybe get killed. Maybe get sick. Or stay outside. Safe. Poor. Watching others claim what could have been yours. The choice was simple. But the consequences weren't.</p>
                           
                           <p>${name}, Will called. What are you doing. Come on. But you hesitated. That voice in your head. The one that kept you alive this long. It was screaming. Warning you. Something was wrong with this place. Something was very wrong. Whether you listened to that voice or ignored it. That would determine what happened next.</p>`;
                },
                choices: [
                    {
                        text: "Enter the manor‚Äîfortune favors the bold",
                        effects: { wealth: 4 },
                        requiresResolution: true,
                        resolutionStat: "luck",
                        resolutionDifficulty: 6,
                        nextScene: function() {
                            if (Math.random() * 10 + gameState.stats.luck >= 6) {
                                return "plunder_success";
                            }
                            return "plunder_trap";
                        }
                    },
                    {
                        text: "Scout around first‚Äîcheck for danger",
                        effects: { wits: 2 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7,
                        nextScene: "trap_discovered"
                    },
                    {
                        text: "Stay outside‚Äîthis feels like a trap",
                        effects: { wits: 1 },
                        nextScene: "caution_rewarded"
                    },
                    {
                        text: "Wait for others to go first‚Äîsee what happens",
                        effects: { reputation: -1 },
                        nextScene: "watch_unfold"
                    }
                ]
            },
            
            // ===== NEW PILLAGING/CRUELTY EVENTS (Opportunities to be bad for money) =====
            peasant_extortion: {
                title: "The Desperate Farmer",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The farmer stood in his field. Old. Bent. His hands shaking. He'd seen you coming. The whole column. Hundreds of men. Moving through his land. Through his crops. Trampling everything. Destroying what he'd spent a year growing.</p>
                           
                           <p>He approached. Hesitant. Fearful. Please, he said in broken English. My family. My farm. We have nothing. But you could see the lie in his eyes. The way he clutched his tunic. The bulge beneath it. He had something. Coin. Or jewelry. Or something worth taking.</p>
                           
                           <p>Your comrades were already looking. Calculating. A farmer like this. Alone. Defenseless. Easy prey. They'd take everything. Leave him with nothing. Maybe worse. You could join them. Get your share. Or you could walk away. Let him keep what little he had. But coin was coin. And you needed it. More than he did. Probably.</p>
                           
                           <p>The old man's eyes pleaded. But his hand moved to his tunic. Protecting something. Something valuable. Something that could mean the difference between life and death for you. Between having coin when you needed it and being broke. Being dead.</p>`;
                },
                choices: [
                    {
                        text: "Threaten him‚Äîmake him hand over his valuables",
                        effects: { wealth: 96, reputation: -3, morale: -1, stress: 1 }, // 8 shillings = 96 pence
                        nextScene: "extortion_success"
                    },
                    {
                        text: "Search him by force‚Äîtake everything",
                        effects: { wealth: 144, reputation: -4, morale: -2, stress: 2 }, // 12 shillings = 144 pence
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 5,
                        nextScene: "brutal_theft"
                    },
                    {
                        text: "Leave him alone‚Äîhe's suffered enough",
                        effects: { reputation: 1, morale: 1 },
                        nextScene: "mercy_shown"
                    },
                    {
                        text: "Take only what you need‚Äîleave him something",
                        effects: { wealth: 36, reputation: -1 }, // 3 shillings = 36 pence
                        nextScene: "partial_theft"
                    }
                ]
            },
            
            village_pillage: {
                title: "The Undefended Village",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The village was empty. Or nearly. The inhabitants had fled. Seeing the column approach. Knowing what soldiers did to undefended villages. They'd taken what they could carry. Left the rest. Their homes. Their possessions. Their lives. All abandoned. All yours for the taking.</p>
                           
                           <p>Your comrades were already inside. Breaking doors. Overturning furniture. Looking for hidden valuables. For coin. For anything worth taking. The sound of destruction filled the air. Wood splintering. Glass breaking. The casual violence of men who'd learned that nothing was sacred. That everything was plunder.</p>
                           
                           <p>You could join them. Take your share. A village like this could have hidden wealth. Coins buried in gardens. Jewelry hidden in walls. Things people thought were safe. Things that weren't. You could be thorough. Methodical. Leave nothing. Or you could be quick. Take what was obvious. Move on. But thorough meant more coin. More wealth. More security against the day when coin meant life.</p>
                           
                           <p>In the distance you heard screams. Not everyone had fled. Some had stayed. Too old. Too sick. Too afraid to leave. They were learning now. Learning what soldiers did. What you could do. If you chose to. The choice was yours. But the screams were real. The fear was real. And the coin was real too.</p>`;
                },
                choices: [
                    {
                        text: "Pillage thoroughly‚Äîsearch every house",
                        effects: { wealth: 180, reputation: -3, morale: -2, stress: 2 }, // 15 shillings = 180 pence
                        nextScene: "thorough_pillage"
                    },
                    {
                        text: "Be cruel‚Äîintimidate those who stayed for more coin",
                        effects: { wealth: 240, reputation: -5, morale: -3, stress: 3 }, // 20 shillings = 240 pence = ¬£1
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "cruel_extraction"
                    },
                    {
                        text: "Take only obvious valuables‚Äîleave quickly",
                        effects: { wealth: 72, reputation: -1 }, // 6 shillings = 72 pence
                        nextScene: "quick_pillage"
                    },
                    {
                        text: "Refuse to pillage‚Äîthis is wrong",
                        effects: { reputation: 2, morale: 1, stress: -1 },
                        nextScene: "refusal_honor"
                    }
                ]
            },
            
            prisoner_ransom: {
                title: "The Wounded Noble",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The French noble lay in the mud. Wounded. His fine clothes torn. Blood soaking through. He was young. Maybe twenty. Rich. You could tell from his armor. From the rings on his fingers. From the way he carried himself even now. Even broken. Even dying.</p>
                           
                           <p>He looked up at you. Fear in his eyes. But also calculation. He knew what you were. What you could do. But he also knew what he was worth. His family would pay. Handsomely. For his safe return. Or you could kill him. Take what he had. Leave his body for the crows. But ransom was more. Much more. If you could keep him alive. If you could get him back to camp.</p>
                           
                           <p>Others were watching. Your comrades. They'd want a share. Or they'd take him from you. Claim the ransom for themselves. You'd need to be quick. Decisive. Claim him as your prisoner. Your prize. Your coin. But there was another option. He had valuables on him. Right now. Rings. A purse. Things you could take. Things worth coin. But less than ransom. Much less.</p>
                           
                           <p>The noble spoke. In French. Then in broken English. Ransom, he said. My family. They pay. Much coin. Please. The desperation in his voice was real. The fear was real. But so was the wealth. So was the opportunity. To be rich. To have coin. To never be broke again. To never die because you couldn't afford to live.</p>`;
                },
                choices: [
                    {
                        text: "Take him prisoner‚Äîclaim the full ransom",
                        effects: { wealth: 360, reputation: 1 }, // 30 shillings = 360 pence = ¬£1 10s
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 7,
                        nextScene: "ransom_secured"
                    },
                    {
                        text: "Kill him and take his valuables‚Äîquick coin",
                        effects: { wealth: 12, reputation: -3, morale: -2, stress: 2 },
                        nextScene: "noble_killed"
                    },
                    {
                        text: "Strip him of valuables and leave him‚Äîcompromise",
                        effects: { wealth: 8, reputation: -1, morale: -1 },
                        nextScene: "partial_theft_noble"
                    },
                    {
                        text: "Help him‚Äîshow mercy",
                        effects: { reputation: 2, morale: 1 },
                        nextScene: "mercy_noble"
                    }
                ]
            },
            
            church_desecration: {
                title: "The Abandoned Church",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The church stood empty. The priest had fled. Or been killed. The doors were open. Inviting. Or warning. You couldn't tell. Inside was dark. Cool. The smell of incense and age. Of something sacred. Or something that had been sacred. Before the war. Before men like you came.</p>
                           
                           <p>Your comrades were already inside. Laughing. Calling out. Finding things. Silver candlesticks. Offering plates. A cross. Gold. Real gold. Worth a fortune. The Church was rich. Everyone knew that. Rich enough to spare. Rich enough that taking from it wasn't really theft. It was redistribution. From the wealthy Church to the poor soldiers. That's how you could justify it. If you needed to.</p>
                           
                           <p>But there was more. The altar. The reliquary. Things that might contain jewels. Things worth more than silver. Things that could make you rich. If you were willing to take them. To defile a church. To commit sacrilege. But coin was coin. And the Church had plenty. More than you'd ever have. More than you'd ever need. Unless you took it.</p>
                           
                           <p>Others were already taking. Filling sacks. Laughing. Joking about God's wrath. About damnation. But they had coin. They had wealth. They had security. And you had nothing. Nothing but the chance to take. To become like them. To have what they had. If you were willing to pay the price. If you were willing to damn yourself. For coin. For life.</p>`;
                },
                choices: [
                    {
                        text: "Take everything valuable‚Äîmaximum profit",
                        effects: { wealth: 25, reputation: -4, morale: -3, stress: 2 },
                        nextScene: "complete_desecration"
                    },
                    {
                        text: "Take only silver‚Äîleave the sacred items",
                        effects: { wealth: 10, reputation: -2, morale: -1 },
                        nextScene: "partial_desecration"
                    },
                    {
                        text: "Take nothing‚Äîthis is sacrilege",
                        effects: { reputation: 2, morale: 1 },
                        nextScene: "respect_shown"
                    },
                    {
                        text: "Take the reliquary‚Äîit's worth the most",
                        effects: { wealth: 35, reputation: -5, morale: -4, stress: 3 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 7,
                        nextScene: "ultimate_sacrilege"
                    }
                ]
            },
            
            merchant_robbery: {
                title: "The Traveling Merchant",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The merchant's cart was stuck. Wheel deep in mud. He was trying to free it. Pushing. Pulling. Desperate. His goods were valuable. Silks. Spices. Things worth coin. Things that could make him rich. Or make you rich. If you took them.</p>
                           
                           <p>He saw you coming. Saw the column. Saw the soldiers. His face went pale. He knew what happened to merchants caught alone. Knew what soldiers did. Knew he was vulnerable. Defenseless. Easy prey. He reached for his purse. Offering coin. Bribing. Trying to buy safety. Trying to buy his life.</p>
                           
                           <p>But you could take more. Much more. The cart. The goods. Everything. Leave him with nothing. Or kill him. Take it all. No witnesses. No one to tell. Just you. And the coin. And the wealth. And the security that came with it. The security of never being broke. Never dying because you couldn't afford to live.</p>
                           
                           <p>Your comrades were watching. Waiting. Seeing what you'd do. If you'd take the bribe. Or take everything. Or kill him. They'd want a share. Or they'd take it from you. But if you acted first. If you claimed it. It was yours. Your coin. Your wealth. Your life. Bought with his. If you were willing to pay that price.</p>`;
                },
                choices: [
                    {
                        text: "Take the bribe and move on‚Äîeasy coin",
                        effects: { wealth: 5, reputation: -1 },
                        nextScene: "bribe_taken"
                    },
                    {
                        text: "Rob him completely‚Äîtake cart and goods",
                        effects: { wealth: 20, reputation: -3, morale: -1, stress: 1 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 6,
                        nextScene: "complete_robbery"
                    },
                    {
                        text: "Kill him and take everything‚Äîno witnesses",
                        effects: { wealth: 25, reputation: -5, morale: -3, stress: 3 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7,
                        nextScene: "murder_robbery"
                    },
                    {
                        text: "Help him free the cart‚Äîshow mercy",
                        effects: { reputation: 2, morale: 1 },
                        nextScene: "mercy_merchant"
                    }
                ]
            },
            
            peasant_brutality: {
                title: "The Hiding Peasants",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>You found them in the cellar. A family. Father. Mother. Three children. Hiding. Hoping you'd pass by. Hoping you wouldn't find them. But you did. You always did. Experience had taught you where people hid. Where they thought they were safe. Where they weren't.</p>
                           
                           <p>They were terrified. The father held a pitchfork. Useless. A farmer's tool against a soldier's sword. But he held it anyway. Protecting his family. Or trying to. The mother clutched the children. Pulled them close. Her eyes wide with fear. With desperation. With the knowledge that they were helpless. That you could do anything. Anything at all.</p>
                           
                           <p>They had things. Hidden. Buried. Things they thought were safe. Coins. Jewelry. Things worth taking. Things worth coin. You could make them tell you. Threaten. Hurt. Kill. They'd tell you. Eventually. Everyone did. Or you could just take what was obvious. Leave them. But thorough meant more coin. More wealth. More security. If you were willing to be cruel. If you were willing to be the thing the war had made you.</p>
                           
                           <p>The father spoke. In French. Pleading. Offering. Trying to buy safety. Trying to buy their lives. But you didn't understand. Or pretended not to. Language was just another weapon. Another way to have power. Another way to take what you wanted. What you needed. What would keep you alive when others died. Because they were broke. Because they had nothing. Because they couldn't buy their way out of death.</p>`;
                },
                choices: [
                    {
                        text: "Intimidate them into revealing hidden valuables",
                        effects: { wealth: 10, reputation: -2, morale: -1, stress: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "intimidation_success"
                    },
                    {
                        text: "Be brutal‚Äîhurt them until they tell",
                        effects: { wealth: 18, reputation: -4, morale: -3, stress: 3 },
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 5,
                        nextScene: "brutality_success"
                    },
                    {
                        text: "Take only what's obvious‚Äîleave them",
                        effects: { wealth: 4, reputation: -1 },
                        nextScene: "partial_theft_peasants"
                    },
                    {
                        text: "Leave them alone‚Äîthey're just trying to survive",
                        effects: { reputation: 2, morale: 1 },
                        nextScene: "mercy_peasants"
                    }
                ]
            },
            
            noblevisit: {
                title: "The Knight's Inspection",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>The knight rode through camp. Sir Edmund. One of the commanders. Full plate. War horse. Everything polished. Gleaming. He looked like something from a tapestry. Like something that wasn't quite real. Too perfect. Too clean. Nothing like the mud-stained soldiers he commanded.</p>
                           
                           <p>Men scrambled to attention. Standing straight. Trying to look presentable. The knight didn't seem to notice. Or care. His eyes swept over them. Assessing. Calculating. Seeing bodies. Numbers. Tools for war. Not men. Not individuals. Just resources to be deployed.</p>
                           
                           <p>He stopped before your section. Dismounted. His squire hurried to take the horse. The knight walked along the line. Inspecting. His gaze sharp. Critical. He stopped at you. Looked you up and down. Your name, he demanded. Not a question. A command. You gave it. ${name}, you said. The knight nodded. Once. Brief. Acknowledging your existence. Barely.</p>
                           
                           <p>Your equipment is acceptable, he said. Not a compliment. Just a statement. But maintain it better. A dull blade is worse than no blade at all. He moved on. Down the line. Stopping at others. Finding faults. Pointing out deficiencies. His voice was cold. Clipped. The voice of someone who'd never known what it was like to be afraid. To be hungry. To be anything other than noble.</p>
                           
                           <p>When he finished he addressed the whole group. You fight for England, he said. For your king. For God. Remember that. Remember why you're here. Then he mounted. Rode away. Back to his tent. His wine. His comfort. Leaving you standing in the mud. In the cold. In the place where men like you belonged. Separate from men like him. Always separate.</p>`;
                },
                choices: [
                    {
                        text: "Feel inspired‚Äîfight for something greater",
                        effects: { morale: 2 },
                        nextScene: "inspiration_found"
                    },
                    {
                        text: "Feel resentment‚Äîhe knows nothing of our struggle",
                        effects: { stress: 1, wits: 1 },
                        nextScene: "class_divide"
                    },
                    {
                        text: "Maintain your gear better‚Äîprove him wrong",
                        effects: { initiative: 1, reputation: 1 },
                        nextScene: "improvement_made"
                    },
                    {
                        text: "Forget him‚Äînobles don't understand soldiers",
                        effects: { morale: -1 },
                        nextScene: "dismissed"
                    }
                ]
            },
            
            camp_follower: {
                title: "The Washerwoman",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>She worked at the stream. Washing clothes. One of the camp followers. Women who traveled with the army. Doing the work soldiers couldn't or wouldn't do. Washing. Cooking. Mending. Other things. For coin. For protection. For survival in a world that offered few choices to women alone.</p>
                           
                           <p>Her hands were red. Raw from cold water. From lye soap. From endless scrubbing. But she worked without complaint. Methodical. Efficient. This was her trade. Her livelihood. She was good at it. Had to be. Competition was fierce. Too many women. Not enough soldiers with coin to pay them.</p>
                           
                           <p>She looked up. Saw you watching. Smiled. Not seductive. Just friendly. Professional. Clothes need washing, she asked. Her accent was French. But her English was good. Learned from necessity. From dealing with English soldiers for months. Maybe years. Three pence, she said. I do good work. Your clothes come back clean.</p>
                           
                           <p>You looked at your clothes. They were filthy. Stiff with dirt and sweat. The idea of clean clothes. Of something that didn't stink. It was tempting. Three pence wasn't much. You'd spent more on dice. On ale. On things with less value. But something made you hesitate. Maybe the way she looked. Tired. Worn. Like the work was eating her from inside.</p>
                           
                           <p>Or maybe it was just the transaction. The cold commerce of it. Money for service. Nothing more. No connection. No humanity. Just need and payment. The war had turned everything into transactions. Even something as simple as washing clothes. Even basic kindness came with a price.</p>`;
                },
                choices: [
                    {
                        text: "Pay her‚Äîyou need clean clothes",
                        effects: { wealth: -1, morale: 1 },
                        nextScene: "clothes_washed"
                    },
                    {
                        text: "Talk with her‚Äîlearn her story",
                        effects: { wits: 1, morale: 1 },
                        nextScene: "conversation_shared"
                    },
                    {
                        text: "Decline‚Äîsave your coins",
                        effects: { stress: 1 },
                        nextScene: "walked_away"
                    },
                    {
                        text: "Offer to help her instead",
                        effects: { reputation: 1, endurance: -1 },
                        nextScene: "kindness_shown"
                    }
                ]
            },
            
            // ===== ADDITIONAL SPENDING OPPORTUNITIES =====
            blacksmith_visit: {
                title: "The Camp Blacksmith",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The blacksmith's forge glowed in the evening. Fire and metal. The sound of hammer on anvil. Ringing. Constant. The rhythm of war. Of preparation. Of survival. The blacksmith was a big man. Arms like tree trunks. Face scarred by sparks. He'd been with the army for years. Knew what soldiers needed. Knew what they'd pay for.</p>
                           
                           <p>Better equipment. That's what kept you alive. A good sword. Proper armor. Things that turned a killing blow into a glancing strike. Things that meant the difference between life and death. The blacksmith had them. Forged them. Sold them. At a price. Everything had a price. Especially life.</p>
                           
                           <p>You had ${wealth} shillings. Enough for something. Maybe better mail. A sharper sword. A sturdier shield. Things that would make you harder to kill. Things that would give you an edge. In a world where edges mattered. Where every advantage counted. Where coin could buy you life itself.</p>
                           
                           <p>The blacksmith looked up. Saw you watching. Nodded. Come to buy, he asked. Or just looking. His voice was rough. Like gravel. Like someone who'd breathed too much smoke. Too much fire. But his eyes were sharp. Calculating. He knew what you wanted. What you needed. What you'd pay.</p>`;
                },
                choices: [
                    {
                        text: "Buy better mail armor (15 shillings)",
                        effects: { wealth: -15, endurance: 2 },
                        nextScene: "armor_purchased"
                    },
                    {
                        text: "Buy a better sword (12 shillings)",
                        effects: { wealth: -12, strength: 1, initiative: 1 },
                        nextScene: "sword_purchased"
                    },
                    {
                        text: "Buy a sturdy shield (10 shillings)",
                        effects: { wealth: -10, endurance: 1 },
                        nextScene: "shield_purchased"
                    },
                    {
                        text: "Can't afford it‚Äîwalk away",
                        effects: { stress: 1 },
                        nextScene: "blacksmith_departed"
                    }
                ]
            },
            
            surgeon_preventive: {
                title: "The Camp Surgeon",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The surgeon's tent smelled of blood. Of rot. Of things you didn't want to think about. But it also smelled of herbs. Of medicine. Of things that could save your life. If you could afford them. If you had coin.</p>
                           
                           <p>The surgeon was a practical man. He'd seen too much death. Too much suffering. He knew what worked. What didn't. And he knew what it cost. Medicine wasn't free. Care wasn't free. Life wasn't free. Everything had a price. Especially prevention. Especially staying alive.</p>
                           
                           <p>You had ${wealth} shillings. Enough for preventive care. For medicine to ward off sickness. For clean bandages. For things that would keep you healthy. Keep you alive. When others got sick. When others died. You could be different. If you had coin. If you spent it wisely.</p>
                           
                           <p>The surgeon looked at you. Assessing. Calculating. You look healthy, he said. But that can change. Fast. Sickness comes. Wounds fester. Men die. But not all men. Not the ones with coin. Not the ones who can afford prevention. Who can afford to stay alive.</p>`;
                },
                choices: [
                    {
                        text: "Buy preventive medicine (8 shillings)",
                        effects: { wealth: -8, stress: -2 },
                        nextScene: "medicine_purchased"
                    },
                    {
                        text: "Buy clean bandages and supplies (5 shillings)",
                        effects: { wealth: -5, endurance: 1 },
                        nextScene: "supplies_purchased"
                    },
                    {
                        text: "Pay for a full health check (12 shillings)",
                        effects: { wealth: -12, stress: -1, morale: 1 },
                        nextScene: "health_check"
                    },
                    {
                        text: "Can't afford it‚Äîhope you stay healthy",
                        effects: { stress: 1 },
                        nextScene: "surgeon_departed"
                    }
                ]
            },
            
            officer_bribe: {
                title: "The Captain's Favor",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The captain was approachable. For a price. Officers always were. They had power. You had coin. It was a simple transaction. Coin for favor. Coin for safety. Coin for the chance to avoid the worst assignments. The most dangerous missions. The ones that got men killed.</p>
                           
                           <p>You had ${wealth} shillings. Enough for something. Maybe a better assignment. Maybe protection from the worst duties. Maybe just the captain's goodwill. The knowledge that when things got bad. When you needed help. He'd remember. He'd help. If you paid. If you had coin.</p>
                           
                           <p>But it was expensive. Officers didn't come cheap. Their favor had a price. A high price. But it was worth it. If it kept you alive. If it meant you didn't get sent on the suicide mission. If it meant you had someone to turn to when you needed help. When coin alone wasn't enough. When you needed someone with power. Someone who could make things happen.</p>
                           
                           <p>The captain looked at you. Waiting. He knew why you were here. Everyone came for the same reason. Coin. Favor. Safety. He'd take your money. Give you what you wanted. Or at least the promise of it. The hope that when you needed him. He'd be there. If you paid enough. If you had enough coin.</p>`;
                },
                choices: [
                    {
                        text: "Pay for better assignments (10 shillings)",
                        effects: { wealth: -10, reputation: 1, stress: -1 },
                        nextScene: "favor_purchased"
                    },
                    {
                        text: "Pay for protection from dangerous missions (15 shillings)",
                        effects: { wealth: -15, stress: -2, morale: 1 },
                        nextScene: "protection_purchased"
                    },
                    {
                        text: "Pay for the captain's goodwill (8 shillings)",
                        effects: { wealth: -8, reputation: 1 },
                        nextScene: "goodwill_purchased"
                    },
                    {
                        text: "Can't afford it‚Äîtake your chances",
                        effects: { stress: 1 },
                        nextScene: "officer_departed"
                    }
                ]
            },
            
            information_broker: {
                title: "The Informant",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The informant was a shadow. A man who knew things. Who sold knowledge. Who made coin from information. He knew where the French were. Where they weren't. Where the safe routes were. Where the ambushes waited. Information was power. Information was life. And he sold it. For coin.</p>
                           
                           <p>You had ${wealth} shillings. Enough for something. Maybe information about the next battle. About where the danger was. About how to avoid it. About how to stay alive. When others died. When others walked into traps. You could know. You could avoid. If you paid. If you had coin.</p>
                           
                           <p>But information was expensive. Knowledge had a price. A high price. But it was worth it. If it kept you alive. If it meant you didn't walk into an ambush. If it meant you knew where the enemy was. Where they weren't. If it meant you had an advantage. In a world where advantages meant life. Where knowledge meant survival.</p>
                           
                           <p>The informant looked at you. Smiled. A thin smile. A knowing smile. Information, he said. That's what you want. That's what I sell. For coin. For the right price. I know things. Things that could save your life. Things that could make you rich. If you're willing to pay. If you have coin.</p>`;
                },
                choices: [
                    {
                        text: "Buy information about enemy positions (12 shillings)",
                        effects: { wealth: -12, wits: 1, stress: -1 },
                        nextScene: "intel_purchased"
                    },
                    {
                        text: "Buy information about safe routes (8 shillings)",
                        effects: { wealth: -8, stress: -1 },
                        nextScene: "route_intel"
                    },
                    {
                        text: "Buy information about plunder opportunities (15 shillings)",
                        effects: { wealth: -15, wits: 1 },
                        nextScene: "plunder_intel"
                    },
                    {
                        text: "Can't afford it‚Äîgo in blind",
                        effects: { stress: 1 },
                        nextScene: "informant_departed"
                    }
                ]
            },
            
            reflection_on_past: {
                title: "The Man You Were",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const age = gameState.age || 25;
                    const background = gameState.background || "common";
                    return `<p>You sat alone. Watching the sun set over French fields. Golden light. Peaceful. Beautiful. As if the war didn't exist. As if the blood spilled on this soil hadn't stained it forever. You thought about home. About England. About the person you were before.</p>
                           
                           <p>You'd been ${age - 4} when you joined up. Young. Full of ideas about glory. About honor. About what it meant to be a soldier. The reality had been different. Harder. Crueler. The glory was horseshit. The honor questionable. And being a soldier meant doing things you never thought you'd do. Becoming someone you never thought you'd be.</p>
                           
                           <p>Your background was ${background}. That had shaped you. Given you certain skills. Certain perspectives. But war had reshaped you. Molded you into something else. A killer. An efficient one. You'd lost count of how many men you'd killed. Stopped trying to remember their faces. But they were there. In the dark. In the quiet. Waiting.</p>
                           
                           <p>The question was whether any of the old you remained. Whether the person you were before the war still existed. Somewhere inside. Buried beneath the scars and the memories and the things you'd done. Or if war had killed that person. Replaced him completely. Left nothing but this. This hollow shell. This weapon. This thing that killed and survived and kept killing.</p>
                           
                           <p>The sun touched the horizon. The light fading. Darkness coming. Always coming. You didn't have answers. Maybe there were no answers. Maybe you'd been asking the wrong questions. Maybe it didn't matter who you were before. Only who you were now. Only what you did next. The past was dead. Like so many other things. All you had was now. This moment. This choice. What to do with it.</p>`;
                },
                choices: [
                    {
                        text: "Try to hold onto who you were",
                        effects: { morale: 2, stress: 1 },
                        nextScene: "identity_preserved"
                    },
                    {
                        text: "Accept what you've become",
                        effects: { wits: 2, morale: -1 },
                        nextScene: "transformation_accepted"
                    },
                    {
                        text: "Vow to be better‚Äîto do better",
                        effects: { reputation: 1, morale: 1 },
                        nextScene: "redemption_sought"
                    },
                    {
                        text: "Nothing matters‚Äîjust survive",
                        effects: { stress: -1, morale: -2 },
                        nextScene: "nihilism"
                    }
                ]
            },
            
            storm_approaching: {
                title: "The Coming Storm",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The sky darkened. Clouds rolling in from the west. Heavy. Threatening. The kind of clouds that meant rain. Lots of rain. The kind that turned roads to mud. Made camp miserable. Made everything harder. You could smell it coming. The wet. The cold. The misery.</p>
                           
                           <p>Men were already preparing. Tying down tents. Securing gear. Moving things under cover. The experienced ones. They'd seen storms before. Knew what was coming. The new ones. The green ones. They watched. Learned. Or didn't. Would pay for it later. When everything was soaked. When they were shivering. When they realized preparation mattered.</p>
                           
                           <p>The wind picked up. Cold. Biting. Pulling at your cloak. At your hair. At everything loose. The first drops fell. Fat. Heavy. Splashing in the dust. Then more. Faster. Harder. The storm was here. No turning back. No avoiding it. Just endure. Wait it out. Hope it passed quickly. Though you knew it wouldn't.</p>
                           
                           <p>Lightning flashed. Far off. But getting closer. Thunder followed. Deep. Rumbling. Like God's anger. Or maybe just nature. Indifferent. Uncaring. Just doing what storms do. Destroying. Washing away. Leaving everything changed. Everything different. The way storms always did.</p>
                           
                           <p>You found what shelter you could. Under a tree. Behind a cart. Anywhere that offered some protection. But you knew it wouldn't be enough. The storm would find you. Soak you. Chill you. Make you miserable. That was its nature. That was what storms did. And there was nothing you could do but endure. Wait. Hope for morning. Hope for it to end.</p>`;
                },
                choices: [
                    {
                        text: "Help others secure their gear",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "storm_helpful"
                    },
                    {
                        text: "Find the best shelter‚Äîlook out for yourself",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 6,
                        nextScene: "shelter_found"
                    },
                    {
                        text: "Accept it‚Äîstorms pass",
                        effects: { morale: 1, stress: 1 },
                        nextScene: "storm_endured"
                    },
                    {
                        text: "Use it as cover‚Äîscout ahead",
                        effects: { initiative: 1 },
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7,
                        nextScene: "storm_scout"
                    }
                ]
            },
            
            siege_boredom: {
                title: "The Endless Siege",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>Week three of the siege. Or was it four. Time had lost meaning. The days blended together. Waiting. Watching. Doing nothing. The town sat behind its walls. Defiant. Untouchable. And you sat outside. Staring at stone. Waiting for something. Anything. To happen.</p>
                           
                           <p>Boredom was worse than battle. At least battle ended. One way or another. But sieges dragged on. Weeks. Months. Sometimes years. Just sitting. Waiting. Starving them out or being starved yourself. Depending who had more food. More patience. More will to endure the tedium.</p>
                           
                           <p>The camp was a festering sore. Too many men. Too long in one place. Disease was spreading. Dysentery. Fever. Things with no names. Just symptoms. Shit and blood and death. The surgeon was overwhelmed. The graves multiplying. More men died of disease in sieges than ever died in battle. But there was no glory in that. No songs about the men who shit themselves to death outside some French town no one had heard of.</p>
                           
                           <p>You did what everyone did. Tried to pass time. Diced. Drank when there was anything to drink. Told stories. Fought over nothing. Just to feel something. Just to break the monotony. Some men deserted. Slipped away in the night. You didn't blame them. Sometimes leaving seemed smarter than staying. Smarter than waiting for disease or starvation or a random crossbow bolt to end you.</p>
                           
                           <p>Another day dawned. Identical to the one before. To the one that would come tomorrow. The walls still stood. The town still defiant. And you still sat here. Waiting. Watching. Dying slowly of boredom and disease and the crushing weight of having nothing to do but survive another day of absolutely nothing happening.</p>`;
                },
                choices: [
                    {
                        text: "Volunteer for dangerous duty‚Äîanything's better than this",
                        effects: { initiative: 1, stress: -1 },
                        nextScene: "siege_duty"
                    },
                    {
                        text: "Endure‚Äîsieges end eventually",
                        effects: { endurance: 2, morale: -1 },
                        nextScene: "siege_continues"
                    },
                    {
                        text: "Find ways to entertain yourself",
                        effects: { morale: 1 },
                        nextScene: "siege_entertainment"
                    },
                    {
                        text: "Think about deserting",
                        effects: { stress: 2 },
                        nextScene: "desertion_considered"
                    }
                ]
            },
            
            friendly_fire: {
                title: "The Mistake",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The arrow came from behind. From your own lines. You heard the thwock of impact. Then the scream. Peter fell. Clutching his shoulder. Blood between his fingers. Someone from your own side had shot him. Mistake. Accident. Incompetence. Didn't matter. Peter was bleeding. Might die. From English steel. Not French.</p>
                           
                           <p>Men rushed to him. Grabbed the arrow. Had to get it out. Peter screamed again. The sound cutting through everything. High. Terrified. Pain and fear mixed. They pulled. The arrow came free. Barbed head tearing flesh. More blood. Too much blood. Someone pressed cloth to the wound. Trying to stop it. But it kept coming. Pulsing. Red. Hot.</p>
                           
                           <p>The archer who'd shot came forward. Young. Pale. Shaking. I didn't mean. I thought. He couldn't finish. The words failing. What could he say. He'd shot a friend. Might have killed him. Sorry didn't cover it. Nothing covered it. This was the reality. More soldiers died from accidents than from enemy action. Friendly fire. Disease. Bad water. The war killed you in so many ways. The French were almost the least of your worries.</p>
                           
                           <p>Peter was conscious. Staring at the sky. His breathing shallow. Rapid. Going into shock. The surgeon would need to see him. If there was time. If he could be moved. If infection didn't set in first. Too many ifs. But this was it. The randomness. The chaos. The way everything could change in a heartbeat. One moment fine. Next moment bleeding. Dying. Because some fool couldn't tell friend from foe in the heat of movement.</p>
                           
                           <p>The sergeant was shouting. At the archer. At everyone. Demanding to know how this happened. But there was no good answer. Mistakes happened. In war they happened constantly. Usually they just weren't this costly. Usually they didn't nearly kill your friends. You looked at Peter. At the blood. At his pale face. And wondered when your own mistake would come. When you'd be the one bleeding in the dirt. From an arrow. From a blade. From anything. Everything. All of it waiting to kill you.</p>`;
                },
                choices: [
                    {
                        text: "Help with Peter‚Äîhe needs you",
                        effects: { reputation: 2, stress: 1 },
                        nextScene: "comrade_aided"
                    },
                    {
                        text: "Confront the archer‚Äîthis can't happen again",
                        effects: { reputation: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "discipline_enforced"
                    },
                    {
                        text: "Report to the sergeant‚Äîlet him handle it",
                        effects: { wits: 1 },
                        nextScene: "official_response"
                    },
                    {
                        text: "Walk away‚Äîyou can't handle this",
                        effects: { stress: -1, morale: -2 },
                        nextScene: "emotional_retreat"
                    }
                ]
            },
            
            looted_church: {
                title: "The Desecrated Chapel",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The church had been looted. Recently. The doors hung open. Broken. Inside was chaos. Pews overturned. Altar stripped. Candlesticks gone. Everything of value taken. Everything sacred defiled. This was what soldiers did. When they got the chance. When there was no one to stop them.</p>
                           
                           <p>You stepped inside. The air was still. Heavy. As if the building itself mourned. As if God had abandoned this place. Or maybe He'd never been here. Maybe churches were just buildings. Stone and wood. No more sacred than any other structure. You didn't know. Didn't know what you believed anymore. About God. About faith. About anything.</p>
                           
                           <p>Someone had defecated on the altar. A final insult. A final desecration. You looked at it. At the mess. At the disrespect. And felt nothing. Or maybe you felt too much. Too many things. Guilt. Shame. Anger. Disgust. All of it mixed together. Indistinguishable. Just a weight. A burden. Another thing to carry.</p>
                           
                           <p>There was still value here. If you looked. Hidden things. Things the looters missed. Or things they left behind. Too heavy. Too obvious. Too risky. You could take them. Add to your plunder. Your wealth. Or you could leave them. Respect the place. Even if others hadn't. Even if it didn't matter. Even if God wasn't watching.</p>
                           
                           <p>You stood in the ruined church. Thinking about what it meant. About what you'd become. About whether you could still call yourself a Christian. After everything you'd done. After everything you'd seen. After standing in a looted church and considering taking what little remained. The answer didn't come. Maybe it never would.</p>`;
                },
                choices: [
                    {
                        text: "Take what remains‚Äîit's already been looted",
                        effects: { wealth: 2, morale: -1, reputation: -1 },
                        nextScene: "church_plundered"
                    },
                    {
                        text: "Leave it‚Äîsome things shouldn't be touched",
                        effects: { morale: 1, reputation: 1 },
                        nextScene: "respect_shown"
                    },
                    {
                        text: "Try to restore some order",
                        effects: { reputation: 2, endurance: -1 },
                        nextScene: "restoration_attempted"
                    },
                    {
                        text: "Pray for forgiveness‚Äîfor all of us",
                        effects: { morale: 2, stress: -1 },
                        nextScene: "prayer_offered"
                    }
                ]
            },
            
            cookfire_conversation: {
                title: "What We Fight For",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>The question came out of nowhere. Jack asked it. Staring into the fire. His voice quiet. Why are we here. Really. What are we fighting for. The words hung in the air. Heavy. Dangerous. The kind of question that could get you beaten. Or worse. But no officers were around. Just soldiers. So the question remained. Unanswered. Waiting.</p>
                           
                           <p>For the king, someone said. Halfhearted. Not believing it. For England, another offered. But that rang hollow too. England was far away. Didn't know you existed. Didn't care what happened to you. For plunder then. That was honest at least. But even plunder seemed insufficient. Not enough to justify the misery. The death. Everything.</p>
                           
                           <p>Old Robert spoke up. His voice steady. Been through this before. We fight because we're here. Because we signed up. Because deserting means dying. Because the man next to you depends on you. Because tomorrow there'll be another battle. Another march. And we'll do it. Because that's what we do. That's all there is.</p>
                           
                           <p>The answer wasn't satisfying. But it was true. You didn't fight for grand ideas. For king or country or God. You fought because you were here. Because stopping meant death. Because the alternative to fighting was lying down. Giving up. And you weren't ready for that. Not yet. So you kept going. Kept fighting. Kept surviving. One day at a time.</p>
                           
                           <p>Jack nodded slowly. Accepting it. The fire crackled. Someone added wood. Sparks flew up into darkness. The conversation moved on. To other things. But the question remained. In your mind. In your heart. Why are you here. What are you fighting for. You didn't have a good answer. Maybe there wasn't one. Maybe you just had to keep going. Keep fighting. Until it ended. However it ended.</p>`;
                },
                choices: [
                    {
                        text: "For England‚Äîbelieve in something",
                        effects: { morale: 2 },
                        nextScene: "patriotism_affirmed"
                    },
                    {
                        text: "For survival‚Äîthat's all that matters",
                        effects: { wits: 1, morale: -1 },
                        nextScene: "pragmatism_accepted"
                    },
                    {
                        text: "For your comrades‚Äîthe only truth",
                        effects: { reputation: 2, morale: 1 },
                        nextScene: "brotherhood_found"
                    },
                    {
                        text: "You don't know anymore",
                        effects: { stress: 2 },
                        nextScene: "purpose_lost"
                    }
                ]
            },
            
            brewing_trouble: {
                title: "The Stolen Rations",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    return `<p>Your rations were gone. You'd left them by your bedroll. Turned your back for five minutes. Now gone. Stolen. In a camp of thieves that shouldn't be surprising. But it was your food. Your survival. And someone had taken it. The anger came hot. Fast. Overwhelming.</p>
                           
                           <p>You looked around. Trying to see who. Trying to catch guilt on someone's face. But everyone was busy. Doing their own things. No one met your eyes. No one showed any sign. This was the problem with thieves. They looked like everyone else. Acted like everyone else. Until they took what wasn't theirs.</p>
                           
                           <p>Will came over. Saw your face. What's wrong, he asked. You told him. Stolen rations. His expression darkened. That's serious, he said. Men have been whipped for less. Hanged even. If you caught whoever did it. If you had proof. But proof was hard. Evidence scarce. Just your word against theirs.</p>
                           
                           <p>You had options. Accuse the most likely suspect. The new man. The one everyone distrusted. Whether he did it or not he'd be the easiest to blame. Or search. Go through everyone's gear. Demand to inspect. See who objected. Who resisted. Or let it go. Take the loss. Find food elsewhere. Avoid confrontation. Each choice had consequences. Each carried risks.</p>
                           
                           <p>${name}, Will said. His voice low. Serious. Be careful. Accusations in camp can turn ugly. Fast. Men are on edge. Hungry. Desperate. Push the wrong person. Say the wrong thing. It could explode. Could get someone hurt. Could get you hurt. Think before you act. But also. Also don't let people think you're soft. Can be stolen from. That brings its own problems.</p>`;
                },
                choices: [
                    {
                        text: "Accuse the new man‚Äîeveryone suspects him anyway",
                        effects: { wealth: 2, reputation: -1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "accusation_made"
                    },
                    {
                        text: "Search everyone's gear",
                        effects: { reputation: -2, wits: 1 },
                        nextScene: "search_conducted"
                    },
                    {
                        text: "Let it go‚Äînot worth the trouble",
                        effects: { stress: 1, reputation: -1 },
                        nextScene: "theft_accepted"
                    },
                    {
                        text: "Set a trap‚Äîcatch the thief next time",
                        effects: { wits: 2 },
                        nextScene: "trap_set"
                    }
                ]
            },
            
            refugee_column: {
                title: "The Displaced",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    return `<p>They came down the road. Hundreds of them. French peasants. Fleeing. Carts piled high with belongings. Children crying. Old people struggling to keep up. Animals driven before them. Everything they owned. Everything they were. Reduced to what they could carry. What they could save. From the war. From you.</p>
                           
                           <p>They saw your column. English soldiers. Some stopped. Paralyzed by fear. Others tried to turn back. To run. But there was nowhere to go. The road was narrow. The forest thick. They were trapped. Between your army and whatever they were fleeing. Caught in the middle. Like so many others. Like everyone in France.</p>
                           
                           <p>The captain rode forward. Raised his hand. We're not here for you, he called. In broken French. Keep moving. We won't harm you. Keep moving. Some believed him. Continued forward. Others remained frozen. Certain this was a trap. Certain English soldiers meant death. They weren't entirely wrong. Your army had killed plenty of civilians. Burned their homes. Destroyed their lives. Why should these people trust you.</p>
                           
                           <p>A woman approached. Older. Gray hair. She carried a child. An infant. The baby was crying. Weak. Sick maybe. The woman's eyes were desperate. Please, she said. In French you could barely understand. Please help. The baby needs. She gestured. Made motions. Eating. Drinking. The baby needed food. Needed water. Needed help she couldn't provide.</p>
                           
                           <p>You had rations. Not much. But some. Enough to share. Enough to help one child. One family. But there were hundreds here. Thousands maybe. You couldn't help them all. Couldn't save everyone. But you could help one. This woman. This child. Or you could pass by. Save your rations. For yourself. For your own survival. The choice was yours. The woman waited. The baby cried. And the refugee column flowed past. Rivers of suffering. Displacement. The cost of war paid by those who never chose it.</p>`;
                },
                choices: [
                    {
                        text: "Give her food‚Äîhelp who you can",
                        effects: { wealth: -1, morale: 2, reputation: 1 },
                        nextScene: "mercy_given"
                    },
                    {
                        text: "Share water at least",
                        effects: { morale: 1 },
                        nextScene: "small_kindness"
                    },
                    {
                        text: "Keep moving‚Äîyou can't help everyone",
                        effects: { stress: 2 },
                        nextScene: "hardened_heart"
                    },
                    {
                        text: "Organize help from your unit",
                        effects: { reputation: 3, wealth: -2 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7,
                        nextScene: "collective_mercy"
                    }
                ]
            },
            
            market_day: {
                title: "The Country Market",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const wealth = gameState.stats.wealth || 0;
                    return `<p>The village had a market. Small. But functioning. Despite the war. Despite everything. People still needed to trade. To buy. To sell. Life continued. In its small stubborn ways. The market was proof. That humanity endured. That commerce survived. That not everything was destroyed by war.</p>
                           
                           <p>Stalls lined the square. Selling what little there was. Bread. Cheese. Vegetables. Some cloth. Tools. The goods were meager. Prices inflated. War did that. Made everything scarce. Made everything expensive. But people came anyway. Needed these things. Would pay what they must.</p>
                           
                           <p>The vendors eyed you warily. English soldier. Foreigner. Potential troublemaker. But also potential customer. You had coins. ${wealth} shillings. Enough to buy. If prices were fair. If you wanted to trade with the enemy. If you could stomach the irony of buying French bread while burning French fields.</p>
                           
                           <p>One vendor was bolder. Called to you. Good prices for soldiers. Fair trade. No trouble. He spoke some English. Learned it from necessity. From months of English occupation. He wasn't friendly. But he was practical. Business was business. War or no war. Money was money. And he needed to eat too.</p>
                           
                           <p>You looked at his goods. Fresh bread. Real vegetables. Things you hadn't seen in weeks. The temptation was strong. Your rations were stale. Moldy. These were fresh. Real. But buying from them. Trading with the enemy. Supporting their economy. It felt wrong. Complicated. Everything was complicated in war. Even simple things like buying bread.</p>`;
                },
                choices: [
                    {
                        text: "Buy food‚Äîyou're hungry (2 shillings)",
                        effects: { wealth: -2, morale: 2 },
                        nextScene: "food_purchased"
                    },
                    {
                        text: "Try to haggle‚Äîwar has made you poor",
                        effects: { wits: 1 },
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 6,
                        nextScene: "bargain_struck"
                    },
                    {
                        text: "Don't buy‚Äîstick with rations",
                        effects: { morale: -1 },
                        nextScene: "purchase_refused"
                    },
                    {
                        text: "Take what you want‚Äîyou're the one with the sword",
                        effects: { wealth: 2, reputation: -3 },
                        nextScene: "market_robbed"
                    }
                ]
            },
            
            patron_camp_arrival: {
                title: "Arrival at Camp",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    const patron = gameState.patron;
                    
                    if (patron === 'james_olooney') {
                        return `<p>The camp was chaos. Men drinking. Fighting. Laughing. The smell of smoke. Of blood. Of unwashed bodies. O'Looney's company. You'd heard the stories. But seeing it. Being in it. That was different.</p>
                               
                               <p>Sir James sat on a barrel. A cup in his hand. Wine. Or blood. Hard to tell. He watched you. Grinned. Welcome to the company, he said. His voice was rough. Harsh. Like broken glass. You'll earn your keep. Or you'll die trying. Either way. We profit.</p>
                               
                               <p>Around you men sharpened blades. Counted coins. Argued over plunder. A man lay in the mud. Drunk. Or dead. No one checked. No one cared. This was what you'd signed up for. This was what you'd get.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>The camp was orderly. Tents in rows. Fires controlled. Men at their duties. Sir David's household. Small. But well-run. You could see the care. The attention to detail. The concern for the men.</p>
                               
                               <p>Sir David approached. His manner was quiet. Reserved. But his eyes were kind. Welcome, he said. You'll find your place here. We look after our own. His words were simple. But they meant something. In a world where men were expendable. He saw you. As a person. Not just a number.</p>
                               
                               <p>Around you men worked. Trained. Prepared. There was discipline. But not fear. Respect. But not terror. This was different. This was something you could live with.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>The camp was large. Impressive. Baron Caley's household. You could see the wealth. The power. The influence. Tents of fine cloth. Horses well-fed. Men well-equipped. This was a lord who had resources. And he used them.</p>
                               
                               <p>The baron sat in his tent. Surrounded by maps. By advisors. By the trappings of command. He didn't look up when you entered. Didn't acknowledge you. You were a number. A tool. That was all. One of his men spoke. Explained your role. The baron nodded. Dismissed you. Without a word. Without a glance.</p>
                               
                               <p>You were useful. Or you weren't. That was all that mattered. That was all there was.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>The camp smelled of wine. Of ale. Of men who'd given up on sobriety. Count Charles's household. English men. Far from home. In France. Looking for land. For glory. For something to call their own.</p>
                               
                               <p>The count sat by a fire. A cup in his hand. Always a cup. Wine. Ale. Something. He looked older than his years. Weathered. Worn. But his eyes still had fire. Still had the look of a man who'd seen battle. Who'd led men. Who'd won. And lost.</p>
                               
                               <p>Welcome, he said. His voice was rough. From drink. From years. From too much of everything. You're English. That's good. We stick together here. In this foreign land. We look after our own.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>The camp was different. Disciplined. Orderly. But not rigid. There was a rhythm. A purpose. Ashkhan's company. Men from the Levant. From the East. Where war was an art. Where tactics mattered. Where discipline was everything.</p>
                               
                               <p>Ashkhan approached. His bearing was confident. But not arrogant. His eyes were sharp. Intelligent. He looked at you. Really looked. Saw more than most would. You're new, he said. His accent was foreign. But his English was clear. You'll learn. If you're willing. If you can keep up.</p>
                               
                               <p>His men watched. Assessed. They were professionals. Veterans. They'd seen war. Real war. The kind that breaks men. The kind that makes them. They'd survived. Together. That meant something.</p>`;
                    } else {
                        return `<p>The camp stretched before you. Your new home. Your new life. Men moved about their duties. Preparing. Waiting. For whatever came next.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Find your place in the company",
                        effects: { morale: 1 },
                        nextScene: "camp_settled"
                    },
                    {
                        text: "Observe the men and their ways",
                        effects: { wits: 1 },
                        nextScene: "camp_observed"
                    },
                    {
                        text: "Introduce yourself to your comrades",
                        effects: { reputation: 1 },
                        nextScene: "introductions_made"
                    }
                ]
            },
            
            patron_before_battle: {
                title: "The Order Comes",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const patron = gameState.patron;
                    
                    if (patron === 'james_olooney') {
                        return `<p>O'Looney stood before the company. His eyes were bright. Wild. The look of a man who's given up on everything but the taking. We ride at dawn, he said. The French have coin. They have goods. They have women. We'll take it all. Leave nothing but ash.</p>
                               
                               <p>His men cheered. Or growled. Hard to tell the difference. You felt your stomach tighten. This wasn't war. This was something else. Something darker. But you'd taken the coin. You'd made the choice. There was no going back now.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>Sir David gathered his men. His voice was calm. Steady. We'll fight, he said. When we must. But we'll fight smart. We'll fight together. And we'll come home. Together.</p>
                               
                               <p>He looked at each man. Met each eye. You could see the weight on him. The responsibility. The care. He didn't want to lose anyone. But he knew he might. The knowledge was there. In his eyes. In the way he spoke. But he'd do everything he could. To bring them home.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>Baron Caley addressed the company. From his horse. High above. His voice carried. But there was no warmth. No care. Just orders. Just plans. Just the business of war.</p>
                               
                               <p>We march tomorrow, he said. The French hold lands that should be ours. We'll take them. By force. By fire. By whatever means necessary. Those who serve well will be rewarded. Those who don't will be replaced.</p>
                               
                               <p>Simple. Direct. Cold. That was his way. That was how he led. You were a tool. A weapon. Expendable. Replaceable. But if you were good. If you were useful. The rewards would be great.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>The count stood before his men. For a moment. Just a moment. The drink was set aside. The old commander was there. In his eyes. In his bearing. In the way he spoke.</p>
                               
                               <p>We fight tomorrow, he said. For England. For ourselves. For the lands we'll claim. His voice was strong. Clear. The voice of the man he'd been. Before the drink. Before the years. Before the losses. We fight together. We win together. Or we die together.</p>
                               
                               <p>Then the moment passed. The cup was back in his hand. The drink took over. But the men remembered. The old commander. The man he'd been. They'd follow him. Out of respect. Out of loyalty. Out of memory.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>Ashkhan gathered his men. Not from a horse. Not from a tent. On the ground. With them. Equal. Or as equal as a commander could be. He spoke. Explained. The plan. The tactics. The why behind the what.</p>
                               
                               <p>We fight like this, he said. Drawing in the dirt. Showing movements. Positions. Not because it's how we've always done it. But because it works. Because it keeps men alive. Because it wins battles.</p>
                               
                               <p>His men listened. Nodded. Understood. This was how they fought. This was why they survived. Tactics. Discipline. Skill. Not just numbers. Not just brute force. But the art of war. The craft of it.</p>`;
                    } else {
                        return `<p>The order came down. Battle tomorrow. Men prepared. Checked weapons. Said prayers. Or didn't. Each in their own way. Getting ready for what was coming.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Prepare your weapons",
                        effects: { initiative: 1 },
                        nextScene: "battle_prepared"
                    },
                    {
                        text: "Rest while you can",
                        effects: { endurance: 1 },
                        nextScene: "rest_taken"
                    },
                    {
                        text: "Talk with your comrades",
                        effects: { morale: 1 },
                        nextScene: "comrades_comforted"
                    }
                ]
            },
            
            patron_after_battle: {
                title: "After the Fighting",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const patron = gameState.patron;
                    
                    if (patron === 'james_olooney') {
                        return `<p>The plunder was rich. More than you'd seen in months. Gold. Silver. Goods. O'Looney laughed. Tossed you a purse. Heavy with coin. See, he said. This is what we do. This is who we are. You're one of us now. Whether you like it or not.</p>
                               
                               <p>The coin felt wrong in your hands. But it was real. It was yours. You'd earned it. In blood. In fire. In things you'd rather forget. But the coin was real. And that was something.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>The battle was won. But men were wounded. Dead. Sir David moved among them. Checked on each. Spoke to each. His face was grim. But his manner was gentle. He'd lost men. But he'd saved more. That was the trade. That was the cost.</p>
                               
                               <p>He found you. Clapped your shoulder. You fought well, he said. I'm glad you're with us. The words were simple. But they meant something. In a world of death. Of loss. Of war. They meant something.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>The victory was won. The plunder was rich. Baron Caley's men shared in the spoils. As promised. The coin flowed. The goods were distributed. Fairly. According to service. According to worth.</p>
                               
                               <p>You received your share. More than you'd expected. The baron kept his word. When it suited him. When you were useful. That was the trade. That was the deal. Service for reward. Nothing more. Nothing less.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>The battle was won. Men were dead. Wounded. The count sat by the fire. Drinking. Always drinking. His face was grim. Haunted. You could see the ghosts. In his eyes. The men he'd lost. The battles he'd fought. The things he'd seen.</p>
                               
                               <p>He raised his cup. To the dead, he said. To the living. To those who'll die tomorrow. His voice was bitter. Angry. At the war. At the drink. At himself. You could see the pain. The regret. The weight of it all.</p>
                               
                               <p>But he'd fight again. Tomorrow. Or the next day. He'd lead. He'd command. He'd drink. Until the drink took him. Or the war did. Or something else. Until then. He'd fight. He'd lead. He'd drink. That was his way.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>The battle was won. Cleanly. Efficiently. With minimal losses. Ashkhan moved among his men. Checked on each. Spoke to each. In their own language. Or in gestures. Or in the universal language of men who've fought together.</p>
                               
                               <p>You fought well, he said to you. In English. Clear. Direct. You learn quickly. That's good. We need men who learn. Who adapt. Who think. Not just men who swing swords.</p>
                               
                               <p>His approval meant something. More than coin. More than plunder. It was respect. From a man who'd earned it. Who'd proven himself. In war. In command. In the ways that mattered. That meant something. In this world. In this war. That meant everything.</p>`;
                    } else {
                        return `<p>The battle ended. Men tended wounds. Counted the dead. Shared what plunder there was. Life went on. As it always did. After the fighting.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Tend to the wounded",
                        effects: { reputation: 1, morale: 1 },
                        nextScene: "wounded_cared_for"
                    },
                    {
                        text: "Collect your share of plunder",
                        effects: { wealth: 2 },
                        nextScene: "plunder_collected"
                    },
                    {
                        text: "Rest and recover",
                        effects: { endurance: 1, stress: -1 },
                        nextScene: "rest_earned"
                    }
                ]
            },
            
            patron_camp_discipline: {
                title: "The Way Things Are",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const patron = gameState.patron;
                    const name = gameState.characterName || "Soldier";
                    
                    if (patron === 'james_olooney') {
                        return `<p>A man had broken the rules. Stolen from another. Not allowed. Even among thieves there were rules. O'Looney made an example of him. Public. Brutal. The man screamed. Then stopped. The message was clear. Break the rules. Pay the price.</p>
                               
                               <p>You watched. Felt sick. But you didn't look away. This was the company you'd joined. This was what they were. What you were becoming. The question was whether you could live with it. Whether you could become one of them. Or whether you'd break. And end up like that man. Screaming. Then silent.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>Two men had fought. Over rations. Over nothing really. Sir David called them before the company. His voice was calm. But firm. We are brothers here, he said. We depend on each other. This cannot happen again.</p>
                               
                               <p>He didn't punish them harshly. Just made them work together. Share duties. Learn to trust. It was a different way. A better way. You could see the respect in the men's eyes. They followed him not from fear. But from something else. Something better.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>A man had failed. In battle. Let the enemy through. Baron Caley didn't care about excuses. Didn't care about reasons. Only results. The man was demoted. Stripped of privileges. Made an example. Others watched. Learned. Failure wasn't tolerated. Success was rewarded. That was the system. That was how it worked.</p>
                               
                               <p>You understood. The baron was fair. In his way. He rewarded service. Punished failure. No sentiment. No second chances. Just results. You'd do well to remember that. To never fail. To always be useful. Or you'd end up like that man. Demoted. Disgraced. Forgotten.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>The count was drunk. Again. Shouting orders. Contradicting himself. The men looked to each other. Uncertain. The old commander was gone. Buried under wine. Under years. Under loss. What remained was this. A drunk. A shadow. A man who'd lost his way.</p>
                               
                               <p>But they followed him anyway. Out of loyalty. Out of memory. Out of the man he'd been. Before. They'd follow him to hell. If that's where he led them. Because once. Once he'd been great. Once he'd been worth following. And maybe. Maybe he could be again.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>A man had broken formation. Disobeyed orders. Put others at risk. Ashkhan didn't shout. Didn't threaten. Just explained. Calmly. Clearly. Why the formation mattered. Why discipline saved lives. Why his mistake could have killed them all.</p>
                               
                               <p>The man understood. Apologized. Not from fear. From understanding. From respect. Ashkhan accepted it. Gave him another chance. But made it clear. There wouldn't be a third. This was how he led. With respect. With teaching. But with firm boundaries. You learned. Or you left. That was the way.</p>`;
                    } else {
                        return `<p>Discipline was maintained. In whatever way your commander saw fit. Rules were rules. Orders were orders. You followed them. Or you didn't. And faced the consequences.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Learn from what you've seen",
                        effects: { wits: 1 },
                        nextScene: "lesson_learned"
                    },
                    {
                        text: "Question the methods",
                        effects: { stress: 1, wits: 1 },
                        nextScene: "doubt_arises"
                    },
                    {
                        text: "Accept it as the way things are",
                        effects: { stress: -1 },
                        nextScene: "acceptance"
                    }
                ]
            },
            
            patron_plunder_distribution: {
                title: "Dividing the Spoils",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const patron = gameState.patron;
                    
                    if (patron === 'james_olooney') {
                        return `<p>The plunder was divided. O'Looney took his share. Largest. As was his right. Then the rest was split. Unevenly. Based on who he liked. Who'd fought hardest. Who'd killed most. Fairness wasn't the point. Power was. And he had it.</p>
                               
                               <p>You got your portion. Smaller than you'd hoped. But more than nothing. That was something. In this company you took what you could get. When you could get it. Tomorrow might be different. Tomorrow you might get more. Or you might get nothing. Or you might be dead. That was the way of it.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>Sir David divided the plunder. Fairly. Equally. According to need as much as service. He took his share. But not more. Not like other lords. He believed in fairness. In treating his men right. Even when it cost him.</p>
                               
                               <p>You received your portion. Fair. Honest. What you'd earned. It wasn't as much as you might have gotten elsewhere. But it was yours. Earned. Deserved. And that meant something. More than coin. It meant respect. It meant you were valued. As a person. Not just a tool.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>Baron Caley's men shared in the spoils. As promised. The distribution was organized. Efficient. Based on rank. On service. On worth. Those who'd fought well got more. Those who hadn't got less. It was fair. In its way. Merit-based. Results-based.</p>
                               
                               <p>You received your share. Calculated precisely. Based on your contribution. Your performance. Your value. It was substantial. More than you'd expected. The baron rewarded service. As he'd said he would. He kept his word. When you were useful. That was the deal.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>The plunder was divided. The count oversaw it. When he was sober enough. Which wasn't always. But his men were fair. They divided it themselves. According to custom. According to what was right. They'd been together long enough. To know how to do it. Without him.</p>
                               
                               <p>You got your share. Standard. Fair. What a man-at-arms could expect. Not more. Not less. Just what was due. The count's men looked after each other. Even when he couldn't. That was their way. Their bond. Forged over years. Over battles. Over shared hardship.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>Ashkhan divided the plunder. Methodically. Fairly. Based on contribution. On need. On what was right. He took his share. As commander. But not more than was fair. Not like some captains. He believed in fairness. In treating his men with respect.</p>
                               
                               <p>You received your portion. Calculated. Fair. Based on your service. Your skill. Your worth to the company. It was substantial. More than you'd expected. Ashkhan rewarded good service. As he'd said he would. His word was good. His methods fair. That was why men followed him. Why they stayed. Even when other companies offered more.</p>`;
                    } else {
                        return `<p>The plunder was divided. Each man received his share. According to custom. According to what was fair. Or what the commander decided. You took what you got. And were grateful for it.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Accept your share",
                        effects: { morale: 1 },
                        nextScene: "plunder_accepted"
                    },
                    {
                        text: "Question the division",
                        effects: { reputation: -1, stress: 1 },
                        nextScene: "division_questioned"
                    },
                    {
                        text: "Share with those who got less",
                        effects: { reputation: 2, wealth: -1 },
                        nextScene: "generosity_shown"
                    }
                ]
            },
            
            patron_leadership_moment: {
                title: "A Test of Leadership",
                year: function() { return gameState.year; },
                age: function() { return gameState.age; },
                location: function() { return gameState.location; },
                text: function() {
                    const patron = gameState.patron;
                    const name = gameState.characterName || "Soldier";
                    
                    if (patron === 'james_olooney') {
                        return `<p>Crisis came. French cavalry. Outnumbered. Outflanked. The company could run. Or fight. O'Looney chose fight. Not from courage. From greed. The French had baggage. Coins. Goods. Worth dying for. Maybe.</p>
                               
                               <p>He rallied the men. Not with words. With promises. With the lure of plunder. Fight and we'll all be rich, he said. Run and we'll be poor. And dead anyway. The choice was simple. Fight. Or die running. They chose to fight.</p>
                               
                               <p>You fought. Because you had to. Because there was no choice. Because O'Looney had led you here. Into this. And now you'd see it through. Or die trying.</p>`;
                    } else if (patron === 'lord_david') {
                        return `<p>Crisis came. French forces. Larger. Better positioned. The company could fight. Or retreat. Sir David chose retreat. Not from cowardice. From wisdom. From care for his men. We'll fight another day, he said. On ground of our choosing. When the odds are better.</p>
                               
                               <p>Some men grumbled. Wanted glory. Wanted to fight. But they followed. Because they trusted him. Because he'd kept them alive this long. Because he'd earned that trust. Through care. Through wisdom. Through bringing them home.</p>
                               
                               <p>You retreated. With the others. Following Sir David's lead. Trusting his judgment. Hoping he was right. That there would be another day. Another fight. When the time was right.</p>`;
                    } else if (patron === 'duke_caley') {
                        return `<p>Crisis came. Opportunity. A French supply train. Vulnerable. Rich. The baron saw it. Calculated. Decided. We attack, he said. The risk is worth the reward. Those who fight well will be rewarded. Those who don't will be left behind.</p>
                               
                               <p>He didn't ask. Didn't consult. Just ordered. Just led. That was his way. Decisive. Confident. Right or wrong. He made the call. And men followed. Because he was the baron. Because he had power. Because he'd been right before. Often enough to trust.</p>
                               
                               <p>You followed. Into the attack. Into the risk. Because that was what you did. What you'd signed up for. To follow. To fight. To win. Or die trying.</p>`;
                    } else if (patron === 'count_charles') {
                        return `<p>Crisis came. French advance. Threatening the position. The count was drunk. Again. But something happened. The old commander surfaced. For a moment. Just a moment. But it was enough.</p>
                               
                               <p>He gave orders. Clear. Confident. The orders of a man who'd done this before. Who knew what to do. The men responded. Not to the drunk. To the commander. To the man he'd been. To the leader they remembered.</p>
                               
                               <p>You followed those orders. Because they were good. Because they made sense. Because for a moment. Just a moment. The count was himself again. The leader he'd been. Before the drink. Before the years. Before everything.</p>`;
                    } else if (patron === 'ashkhan') {
                        return `<p>Crisis came. Ambush. French forces. Hidden. Waiting. But Ashkhan saw it. Before it happened. His eyes. His experience. His tactical mind. He recognized the signs. The too-quiet road. The perfect ambush site. The trap.</p>
                               
                               <p>He didn't panic. Didn't rush. Just adjusted. Changed formation. Changed approach. Turned their trap into ours, he said. We'll hit them from the side. Where they're not expecting. Where they're vulnerable.</p>
                               
                               <p>You followed his lead. Trusted his judgment. His tactics. His experience. He'd been right before. Often. His methods worked. His leadership saved lives. You'd follow him. Into anything. Because you trusted him. Because he'd earned that trust.</p>`;
                    } else {
                        return `<p>Crisis came. Decisions had to be made. Orders given. Men led. You followed. As you always did. Hoping the leadership was sound. Hoping you'd survive. Hoping you'd see another day.</p>`;
                    }
                },
                choices: [
                    {
                        text: "Follow the orders",
                        effects: { reputation: 1 },
                        nextScene: "orders_followed"
                    },
                    {
                        text: "Question the decision",
                        effects: { wits: 1, reputation: -1 },
                        nextScene: "decision_questioned"
                    },
                    {
                        text: "Trust your commander",
                        effects: { morale: 1 },
                        nextScene: "trust_shown"
                    }
                ]
            },
            
            campfire_wat_01_the_sharpening: {
                title: "Campfire ‚Äî The Sharpening",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>The fire is low and mean. Smoke clings to your hair and the damp sits inside your sleeves like a second skin.</p>
                        <p>Wat squats close to the coals with his sword across his knees. He works a whetstone along the edge in slow, patient strokes. The sound is small and ugly. Stone. Steel. A promise.</p>
                        <p><strong>Wat:</strong> Keep your edge honest, ${name}. A blunt blade turns a clean kill into a wrestling match. A wrestling match turns into a grave.</p>
                        <p>Across from him, The Cook watches the stew-pot as if it might try to escape. He stirs twice. Stops. Listens. Stirs once more.</p>
                        <p><strong>The Cook:</strong> The fat is rising. That means it will taste like something, which is better than most days.</p>
                        <p>Wat snorts without looking up.</p>
                        <p><strong>Wat:</strong> Taste like ash, taste like pig, taste like nothing. It all turns to shit in your gut the same.</p>
                    `;
                },
                choices: [
                    { text: "Ask Wat how he learned to fight like this.", effects: { wits: 1, stress: 1 }, nextScene: "start" },
                    { text: "Say nothing. Warm your hands and listen.", effects: { stress: -1 }, nextScene: "start" },
                    { text: "Trade a sharp remark with him, just to see if he bites.", effects: { morale: 1, stress: 1 }, nextScene: "start" },
                    { text: "Watch The Cook instead. Ask what's in the pot.", effects: { morale: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_wat_02_the_rope: {
                title: "Campfire ‚Äî The Rope",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>Someone has strung a rope between two stakes near the wagons. Not for laundry. Not for tents. The knot is too careful for that.</p>
                        <p>Men avoid looking at it. They glance and then look away, like it might look back.</p>
                        <p>Wat spits into the dirt. He is always spitting, like the world keeps trying to crawl into his mouth.</p>
                        <p><strong>Wat:</strong> Deserter's rope. Or thief's rope. Or unlucky bastard's rope. Doesn't matter. The rope's always hungry.</p>
                        <p>The Cook kneels near the fire, mending a split in a canvas sack with neat, identical stitches.</p>
                        <p><strong>The Cook:</strong> Hunger is predictable. Men are not.</p>
                        <p>Wat laughs once. It is not a friendly sound.</p>
                        <p><strong>Wat:</strong> You hear that, ${name}? Cook's got a philosophy. He'll stitch it into your ribs if you stand still.</p>
                    `;
                },
                choices: [
                    { text: "Tell Wat a man runs when he has no other door.", effects: { morale: 1, stress: 1 }, nextScene: "start" },
                    { text: "Agree with Wat: discipline is the only thing holding it together.", effects: { morale: -1 }, nextScene: "start" },
                    { text: "Ask The Cook why he's so calm about it.", effects: { wits: 1 }, nextScene: "start" },
                    { text: "Change the subject to tomorrow's march.", effects: { stress: -1 }, nextScene: "start" }
                ]
            },
            
            campfire_wat_03_the_boy_king: {
                title: "Campfire ‚Äî The Boy King",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>A rider came through camp at dusk with news from somewhere important. You did not hear the message. You saw the way men leaned toward it anyway, thirsty for meaning.</p>
                        <p>Wat pokes the fire until sparks leap and die.</p>
                        <p><strong>Wat:</strong> They'll tell you it's for England. For the King. For God. They'll sing it pretty, like it's a hymn. But it's men with purses pointing men with spears.</p>
                        <p>The Cook tastes the stew with the tip of a spoon. He frowns, adds a pinch of salt, and tastes again as if he is conducting a trial.</p>
                        <p><strong>The Cook:</strong> Salt changes the whole pot. A little decision. A big outcome.</p>
                        <p>Wat looks at him like he's seen a ghost.</p>
                        <p><strong>Wat:</strong> Don't start, Cook. Don't start your little lessons.</p>
                        <p><strong>The Cook:</strong> It is not a lesson. It is cooking.</p>
                        <p>Wat looks back to you.</p>
                        <p><strong>Wat:</strong> You still believe in it, ${name}? The grand story?</p>
                    `;
                },
                choices: [
                    { text: "Say you believe. Better to have a story than none.", effects: { morale: 1 }, nextScene: "start" },
                    { text: "Say Wat is right. It's about coin and power.", effects: { wits: 1, morale: -1 }, nextScene: "start" },
                    { text: "Say you don't know. You're here now. That's enough.", effects: { stress: -1 }, nextScene: "start" },
                    { text: "Ask what Wat thinks happens to men who stop believing.", effects: { wits: 1, stress: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_wat_04_the_dead_mules: {
                title: "Campfire ‚Äî The Dead Mules",
                location: "Camp",
                text: function () {
                    return `
                        <p>There is a smell near the picket line where the animals stand. Not all of them are standing. War eats beasts too.</p>
                        <p>Wat sits with his back to a wagon wheel, chewing something that might be bread if you squint.</p>
                        <p><strong>Wat:</strong> Men think battles decide wars. It's mules. It's oats. It's boots that don't rot off your feet. That's what decides it.</p>
                        <p>The Cook holds up a strip of salted meat to the firelight, inspecting it like a jeweler.</p>
                        <p><strong>The Cook:</strong> If you boil it long enough, you can pretend it is tender.</p>
                        <p><strong>Wat:</strong> Pretend's all this is half the time.</p>
                    `;
                },
                choices: [
                    { text: "Offer to help The Cook tomorrow. Fetch water, chop wood.", effects: { morale: 1 }, nextScene: "start" },
                    { text: "Ask Wat how he keeps going when it's like this.", effects: { stress: -1 }, nextScene: "start" },
                    { text: "Complain about rations and the march.", effects: { morale: -1, stress: 1 }, nextScene: "start" },
                    { text: "Make a joke about mules outranking soldiers.", effects: { morale: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_wat_05_the_prayer: {
                title: "Campfire ‚Äî The Prayer",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>Somewhere down the line a man is praying. Quietly. Not for victory. Not for glory. Just for the morning.</p>
                        <p>Wat watches the shadows as if they owe him money.</p>
                        <p><strong>Wat:</strong> Prayer won't stop a blade. But men pray anyway. Like God's got time for the likes of us.</p>
                        <p>The Cook is arranging pebbles in a careful little row beside the pot. Small. Medium. Small. Medium. Like a pattern that calms him.</p>
                        <p><strong>The Cook:</strong> People do it because it gives their hands a place to go.</p>
                        <p><strong>Wat:</strong> My hands go on a hilt.</p>
                        <p><strong>The Cook:</strong> And mine go on a ladle. We all have our ritual.</p>
                        <p>Wat turns to you.</p>
                        <p><strong>Wat:</strong> What about you, ${name}? You got a ritual? Or are you just waiting to die?</p>
                    `;
                },
                choices: [
                    { text: "Say you pray. Quietly. For the morning.", effects: { morale: 1, stress: -1 }, nextScene: "start" },
                    { text: "Say you don't pray. You prepare.", effects: { wits: 1 }, nextScene: "start" },
                    { text: "Say you don't know what you believe anymore.", effects: { stress: 1 }, nextScene: "start" },
                    { text: "Deflect with humor. Better laughing than trembling.", effects: { morale: 1, stress: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_cook_01_onions_and_names: {
                title: "Campfire ‚Äî Onions and Names",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>The Cook is cutting onions with a small knife that has seen too many hands. His slices are thin and identical, as if he is measuring time.</p>
                        <p><strong>The Cook:</strong> Onions keep if you hang them. Not in damp. Damp makes everything soft.</p>
                        <p>Wat is nearby, arguing with his own bootlaces.</p>
                        <p><strong>Wat:</strong> This whole country's damp. France is damp. Normandy's damp. Hell's probably damp.</p>
                        <p>The Cook looks up at you.</p>
                        <p><strong>The Cook:</strong> ${name}. Is that your real name?</p>
                        <p>Wat barks a laugh.</p>
                        <p><strong>Wat:</strong> Don't answer him. He'll put it in the stew. He'll remember it forever.</p>
                        <p><strong>The Cook:</strong> I remember things that are true. It helps with the cooking. It helps with people.</p>
                    `;
                },
                choices: [
                    { text: "Tell The Cook the name you were called at home.", effects: { morale: 1 }, nextScene: "start" },
                    { text: "Lie. Give him a cleaner name than the one you earned.", effects: { stress: 1 }, nextScene: "start" },
                    { text: "Ask The Cook where he learned to cook for soldiers.", effects: { wits: 1 }, nextScene: "start" },
                    { text: "Tell Wat to stop heckling him.", effects: { morale: 1, stress: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_cook_02_the_bread_story: {
                title: "Campfire ‚Äî The Bread Story",
                location: "Camp",
                text: function () {
                    return `
                        <p>The Cook has managed bread. Not good bread. Camp bread. But bread all the same. It comes out dark and heavy, like a stone you can chew.</p>
                        <p><strong>The Cook:</strong> It is not ruined. It is finished.</p>
                        <p>Wat breaks a piece, tests it with his teeth, and makes a face.</p>
                        <p><strong>Wat:</strong> Christ. You could build a wall with this.</p>
                        <p><strong>The Cook:</strong> Walls are useful.</p>
                        <p>He offers you a piece before he eats. That is a small kindness in a world that forgets kindness.</p>
                    `;
                },
                choices: [
                    { text: "Share your piece with Wat, even if he doesn't deserve it.", effects: { morale: 1 }, nextScene: "start" },
                    { text: "Eat it yourself. You'll need the strength tomorrow.", effects: { stress: -1 }, nextScene: "start" },
                    { text: "Trade it away for something better if you can.", effects: { wealth: 1 }, nextScene: "start" },
                    { text: "Ask The Cook what bread was like where he came from.", effects: { wits: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_cook_03_counting_buttons: {
                title: "Campfire ‚Äî Counting Buttons",
                location: "Camp",
                text: function () {
                    return `
                        <p>The Cook sits with a shirt in his lap, counting buttons under his breath as he sews. One. Two. Three. Pause. Four. Five. He touches each one like it is an oath.</p>
                        <p>Wat watches him and shakes his head, disgusted by any calm he doesn't understand.</p>
                        <p><strong>Wat:</strong> Look at him. Counting like it'll save him. Like a button's going to stop a lance.</p>
                        <p><strong>The Cook:</strong> Counting keeps my hands steady.</p>
                        <p><strong>Wat:</strong> Your hands should be holding a spear.</p>
                        <p><strong>The Cook:</strong> Your hands are already holding enough spears for the both of us.</p>
                        <p>Wat's jaw tightens. He looks at you like you've been asked to judge a fight.</p>
                    `;
                },
                choices: [
                    { text: "Tell Wat to leave him be. The Cook keeps you alive too.", effects: { morale: 1, stress: 1 }, nextScene: "start" },
                    { text: "Laugh along with Wat. Safer than being the target.", effects: { morale: -1 }, nextScene: "start" },
                    { text: "Ask The Cook what he's counting for, exactly.", effects: { wits: 1 }, nextScene: "start" },
                    { text: "Change the subject: ask Wat about his last campaign.", effects: { wits: 1, stress: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_cook_04_the_simmer: {
                title: "Campfire ‚Äî The Simmer",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>The stew simmers. The surface trembles and settles, trembles and settles, as if it is breathing.</p>
                        <p><strong>The Cook:</strong> If you boil too hard, it tastes like panic. If you simmer, it tastes like patience.</p>
                        <p>Wat snorts.</p>
                        <p><strong>Wat:</strong> Panic keeps you alive.</p>
                        <p><strong>The Cook:</strong> Panic makes you drop things.</p>
                        <p>He looks at you as if you are a question he wants to solve carefully.</p>
                        <p><strong>The Cook:</strong> What do you fear most, ${name}? Be specific. Not "death." That's lazy.</p>
                        <p>Wat's eyes flick over you. Quick. Hungry. Like he wants the answer too.</p>
                    `;
                },
                choices: [
                    { text: "Admit something small and true. Heights. Horses. Blood.", effects: { stress: -1, morale: 1 }, nextScene: "start" },
                    { text: "Refuse to answer. Some things stay behind your teeth.", effects: { stress: 1 }, nextScene: "start" },
                    { text: "Deflect with a joke. Make it someone else's problem.", effects: { morale: 1, stress: 1 }, nextScene: "start" },
                    { text: "Ask Wat what he fears most.", effects: { wits: 1, stress: 1 }, nextScene: "start" }
                ]
            },
            
            campfire_cook_05_the_old_recipe: {
                title: "Campfire ‚Äî The Old Recipe",
                location: "Camp",
                text: function () {
                    const name = gameState.characterName || "Soldier";
                    return `
                        <p>The Cook talks about a recipe from home as if naming it will summon it. A broth thickened with barley. A little herb if you can steal it from a hedge. A scrap of meat if fortune smiles.</p>
                        <p><strong>The Cook:</strong> People think food is just fuel. It is not. It is memory you can swallow.</p>
                        <p>Wat rolls his eyes.</p>
                        <p><strong>Wat:</strong> Memory doesn't stop steel.</p>
                        <p><strong>The Cook:</strong> No. But it stops men from turning into animals.</p>
                        <p>Wat stares at the fire. Quiet for a moment. The flames paint his face like an old bruise.</p>
                        <p><strong>Wat:</strong> Animals live longer.</p>
                        <p>The Cook turns to you.</p>
                        <p><strong>The Cook:</strong> When you think of home, ${name}, what is the first smell?</p>
                    `;
                },
                choices: [
                    { text: "Answer honestly. Smoke. Bread. Wet earth. Horses.", effects: { morale: 1 }, nextScene: "start" },
                    { text: "Say you don't remember. Or pretend you don't.", effects: { stress: 1 }, nextScene: "start" },
                    { text: "Ask The Cook what he misses most.", effects: { wits: 1 }, nextScene: "start" },
                    { text: "Ask Wat, quietly, what he misses. If anything.", effects: { stress: 1, wits: 1 }, nextScene: "start" }
                ]
            },
            campfire_interlude: {
                title: "Campfire",
                year: function() { return gameState.year; },
                age: function() { return gameState.age || 18; },
                location: function() { return gameState.location || "Camp"; },
                noCampfire: true, // Prevent recursion
                artwork: "artwork/campfire.jpg",
                artworkCaption: "Evening by the fire - a moment of rest and reflection",
                text: function() {
                    const cf = gameState.campfire || {};
                    const step = cf.currentStep || 0;
                    
                    // Initialize vignette on step 0
                    if (step === 0) {
                        const seenIds = new Set(cf.seenIds || []);
                        
                        // Pick a vignette: prefer unseen, but allow repeats if all seen
                        let available = CAMPFIRE_VIGNETTES.filter(v => {
                            // Check year range if specified
                            if (v.minYear && gameState.year < v.minYear) return false;
                            if (v.maxYear && gameState.year > v.maxYear) return false;
                            return true;
                        });
                        
                        let selectedVignette = null;
                        
                        // Prefer unseen vignettes
                        const unseen = available.filter(v => !seenIds.has(v.id));
                        if (unseen.length > 0) {
                            selectedVignette = unseen[Math.floor(Math.random() * unseen.length)];
                        } else {
                            // All seen - avoid last 3 seen
                            const recentSeen = cf.seenIds.slice(-3);
                            const notRecent = available.filter(v => !recentSeen.includes(v.id));
                            if (notRecent.length > 0) {
                                selectedVignette = notRecent[Math.floor(Math.random() * notRecent.length)];
                            } else {
                                // Fallback to any
                                selectedVignette = available[Math.floor(Math.random() * available.length)];
                            }
                        }
                        
                        if (!selectedVignette) {
                            return `<p>The fire burns low. Men sleep. The night passes.</p>`;
                        }
                        
                        // Store selected vignette and reset step
                        cf.currentVignetteId = selectedVignette.id;
                        cf.currentStep = 0;
                        cf.stepHistory = [];
                        
                        // Add to seen list (limit to last 20)
                        if (!cf.seenIds) cf.seenIds = [];
                        cf.seenIds.push(selectedVignette.id);
                        if (cf.seenIds.length > 20) {
                            cf.seenIds = cf.seenIds.slice(-20);
                        }
                    }
                    
                    const vignetteId = cf.currentVignetteId;
                    const vignette = CAMPFIRE_VIGNETTES.find(v => v.id === vignetteId);
                    
                    if (!vignette) {
                        return `<p>The fire burns low. Men sleep. The night passes.</p>`;
                    }
                    
                    // Render header
                    const header = vignette.focus === "wat" ? 
                        `<p style="color: #d4af37; font-style: italic; margin-bottom: 10px;">Wat spits into the fire.</p>` :
                        vignette.focus === "cook" ?
                        `<p style="color: #d4af37; font-style: italic; margin-bottom: 10px;">The Cook stirs the pot.</p>` :
                        `<p style="color: #d4af37; font-style: italic; margin-bottom: 10px;">Wat and The Cook sit by the fire.</p>`;
                    
                    const title = vignette.title || vignette.id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    // Handle multi-stage vignettes
                    if (vignette.stages && Array.isArray(vignette.stages)) {
                        const currentStage = vignette.stages[step];
                        if (currentStage) {
                            const stageText = typeof currentStage.text === 'function' ? currentStage.text(gameState) : currentStage.text;
                            if (step === 0) {
                                return header + `<h3 style="margin-top:0; color: #f4d03f;">${title}</h3>` + stageText;
                            } else {
                                return header + stageText;
                            }
                        }
                    }
                    
                    // Fallback to old format (single stage)
                    const vignetteText = typeof vignette.text === 'function' ? vignette.text(gameState) : vignette.text;
                    if (step === 0) {
                        return header + `<h3 style="margin-top:0; color: #f4d03f;">${title}</h3>` + vignetteText;
                    } else {
                        // Show response from previous choice
                        return header + (cf.currentResponse || '');
                    }
                },
                choices: function() {
                    const cf = gameState.campfire || {};
                    const step = cf.currentStep || 0;
                    const vignetteId = cf.currentVignetteId;
                    const vignette = CAMPFIRE_VIGNETTES.find(v => v.id === vignetteId);
                    
                    if (!vignette) {
                        // Fallback if no vignette selected
                        return [{
                            text: "Turn in for the night.",
                            effects: { stress: -1 },
                            nextScene: function() {
                                const next = cf.returnScene || "start";
                                cf.returnScene = null;
                                cf.currentVignetteId = null;
                                cf.currentStep = 0;
                                return next;
                            }
                        }];
                    }
                    
                    // Handle multi-stage vignettes
                    if (vignette.stages && Array.isArray(vignette.stages)) {
                        const currentStage = vignette.stages[step];
                        if (!currentStage) {
                            // No more stages, exit
                            return [{
                                text: "Turn in for the night.",
                                effects: { stress: -1 },
                                nextScene: function() {
                                    const next = cf.returnScene || "start";
                                    cf.returnScene = null;
                                    cf.currentVignetteId = null;
                                    cf.currentStep = 0;
                                    return next;
                                }
                            }];
                        }
                        
                        // Convert stage choices to scene choices format
                        const choices = currentStage.choices.map((c, i) => {
                            return {
                                text: c.text,
                                effects: function(gs) {
                                    const state = gs || gameState;
                                    // Apply effects
                                    if (typeof c.effects === 'function') {
                                        c.effects(state);
                                    } else if (typeof c.effects === 'object') {
                                        Object.entries(c.effects).forEach(([key, value]) => {
                                            applyStatChange(key, value, {silent:true});
                                        });
                                    }
                                },
                                nextScene: function() {
                                    // If this is an exit choice, return to next scene
                                    if (c.isExit) {
                                        const next = cf.returnScene || "start";
                                        cf.returnScene = null;
                                        cf.currentVignetteId = null;
                                        cf.currentStep = 0;
                                        return next;
                                    }
                                    
                                    // Otherwise, advance to next stage
                                    const nextStep = step + 1;
                                    const nextStage = vignette.stages[nextStep];
                                    
                                    if (nextStage) {
                                        // Store response for next stage
                                        if (typeof c.response === 'function') {
                                            cf.currentResponse = c.response(gameState);
                                        } else if (c.response) {
                                            cf.currentResponse = c.response;
                                        }
                                        cf.currentStep = nextStep;
                                        cf.stepHistory.push({ step: step, choiceIndex: i });
                                        return "campfire_interlude"; // Stay in campfire, show next stage
                                    } else {
                                        // No more stages, exit
                                        const next = cf.returnScene || "start";
                                        cf.returnScene = null;
                                        cf.currentVignetteId = null;
                                        cf.currentStep = 0;
                                        return next;
                                    }
                                }
                            };
                        });
                        
                        return choices;
                    }
                    
                    // Fallback to old format (single stage) - convert to multi-stage format on the fly
                    let oldChoices = [];
                    if (typeof vignette.choices === 'function') {
                        try {
                            oldChoices = vignette.choices(gameState) || [];
                        } catch (error) {
                            console.error('Error getting choices from vignette function:', error);
                            oldChoices = [];
                        }
                    } else if (Array.isArray(vignette.choices)) {
                        oldChoices = vignette.choices;
                    }
                    const choices = oldChoices.map((c, i) => {
                        return {
                            text: c.text,
                            effects: function(gs) {
                                const state = gs || gameState;
                                if (typeof c.effects === 'function') {
                                    c.effects(state);
                                } else if (typeof c.effects === 'object') {
                                    Object.entries(c.effects).forEach(([key, value]) => {
                                        applyStatChange(key, value, {silent:true});
                                    });
                                }
                            },
                            nextScene: function() {
                                // Old format: exit immediately
                                const next = cf.returnScene || "start";
                                cf.returnScene = null;
                                cf.currentVignetteId = null;
                                cf.currentStep = 0;
                                return next;
                            }
                        };
                    });
                    
                    // Always add "Turn in" option
                    choices.push({
                        text: "Turn in for the night.",
                        effects: { stress: -1 },
                        nextScene: function() {
                            const next = cf.returnScene || "start";
                            cf.returnScene = null;
                            cf.currentVignetteId = null;
                            cf.currentStep = 0;
                            return next;
                        }
                    });
                    
                    return choices;
                }
            }
        },
        
        // ===== RANDOM ENCOUNTERS =====
        
        random_drunken_song: {
            title: "A Drunken Song",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>Someone's trying to remember the words to a drinking song. He gets halfway through the first verse, forgets the next line, starts over, forgets again. A few men join in, each with a different version of the lyrics.</p>
                   <p>It's not good. It's not even close to good. But it's loud, and it's happening, and you're stuck listening to it.</p>`,
            choices: [
                {
                    text: "Join in and try to remember the words",
                    effects: function(gs) {
                        applyStatChange('morale', 1, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Tell them to shut up",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Walk away and find somewhere quieter",
                    effects: function(gs) {
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_lost_boot: {
            title: "Missing Boot",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>You wake up and one of your boots is gone. Not stolen, probably. Just gone. Moved. Disappeared into the chaos of camp life.</p>
                   <p>You search around your tent. Under your pack. Behind the fire pit. Nothing. The boot has simply ceased to exist.</p>`,
            choices: [
                {
                    text: "Search thoroughly for the boot",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Ask around if anyone's seen it",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Give up and make do with one boot",
                    effects: function(gs) {
                        applyStatChange('stress', 2, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_gambling_debt: {
            title: "Gambling Debt",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>A man approaches you with a serious expression. He says you owe him money from a dice game last week. You don't remember the game. You don't remember owing anyone anything.</p>
                   <p>But he's insistent. And he's bigger than you. And he's got friends watching.</p>`,
            choices: [
                {
                    text: "Pay him to avoid trouble",
                    effects: function(gs) {
                        const wealth = gs.stats?.wealth || gs.wealth || 0;
                        if (wealth >= 2) {
                            applyStatChange('wealth', -2, {silent: true});
                            applyStatChange('stress', -1, {silent: true});
                        } else {
                            applyStatChange('stress', 2, {silent: true});
                        }
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Refuse and stand your ground",
                    effects: function(gs) {
                        applyStatChange('stress', 2, {silent: true});
                        applyStatChange('reputation', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Challenge him to another game to settle it",
                    effects: function(gs) {
                        const roll = Math.random();
                        if (roll < 0.5) {
                            applyStatChange('wealth', 2, {silent: true});
                            applyStatChange('morale', 1, {silent: true});
                        } else {
                            applyStatChange('wealth', -3, {silent: true});
                            applyStatChange('stress', 2, {silent: true});
                        }
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_campfire_tale: {
            title: "A Tall Tale",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>An old soldier is telling a story. It's about a French knight who got so drunk he tried to kiss a pig, thinking it was a beautiful lady. The pig bit him. The knight fell into a ditch. His squire had to pull him out.</p>
                   <p>It's probably not true. But it's funny. And everyone's listening. And for a moment, the war feels far away.</p>`,
            choices: [
                {
                    text: "Laugh along with the story",
                    effects: function(gs) {
                        applyStatChange('morale', 1, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Add your own embellishment to the tale",
                    effects: function(gs) {
                        applyStatChange('morale', 2, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Roll your eyes and ignore it",
                    effects: function(gs) {
                        // No effect
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_broken_sword: {
            title: "Broken Blade",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>You notice a crack in your sword's tang. Not a break. Not yet. But a crack. A weakness. Something that could fail when you need it most.</p>
                   <p>You could try to fix it. You could ignore it. You could find a smith. But smiths cost money. And money is hard to come by.</p>`,
            choices: [
                {
                    text: "Pay a smith to repair it properly",
                    effects: function(gs) {
                        const wealth = gs.stats?.wealth || gs.wealth || 0;
                        if (wealth >= 3) {
                            applyStatChange('wealth', -3, {silent: true});
                            applyStatChange('stress', -1, {silent: true});
                        } else {
                            applyStatChange('stress', 2, {silent: true});
                        }
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Try to fix it yourself",
                    effects: function(gs) {
                        const roll = Math.random();
                        if (roll < 0.4) {
                            applyStatChange('stress', -1, {silent: true});
                        } else {
                            applyStatChange('stress', 2, {silent: true});
                        }
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Ignore it and hope it holds",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_stolen_socks: {
            title: "Stolen Socks",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>Someone's taken your socks. Not your boots. Not your shirt. Your socks. The ones you were drying by the fire.</p>
                   <p>It's a small thing. A petty thing. But it's annoying. And you're tired. And you just want your socks back.</p>`,
            choices: [
                {
                    text: "Search the camp for the thief",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Accept the loss and move on",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Take someone else's socks in revenge",
                    effects: function(gs) {
                        applyStatChange('stress', -1, {silent: true});
                        applyStatChange('reputation', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_bad_stew: {
            title: "Bad Stew",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>The cook's made another stew. It looks wrong. It smells wrong. It tastes like someone boiled old leather and called it food.</p>
                   <p>But you're hungry. And it's food. And you don't have much choice.</p>`,
            choices: [
                {
                    text: "Eat it anyway",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                        applyStatChange('endurance', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Skip the meal",
                    effects: function(gs) {
                        applyStatChange('endurance', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Complain to the cook",
                    effects: function(gs) {
                        applyStatChange('stress', 2, {silent: true});
                        applyStatChange('reputation', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_weather_complaint: {
            title: "The Weather",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>It's been raining for three days. Everything's wet. Your tent leaks. Your boots squelch. Your clothes never dry.</p>
                   <p>Someone nearby is complaining about it. Loudly. Constantly. As if the weather will change if he complains enough.</p>`,
            choices: [
                {
                    text: "Join in the complaining",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Tell him to shut up",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Ignore it and focus on staying dry",
                    effects: function(gs) {
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_insult_battle: {
            title: "Insults Fly",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>Two men are trading insults. Not fighting. Not yet. Just words. Sharp words. Clever words. Words designed to cut deeper than any blade.</p>
                   <p>A crowd's gathering. Men are placing bets. Someone's keeping score. It's entertainment. It's distraction. It's something to do.</p>`,
            choices: [
                {
                    text: "Watch and enjoy the show",
                    effects: function(gs) {
                        applyStatChange('morale', 1, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Join in with your own insult",
                    effects: function(gs) {
                        applyStatChange('morale', 2, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Try to break it up before it turns violent",
                    effects: function(gs) {
                        applyStatChange('reputation', 1, {silent: true});
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_dice_game: {
            title: "A Game of Dice",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>Someone's organized a dice game. Simple rules. Simple stakes. Your coin against theirs. Winner takes all.</p>
                   <p>It's a distraction. It's a chance. It's a way to pass the time and maybe come out ahead.</p>`,
            choices: [
                {
                    text: "Join the game",
                    effects: function(gs) {
                        const wealth = gs.stats?.wealth || gs.wealth || 0;
                        if (wealth >= 1) {
                            const roll = Math.random();
                            if (roll < 0.5) {
                                applyStatChange('wealth', 2, {silent: true});
                                applyStatChange('morale', 1, {silent: true});
                            } else {
                                applyStatChange('wealth', -1, {silent: true});
                                applyStatChange('stress', 1, {silent: true});
                            }
                        } else {
                            applyStatChange('stress', 1, {silent: true});
                        }
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Watch but don't play",
                    effects: function(gs) {
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Walk away",
                    effects: function(gs) {
                        // No effect
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_cooking_disaster: {
            title: "Cooking Disaster",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>The cook's burned something. Badly. The smell of charred meat and smoke fills the camp. Men are coughing. Eyes are watering.</p>
                   <p>It's not the end of the world. But it's annoying. And it means less food for everyone. And you're already hungry.</p>`,
            choices: [
                {
                    text: "Help salvage what you can",
                    effects: function(gs) {
                        applyStatChange('reputation', 1, {silent: true});
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Complain about the waste",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                        applyStatChange('morale', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Ignore it and find other food",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_sleepwalking: {
            title: "Sleepwalking",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>You wake up outside your tent. You don't remember leaving. You don't remember walking. But here you are, standing in the dark, confused and cold.</p>
                   <p>Someone's watching you. A guard. He's got his hand on his sword. He thinks you're up to something. You're not. You're just lost. Just confused. Just tired.</p>`,
            choices: [
                {
                    text: "Explain that you were sleepwalking",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                        applyStatChange('endurance', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Say nothing and go back to your tent",
                    effects: function(gs) {
                        applyStatChange('stress', 2, {silent: true});
                        applyStatChange('endurance', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Make up an excuse about checking the perimeter",
                    effects: function(gs) {
                        applyStatChange('reputation', 1, {silent: true});
                        applyStatChange('stress', 1, {silent: true});
                        applyStatChange('endurance', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        },
        
        random_animal_encounter: {
            title: "Camp Visitor",
            year: function() { return gameState.year; },
            age: function() { return gameState.age; },
            location: "Camp",
            text: `<p>A stray dog has wandered into camp. It's thin. It's dirty. It's looking for food. Men are throwing it scraps. Some are trying to pet it. Others are trying to shoo it away.</p>
                   <p>It's not a threat. It's not a problem. It's just a dog. Just an animal. Just something that doesn't belong here but is here anyway.</p>`,
            choices: [
                {
                    text: "Feed the dog some of your rations",
                    effects: function(gs) {
                        applyStatChange('morale', 1, {silent: true});
                        applyStatChange('stress', -1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Ignore it and go about your business",
                    effects: function(gs) {
                        // No effect
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                },
                {
                    text: "Try to shoo it away",
                    effects: function(gs) {
                        applyStatChange('stress', 1, {silent: true});
                    },
                    nextScene: function() {
                        return (gameState.randomEncounter && gameState.randomEncounter.returnScene) || "start";
                    }
                }
            ]
        }
        
        };
        
        // Initialize game
        function initGame() {
            // Hide loading message immediately (redundant check, but safe)
            try {
                const loadingMsg = document.getElementById('loading-message');
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
            } catch (e) {
                console.error('Error hiding loading message in initGame:', e);
            }
            
            console.log("=== INIT GAME START ===");
            console.log("initGame called");
            console.log("gameState.currentScene:", gameState.currentScene);
            console.log("scenes object exists:", typeof scenes !== 'undefined');
            
            // Ensure we start at character creation if no save exists or if scene is invalid
            if (!gameState.currentScene || gameState.currentScene === 'start') {
                console.log("Forcing character creation scene (no scene or start)");
                gameState.currentScene = 'character_creation';
                gameState.characterName = gameState.characterName || "William Thatcher";
                gameState.background = gameState.background || null;
            } else if (typeof scenes !== 'undefined' && !scenes[gameState.currentScene]) {
                console.log("Forcing character creation scene (invalid scene:", gameState.currentScene + ")");
                gameState.currentScene = 'character_creation';
                gameState.characterName = gameState.characterName || "William Thatcher";
                gameState.background = gameState.background || null;
            }
            
            console.log("Final currentScene:", gameState.currentScene);
            console.log("Scene exists:", typeof scenes !== 'undefined' && scenes[gameState.currentScene] ? 'YES' : 'NO');
            
            // Initialize equipment manager if not already done (consolidated to single function)
            initializeEquipmentSystem();
            
            console.log("Calling updateDisplay");
            try {
                updateDisplay();
                console.log("updateDisplay completed");
            } catch (e) {
                console.error("updateDisplay threw error:", e);
                const storyEl = document.getElementById('story');
                if (storyEl) {
                    const safeError = escapeHTML(String(e.message || 'Unknown error'));
                    storyEl.innerHTML = '<p style="color: red;">Error initializing game. Check console for details.</p><p>Error: ' + safeError + '</p>';
                }
            }
            console.log("=== INIT GAME END ===");
        }
        
        // Update all displays
        function updateDisplay() {
            // Isolate each renderer so one failure doesn't block others
            try {
                updateStory();
            } catch (e) {
                console.error('updateStory failed:', e);
            }
            try {
                updateStats();
            } catch (e) {
                console.error('updateStats failed:', e);
            }
            try {
                updateChoices();
            } catch (e) {
                console.error('updateChoices failed:', e);
            }
            try {
                updateStatusBar();
            } catch (e) {
                console.error('updateStatusBar failed:', e);
            }
            
            // Hide controls footer on character creation screen
            const controls = document.querySelector('.controls');
            if (controls) {
                if (gameState.currentScene === 'character_creation') {
                    controls.style.display = 'none';
                } else {
                    controls.style.display = 'flex';
                }
            }
        }
        
        // Update story text
        function updateStory() {
            console.log("=== UPDATE STORY START ===");
            // Get story element once at the start
            const storyElement = document.getElementById('story');
            if (!storyElement) {
                console.error("Story element not found!");
                return;
            }
            console.log("Story element found:", storyElement);
            
            // Declare scene in function scope so it's accessible throughout
            let scene;
            
            try {
                console.log("updateStory called, currentScene:", gameState.currentScene);
                console.log("scenes object exists:", typeof scenes !== 'undefined');
                
                if (typeof scenes === 'undefined') {
                    console.error("scenes object is not defined!");
                    storyElement.innerHTML = '<p>Error: Scenes not loaded. Please refresh the page.</p>';
                    // Reset to safe state
                    gameState.currentScene = 'character_creation';
                    return;
                }
                
                console.log("scenes keys:", Object.keys(scenes).slice(0, 5));
                
                // Assign scene (not const, so it's accessible outside try block)
                scene = scenes[gameState.currentScene];
                if (!scene) {
                    console.error("Scene not found:", gameState.currentScene);
                    console.log("Available scenes:", Object.keys(scenes));
                    // Reset to safe state instead of showing error
                    console.warn("Resetting to character_creation scene");
                    gameState.currentScene = 'character_creation';
                    scene = scenes['character_creation'];
                    if (!scene) {
                        storyElement.innerHTML = '<p style="color: red;">Error: Game state corrupted. Please refresh the page.</p>';
                        return;
                    }
                }
                
                // Debug: log character creation scene
                if (gameState.currentScene === 'character_creation') {
                    console.log("Rendering character creation scene");
                }
            } catch (error) {
                console.error("Error in updateStory:", error);
                const safeError = escapeHTML(String(error.message || 'Unknown error'));
                storyElement.innerHTML = `<p>Error loading scene: ${safeError}</p><p>Please check the console for details.</p>`;
                return;
            }
            
            // Now scene is guaranteed to be defined (or we've returned)
            // Update timeline if scene specifies it
            if (scene.year !== undefined && scene.year !== null) {
                gameState.year = typeof scene.year === 'function' ? scene.year() : scene.year;
            }
            if (scene.age !== undefined && scene.age !== null) {
                // Handle both function and number age values
                gameState.age = typeof scene.age === 'function' ? scene.age() : scene.age;
            }
            if (scene.location !== undefined && scene.location !== null) {
                gameState.location = typeof scene.location === 'function' ? scene.location() : scene.location;
            }
            
            // Update conditions
            updateConditions();
            
            // Run onEnter callback if present (only once per scene entry)
            if (scene.onEnter && typeof scene.onEnter === 'function') {
                const sceneKey = `${gameState.currentScene}_${gameState.year}`;
                if (!gameState.enteredScenes.has(sceneKey)) {
                    scene.onEnter();
                    gameState.enteredScenes.add(sceneKey);
                }
            }
            
            // Get story text (handle function-based text)
            let storyText = '';
            try {
                if (typeof scene.text === 'function') {
                    storyText = scene.text();
                } else if (typeof scene.text === 'string') {
                    storyText = scene.text;
                } else {
                    console.error("Scene text is neither function nor string:", typeof scene.text);
                    storyText = '<p>Error: Scene text format invalid.</p>';
                }
            } catch (error) {
                console.error("Error rendering scene text:", error);
                console.error("Error stack:", error.stack);
                storyText = `<p>Error loading scene content. Please refresh the page.</p><p>Error: ${error.message}</p><p>Check console for details.</p>`;
            }
            
            // Ensure we have some text to display
            if (!storyText || storyText.trim() === '') {
                console.error("storyText is empty after rendering!");
                storyText = '<p>Error: Scene rendered empty content.</p>';
            }
            
            // Add rank display
            let rankDisplay = '';
            if (gameState.rank) {
                rankDisplay = `<div class="rank-display">Rank: ${gameState.rank}</div>`;
            }
            
            // Add patron favor display
            let favorDisplay = '';
            if (gameState.stats.patronFavor > 0) {
                favorDisplay = `<div style="margin-top: 5px; color: #f4d03f;">Patron Favor: ${gameState.stats.patronFavor}</div>`;
            }
            
            // Handle scene artwork
            const artworkElement = document.getElementById('scene-artwork');
            const artworkImage = document.getElementById('artwork-image');
            const artworkCaption = document.getElementById('artwork-caption');
            
            if (scene.artwork && artworkElement && artworkImage) {
                // Scene has artwork - display it
                artworkImage.src = scene.artwork;
                artworkImage.alt = scene.artworkCaption || scene.title || 'Scene artwork';
                if (artworkCaption && scene.artworkCaption) {
                    artworkCaption.textContent = scene.artworkCaption;
                    artworkCaption.style.display = 'block';
                } else if (artworkCaption) {
                    artworkCaption.style.display = 'none';
                }
                artworkElement.classList.add('visible');
            } else if (artworkElement) {
                // No artwork for this scene - hide it
                artworkElement.classList.remove('visible');
            }
            
            // Add equipment display (skip for character creation)
            let equipmentDisplay = '';
            if (gameState.currentScene !== 'character_creation') {
                // Old equipment format check - skip if using new layered system
                try {
                    if (gameState.equipment && gameState.equipment.weapon && gameState.equipment.weapon.quality > 0) {
                        equipmentDisplay = `<div style="margin-top: 5px; font-size: 0.9em;">
                            Equipment: ${gameState.equipment.weapon.name || 'Weapon'} (Quality +${gameState.equipment.weapon.quality})
                        </div>`;
                    }
                } catch (e) {
                    // Equipment display is optional, ignore errors
                }
            }
            
            // Add conditions display
            let conditionsDisplay = '';
            if (gameState.conditions.length > 0) {
                conditionsDisplay = '<div style="margin-top: 10px;"><strong>Conditions:</strong> ';
                conditionsDisplay += gameState.conditions.map(c => 
                    `<span class="condition-badge ${c.type}">${c.name}</span>`
                ).join('');
                conditionsDisplay += '</div>';
            }
            
            // Render the story - ensure we always set innerHTML even if something is undefined
            try {
                const title = scene.title || 'Untitled Scene';
                storyElement.innerHTML = 
                    `<h2 style="margin-bottom: 15px; color: #f4d03f;">${title}</h2>
                     ${rankDisplay || ''}
                     ${favorDisplay || ''}
                     ${equipmentDisplay || ''}
                     ${storyText || '<p>No content available.</p>'}
                     ${conditionsDisplay || ''}`;
                storyElement.classList.add('fade-in');
                console.log("Successfully rendered story for scene:", gameState.currentScene);
            } catch (error) {
                console.error("Error setting storyElement.innerHTML:", error);
                const safeError = escapeHTML(String(error.message || 'Unknown error'));
                const safeScene = escapeHTML(String(gameState.currentScene || 'unknown'));
                storyElement.innerHTML = `<p>Error rendering scene: ${safeError}</p><p>Scene: ${safeScene}</p>`;
            }
        }
        
        // Update stats display
        function updateStats() {
            const statsContainer = document.getElementById('stats');
            
            // Hide stats panel on character creation screen
            if (gameState.currentScene === 'character_creation') {
                if (statsContainer) {
                    statsContainer.style.display = 'none';
                }
                return; // Exit early, don't update anything
            } else {
                if (statsContainer) {
                    statsContainer.style.display = 'block'; // Show it for other scenes
                }
            }
            
            const stats = gameState.stats;
            
            // Apply condition effects for display
            const conditionEffects = getConditionEffects();
            
            const statItems = [
                { key: 'strength', label: '‚öîÔ∏è Strength', max: 10 },
                { key: 'agility', label: 'üèÉ Agility', max: 10 },
                { key: 'endurance', label: '‚ù§Ô∏è Endurance', max: 10 },
                { key: 'charisma', label: 'üí¨ Charisma', max: 10 },
                { key: 'luck', label: 'üçÄ Luck', max: 10 },
                { key: 'wits', label: 'üß† Wits', max: 10 },
                { key: 'morale', label: 'üí™ Morale', max: 10 },
                { key: 'stress', label: 'üò∞ Stress', max: 10 },
                { key: 'wealth', label: 'üí∞ Wealth', max: 24000, isSpecial: true }, // Max 100 pounds (24000 pence)
                { key: 'reputation', label: '‚≠ê Reputation', max: 50, isSpecial: true },
                { key: 'experience', label: '‚≠ê Experience', max: 1000, isSpecial: true },
                { key: 'patronFavor', label: 'üëë Patron Favor', max: 20, isSpecial: true }
            ];
            
            statsContainer.innerHTML = statItems.map(stat => {
                let value = stats[stat.key] || 0;
                // Apply condition effects (but not equipment - that's situational)
                if (conditionEffects[stat.key]) {
                    value += conditionEffects[stat.key];
                }
                value = Math.max(0, Math.min(stat.max, value));
                const percentage = (value / stat.max) * 100;
                
                if (stat.isSpecial) {
                    return `
                        <div class="stat-item">
                            <div class="stat-label">${stat.label}</div>
                            <div class="stat-special">${stat.key === 'wealth' ? formatCurrency(value) : stat.key === 'experience' ? value + ' XP' : value + ' points'}</div>
                        </div>
                    `;
                }
                
                // Show effective stat if different from base
                const effectiveValue = getEffectiveStat(stat.key);
                const effectiveDisplay = effectiveValue !== value ? ` (Effective: ${effectiveValue})` : '';
                
                return `
                    <div class="stat-item">
                        <div class="stat-label">${stat.label}${effectiveDisplay}</div>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: ${percentage}%"></div>
                            <div class="stat-value">${value}/${stat.max}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update choices
        function updateChoices() {
            const scene = scenes[gameState.currentScene];
            if (!scene) return;
            
            const choicesContainer = document.getElementById('choices-container');
            
            // Handle both function and array choices
            let choices = scene.choices;
            if (typeof choices === 'function') {
                try {
                    choices = choices();
                } catch (error) {
                    console.error('Error getting choices from function:', error);
                    choices = [];
                }
            }
            
            if (!Array.isArray(choices) || choices.length === 0) {
                choicesContainer.innerHTML = '<p style="color: #888; font-style: italic;">No choices available.</p>';
                return;
            }
            
            choicesContainer.innerHTML = choices.map((choice, index) => {
                let effectsText = '';
                if (choice.effects) {
                    effectsText = Object.entries(choice.effects)
                        .map(([key, value]) => {
                            const sign = value > 0 ? '+' : '';
                            return `${sign}${value} ${key}`;
                        })
                        .join(', ');
                }
                
                // Consequence tags
                let consequenceTags = '';
                if (choice.consequences) {
                    const tags = [];
                    
                    if (choice.consequences.risk) {
                        const riskColors = { 
                            low: { bg: '#4CAF50', text: 'SAFE' }, 
                            medium: { bg: '#FF9800', text: 'MODERATE RISK' }, 
                            high: { bg: '#f44336', text: 'HIGH RISK' } 
                        };
                        const risk = riskColors[choice.consequences.risk] || riskColors.medium;
                        tags.push(`<span style="background: ${risk.bg}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; font-weight: bold; margin-left: 5px;">[${risk.text}]</span>`);
                    }
                    
                    if (choice.consequences.reward) {
                        tags.push(`<span style="background: #d4af37; color: #1a0f08; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; font-weight: bold; margin-left: 5px;">[${choice.consequences.reward}]</span>`);
                    }
                    
                    if (choice.consequences.statChanges) {
                        const statText = Object.entries(choice.consequences.statChanges)
                            .map(([stat, val]) => `${val > 0 ? '+' : ''}${val} ${stat}`)
                            .join(', ');
                        tags.push(`<span style="background: #2a2a2a; color: #d4af37; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 5px;">[${statText}]</span>`);
                    }
                    
                    if (tags.length > 0) {
                        consequenceTags = `<div style="margin-top: 5px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">${tags.join('')}</div>`;
                    }
                }
                
                // Check requirements
                let disabled = false;
                let disabledReason = '';
                if (choice.requires) {
                    if (choice.requires.stat) {
                        const statValue = gameState.stats[choice.requires.stat] || 0;
                        if (statValue < choice.requires.min) {
                            disabled = true;
                            disabledReason = `Requires ${choice.requires.stat} ‚â• ${choice.requires.min}`;
                        }
                    }
                }
                
                return `
                    <button class="choice-button" onclick="makeChoice(${index})" ${disabled ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        <div style="text-align: left;">
                            <div>${choice.text}</div>
                            ${consequenceTags}
                            ${effectsText ? `<span class="choice-effects">${effectsText}</span>` : ''}
                            ${disabledReason ? `<span class="choice-effects" style="color: #8b0000;">${disabledReason}</span>` : ''}
                        </div>
                    </button>
                `;
            }).join('');
        }
        
        // Calculate rank based on experience
        function calculateRank() {
            const xp = gameState.stats.experience || 0;
            if (xp >= 500) return "Knight";
            if (xp >= 301) return "Sergeant";
            if (xp >= 151) return "Veteran";
            if (xp >= 51) return "Common Soldier";
            return "Raw Recruit";
        }
        
        // Update status bar
        function updateStatusBar() {
            // Hide status bar on character creation screen
            const statusBar = document.querySelector('.status-bar');
            if (!statusBar) return;
            
            if (gameState.currentScene === 'character_creation') {
                statusBar.style.display = 'none';
                return; // Exit early, don't update anything
            } else {
                statusBar.style.display = 'flex'; // Show it for other scenes
            }
            
            document.getElementById('year').textContent = gameState.year || 1337;
            // Ensure age is always a number, not a function
            const ageValue = typeof gameState.age === 'function' ? gameState.age() : (gameState.age || 18);
            document.getElementById('age').textContent = ageValue;
            document.getElementById('location').textContent = gameState.location || 'Unknown';
            
            // Update rank display
            const currentRank = calculateRank();
            if (gameState.rank !== currentRank) {
                const oldRank = gameState.rank;
                gameState.rank = currentRank;
                if (oldRank && oldRank !== "Common Soldier") {
                    showNotification("Rank Advancement", `You have been promoted to ${currentRank}!`, "success");
                }
            }
            
            // Display rank in status bar if element exists
            let rankElement = document.getElementById('status-rank');
            if (!rankElement) {
                rankElement = document.createElement('div');
                rankElement.id = 'status-rank';
                rankElement.className = 'status-item';
                rankElement.style.cssText = 'color: #d4af37; font-weight: bold;';
                statusBar.insertBefore(rankElement, statusBar.firstChild);
            }
            if (rankElement) {
                rankElement.textContent = currentRank;
            }
            
            // Add conditions display
            
            let conditionsElement = document.getElementById('status-conditions');
            
            if (!conditionsElement) {
                conditionsElement = document.createElement('div');
                conditionsElement.id = 'status-conditions';
                conditionsElement.className = 'status-item';
                conditionsElement.style.cssText = 'display: flex; gap: 5px; flex-wrap: wrap; align-items: center;';
                statusBar.appendChild(conditionsElement);
            }
            
            if (gameState.conditions && gameState.conditions.length > 0) {
                conditionsElement.innerHTML = '<span style="color: #d4af37; font-weight: bold;">Status:</span>' +
                    gameState.conditions.map(c => {
                        const colors = {
                            'Wounded': '#8b0000',
                            'Seriously Wounded': '#ff0000',
                            'Fatigued': '#8b6914',
                            'Shaken': '#8b4513',
                            'Sick': '#6b8e23',
                            'Exhausted': '#4b0082'
                        };
                        const color = colors[c.name] || '#d4af37';
                        return `<span style="
                            background: ${color}33;
                            border: 1px solid ${color};
                            padding: 2px 8px;
                            border-radius: 3px;
                            font-size: 0.9em;
                        ">${c.name}${c.duration ? ` (${c.duration})` : ''}</span>`;
                    }).join('');
                conditionsElement.style.display = 'flex';
            } else {
                conditionsElement.style.display = 'none';
            }
        }
        
        // ===== COMBAT SYSTEM FUNCTIONS =====
        
        // Combat state - declared globally to persist during combat
        let combatState = {
            playerHealth: 100,
            enemyHealth: 100,
            currentRound: 1,
            actionsRemaining: 2,
            playerState: {
                stance: 'balanced',
                counterReady: false,
                nextActionBonus: 0,
                fatigue: 0
            },
            enemyState: {
                stance: 'balanced',
                defenseReduced: 0
            },
            playerStats: {
                strength: 5,
                agility: 5,
                initiative: 5,
                weaponQuality: 0,
                shield: false
            },
            enemyStats: {
                initiative: 5,
                strength: 5,
                agility: 5,
                archetype: 'balanced',
                health: 100
            },
            conditions: {
                defending: false,
                enemyStunned: 0,
                playerStunned: 0,
                terrain: 'open',
                enemyDefense: 5,
                positioning: 'neutral'
            },
            initiative: {
                playerWon: true,
                margin: 0,
                bonusActions: 0,
                playerActions: 2
            },
            combatHistory: [],
            turnOrder: 'player'
        };
        
        let combatAnimationId = null;
        
        // Reset combat state to initial values
        function resetCombatState() {
            combatState.playerHealth = 100;
            combatState.enemyHealth = 100;
            combatState.currentRound = 1;
            combatState.actionsRemaining = 2;
            combatState.playerState.stance = 'balanced';
            combatState.playerState.counterReady = false;
            combatState.playerState.nextActionBonus = 0;
            combatState.playerState.fatigue = 0;
            combatState.enemyState.stance = 'balanced';
            combatState.enemyState.defenseReduced = 0;
            combatState.conditions.defending = false;
            combatState.conditions.enemyStunned = 0;
            combatState.conditions.playerStunned = 0;
            combatState.conditions.terrain = 'open';
            combatState.conditions.enemyDefense = 5;
            combatState.conditions.positioning = 'neutral';
            combatState.combatHistory = [];
            combatState.turnOrder = 'player';
            combatState.initiative.playerWon = true;
            combatState.initiative.margin = 0;
            combatState.initiative.bonusActions = 0;
            combatState.initiative.playerActions = 2;
        }
        
        function updateHealthBars() {
            const playerBar = document.getElementById('player-health-bar');
            const enemyBar = document.getElementById('enemy-health-bar');
            
            if (!playerBar || !enemyBar) return;
            
            playerBar.style.width = combatState.playerHealth + '%';
            playerBar.textContent = Math.max(0, Math.floor(combatState.playerHealth));
            playerBar.className = 'health-fill' + 
                (combatState.playerHealth < 30 ? ' low' : 
                 combatState.playerHealth < 60 ? ' medium' : '');
            
            enemyBar.style.width = combatState.enemyHealth + '%';
            enemyBar.textContent = Math.max(0, Math.floor(combatState.enemyHealth));
            enemyBar.className = 'health-fill' + 
                (combatState.enemyHealth < 30 ? ' low' : 
                 combatState.enemyHealth < 60 ? ' medium' : '');
        }
        
        function addLogEntry(message, type = 'info') {
            // Try to find combat log in overlay, fallback to console
            const log = document.getElementById('combat-log');
            if (log) {
                const entry = document.createElement('div');
                entry.className = 'log-entry ' + type;
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            } else {
                // Fallback to console if log element doesn't exist
                console.log(`[Combat ${type}]: ${message}`);
            }
        }
        
        function calculateZoneSize(actionType, baseStat, modifiers) {
            let zoneSize = 60 + (baseStat * 12);
            
            if (combatState.playerState.stance === 'aggressive') {
                zoneSize += 10;
            } else if (combatState.playerState.stance === 'guarded') {
                zoneSize -= 5;
            }
            
            const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
            zoneSize -= fatiguePenalty * 3;
            
            if (modifiers.weaponQuality) {
                zoneSize += modifiers.weaponQuality * 8;
            }
            if (modifiers.terrain === 'mud') {
                zoneSize -= 20;
            } else if (modifiers.terrain === 'high_ground') {
                zoneSize += 15;
            }
            if (modifiers.positioning === 'advantage') {
                zoneSize += 15;
            } else if (modifiers.positioning === 'disadvantage') {
                zoneSize -= 20;
            }
            
            zoneSize -= (modifiers.enemyDefense - combatState.enemyState.defenseReduced) * 3;
            
            if (actionType === 'measured') {
                zoneSize += 20;
            } else if (actionType === 'press') {
                zoneSize += 5;
            } else if (actionType === 'flurry') {
                zoneSize -= 15;
            }
            
            if (combatState.playerState.counterReady) {
                zoneSize += 15;
            }
            
            return Math.max(25, Math.min(150, zoneSize));
        }
        
        function calculateFatigueGain(actionType, stance) {
            let fatigue = 0;
            
            if (actionType === 'measured') {
                fatigue = 5;
            } else if (actionType === 'press') {
                fatigue = 12;
            } else if (actionType === 'flurry') {
                fatigue = 25;
            } else if (actionType === 'defend') {
                fatigue = 3;
            } else if (actionType === 'shield_bash') {
                fatigue = 15;
            } else if (actionType === 'dirty_trick') {
                fatigue = 8;
            }
            
            if (stance === 'aggressive') {
                fatigue = Math.floor(fatigue * 1.3);
            } else if (stance === 'guarded') {
                fatigue = Math.floor(fatigue * 0.7);
            }
            
            if (combatState.conditions.terrain === 'mud') {
                fatigue += 5;
            }
            
            return fatigue;
        }
        
        function showInitiativeCheck(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ playerWon: true, margin: 0, bonusActions: 0 });
                return;
            }
            
            title.textContent = '‚ö° Initiative Check';
            subtitle.textContent = 'Who acts first?';
            instructions.textContent = 'Press SPACE when the bar is in the green zone!';
            
            const barWidth = 600;
            const playerInitiative = combatState.playerStats.initiative;
            const enemyInitiative = combatState.enemyStats.initiative;
            
            const initiativeDiff = playerInitiative - enemyInitiative;
            const baseZoneSize = 80;
            const zoneSize = baseZoneSize + (initiativeDiff * 12);
            const greenZoneStart = (barWidth - zoneSize) / 2;
            const difficulty = 7 - Math.floor(initiativeDiff / 2);
            const speed = 2.0;
            
            display.innerHTML = `
                <div class="qte-bar-container">
                    <div class="qte-green-zone" id="green-zone" style="left: ${greenZoneStart}px; width: ${zoneSize}px;"></div>
                    <div class="qte-indicator" id="qte-indicator" style="left: 0;"></div>
                </div>
                <div style="color: #d4af37; margin-top: 20px; font-size: 18px;">
                    <small style="color: #888;">
                        Your Initiative: ${playerInitiative} | Enemy Initiative: ${enemyInitiative}
                        ${initiativeDiff > 0 ? '<br><span style="color: #0f0;">You have the advantage!</span>' : 
                          initiativeDiff < 0 ? '<br><span style="color: #f00;">Enemy is faster!</span>' : 
                          '<br>Equal speed!'}
                    </small>
                </div>
            `;
            
            const indicator = document.getElementById('qte-indicator');
            const greenZone = document.getElementById('green-zone');
            if (!indicator || !greenZone) {
                callback({ playerWon: true, margin: 0, bonusActions: 0 });
                return;
            }
            
            let position = 0;
            let direction = 1;
            let pressed = false;
            let animationId;
            
            const moveIndicator = () => {
                position += speed * direction;
                if (position >= barWidth - 8) {
                    direction = -1;
                    position = barWidth - 8;
                } else if (position <= 0) {
                    direction = 1;
                    position = 0;
                }
                indicator.style.left = position + 'px';
                
                if (!pressed) {
                    animationId = requestAnimationFrame(moveIndicator);
                    combatAnimationId = animationId;
                }
            };
            
            const handlePress = (e) => {
                if (e.code === 'Space' && !pressed) {
                    e.preventDefault();
                    pressed = true;
                    if (animationId) cancelAnimationFrame(animationId);
                    
                    const zoneStart = greenZoneStart;
                    const zoneEnd = zoneStart + zoneSize;
                    const inZone = position >= zoneStart && position <= zoneEnd;
                    const distance = inZone ? 0 : Math.min(
                        Math.abs(position - zoneStart),
                        Math.abs(position - zoneEnd)
                    );
                    
                    let roll = 10;
                    if (!inZone) {
                        roll = Math.max(1, 10 - Math.floor(distance / 20));
                    } else {
                        const center = zoneStart + zoneSize / 2;
                        const distanceFromCenter = Math.abs(position - center);
                        const centerBonus = distanceFromCenter < zoneSize / 4 ? 1 : 0;
                        roll = Math.min(10, 9 + centerBonus);
                    }
                    
                    const finalRoll = roll + playerInitiative;
                    const enemyRollDie = Math.floor(Math.random() * 10) + 1;
                    const enemyRoll = enemyRollDie + enemyInitiative;
                    const playerWon = finalRoll > enemyRoll;
                    const margin = Math.abs(finalRoll - enemyRoll);
                    
                    let bonusActions = 0;
                    if (playerWon && margin >= 5) {
                        bonusActions = 1;
                    }
                    
                    display.innerHTML = `
                        <div style="color: ${playerWon ? '#0f0' : '#f00'}; font-size: 32px; margin: 30px 0;">
                            ${playerWon ? '‚úì You Act First!' : '‚úó Enemy Acts First!'}
                        </div>
                        <div style="color: #d4af37; font-size: 18px;">
                            Your Roll: ${roll} + ${playerInitiative} = ${finalRoll}
                            <br>Enemy Roll: ${enemyRollDie} + ${enemyInitiative} = ${enemyRoll}
                            ${bonusActions > 0 ? `<br><span style="color: #0f0;">Bonus action gained from superior speed!</span>` : ''}
                        </div>
                    `;
                    
                    window.removeEventListener('keydown', handlePress);
                    setTimeout(() => {
                        callback({ 
                            playerWon, 
                            margin,
                            playerRoll: finalRoll,
                            enemyRoll: enemyRoll,
                            bonusActions 
                        });
                    }, 2000);
                }
            };
            
            window.addEventListener('keydown', handlePress);
            moveIndicator();
        }
        
        function showCombatQTE(actionType, attackStyle, stat, modifiers, callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ success: false, roll: 0, margin: 0, inZone: false, actionType, quality: 'miss' });
                return;
            }
            
            const actionNames = {
                'attack': '‚öîÔ∏è Attack',
                'defend': 'üõ°Ô∏è Defend',
                'shield_bash': 'üõ°Ô∏è Shield Bash',
                'dirty_trick': 'üéØ Dirty Trick',
                'flee': 'üèÉ Flee',
                'parry': 'üõ°Ô∏è Parry',
                'dodge': 'üí® Dodge',
                'interrupt': '‚öîÔ∏è Interrupt'
            };
            
            const styleNames = {
                'measured': 'Measured Strike',
                'press': 'Press Attack',
                'flurry': 'Flurry'
            };
            
            title.textContent = actionNames[actionType] || '‚öîÔ∏è Action';
            if (actionType === 'attack') {
                subtitle.textContent = styleNames[attackStyle] || 'Attack';
            } else {
                subtitle.textContent = actionNames[actionType];
            }
            
            instructions.textContent = 'Press SPACE when the bar is in the green zone!';
            
            const barWidth = 600;
            
            let baseZoneSize;
            if (actionType === 'attack') {
                baseZoneSize = calculateZoneSize(attackStyle, stat, modifiers);
            } else if (actionType === 'defend' || actionType === 'parry') {
                baseZoneSize = 80 + (combatState.playerStats.agility * 10);
                if (combatState.playerState.stance === 'guarded') {
                    baseZoneSize += 20;
                } else if (combatState.playerState.stance === 'aggressive') {
                    baseZoneSize -= 15;
                }
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
                baseZoneSize -= fatiguePenalty * 2;
            } else if (actionType === 'dodge') {
                baseZoneSize = 70 + (combatState.playerStats.agility * 12);
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 8);
                baseZoneSize -= fatiguePenalty * 3;
            } else if (actionType === 'interrupt') {
                baseZoneSize = 60 + (combatState.playerStats.strength * 10);
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
                baseZoneSize -= fatiguePenalty * 2;
            } else if (actionType === 'shield_bash') {
                baseZoneSize = 70 + (combatState.playerStats.strength * 8);
            } else if (actionType === 'dirty_trick') {
                baseZoneSize = 60 + (combatState.playerStats.agility * 12);
            } else { // flee
                baseZoneSize = 90 + (combatState.playerStats.agility * 15);
                baseZoneSize -= Math.floor(combatState.playerState.fatigue / 5);
            }
            
            const greenZoneStart = (barWidth - baseZoneSize) / 2;
            const difficulty = actionType === 'flee' ? 5 : (7 - Math.floor((baseZoneSize - 60) / 20));
            const speed = 2.0 + (combatState.playerState.fatigue > 50 ? 0.3 : 0);
            
            const useMovingZone = (actionType === 'attack' && attackStyle === 'flurry') || 
                                  actionType === 'dirty_trick';
            const zoneSpeed = 0.5;
            
            display.innerHTML = `
                <div class="qte-bar-container">
                    <div class="qte-green-zone" id="green-zone" style="left: ${greenZoneStart}px; width: ${baseZoneSize}px;"></div>
                    <div class="qte-indicator" id="qte-indicator" style="left: 0;"></div>
                </div>
                <div style="color: #d4af37; margin-top: 20px; font-size: 18px;">
                    ${useMovingZone ? '<span style="color: #f00;">‚ö†Ô∏è The green zone is moving!</span><br>' : ''}
                    <small style="color: #888;">
                        ${actionType === 'attack' ? `Zone size: ${Math.floor(baseZoneSize)}px` : ''} |
                        ${modifiers.terrain === 'mud' ? 'Mud slows you down' : 
                          modifiers.terrain === 'high_ground' ? 'High ground advantage' : 
                          'Normal terrain'} |
                        ${modifiers.positioning === 'advantage' ? 'You have the advantage' : 
                          modifiers.positioning === 'disadvantage' ? 'You are at a disadvantage' : 
                          'Neutral positioning'}
                        ${combatState.conditions.enemyStunned > 0 ? ' | Enemy is stunned!' : ''}
                    </small>
                </div>
            `;
            
            const indicator = document.getElementById('qte-indicator');
            const greenZone = document.getElementById('green-zone');
            if (!indicator || !greenZone) {
                callback({ success: false, roll: 0, margin: 0, inZone: false, actionType, quality: 'miss' });
                return;
            }
            
            let position = 0;
            let direction = 1;
            let pressed = false;
            let animationId;
            let greenZonePosition = greenZoneStart;
            let greenZoneDirection = useMovingZone ? (Math.random() > 0.5 ? 1 : -1) : 0;
            
            const moveIndicator = () => {
                position += speed * direction;
                if (position >= barWidth - 8) {
                    direction = -1;
                    position = barWidth - 8;
                } else if (position <= 0) {
                    direction = 1;
                    position = 0;
                }
                indicator.style.left = position + 'px';
                
                if (useMovingZone) {
                    greenZonePosition += zoneSpeed * greenZoneDirection;
                    if (greenZonePosition + baseZoneSize >= barWidth) {
                        greenZoneDirection = -1;
                        greenZonePosition = barWidth - baseZoneSize;
                    } else if (greenZonePosition <= 0) {
                        greenZoneDirection = 1;
                        greenZonePosition = 0;
                    }
                    greenZone.style.left = greenZonePosition + 'px';
                }
                
                if (!pressed) {
                    animationId = requestAnimationFrame(moveIndicator);
                    combatAnimationId = animationId;
                }
            };
            
            const handlePress = (e) => {
                if (e.code === 'Space' && !pressed) {
                    e.preventDefault();
                    pressed = true;
                    if (animationId) cancelAnimationFrame(animationId);
                    
                    const zoneStart = useMovingZone ? greenZonePosition : greenZoneStart;
                    const zoneEnd = zoneStart + baseZoneSize;
                    const inZone = position >= zoneStart && position <= zoneEnd;
                    const distance = inZone ? 0 : Math.min(
                        Math.abs(position - zoneStart),
                        Math.abs(position - zoneEnd)
                    );
                    
                    let roll = 10;
                    let quality = 'miss';
                    
                    if (!inZone) {
                        roll = Math.max(1, 10 - Math.floor(distance / 20));
                        quality = 'miss';
                    } else {
                        const center = zoneStart + baseZoneSize / 2;
                        const distanceFromCenter = Math.abs(position - center);
                        if (distanceFromCenter < baseZoneSize / 6) {
                            roll = 10;
                            quality = 'perfect';
                        } else if (distanceFromCenter < baseZoneSize / 3) {
                            roll = 9;
                            quality = 'good';
                        } else {
                            roll = 7;
                            quality = 'glancing';
                        }
                    }
                    
                    const finalRoll = roll + stat + combatState.playerState.nextActionBonus;
                    const success = finalRoll >= difficulty;
                    const margin = finalRoll - difficulty;
                    
                    const resultText = {
                        'attack': quality === 'perfect' ? '‚úì PERFECT HIT!' : 
                                 quality === 'good' ? '‚úì SOLID HIT!' :
                                 quality === 'glancing' ? '‚úì GLANCING BLOW!' : '‚úó MISS!',
                        'defend': quality === 'perfect' ? '‚úì PERFECT BLOCK!' :
                                 quality === 'good' ? '‚úì BLOCKED!' : '‚úó FAILED!',
                        'parry': quality === 'perfect' ? '‚úì PERFECT PARRY!' :
                                quality === 'good' ? '‚úì PARRY!' : '‚úó FAILED!',
                        'dodge': quality === 'perfect' ? '‚úì PERFECT DODGE!' :
                                quality === 'good' ? '‚úì DODGED!' : '‚úó HIT!',
                        'interrupt': success ? '‚úì INTERRUPTED!' : '‚úó FAILED!',
                        'shield_bash': success ? '‚úì BASHED!' : '‚úó MISSED!',
                        'dirty_trick': success ? '‚úì TRICKED!' : '‚úó FAILED!',
                        'flee': success ? '‚úì ESCAPED!' : '‚úó TRAPPED!'
                    };
                    
                    display.innerHTML = `
                        <div style="color: ${success ? '#0f0' : '#f00'}; font-size: 32px; margin: 30px 0;">
                            ${resultText[actionType] || (success ? '‚úì SUCCESS!' : '‚úó FAILURE!')}
                        </div>
                        <div style="color: #d4af37; font-size: 18px;">
                            Roll: 1d10 (${roll}) + ${stat}${combatState.playerState.nextActionBonus > 0 ? ` + ${combatState.playerState.nextActionBonus} (counter)` : ''} = ${finalRoll} vs ${difficulty}
                            <br>Quality: ${quality.toUpperCase()}
                        </div>
                    `;
                    
                    window.removeEventListener('keydown', handlePress);
                    setTimeout(() => {
                        callback({ success, roll: finalRoll, margin, inZone, actionType, quality });
                    }, 1500);
                }
            };
            
            window.addEventListener('keydown', handlePress);
            moveIndicator();
        }
        
        function showActionSelection(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ action: 'attack', attackStyle: 'measured', stance: 'balanced', actionsUsed: 1 });
                return;
            }
            
            title.textContent = `‚öîÔ∏è Round ${combatState.currentRound} - Choose Your Actions`;
            subtitle.textContent = `${combatState.actionsRemaining} action${combatState.actionsRemaining !== 1 ? 's' : ''} remaining`;
            
            let selectedAction = null;
            let attackStyle = 'measured';
            let selectedStance = combatState.playerState.stance || 'balanced';
            let actionsUsed = 0;
            
            const updateDisplay = () => {
                const actionsText = combatState.actionsRemaining - actionsUsed > 0 
                    ? `${combatState.actionsRemaining - actionsUsed} action${combatState.actionsRemaining - actionsUsed !== 1 ? 's' : ''} remaining`
                    : 'No actions remaining';
                
                instructions.innerHTML = `
                    <div class="actions-remaining">${actionsText}</div>
                    <div style="margin: 15px 0; padding: 10px; background: rgba(212,175,55,0.1); border-radius: 5px;">
                        <div style="color: #d4af37; margin-bottom: 10px;">Stance: 
                            <button onclick="window.selectStance('aggressive')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'aggressive' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'aggressive' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Aggressive (+damage, +fatigue)
                            </button>
                            <button onclick="window.selectStance('balanced')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'balanced' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'balanced' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Balanced
                            </button>
                            <button onclick="window.selectStance('guarded')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'guarded' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'guarded' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Guarded (-damage, -fatigue, +defense)
                            </button>
                        </div>
                        <div style="color: #888; font-size: 12px;">
                            Fatigue: ${combatState.playerState.fatigue}/100
                            ${combatState.playerState.fatigue > 70 ? ' <span style="color: #f00;">(High fatigue - smaller zones!)</span>' : ''}
                            ${combatState.playerState.counterReady ? ' <span style="color: #0f0;">Counter ready!</span>' : ''}
                        </div>
                    </div>
                    ${selectedAction === 'attack' ? `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="color: #d4af37; margin-bottom: 10px;">Attack Style:</div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="window.selectAttackStyle('measured')" style="padding: 15px 20px; background: ${attackStyle === 'measured' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${attackStyle === 'measured' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Measured<br><small>Big zone, moderate damage</small>
                                </button>
                                <button onclick="window.selectAttackStyle('press')" style="padding: 15px 20px; background: ${attackStyle === 'press' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${attackStyle === 'press' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Press<br><small>Smaller zone, higher damage</small>
                                </button>
                                <button onclick="window.selectAttackStyle('flurry')" style="padding: 15px 20px; background: ${attackStyle === 'flurry' ? '#f00' : '#2a2a2a'}; border: 2px solid ${attackStyle === 'flurry' ? '#f00' : '#d4af37'}; color: ${attackStyle === 'flurry' ? 'white' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Flurry<br><small>Smallest zone, multi-hit, high fatigue</small>
                                </button>
                            </div>
                            <div style="color: #888; margin-top: 10px; font-size: 14px;">
                                ${attackStyle === 'flurry' ? '<span style="color: #f00;">Uses both actions!</span>' : 'Uses 1 action'}
                            </div>
                        </div>
                    ` : ''}
                `;
            };
            
            display.innerHTML = `
                <div class="action-selection">
                    <button class="action-button" onclick="window.selectAction('attack')">
                        ‚öîÔ∏è Attack
                        <div class="action-details">Strike your enemy</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('defend')">
                        üõ°Ô∏è Defend
                        <div class="action-details">Block incoming attacks</div>
                    </button>
                    <button class="action-button ${!combatState.playerStats.shield ? 'disabled' : ''}" 
                            onclick="window.selectAction('shield_bash')" ${!combatState.playerStats.shield ? 'disabled' : ''}>
                        üõ°Ô∏è Shield Bash
                        <div class="action-details">Stun enemy (requires shield)</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('dirty_trick')">
                        üéØ Dirty Trick
                        <div class="action-details">Disorient your enemy</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('flee')">
                        üèÉ Flee
                        <div class="action-details">Attempt to escape</div>
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="start-button" onclick="window.confirmAction()" style="max-width: 300px; padding: 15px;">
                        Confirm Action
                    </button>
                </div>
            `;
            
            window.selectAction = (action) => {
                selectedAction = action;
                attackStyle = 'measured';
                actionsUsed = 0;
                
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Find the button that was clicked by checking onclick attribute
                const buttons = document.querySelectorAll('.action-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${action}'`)) {
                        btn.classList.add('selected');
                    }
                });
                
                if (action === 'attack') {
                    actionsUsed = 1;
                } else {
                    actionsUsed = 1;
                }
                
                updateDisplay();
            };
            
            window.selectAttackStyle = (style) => {
                attackStyle = style;
                actionsUsed = style === 'flurry' ? 2 : 1;
                
                document.querySelectorAll('[onclick*="selectAttackStyle"]').forEach(btn => {
                    btn.style.background = '#2a2a2a';
                    btn.style.color = '#d4af37';
                    btn.style.borderColor = '#d4af37';
                });
                // Find and highlight the clicked button
                document.querySelectorAll('[onclick*="selectAttackStyle"]').forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${style}'`)) {
                        btn.style.background = style === 'flurry' ? '#f00' : '#d4af37';
                        btn.style.color = 'white';
                        btn.style.borderColor = style === 'flurry' ? '#f00' : '#d4af37';
                    }
                });
                
                updateDisplay();
            };
            
            window.selectStance = (stance) => {
                selectedStance = stance;
                updateDisplay();
            };
            
            window.confirmAction = () => {
                if (!selectedAction) {
                    alert('Please select an action!');
                    return;
                }
                
                if (selectedAction === 'attack' && (combatState.actionsRemaining - actionsUsed) < 0) {
                    alert('Not enough actions remaining!');
                    return;
                }
                
                if (selectedAction !== 'attack' && combatState.actionsRemaining < 1) {
                    alert('No actions remaining!');
                    return;
                }
                
                delete window.selectAction;
                delete window.selectAttackStyle;
                delete window.selectStance;
                delete window.confirmAction;
                
                callback({
                    action: selectedAction,
                    attackStyle: selectedAction === 'attack' ? attackStyle : null,
                    stance: selectedStance,
                    actionsUsed: selectedAction === 'attack' ? actionsUsed : 1
                });
            };
            
            updateDisplay();
        }
        
        function determineEnemyIntent() {
            const archetype = combatState.enemyStats.archetype;
            let intent;
            
            if (archetype === 'aggressive') {
                intent = Math.random() > 0.4 ? 'heavy' : 'quick';
            } else if (archetype === 'cautious') {
                if (combatState.playerState.fatigue > 60) {
                    intent = 'heavy';
                } else {
                    intent = Math.random() > 0.6 ? 'defend' : 'quick';
                }
            } else { // skilled
                const rand = Math.random();
                intent = rand > 0.6 ? 'heavy' : rand > 0.3 ? 'quick' : 'defend';
            }
            
            combatState.enemyState.nextIntent = intent;
            combatState.enemyState.intentTelegraphed = true;
            
            const intentText = {
                'heavy': 'winds up a heavy cut',
                'quick': 'probes with quick jabs',
                'defend': 'raises guard defensively'
            };
            
            return intentText[intent];
        }
        
        async function enemyAttack() {
            const intentText = determineEnemyIntent();
            addLogEntry(`Enemy ${intentText}!`, 'info');
            
            const response = await new Promise((resolve) => {
                showEnemyResponseSelection(resolve);
            });
            
            const defenseResult = await new Promise((resolve) => {
                showCombatQTE(
                    response.action,
                    null,
                    combatState.playerStats.agility,
                    combatState.conditions,
                    resolve
                );
            });
            
            const intent = combatState.enemyState.nextIntent;
            const baseDamage = intent === 'heavy' ? 25 : 12;
            
            if (response.action === 'parry') {
                if (defenseResult.quality === 'perfect') {
                    combatState.playerState.counterReady = true;
                    combatState.playerState.nextActionBonus = 3;
                    addLogEntry('Perfect parry! Counter ready!', 'success');
                } else if (defenseResult.success) {
                    const damage = Math.floor(baseDamage * 0.3);
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                    addLogEntry(`Parried! (${damage} damage)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Parry failed! (${baseDamage} damage)`, 'failure');
                }
            } else if (response.action === 'dodge') {
                if (defenseResult.quality === 'perfect') {
                    addLogEntry('Perfect dodge! No damage!', 'success');
                } else if (defenseResult.success) {
                    const damage = Math.floor(baseDamage * 0.5);
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                    addLogEntry(`Dodged! (${damage} damage)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Dodge failed! (${baseDamage} damage)`, 'failure');
                }
            } else if (response.action === 'interrupt') {
                if (defenseResult.success) {
                    const damage = 15;
                    combatState.enemyHealth = Math.max(0, combatState.enemyHealth - damage);
                    addLogEntry(`Interrupted enemy! (${damage} damage to enemy)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Interrupt failed! (${baseDamage} damage)`, 'failure');
                }
            }
            
            if (defenseResult.success === false || defenseResult.quality === 'glancing') {
                combatState.playerState.fatigue += 5;
            }
            
            updateHealthBars();
        }
        
        function showEnemyResponseSelection(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                callback({ action: 'parry' });
                return;
            }
            
            const intent = combatState.enemyState.nextIntent;
            const intentText = {
                'heavy': 'Heavy Cut',
                'quick': 'Quick Jabs',
                'defend': 'Defensive Stance'
            };
            
            title.textContent = `‚öîÔ∏è Enemy ${intentText[intent]}!`;
            subtitle.textContent = 'Choose your response';
            instructions.textContent = 'How do you respond?';
            
            display.innerHTML = `
                <div class="action-selection">
                    <button class="action-button" onclick="window.selectResponse('parry')">
                        üõ°Ô∏è Parry
                        <div class="action-details">Block and counter (perfect = counter ready)</div>
                    </button>
                    <button class="action-button" onclick="window.selectResponse('dodge')">
                        üí® Dodge
                        <div class="action-details">Avoid the attack (perfect = no damage)</div>
                    </button>
                    <button class="action-button" onclick="window.selectResponse('interrupt')">
                        ‚öîÔ∏è Interrupt
                        <div class="action-details">Strike first (risky but rewarding)</div>
                    </button>
                </div>
            `;
            
            let selectedResponse = null;
            
            window.selectResponse = (action) => {
                selectedResponse = action;
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Find the button that was clicked
                const buttons = document.querySelectorAll('.action-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${action}'`)) {
                        btn.classList.add('selected');
                    }
                });
                
                setTimeout(() => {
                    delete window.selectResponse;
                    callback({ action: selectedResponse });
                }, 300);
            };
        }
        
        async function startCombat() {
            // Reset combat state using centralized function
            resetCombatState();
            // Set enemy-specific values
            combatState.enemyHealth = combatState.enemyStats.health || 100;
            
            // Clear log (if exists)
            const log = document.getElementById('combat-log');
            if (log) {
                log.innerHTML = '<h3>Combat Log</h3>';
            }
            addLogEntry('Combat begins!', 'info');
            
            // Show overlay
            const overlay = document.getElementById('minigame-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
            updateHealthBars();
            
            // Initiative check
            addLogEntry('--- Initiative Check ---', 'info');
            const initiativeResult = await new Promise((resolve) => {
                showInitiativeCheck(resolve);
            });
            
            combatState.initiative.playerWon = initiativeResult.playerWon;
            combatState.initiative.margin = initiativeResult.margin;
            combatState.initiative.playerActions = 2 + initiativeResult.bonusActions;
            combatState.turnOrder = initiativeResult.playerWon ? 'player' : 'enemy';
            
            if (initiativeResult.playerWon) {
                addLogEntry(`You win initiative! (${initiativeResult.bonusActions > 0 ? '+1 bonus action' : ''})`, 'success');
            } else {
                addLogEntry('Enemy wins initiative!', 'failure');
            }
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Combat loop
            while (combatState.playerHealth > 0 && combatState.enemyHealth > 0) {
                // Reset actions for new round
                combatState.actionsRemaining = combatState.initiative.playerActions;
                combatState.conditions.defending = false;
                
                // Reduce fatigue slightly each round (recovery)
                combatState.playerState.fatigue = Math.max(0, combatState.playerState.fatigue - 3);
                
                // Reduce stun counters
                if (combatState.conditions.enemyStunned > 0) {
                    combatState.conditions.enemyStunned--;
                }
                if (combatState.conditions.playerStunned > 0) {
                    combatState.conditions.playerStunned--;
                }
                
                addLogEntry(`--- Round ${combatState.currentRound} ---`, 'info');
                
                // Turn order based on initiative
                if (combatState.turnOrder === 'enemy' && combatState.conditions.playerStunned === 0) {
                    await enemyAttack();
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                }
                
                // Player actions
                while (combatState.actionsRemaining > 0 && combatState.playerHealth > 0 && combatState.enemyHealth > 0) {
                    const actionChoice = await new Promise((resolve) => {
                        showActionSelection(resolve);
                    });
                    
                    combatState.actionsRemaining -= actionChoice.actionsUsed;
                    combatState.playerState.stance = actionChoice.stance;
                    
                    if (actionChoice.action === 'attack') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'attack',
                                actionChoice.attackStyle,
                                combatState.playerStats.strength + combatState.playerStats.weaponQuality,
                                {
                                    weaponQuality: combatState.playerStats.weaponQuality,
                                    terrain: combatState.conditions.terrain,
                                    enemyDefense: combatState.conditions.enemyDefense - combatState.enemyState.defenseReduced - (combatState.conditions.enemyStunned > 0 ? 2 : 0),
                                    positioning: combatState.conditions.positioning
                                },
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain(actionChoice.attackStyle, actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        let damage = 0;
                        let hits = 1;
                        
                        if (result.success) {
                            if (actionChoice.attackStyle === 'measured') {
                                damage = result.quality === 'perfect' ? 20 : result.quality === 'good' ? 15 : 10;
                            } else if (actionChoice.attackStyle === 'press') {
                                damage = result.quality === 'perfect' ? 30 : result.quality === 'good' ? 22 : 12;
                            } else if (actionChoice.attackStyle === 'flurry') {
                                hits = result.quality === 'perfect' ? 3 : result.quality === 'good' ? 2 : 1;
                                damage = hits * 12;
                            }
                            
                            if (result.quality === 'perfect' && actionChoice.attackStyle !== 'flurry') {
                                combatState.conditions.enemyStunned = 1;
                                addLogEntry('Perfect hit! Enemy stunned!', 'success');
                            }
                            
                            combatState.enemyHealth = Math.max(0, combatState.enemyHealth - damage);
                            addLogEntry(`${result.quality === 'perfect' ? 'Perfect' : result.quality === 'good' ? 'Solid' : 'Glancing'} hit! (${damage} damage${hits > 1 ? `, ${hits} hits` : ''})`, 'success');
                        } else {
                            addLogEntry('Attack missed!', 'failure');
                        }
                        
                        combatState.playerState.counterReady = false;
                        combatState.playerState.nextActionBonus = 0;
                        updateHealthBars();
                    } else if (actionChoice.action === 'defend') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'defend',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('defend', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.quality === 'perfect') {
                            combatState.playerState.counterReady = true;
                            combatState.playerState.nextActionBonus = 3;
                            addLogEntry('Perfect defense! Counter ready!', 'success');
                        } else if (result.success) {
                            combatState.conditions.defending = true;
                            addLogEntry('Defensive stance ready!', 'success');
                        } else {
                            addLogEntry('Defense failed!', 'failure');
                        }
                        updateHealthBars();
                    } else if (actionChoice.action === 'shield_bash') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'shield_bash',
                                null,
                                combatState.playerStats.strength,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('shield_bash', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.success) {
                            combatState.conditions.enemyStunned = 2;
                            addLogEntry('Shield bash! Enemy stunned!', 'success');
                        } else {
                            combatState.conditions.positioning = 'disadvantage';
                            addLogEntry('Shield bash missed! You are off-balance!', 'failure');
                        }
                        updateHealthBars();
                    } else if (actionChoice.action === 'dirty_trick') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'dirty_trick',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('dirty_trick', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.success) {
                            combatState.enemyState.defenseReduced = 2;
                            combatState.conditions.positioning = 'advantage';
                            addLogEntry('Dirty trick! Enemy defense reduced, advantage gained!', 'success');
                        } else {
                            addLogEntry('Dirty trick failed!', 'failure');
                        }
                    } else if (actionChoice.action === 'flee') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'flee',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        if (result.success) {
                            addLogEntry('You successfully flee!', 'success');
                            setTimeout(() => {
                                if (overlay) overlay.style.display = 'none';
                            }, 2000);
                            return { victory: false, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue, fled: true };
                        } else {
                            combatState.conditions.positioning = 'disadvantage';
                            const damage = 15 + Math.abs(result.margin) * 2;
                            combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                            addLogEntry(`Escape failed! Enemy strikes! (${damage} damage, positioning lost)`, 'failure');
                            updateHealthBars();
                        }
                    }
                    
                    // Check for victory/defeat
                    if (combatState.enemyHealth <= 0) {
                        addLogEntry('Victory! You have defeated your enemy!', 'success');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: true, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
                    }
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                }
                
                // Enemy turn (if player acted first)
                if (combatState.turnOrder === 'player' && combatState.enemyHealth > 0 && combatState.conditions.enemyStunned === 0) {
                    await enemyAttack();
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                } else if (combatState.conditions.enemyStunned > 0) {
                    addLogEntry('Enemy is stunned and cannot attack!', 'info');
                } else if (combatState.conditions.playerStunned > 0) {
                    addLogEntry('You are stunned and cannot act!', 'failure');
                }
                
                // Check for victory/defeat after enemy turn
                if (combatState.enemyHealth <= 0) {
                    addLogEntry('Victory! You have defeated your enemy!', 'success');
                    setTimeout(() => {
                        if (overlay) overlay.style.display = 'none';
                    }, 2000);
                    return { victory: true, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
                }
                
                combatState.currentRound++;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Fallback return (shouldn't reach here)
            return { victory: combatState.enemyHealth <= 0, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
        }
        
        // Show combat resolution screen
        function showCombatResolution(result) {
            const overlay = document.getElementById('minigame-overlay');
            if (!overlay) {
                // Fallback: show in main story area if overlay doesn't exist
                const storyElement = document.getElementById('story');
                if (storyElement) {
                    const resolutionHTML = `
                        <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.8); border: 2px solid #d4af37; border-radius: 12px; margin: 20px 0;">
                            <h2 style="color: ${result.victory ? '#4CAF50' : '#f44336'}; font-size: 28px; margin-bottom: 15px;">
                                ${result.victory ? '‚úì VICTORY' : '‚úó DEFEAT'}
                            </h2>
                            <div style="color: #d4af37; font-size: 16px; margin: 15px 0;">
                                ${result.victory 
                                    ? '<p>You have defeated your enemy!</p><p>Your skill and courage have carried the day.</p>' 
                                    : '<p>You have been struck down...</p><p>The battle did not go in your favor.</p>'}
                            </div>
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #8b6914;">
                                <p style="color: rgba(255,255,255,0.8); margin: 8px 0;">
                                    <strong>Your Condition:</strong> ${result.playerHealth > 75 ? 'Unharmed' : result.playerHealth > 50 ? 'Lightly Wounded' : result.playerHealth > 25 ? 'Wounded' : result.playerHealth > 0 ? 'Seriously Wounded' : 'Defeated'}
                                </p>
                                <p style="color: rgba(255,255,255,0.8); margin: 8px 0;">
                                    <strong>Health Remaining:</strong> ${result.playerHealth}%
                                </p>
                                ${result.victory ? '<p style="color: #4CAF50; margin-top: 10px;">+1 Experience gained</p>' : ''}
                            </div>
                        </div>
                    `;
                    storyElement.innerHTML = resolutionHTML + storyElement.innerHTML;
                }
                return;
            }
            
            const resolutionHTML = `
                <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.95); border: 2px solid #d4af37; border-radius: 12px; max-width: 600px; margin: 50px auto;">
                    <h2 style="color: ${result.victory ? '#4CAF50' : '#f44336'}; font-size: 32px; margin-bottom: 20px;">
                        ${result.victory ? '‚úì VICTORY' : '‚úó DEFEAT'}
                    </h2>
                    <div style="color: #d4af37; font-size: 18px; margin: 20px 0;">
                        ${result.victory 
                            ? '<p>You have defeated your enemy!</p><p>Your skill and courage have carried the day.</p>' 
                            : '<p>You have been struck down...</p><p>The battle did not go in your favor.</p>'}
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #8b6914;">
                        <p style="color: rgba(255,255,255,0.8); margin: 10px 0;">
                            <strong>Your Condition:</strong> ${result.playerHealth > 75 ? 'Unharmed' : result.playerHealth > 50 ? 'Lightly Wounded' : result.playerHealth > 25 ? 'Wounded' : result.playerHealth > 0 ? 'Seriously Wounded' : 'Defeated'}
                        </p>
                        <p style="color: rgba(255,255,255,0.8); margin: 10px 0;">
                            <strong>Health Remaining:</strong> ${result.playerHealth}%
                        </p>
                        ${result.victory ? '<p style="color: #4CAF50; margin-top: 15px;">+1 Experience gained</p>' : ''}
                    </div>
                </div>
            `;
            
            overlay.innerHTML = resolutionHTML;
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
        }
        
        // Combat bridge function
        async function triggerCombat(enemyProfile, winScene, loseScene) {
            try {
                // Handle enemy profile as string ID or object
                if (typeof enemyProfile === 'string' && typeof getEnemyProfile !== 'undefined') {
                    const profile = getEnemyProfile(enemyProfile);
                    if (profile) {
                        enemyProfile = {
                            name: profile.name,
                            health: profile.health,
                            initiative: profile.initiative,
                            strength: profile.strength,
                            agility: profile.agility,
                            archetype: profile.archetype
                        };
                    }
                }
                
                // Hide main story container
                const gameContainer = document.querySelector('.game-container');
                if (gameContainer) gameContainer.style.display = 'none';
                
                // Map stress to fatigue
                const stressMax = statLimits.stress?.max || 10;
                combatState.playerState.fatigue = Math.floor((gameState.stats.stress / stressMax) * 100);
                
                // Set player stats from effective stats
                combatState.playerStats.strength = getEffectiveStat('strength');
                combatState.playerStats.agility = getEffectiveStat('agility');
                combatState.playerStats.initiative = getEffectiveStat('agility');
                
                // Get weapon stats from equipment manager
                if (window.equipmentManager) {
                    const weaponStats = window.equipmentManager.getWeaponStats();
                    combatState.playerStats.weaponQuality = weaponStats.quality || 0;
                    // Check for shield - check accessory slot or weapon secondary slot
                    const accessory = gameState.equipment.accessory || {};
                    const weaponSecondary = (gameState.equipment.weapon || {}).secondary;
                    // Shield could be in accessory or as secondary weapon
                    const hasShield = (accessory.item && accessory.item.id) || 
                                     (weaponSecondary && weaponSecondary.id) ||
                                     false;
                    // Check if it's actually a shield by looking up the item
                    if (hasShield) {
                        const shieldId = accessory.item?.id || weaponSecondary?.id;
                        // Simple check: if item ID contains shield-related terms, it's a shield
                        combatState.playerStats.shield = shieldId && (
                            shieldId.includes('shield') || 
                            shieldId.includes('buckler') || 
                            shieldId.includes('pavise') ||
                            shieldId.includes('targe')
                        );
                    } else {
                        combatState.playerStats.shield = false;
                    }
                } else {
                    combatState.playerStats.weaponQuality = 0;
                    combatState.playerStats.shield = false;
                }
                
                // Map enemy profile to combat state
                combatState.enemyStats = {
                    initiative: enemyProfile.initiative || 5,
                    strength: enemyProfile.strength || 5,
                    agility: enemyProfile.agility || 5,
                    archetype: enemyProfile.archetype || 'balanced',
                    health: enemyProfile.health || 100
                };
                combatState.enemyHealth = enemyProfile.health || 100;
                
                // Reset combat state
                combatState.playerHealth = 100;
                combatState.currentRound = 1;
                combatState.actionsRemaining = 2;
                combatState.playerState.stance = 'balanced';
                combatState.playerState.counterReady = false;
                combatState.playerState.nextActionBonus = 0;
                combatState.conditions.enemyStunned = 0;
                combatState.conditions.playerStunned = 0;
                combatState.conditions.terrain = 'open';
                combatState.conditions.enemyDefense = 5;
                combatState.conditions.positioning = 'neutral';
                combatState.combatHistory = [];
                combatState.turnOrder = 'player';
                
                // Start combat and await result
                const result = await startCombat();
                
                // Clean up animations
                if (combatAnimationId) {
                    cancelAnimationFrame(combatAnimationId);
                    combatAnimationId = null;
                }
                
                // Restore story container
                if (gameContainer) gameContainer.style.display = 'block';
                
                // Update game state based on combat result
                const stressMax2 = statLimits.stress?.max || 10;
                gameState.stats.stress = Math.min(stressMax2, Math.floor((result.fatigue / 100) * stressMax2));
                gameState.stats.stress = clampStat('stress', gameState.stats.stress);
                
                // Apply wounds
                if (result.playerHealth < 50) {
                    addCondition('Wounded', 'negative', 2);
                }
                if (result.playerHealth <= 0) {
                    addCondition('Seriously Wounded', 'negative', 3);
                }
                
                // Track combat
                gameState.career.battles++;
                if (result.victory) {
                    applyStatChange('experience', 1);
                }
                
                // Show combat resolution before transitioning
                if (!result.fled) {
                    showCombatResolution(result);
                    // Wait a moment for player to read resolution, then transition
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
                
                // Transition to appropriate scene
                if (result.fled) {
                    // Flee doesn't transition to win/lose scenes
                    resetCombatState(); // Clean up combat state
                    return;
                }
                
                // Reset combat state before transitioning
                resetCombatState();
                
                gameState.currentScene = result.victory ? winScene : loseScene;
                updateDisplay();
                
            } catch (error) {
                console.error('Combat error:', error);
                // Reset combat state even on error
                resetCombatState();
                // Fallback: restore UI and transition to lose scene
                const gameContainer = document.querySelector('.game-container');
                if (gameContainer) gameContainer.style.display = 'block';
                const overlay = document.getElementById('minigame-overlay');
                if (overlay) overlay.style.display = 'none';
                gameState.currentScene = loseScene;
                updateDisplay();
            }
        }
        
        // Character creation helpers
        // ========================================================================
        // PRIORITY SYSTEM FUNCTIONS
        // ========================================================================
        
        /** Get priority bonuses for a category and letter */
        function getPriorityBonuses(category, letter) {
            const bonuses = {
                might: { A: { strength: 4, endurance: 4 }, B: { strength: 3, endurance: 3 }, C: { strength: 2, endurance: 2 }, D: { strength: 1, endurance: 1 }, E: { strength: 0, endurance: 0 } },
                finesse: { A: { agility: 5 }, B: { agility: 4 }, C: { agility: 3 }, D: { agility: 2 }, E: { agility: 1 } },
                wits: { A: { wits: 5 }, B: { wits: 4 }, C: { wits: 3 }, D: { wits: 2 }, E: { wits: 1 } },
                presence: { A: { charisma: 5 }, B: { charisma: 4 }, C: { charisma: 3 }, D: { charisma: 2 }, E: { charisma: 1 } },
                fortune: { 
                    A: { luck: 4, wealth: 12, reputation: 2, kitTier: "Superior" },
                    B: { luck: 3, wealth: 8, reputation: 1, kitTier: "Fine" },
                    C: { luck: 2, wealth: 5, reputation: 0, kitTier: "Good" },
                    D: { luck: 1, wealth: 2, reputation: 0, kitTier: "Standard" },
                    E: { luck: 0, wealth: 0, reputation: 0, kitTier: "Ragged" }
                }
            };
            return bonuses[category] && bonuses[category][letter] ? bonuses[category][letter] : {};
        }
        
        /** Set priority for a category */
        function setPriority(category, letter) {
            if (!gameState.priorities) {
                gameState.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            
            // Clear previous assignment of this letter
            if (letter) {
                Object.keys(gameState.priorities).forEach(function(key) {
                    if (gameState.priorities[key] === letter && key !== category) {
                        gameState.priorities[key] = null;
                    }
                });
            }
            
            gameState.priorities[category] = letter || null;
            recalculateCharacterCreationDerivedStats();
            updateDisplay();
        }
        
        /** Recalculate all character creation derived stats from scratch (anti-stacking fix) */
        function recalculateCharacterCreationDerivedStats() {
            // Step 1: Start with base stats and apply priorities
            recalculateFromPriorities();
            
            // Step 2: Apply age range stat mods (silent)
            if (gameState.ageRange) {
                const ageStatMods = {
                    'youth': { initiative: 2, agility: 1, endurance: -1, wits: -1 },
                    'young_adult': { strength: 1, agility: 1, wits: -1 },
                    'prime': { strength: 1, wits: 1 },
                    'veteran': { wits: 2, endurance: 1, agility: -1 },
                    'old_hand': { wits: 2, endurance: 1, charisma: 1, agility: -2, strength: -1 }
                };
                const ageMods = ageStatMods[gameState.ageRange];
                if (ageMods) {
                    Object.keys(ageMods).forEach(function(stat) {
                        applyStatChange(stat, ageMods[stat], {silent: true});
                    });
                }
            }
            
            // Step 3: Apply origin stat mods (silent)
            if (gameState.origin) {
                switch(gameState.origin) {
                    case 'rural_peasant':
                        applyStatChange('endurance', 2, {silent: true});
                        applyStatChange('wealth', -5, {silent: true});
                        break;
                    case 'manor_retainer':
                        applyStatChange('strength', 1, {silent: true});
                        applyStatChange('charisma', 1, {silent: true});
                        break;
                    case 'craftsman_apprentice':
                        applyStatChange('wits', 1, {silent: true});
                        applyStatChange('agility', 1, {silent: true});
                        break;
                    case 'squire':
                        applyStatChange('strength', 1, {silent: true});
                        applyStatChange('wits', 1, {silent: true});
                        break;
                    case 'minor_noble':
                        applyStatChange('charisma', 1, {silent: true});
                        applyStatChange('wits', 1, {silent: true});
                        applyStatChange('reputation', 5, {silent: true});
                        break;
                }
            }
            
            // Step 4: Apply background question mods (silent)
            if (gameState.backgroundQuestionsAnswered && Array.isArray(gameState.backgroundQuestionsAnswered)) {
                const backgroundEffects = {
                    hard_father: { strength: 1, endurance: 1, charisma: -1 },
                    mangled_hand: { agility: -1, endurance: -1, wits: 3 },
                    lost_sibling: { wits: 1, endurance: 1, morale: -1 },
                    village_hero: { charisma: 1, reputation: 2, strength: -1 },
                    apprentice_master: { wits: 2, agility: 1, stress: 1 },
                    first_love: { charisma: -1, wits: 1, morale: 1 }
                };
                gameState.backgroundQuestionsAnswered.forEach(function(qId) {
                    const effects = backgroundEffects[qId];
                    if (effects) {
                        Object.keys(effects).forEach(function(stat) {
                            applyStatChange(stat, effects[stat], {silent: true});
                        });
                    }
                });
            }
            
            // Step 5: Apply patron stat mods (silent)
            if (gameState.patronId && PATRONS[gameState.patronId]) {
                const patron = PATRONS[gameState.patronId];
                if (patron.statMods) {
                    Object.entries(patron.statMods).forEach(([stat, mod]) => {
                        applyStatChange(stat, mod, {silent: true});
                    });
                }
            }
            
            // Step 6: Resolve starting kit tier
            resolveStartingKitTier();
        }
        
        /** Resolve final starting kit tier from fortune priority + patron */
        function resolveStartingKitTier() {
            const tierOrder = ["Ragged", "Standard", "Good", "Fine", "Superior"];
            
            // Get kit tier from fortune priority (already set by recalculateFromPriorities)
            const fortuneTier = gameState.kitTier || "Standard";
            const fortuneIdx = tierOrder.indexOf(fortuneTier);
            
            // Get kit tier from patron
            let patronTier = "Standard";
            if (gameState.patronId && PATRONS[gameState.patronId]) {
                const patronKitTier = PATRONS[gameState.patronId].kitTier || "standard";
                const mappedTier = KIT_TIER_MAP[patronKitTier] || "Standard";
                patronTier = mappedTier;
            }
            const patronIdx = tierOrder.indexOf(patronTier);
            
            // Use the better (higher) tier
            const finalIdx = Math.max(fortuneIdx >= 0 ? fortuneIdx : 1, patronIdx >= 0 ? patronIdx : 1);
            gameState.startingKitTier = tierOrder[finalIdx];
        }
        
        /** Recalculate stats from priorities */
        function recalculateFromPriorities() {
            // Safety check: ensure gameState and stats exist
            if (!gameState) {
                console.error("recalculateFromPriorities: gameState is not defined");
                return;
            }
            if (!gameState.stats) {
                console.error("recalculateFromPriorities: gameState.stats is not defined");
                return;
            }
            
            if (!gameState.priorities) {
                gameState.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            
            // Start with base stats (all 5)
            gameState.stats.strength = 5;
            gameState.stats.agility = 5;
            gameState.stats.endurance = 5;
            gameState.stats.charisma = 5;
            gameState.stats.wits = 5;
            gameState.stats.luck = 5;
            gameState.stats.wealth = 10; // Base wealth
            gameState.stats.reputation = 0; // Base reputation
            
            // Apply priority bonuses
            Object.keys(gameState.priorities).forEach(function(category) {
                const letter = gameState.priorities[category];
                if (letter) {
                    const bonuses = getPriorityBonuses(category, letter);
                    Object.keys(bonuses).forEach(function(stat) {
                        if (stat === 'kitTier') {
                            gameState.kitTier = bonuses[stat];
                        } else if (gameState.stats.hasOwnProperty(stat)) {
                            gameState.stats[stat] += bonuses[stat];
                        }
                    });
                }
            });
            
            // Clamp all stats
            Object.keys(gameState.stats).forEach(function(stat) {
                gameState.stats[stat] = clampStat(stat, gameState.stats[stat]);
            });
            
            // Ensure kitTier is set
            if (!gameState.kitTier) {
                gameState.kitTier = "Standard";
            }
        }
        
        /** Validate priorities are complete and unique */
        function validatePrioritiesCompleteAndUnique() {
            if (!gameState.priorities) {
                return { ok: false, message: "Please assign all priorities (A-E)." };
            }
            
            const priorities = gameState.priorities;
            const categories = ['might', 'finesse', 'wits', 'presence', 'fortune'];
            const assigned = [];
            const missing = [];
            
            categories.forEach(function(cat) {
                if (!priorities[cat] || priorities[cat] === '') {
                    missing.push(cat);
                } else {
                    if (assigned.includes(priorities[cat])) {
                        return { ok: false, message: "Each priority (A-E) must be assigned exactly once." };
                    }
                    assigned.push(priorities[cat]);
                }
            });
            
            if (missing.length > 0) {
                return { ok: false, message: "Please assign all priorities (A-E). Missing: " + missing.length + " category(ies)." };
            }
            
            if (assigned.length !== 5) {
                return { ok: false, message: "Please assign exactly one priority (A-E) to each category." };
            }
            
            return { ok: true, message: "All priorities assigned correctly." };
        }
        
        /** Apply priority preset */
        function applyPriorityPreset(presetId) {
            if (!gameState.priorities) {
                gameState.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            
            const presets = {
                brawny: { might: 'A', finesse: 'C', wits: 'D', presence: 'E', fortune: 'B' },
                cunning: { might: 'D', finesse: 'A', wits: 'A', presence: 'C', fortune: 'B' },
                court: { might: 'C', finesse: 'D', wits: 'B', presence: 'A', fortune: 'E' },
                lucky: { might: 'C', finesse: 'C', wits: 'C', presence: 'C', fortune: 'A' }
            };
            
            if (presets[presetId]) {
                Object.assign(gameState.priorities, presets[presetId]);
                recalculateFromPriorities();
                updateDisplay();
            }
        }
        
        /** Grant starting kit based on origin and fortune tier */
        function grantStartingKit(origin, kitTier) {
            if (gameState.startingKitGranted) {
                return; // Already granted
            }
            
            if (!gameState.inventory) {
                gameState.inventory = [];
            }
            
            // Use resolved startingKitTier if available, otherwise fall back to parameter or default
            const tier = gameState.startingKitTier || kitTier || "Standard";
            
            // Kit shapes by origin
            const originKits = {
                rural_peasant: {
                    Ragged: [{ id: "cudgel", name: "Cudgel", type: "weapon" }],
                    Standard: [{ id: "cudgel", name: "Cudgel", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }],
                    Good: [{ id: "knife", name: "Knife", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }, { id: "cap", name: "Leather Cap", type: "armor" }],
                    Fine: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }],
                    Superior: [{ id: "arming_sword", name: "Fine Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }]
                },
                manor_retainer: {
                    Ragged: [{ id: "spear", name: "Spear", type: "weapon" }],
                    Standard: [{ id: "spear", name: "Spear", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }],
                    Good: [{ id: "bill", name: "Bill", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Fine: [{ id: "bill", name: "Bill", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Superior: [{ id: "bill", name: "Bill", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_coif", name: "Mail Coif", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }]
                },
                craftsman_apprentice: {
                    Ragged: [{ id: "knife", name: "Knife", type: "weapon" }],
                    Standard: [{ id: "knife", name: "Knife", type: "weapon" }, { id: "leather_jerkin", name: "Leather Jerkin", type: "armor" }],
                    Good: [{ id: "short_sword", name: "Short Sword", type: "weapon" }, { id: "leather_jerkin", name: "Leather Jerkin", type: "armor" }, { id: "cap", name: "Cap", type: "armor" }],
                    Fine: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }],
                    Superior: [{ id: "arming_sword", name: "Fine Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }]
                },
                squire: {
                    Ragged: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }],
                    Standard: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "padded_jack", name: "Padded Jack", type: "armor" }],
                    Good: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Fine: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_shirt", name: "Mail Shirt", type: "armor" }, { id: "kettle_hat", name: "Kettle Hat", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Superior: [{ id: "arming_sword", name: "Fine Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_shirt", name: "Mail Shirt", type: "armor" }, { id: "bascinet", name: "Bascinet", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }]
                },
                minor_noble: {
                    Ragged: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }],
                    Standard: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }],
                    Good: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_shirt", name: "Mail Shirt", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Fine: [{ id: "arming_sword", name: "Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_shirt", name: "Mail Shirt", type: "armor" }, { id: "bascinet", name: "Bascinet", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }],
                    Superior: [{ id: "arming_sword", name: "Fine Arming Sword", type: "weapon" }, { id: "gambeson", name: "Gambeson", type: "armor" }, { id: "mail_shirt", name: "Mail Shirt", type: "armor" }, { id: "bascinet", name: "Visored Bascinet", type: "armor" }, { id: "buckler", name: "Buckler", type: "shield" }, { id: "rondel_dagger", name: "Rondel Dagger", type: "weapon" }]
                }
            };
            
            const selectedOrigin = origin || 'rural_peasant';
            const kit = originKits[selectedOrigin] && originKits[selectedOrigin][tier] ? originKits[selectedOrigin][tier] : originKits.rural_peasant[tier] || originKits.rural_peasant.Standard;
            
            // Add items to inventory
            kit.forEach(function(item) {
                gameState.inventory.push({
                    id: item.id,
                    name: item.name,
                    type: item.type,
                    condition: tier === "Ragged" ? 0.5 : tier === "Standard" ? 0.7 : tier === "Good" ? 0.8 : tier === "Fine" ? 0.9 : 1.0,
                    fit: "standard"
                });
            });
            
            // Auto-equip basic items if equipment manager exists
            if (typeof EquipmentManager !== 'undefined' && window.equipmentManager) {
                kit.forEach(function(item) {
                    try {
                        if (item.type === "weapon" && !gameState.equipment.weapon.item) {
                            const invItem = gameState.inventory.find(function(i) { return i.id === item.id; });
                            if (invItem) {
                                window.equipmentManager.equipItem(invItem.id, 'weapon');
                            }
                        } else if (item.type === "armor" && item.id.includes("hat") && !gameState.equipment.head.item) {
                            const invItem = gameState.inventory.find(function(i) { return i.id === item.id; });
                            if (invItem) {
                                window.equipmentManager.equipItem(invItem.id, 'head');
                            }
                        } else if (item.type === "armor" && !gameState.equipment.torso.item) {
                            const invItem = gameState.inventory.find(function(i) { return i.id === item.id && i.type === "armor"; });
                            if (invItem) {
                                window.equipmentManager.equipItem(invItem.id, 'torso');
                            }
                        } else if (item.type === "shield" && !gameState.equipment.accessory.item) {
                            const invItem = gameState.inventory.find(function(i) { return i.id === item.id; });
                            if (invItem) {
                                window.equipmentManager.equipItem(invItem.id, 'accessory');
                            }
                        }
                    } catch (e) {
                        console.warn("Could not auto-equip " + item.name + ":", e);
                    }
                });
            }
            
            gameState.startingKitGranted = true;
        }
        
        function selectBackground(bg) {
            gameState.background = bg;
            // Update button styles
            ['peasant', 'merchant', 'noble'].forEach(b => {
                const btn = document.getElementById(`bg-${b}`);
                if (btn) {
                    if (b === bg) {
                        btn.style.background = '#d4af37';
                        btn.style.color = '#1a0f08';
                    } else {
                        btn.style.background = '#2a2a2a';
                        btn.style.color = '#d4af37';
                    }
                }
            });
            updateDisplay();
        }
        
        // Character Creation Step Navigation
        function nextCharacterCreationStep() {
            const currentStep = gameState.characterCreationStep || 1;
            const maxStep = 6;
            if (currentStep < maxStep) {
                gameState.characterCreationStep = currentStep + 1;
                updateDisplay();
            } else if (currentStep === maxStep) {
                // On step 6, clicking Next creates the character
                completeCharacterCreation();
            }
        }
        
        function completeCharacterCreation() {
            // Validate required fields
            if (!gameState.characterName || gameState.characterName.trim() === '') {
                gameState.characterName = "William Thatcher";
            }
            if (!gameState.culture) {
                showNotification('Character Creation', 'Please select your region.');
                return;
            }
            if (!gameState.ageRange) {
                showNotification('Character Creation', 'Please select your age range.');
                return;
            }
            if (!gameState.origin) {
                showNotification('Character Creation', 'Please select your origin.');
                return;
            }
            
            // Validate patron is selected
            if (!gameState.patronId && !gameState.patron) {
                showNotification('Character Creation', 'Please select a patron before continuing.');
                return;
            }
            
            // Validate priorities
            const priorityValidation = validatePrioritiesCompleteAndUnique();
            if (!priorityValidation.ok) {
                showNotification('Character Creation', priorityValidation.message);
                return;
            }
            
            // Grant starting kit (kit tier already resolved by recalculateCharacterCreationDerivedStats)
            if (!gameState.startingKitGranted) {
                grantStartingKit(gameState.origin, gameState.startingKitTier);
            }
            
            // Transition to start scene
            gameState.currentScene = "start";
            updateDisplay();
        }
        
        function prevCharacterCreationStep() {
            const currentStep = gameState.characterCreationStep || 1;
            if (currentStep > 1) {
                gameState.characterCreationStep = currentStep - 1;
                updateDisplay();
            }
        }
        
        function goToCharacterCreationStep(step) {
            if (step >= 1 && step <= 6) {
                gameState.characterCreationStep = step;
                updateDisplay();
            }
        }
        
        // Render step navigation buttons
        function renderStepNavigation(currentStep, maxStep) {
            const canGoBack = currentStep > 1;
            const isLastStep = currentStep === maxStep;
            
            let navHtml = '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #8b6914;">';
            
            // Step indicator
            navHtml += '<div style="color: #d4af37; font-size: 14px;">Step ' + currentStep + ' of ' + maxStep + '</div>';
            
            // Navigation buttons
            navHtml += '<div style="display: flex; gap: 10px;">';
            
            if (canGoBack) {
                navHtml += '<button onclick="prevCharacterCreationStep()" style="padding: 10px 20px; background: #2a2a2a; border: 2px solid #d4af37; color: #d4af37; border-radius: 5px; cursor: pointer; font-size: 14px; font-family: \'Crimson Text\', serif;">‚Üê Previous</button>';
            } else {
                navHtml += '<button disabled style="padding: 10px 20px; background: #1a1a1a; border: 2px solid #555; color: #666; border-radius: 5px; font-size: 14px; font-family: \'Crimson Text\', serif; cursor: not-allowed;">‚Üê Previous</button>';
            }
            
            if (isLastStep) {
                // On last step, show "Begin Journey" button
                navHtml += '<button onclick="completeCharacterCreation()" style="padding: 10px 20px; background: #d4af37; border: 2px solid #f4d03f; color: #1a0f08; border-radius: 5px; cursor: pointer; font-size: 14px; font-family: \'Crimson Text\', serif; font-weight: bold;">Begin Your Journey ‚Üí</button>';
            } else {
                navHtml += '<button onclick="nextCharacterCreationStep()" style="padding: 10px 20px; background: #2a2a2a; border: 2px solid #d4af37; color: #d4af37; border-radius: 5px; cursor: pointer; font-size: 14px; font-family: \'Crimson Text\', serif;">Next ‚Üí</button>';
            }
            
            navHtml += '</div>';
            navHtml += '</div>';
            
            return navHtml;
        }
        
        // Quick Start Character Generation
        function generateQuickStartCharacter() {
            // Ensure stats are initialized
            if (!gameState.stats) {
                gameState.stats = {
                    strength: 5,
                    agility: 5,
                    endurance: 5,
                    charisma: 5,
                    luck: 5,
                    wits: 5,
                    wealth: 10,
                    reputation: 0,
                    morale: 5,
                    stress: 0,
                    experience: 0,
                    patronFavor: 0,
                    initiative: 5
                };
            }
            
            // Random name from common names
            const firstNames = ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter", "James", "David", "Michael", "Stephen", "Alan"];
            const lastNames = ["Thatcher", "Smith", "Miller", "Baker", "Taylor", "Cooper", "Wright", "Carter", "Turner", "Parker", "Clark", "Hill", "Green", "Wood", "Brown"];
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            gameState.characterName = firstName + " " + lastName;
            
            // Random region
            const regions = ["Yorkshire", "Kent", "London", "Cornwall", "Lancashire", "Essex", "Norfolk", "Somerset"];
            gameState.culture = regions[Math.floor(Math.random() * regions.length)];
            
            // Random age range (weighted toward prime/young_adult)
            const ageRanges = [
                { id: 'youth', weight: 1 },
                { id: 'young_adult', weight: 3 },
                { id: 'prime', weight: 4 },
                { id: 'veteran', weight: 2 },
                { id: 'old_hand', weight: 1 }
            ];
            const totalWeight = ageRanges.reduce((sum, r) => sum + r.weight, 0);
            let random = Math.random() * totalWeight;
            for (let range of ageRanges) {
                random -= range.weight;
                if (random <= 0) {
                    gameState.ageRange = range.id;
                    break;
                }
            }
            
            // Random origin
            const origins = ["rural_peasant", "manor_retainer", "craftsman_apprentice", "squire", "minor_noble"];
            gameState.origin = origins[Math.floor(Math.random() * origins.length)];
            
            // Random priority preset
            const priorityPresets = ['brawny', 'cunning', 'court', 'lucky'];
            const preset = priorityPresets[Math.floor(Math.random() * priorityPresets.length)];
            const presets = {
                brawny: { might: 'A', finesse: 'C', wits: 'D', presence: 'E', fortune: 'B' },
                cunning: { might: 'D', finesse: 'A', wits: 'A', presence: 'C', fortune: 'B' },
                court: { might: 'C', finesse: 'D', wits: 'B', presence: 'A', fortune: 'E' },
                lucky: { might: 'C', finesse: 'C', wits: 'C', presence: 'C', fortune: 'A' }
            };
            if (!gameState.priorities) {
                gameState.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            Object.assign(gameState.priorities, presets[preset]);
            gameState.quickStartPreset = preset;
            
            // Recalculate stats from priorities first (this resets to base and applies priority bonuses)
            if (typeof recalculateFromPriorities === 'function') {
                recalculateFromPriorities();
            }
            
            // Set age based on age range
            const ageMap = {
                'youth': 18,
                'young_adult': 22,
                'prime': 27,
                'veteran': 33,
                'old_hand': 38
            };
            gameState.age = ageMap[gameState.ageRange] || 27;
            
            // Apply age range stat mods (after priorities)
            const ageStatMods = {
                'youth': { initiative: 2, agility: 1, endurance: -1, wits: -1 },
                'young_adult': { strength: 1, agility: 1, wits: -1 },
                'prime': { strength: 1, wits: 1 },
                'veteran': { wits: 2, endurance: 1, agility: -1 },
                'old_hand': { wits: 2, endurance: 1, charisma: 1, agility: -2, strength: -1 }
            };
            const ageMods = ageStatMods[gameState.ageRange];
            if (ageMods && typeof applyStatChange === 'function') {
                Object.keys(ageMods).forEach(function(stat) {
                    applyStatChange(stat, ageMods[stat]);
                });
            }
            
            // Random 1-2 background questions (apply after priorities and age)
            const backgroundQuestions = ['hard_father', 'mangled_hand', 'lost_sibling', 'village_hero', 'apprentice_master', 'first_love'];
            gameState.backgroundQuestionsAnswered = [];
            const numQuestions = Math.random() < 0.5 ? 1 : 2;
            // Fisher-Yates shuffle for proper random distribution
            const shuffled = [...backgroundQuestions];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            for (let i = 0; i < numQuestions && i < shuffled.length; i++) {
                gameState.backgroundQuestionsAnswered.push(shuffled[i]);
            }
            
            // Apply background question effects
            const backgroundEffects = {
                hard_father: { strength: 1, endurance: 1, charisma: -1 },
                mangled_hand: { agility: -1, endurance: -1, wits: 3 },
                lost_sibling: { wits: 1, endurance: 1, morale: -1 },
                village_hero: { charisma: 1, reputation: 2, strength: -1 },
                apprentice_master: { wits: 2, agility: 1, stress: 1 },
                first_love: { charisma: -1, wits: 1, morale: 1 }
            };
            if (typeof applyStatChange === 'function') {
                gameState.backgroundQuestionsAnswered.forEach(function(qId) {
                    const effects = backgroundEffects[qId];
                    if (effects) {
                        Object.keys(effects).forEach(function(stat) {
                            applyStatChange(stat, effects[stat]);
                        });
                    }
                });
            }
            
            // Random patron
            const patrons = ['james_olooney', 'lord_david', 'duke_caley', 'count_charles', 'ashkhan'];
            const selectedPatron = patrons[Math.floor(Math.random() * patrons.length)];
            gameState.patronId = selectedPatron;
            gameState.patron = selectedPatron; // Legacy compatibility
            if (PATRONS[selectedPatron]) {
                gameState.patronEventPath = PATRONS[selectedPatron].eventPath;
            }
            
            // Apply origin stat bonuses (same as start.onEnter does)
            if (!gameState.flags.originApplied && typeof applyStatChange === 'function') {
                switch(gameState.origin) {
                    case 'rural_peasant':
                        applyStatChange('endurance', 2);
                        applyStatChange('wealth', -5);
                        break;
                    case 'manor_retainer':
                        applyStatChange('strength', 1);
                        applyStatChange('charisma', 1);
                        break;
                    case 'craftsman_apprentice':
                        applyStatChange('wits', 1);
                        applyStatChange('agility', 1);
                        break;
                    case 'squire':
                        applyStatChange('strength', 1);
                        applyStatChange('wits', 1);
                        break;
                    case 'minor_noble':
                        applyStatChange('charisma', 1);
                        applyStatChange('wits', 1);
                        applyStatChange('reputation', 5);
                        break;
                }
                gameState.flags.originApplied = true;
            }
            
            // Mark character creation as complete
            gameState.characterCreationStep = 6;
            gameState.quickStartUsed = true;
            
            // Grant starting kit
            if (!gameState.startingKitGranted) {
                const kitTier = gameState.kitTier || "Standard";
                grantStartingKit(gameState.origin, kitTier);
            }
            
            // Go to quick start review scene
            gameState.currentScene = "quick_start_review";
            updateDisplay();
        }
        
        // Step Renderer Functions
        function renderCharacterCreationStep1(nameDisplay, currentCulture) {
            const nameSuggestions = {
                "Yorkshire": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Kent": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "London": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Cornwall": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Lancashire": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Essex": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Norfolk": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"],
                "Somerset": ["William", "John", "Thomas", "Richard", "Robert", "Henry", "Geoffrey", "Roger", "Edward", "Hugh", "Simon", "Walter", "Ralph", "Nicholas", "Peter"]
            };
            
            const regionFlavor = {
                "Yorkshire": "You hail from the rugged moors and dales of Yorkshire. The longbow is your birthright, and you know the weight of honest labor. Your northern accent marks you among southerners, but your loyalty to the Crown is unquestioned. You are a Yorkshireman, and you will fight for King Edward and the realm.",
                "Kent": "You come from the fertile fields and bustling ports of Kent. The Channel is your neighbor, and you've seen French ships on the horizon. Your accent carries the weight of the south, and your loyalty to the Crown runs deep. You are a Kentishman, and you will fight for King Edward and the realm.",
                "London": "You are a son of London‚Äîthe great city where merchants and nobles mix. You know the value of coin and the weight of reputation. Your speech marks you as a man of the capital, and your loyalty to the Crown is absolute. You are a Londoner, and you will fight for King Edward and the realm.",
                "Cornwall": "You hail from the wild coasts and tin mines of Cornwall. The sea is in your blood, and you know the ways of both land and water. Your Cornish heritage sets you apart, but your loyalty to the Crown is steadfast. You are a Cornishman, and you will fight for King Edward and the realm.",
                "Lancashire": "You come from the rolling hills and wool towns of Lancashire. The trade routes run through your land, and you know the value of hard work. Your northern roots shape you, and your loyalty to the Crown is unwavering. You are a Lancastrian, and you will fight for King Edward and the realm.",
                "Essex": "You hail from the rich farmlands and ports of Essex. The Thames flows near, and you've seen the wealth of London. Your eastern accent marks you, and your loyalty to the Crown is true. You are an Essex man, and you will fight for King Edward and the realm.",
                "Norfolk": "You come from the fens and ports of Norfolk. The sea and the land are both your home, and you know the ways of both. Your eastern roots shape you, and your loyalty to the Crown is resolute. You are a Norfolk man, and you will fight for King Edward and the realm.",
                "Somerset": "You hail from the green hills and cider country of Somerset. The West Country is your home, and you know the value of honest toil. Your western accent marks you, and your loyalty to the Crown is firm. You are a Somerset man, and you will fight for King Edward and the realm."
            };
            
            // England vector map - simplified but recognizable outline
            const englandMapPath = "M 50 50 L 350 50 L 350 450 L 50 450 Z M 100 80 L 300 80 L 300 420 L 100 420 Z"; // Simplified outline
            
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<div style="margin-bottom: 20px; padding: 15px; background: rgba(139, 105, 20, 0.3); border: 2px solid #8b6914; border-radius: 5px; text-align: center;">' +
                    '<div style="color: #f4d03f; font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">Want to jump right in?</div>' +
                    '<button onclick="generateQuickStartCharacter()" style="padding: 12px 24px; background: #8b6914; border: 2px solid #d4af37; color: #f4d03f; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background=\'#d4af37\'; this.style.color=\'#1a0f08\';" onmouseout="this.style.background=\'#8b6914\'; this.style.color=\'#f4d03f\';">‚ö° Quick Start</button>' +
                    '<div style="color: #888; font-size: 12px; margin-top: 8px; font-style: italic;">We will randomly generate a character for you</div>' +
                '</div>' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 1 ‚Äî Identity</h3>' +
                '<div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                    '<label style="display: block; color: #d4af37; margin-bottom: 8px; font-weight: bold;">Your Name:</label>' +
                    '<input type="text" id="character-name-input" placeholder="Enter your name" ' +
                           'value="' + (nameDisplay || "William Thatcher") + '" ' +
                           'list="name-suggestions" ' +
                           'style="width: 100%; padding: 10px; background: #2a2a2a; border: 2px solid #d4af37; color: #d4af37; border-radius: 5px; font-size: 16px; font-family: \'Crimson Text\', serif; margin-bottom: 15px;" ' +
                           'onfocus="if(this.value === \'William Thatcher\') { this.value = \'\'; }" ' +
                           'onblur="if(this.value.trim() === \'\') { this.value = \'William Thatcher\'; }" ' +
                           'onchange="gameState.characterName = this.value.trim() || \'William Thatcher\'; updateDisplay();">' +
                    '<datalist id="name-suggestions">' +
                        (currentCulture && nameSuggestions[currentCulture] ? nameSuggestions[currentCulture].map(function(n) { return '<option value="' + n + '">'; }).join('') : '') +
                    '</datalist>' +
                '</div>' +
                '<div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                    '<label style="display: block; color: #d4af37; margin-bottom: 10px; font-weight: bold;">Your Region:</label>' +
                    '<div style="position: relative; margin-bottom: 15px; display: inline-block; width: 100%; max-width: 800px;">' +
                        '<img id="uk-map-image" src="artwork/uk-map.png" alt="Map of England" style="width: 100%; max-width: 800px; height: auto; border: 2px solid #d4af37; border-radius: 5px; display: block; margin: 0 auto; background: rgba(26, 15, 8, 0.8);" />' +
                        // Region markers positioned absolutely over the map
                        // Positions adjusted based on detailed feedback
                        // Yorkshire (North East England) - moved down from Scotland, slightly east
                        '<button id="region-marker-Yorkshire" onclick="selectCulture(\'Yorkshire\')" onmouseover="showRegionTooltip(event, \'Yorkshire\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 60%; top: 38%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Yorkshire' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Yorkshire' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Yorkshire"></button>' +
                        // Lancashire (North West England) - moved down from Scotland, slightly west
                        '<button id="region-marker-Lancashire" onclick="selectCulture(\'Lancashire\')" onmouseover="showRegionTooltip(event, \'Lancashire\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 46%; top: 38%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Lancashire' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Lancashire' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Lancashire"></button>' +
                        // Norfolk (East Anglia) - moved down from NE England, slightly east
                        '<button id="region-marker-Norfolk" onclick="selectCulture(\'Norfolk\')" onmouseover="showRegionTooltip(event, \'Norfolk\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 66%; top: 52%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Norfolk' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Norfolk' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Norfolk"></button>' +
                        // Essex (Southeast, NE of London) - moved up and slightly left
                        '<button id="region-marker-Essex" onclick="selectCulture(\'Essex\')" onmouseover="showRegionTooltip(event, \'Essex\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 58%; top: 54%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Essex' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Essex' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Essex"></button>' +
                        // London (Southeast England) - moved down and slightly right
                        '<button id="region-marker-London" onclick="selectCulture(\'London\')" onmouseover="showRegionTooltip(event, \'London\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 54%; top: 60%; transform: translate(-50%, -50%); width: 28px; height: 28px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'London' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'London' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 10px rgba(212, 175, 55, 1); transition: all 0.3s; font-weight: bold;" title="London">‚öî</button>' +
                        // Kent (Southeast corner) - small nudge down and right
                        '<button id="region-marker-Kent" onclick="selectCulture(\'Kent\')" onmouseover="showRegionTooltip(event, \'Kent\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 64%; top: 68%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Kent' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Kent' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Kent"></button>' +
                        // Somerset (South West England) - moved right and slightly down
                        '<button id="region-marker-Somerset" onclick="selectCulture(\'Somerset\')" onmouseover="showRegionTooltip(event, \'Somerset\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 44%; top: 72%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Somerset' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Somerset' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Somerset"></button>' +
                        // Cornwall (Far Southwest peninsula) - moved right and slightly down
                        '<button id="region-marker-Cornwall" onclick="selectCulture(\'Cornwall\')" onmouseover="showRegionTooltip(event, \'Cornwall\')" onmouseout="hideRegionTooltip()" style="position: absolute; left: 32%; top: 82%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid ' + (currentCulture === 'Cornwall' ? '#f4d03f' : '#d4af37') + '; background: ' + (currentCulture === 'Cornwall' ? 'rgba(244, 208, 63, 0.8)' : 'rgba(212, 175, 55, 0.6)') + '; cursor: pointer; z-index: 10; box-shadow: 0 0 8px rgba(212, 175, 55, 0.8); transition: all 0.3s;" title="Cornwall"></button>' +
                        '<div id="region-tooltip" style="position: absolute; display: none; background: rgba(0, 0, 0, 0.95); border: 2px solid #d4af37; border-radius: 5px; padding: 12px; max-width: 300px; z-index: 1000; pointer-events: none; color: #d4af37; font-size: 13px; line-height: 1.5; box-shadow: 0 4px 12px rgba(0,0,0,0.8);"></div>' +
                    '</div>' +
                    (currentCulture && regionFlavor[currentCulture] ? 
                        '<div style="padding: 12px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 5px; margin-top: 10px;">' +
                            '<div style="color: #f4d03f; font-weight: bold; margin-bottom: 8px;">Selected: ' + currentCulture + '</div>' +
                            '<div style="color: #d4af37; font-style: italic; font-size: 13px; line-height: 1.5;">' + regionFlavor[currentCulture] + '</div>' +
                        '</div>' :
                        '<div style="padding: 10px; background: rgba(139, 105, 20, 0.1); border: 1px dashed #8b6914; border-radius: 5px; margin-top: 10px; text-align: center; color: #888; font-size: 12px;">Click a region on the map above to select your origin</div>') +
                '</div>' +
            '</div>';
        }
        
        function renderCharacterCreationStep2(currentAgeRange) {
            const ageRanges = [
                { id: 'youth', name: 'Youth (16-19)', description: 'Fresh-faced and eager, but untested in the ways of war.', advantages: ['+2 Initiative', '+1 Agility', 'Quick to learn'], drawbacks: ['-1 Endurance', '-1 Wits', 'Less respect from veterans'], statMods: { initiative: 2, agility: 1, endurance: -1, wits: -1 }, numericAge: 18 },
                { id: 'young_adult', name: 'Young Adult (20-24)', description: 'In your prime, strong and fast with growing experience.', advantages: ['+1 Strength', '+1 Agility', 'Peak physical condition'], drawbacks: ['-1 Wits', 'Still learning tactics'], statMods: { strength: 1, agility: 1, wits: -1 }, numericAge: 22 },
                { id: 'prime', name: 'Prime (25-30)', description: 'The perfect balance of strength, speed, and wisdom.', advantages: ['+1 Strength', '+1 Wits', 'Balanced capabilities'], drawbacks: ['None - the ideal age for a soldier'], statMods: { strength: 1, wits: 1 }, numericAge: 27 },
                { id: 'veteran', name: 'Veteran (31-35)', description: 'Seasoned by years of service, wise but slower.', advantages: ['+2 Wits', '+1 Endurance', 'Respected by peers'], drawbacks: ['-1 Agility', 'Slower reflexes'], statMods: { wits: 2, endurance: 1, agility: -1 }, numericAge: 33 },
                { id: 'old_hand', name: 'Old Hand (36-40)', description: 'A grizzled veteran with hard-won wisdom, but age takes its toll.', advantages: ['+2 Wits', '+1 Endurance', '+1 Charisma', 'Greatly respected'], drawbacks: ['-2 Agility', '-1 Strength', 'Slower in combat'], statMods: { wits: 2, endurance: 1, charisma: 1, agility: -2, strength: -1 }, numericAge: 38 }
            ];
            
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 2 ‚Äî Age Range</h3>' +
                '<p style="color: #888; font-size: 14px; margin-bottom: 20px;">Choose the age range that best describes your character. Each has unique advantages and drawbacks.</p>' +
                '<div style="display: grid; grid-template-columns: 1fr; gap: 12px;">' +
                    ageRanges.map(function(range) {
                        const isSelected = currentAgeRange === range.id;
                        return '<button onclick="selectAgeRange(\'' + range.id + '\')" style="padding: 15px; background: ' + (isSelected ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (isSelected ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left; transition: all 0.2s;">' +
                            '<strong style="font-size: 1.1em; display: block; margin-bottom: 5px;">' + range.name + '</strong>' +
                            '<div style="font-size: 13px; font-style: italic; color: ' + (isSelected ? '#1a0f08' : '#888') + '; margin-bottom: 10px;">' + range.description + '</div>' +
                            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">' +
                                '<div style="padding: 8px; background: rgba(0, 150, 0, ' + (isSelected ? '0.3' : '0.1') + '); border-radius: 3px;">' +
                                    '<div style="font-size: 11px; font-weight: bold; color: ' + (isSelected ? '#0a5a0a' : '#0f0') + '; margin-bottom: 5px;">Advantages:</div>' +
                                    '<ul style="margin: 0; padding-left: 20px; font-size: 12px; color: ' + (isSelected ? '#1a0f08' : '#0f0') + ';">' +
                                        range.advantages.map(function(adv) { return '<li>' + adv + '</li>'; }).join('') +
                                    '</ul>' +
                                '</div>' +
                                '<div style="padding: 8px; background: rgba(150, 0, 0, ' + (isSelected ? '0.3' : '0.1') + '); border-radius: 3px;">' +
                                    '<div style="font-size: 11px; font-weight: bold; color: ' + (isSelected ? '#5a0a0a' : '#f00') + '; margin-bottom: 5px;">Drawbacks:</div>' +
                                    '<ul style="margin: 0; padding-left: 20px; font-size: 12px; color: ' + (isSelected ? '#1a0f08' : '#f66') + ';">' +
                                        range.drawbacks.map(function(draw) { return '<li>' + draw + '</li>'; }).join('') +
                                    '</ul>' +
                                '</div>' +
                            '</div>' +
                        '</button>';
                    }).join('') +
                '</div>' +
            '</div>';
        }
        
        function renderCharacterCreationStep3() {
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 3 ‚Äî Origin Story</h3>' +
                '<p style="color: #888; font-size: 14px; margin-bottom: 20px;">Your origin unlocks unique story paths, advantages, and challenges that shape your journey.</p>' +
                '<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">' +
                    '<button onclick="selectOrigin(\'rural_peasant\')" style="padding: 20px; background: ' + (gameState.origin === 'rural_peasant' ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (gameState.origin === 'rural_peasant' ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left;">' +
                        '<strong style="font-size: 1.1em;">Rural Peasant</strong>' +
                        '<div style="font-size: 14px; margin-top: 8px; color: ' + (gameState.origin === 'rural_peasant' ? '#1a0f08' : '#888') + ';">' +
                            '<div style="margin-bottom: 5px;"><strong>Advantages:</strong> +Endurance, Insight into rural networks</div>' +
                            '<div style="margin-bottom: 5px;"><strong>Challenges:</strong> Low coin, no formal training</div>' +
                        '</div>' +
                    '</button>' +
                    '<button onclick="selectOrigin(\'manor_retainer\')" style="padding: 20px; background: ' + (gameState.origin === 'manor_retainer' ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (gameState.origin === 'manor_retainer' ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left;">' +
                        '<strong style="font-size: 1.1em;">Manor Retainer</strong>' +
                        '<div style="font-size: 14px; margin-top: 8px; color: ' + (gameState.origin === 'manor_retainer' ? '#1a0f08' : '#888') + ';">' +
                            '<div style="margin-bottom: 5px;"><strong>Advantages:</strong> +Strength, +Charisma in village contexts</div>' +
                            '<div style="margin-bottom: 5px;"><strong>Challenges:</strong> Fealty binds your options, owe service</div>' +
                        '</div>' +
                    '</button>' +
                    '<button onclick="selectOrigin(\'craftsman_apprentice\')" style="padding: 20px; background: ' + (gameState.origin === 'craftsman_apprentice' ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (gameState.origin === 'craftsman_apprentice' ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left;">' +
                        '<strong style="font-size: 1.1em;">Craftsman\'s Apprentice</strong>' +
                        '<div style="font-size: 14px; margin-top: 8px; color: ' + (gameState.origin === 'craftsman_apprentice' ? '#1a0f08' : '#888') + ';">' +
                            '<div style="margin-bottom: 5px;"><strong>Advantages:</strong> +Wits, +Agility when crafting/repairing</div>' +
                            '<div style="margin-bottom: 5px;"><strong>Challenges:</strong> No noble allies, urban ties pull into guild politics</div>' +
                        '</div>' +
                    '</button>' +
                    '<button onclick="selectOrigin(\'squire\')" style="padding: 20px; background: ' + (gameState.origin === 'squire' ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (gameState.origin === 'squire' ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left;">' +
                        '<strong style="font-size: 1.1em;">Squire to a Knight</strong>' +
                        '<div style="font-size: 14px; margin-top: 8px; color: ' + (gameState.origin === 'squire' ? '#1a0f08' : '#888') + ';">' +
                            '<div style="margin-bottom: 5px;"><strong>Advantages:</strong> +Strength, +Wits, Access to basic gear</div>' +
                            '<div style="margin-bottom: 5px;"><strong>Challenges:</strong> Bound by knight\'s agenda, must prove worth</div>' +
                        '</div>' +
                    '</button>' +
                    '<button onclick="selectOrigin(\'minor_noble\')" style="padding: 20px; background: ' + (gameState.origin === 'minor_noble' ? '#d4af37' : '#2a2a2a') + '; border: 2px solid #d4af37; color: ' + (gameState.origin === 'minor_noble' ? '#1a0f08' : '#d4af37') + '; border-radius: 5px; cursor: pointer; text-align: left;">' +
                        '<strong style="font-size: 1.1em;">Minor Noble or Garrison\'s Son/Daughter</strong>' +
                        '<div style="font-size: 14px; margin-top: 8px; color: ' + (gameState.origin === 'minor_noble' ? '#1a0f08' : '#888') + ';">' +
                            '<div style="margin-bottom: 5px;"><strong>Advantages:</strong> +Charisma, +Wits, Political network</div>' +
                            '<div style="margin-bottom: 5px;"><strong>Challenges:</strong> Political stakes ‚Äî errors are punished</div>' +
                        '</div>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }
        
        function renderCharacterCreationStep4() {
            const backgroundQuestions = [
                { id: 'hard_father', text: "Your father was a hard, cruel man. Your entire life you have woken before the dawn to break hard Earth, scratching a living out of the frozen soil to appease him. You learned hard lessons from those days, but each day in that house is a stain of black misery in your memories.", effects: { strength: 1, endurance: 1, charisma: -1 } },
                { id: 'mangled_hand', text: "Your hand was mangled as a youth. It wasn't ruined, but it bears the twisted scars of that old trauma and has never been quite the same. Your hand excused you from some of the chores that would have been assigned to a healthy boy. Instead, you often helped in the homestead with women's work, and learned to read at the local Abbey.", effects: { agility: -1, endurance: -1, wits: 3 } },
                { id: 'lost_sibling', text: "You had a sibling who died young‚Äîfever, accident, or the simple cruelty of a world that takes children. Their absence shaped you. You learned to be careful, to watch for danger, but also to value what remains.", effects: { wits: 1, endurance: 1, morale: -1 } },
                { id: 'village_hero', text: "When bandits came to your village, you stood with the others. You weren't the strongest or the fastest, but you were there when it mattered. The respect you earned that day still follows you.", effects: { charisma: 1, reputation: 2, strength: -1 } },
                { id: 'apprentice_master', text: "Your master was a harsh teacher, but fair. Every mistake was a lesson, every success earned a nod. You learned discipline and precision, but also learned to fear failure.", effects: { wits: 2, agility: 1, stress: 1 } },
                { id: 'first_love', text: "There was someone once‚Äîa first love, a promise made, a promise broken. Whether by war, by family, or by your own choices, it ended. The memory of what was lost makes you careful with new bonds.", effects: { charisma: -1, wits: 1, morale: 1 } }
            ];
            
            if (!gameState.backgroundQuestionsAnswered) {
                gameState.backgroundQuestionsAnswered = [];
            }
            
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 4 ‚Äî Background Questions</h3>' +
                '<p style="color: #888; font-size: 14px; margin-bottom: 20px;">These questions shape your past. Each answer adjusts your stats. You may answer as many or as few as you wish. <em style="color: #d4af37;">(Optional)</em></p>' +
                '<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">' +
                    backgroundQuestions.map(function(q) {
                        const isAnswered = gameState.backgroundQuestionsAnswered.includes(q.id);
                        const effectText = Object.entries(q.effects).map(function([stat, val]) {
                            const sign = val > 0 ? '+' : '';
                            const statName = stat.charAt(0).toUpperCase() + stat.slice(1);
                            return sign + val + ' ' + statName;
                        }).join(', ');
                        
                        return '<div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px; border: 2px solid ' + (isAnswered ? '#d4af37' : '#555') + ';">' +
                            '<div style="color: #d4af37; font-style: italic; margin-bottom: 10px; line-height: 1.6;">"' + q.text + '"</div>' +
                            (isAnswered ? 
                                '<div style="color: #0f0; font-size: 12px; margin-top: 8px;">‚úì Answered: ' + effectText + '</div>' :
                                '<div style="color: #888; font-size: 12px; margin-top: 8px; font-style: italic;">Secret result: ' + effectText + '</div>') +
                            '<button onclick="answerBackgroundQuestion(\'' + q.id + '\')" style="margin-top: 10px; padding: 8px 15px; background: ' + (isAnswered ? '#444' : '#8b6914') + '; border: 1px solid #d4af37; color: ' + (isAnswered ? '#666' : '#d4af37') + '; border-radius: 3px; cursor: ' + (isAnswered ? 'not-allowed' : 'pointer') + '; font-size: 13px;" ' + (isAnswered ? 'disabled' : '') + '>' +
                                (isAnswered ? 'Already Answered' : 'This Was My Past') +
                            '</button>' +
                        '</div>';
                    }).join('') +
                '</div>' +
            '</div>';
        }
        
        function renderCharacterCreationStep5() {
            if (!gameState.priorities) {
                gameState.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            if (!gameState.kitTier) {
                gameState.kitTier = "Standard";
            }
            
            const categories = [
                { id: 'might', name: 'üí™ Might', desc: 'Strength + Endurance' },
                { id: 'finesse', name: 'üèÉ Finesse', desc: 'Agility' },
                { id: 'wits', name: 'üß† Wits', desc: 'Intelligence & Tactics' },
                { id: 'presence', name: 'üí¨ Presence', desc: 'Charisma & Leadership' },
                { id: 'fortune', name: 'üí∞ Fortune', desc: 'Luck, Wealth & Starting Kit' }
            ];
            
            const usedPriorities = Object.values(gameState.priorities || {}).filter(function(p) { return p !== null; });
            
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 5 ‚Äî Priorities</h3>' +
                '<p style="color: #888; font-size: 14px; margin-bottom: 20px;">Assign each priority (A, B, C, D, E) exactly once across the five categories. Your choices determine your starting capabilities and equipment.</p>' +
                '<div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px;">' +
                    categories.map(function(cat) {
                        const currentPriority = (gameState.priorities || {})[cat.id] || '';
                        const priorityOptions = ['A', 'B', 'C', 'D', 'E'];
                        
                        return '<div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 5px; border: 2px solid ' + (currentPriority ? '#d4af37' : '#555') + ';">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                                '<div><div style="color: #d4af37; font-weight: bold; font-size: 1.05em;">' + cat.name + '</div><div style="color: #888; font-size: 12px;">' + cat.desc + '</div></div>' +
                                '<select onchange="setPriority(\'' + cat.id + '\', this.value);" style="padding: 6px 10px; background: #2a2a2a; border: 2px solid #d4af37; color: #d4af37; border-radius: 4px; font-size: 14px; font-weight: bold; min-width: 60px;">' +
                                    '<option value="">--</option>' +
                                    priorityOptions.map(function(letter) {
                                        const isUsed = usedPriorities.includes(letter) && letter !== currentPriority;
                                        return '<option value="' + letter + '" ' + (currentPriority === letter ? 'selected' : '') + (isUsed ? 'disabled' : '') + '>' + letter + (isUsed ? ' (used)' : '') + '</option>';
                                    }).join('') +
                                '</select>' +
                            '</div>' +
                        '</div>';
                    }).join('') +
                '</div>' +
                '<div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">' +
                    '<div style="color: #d4af37; font-weight: bold; margin-bottom: 8px; font-size: 13px;">Quick Presets:</div>' +
                    '<div style="display: flex; flex-wrap: wrap; gap: 8px;">' +
                        '<button onclick="applyPriorityPreset(\'brawny\')" style="padding: 6px 12px; background: #2a2a2a; border: 1px solid #d4af37; color: #d4af37; border-radius: 3px; cursor: pointer; font-size: 12px;">üí™ Brawny Footman</button>' +
                        '<button onclick="applyPriorityPreset(\'cunning\')" style="padding: 6px 12px; background: #2a2a2a; border: 1px solid #d4af37; color: #d4af37; border-radius: 3px; cursor: pointer; font-size: 12px;">üß† Cunning Scout</button>' +
                        '<button onclick="applyPriorityPreset(\'court\')" style="padding: 6px 12px; background: #2a2a2a; border: 1px solid #d4af37; color: #d4af37; border-radius: 3px; cursor: pointer; font-size: 12px;">üëë Court-Leaned</button>' +
                        '<button onclick="applyPriorityPreset(\'lucky\')" style="padding: 6px 12px; background: #2a2a2a; border: 1px solid #d4af37; color: #d4af37; border-radius: 3px; cursor: pointer; font-size: 12px;">üé≤ Lucky Bastard</button>' +
                    '</div>' +
                '</div>' +
                (function() {
                    try {
                        if (typeof recalculateFromPriorities === 'function') {
                            recalculateFromPriorities();
                        }
                        const validation = typeof validatePrioritiesCompleteAndUnique === 'function' ? validatePrioritiesCompleteAndUnique() : { ok: false, message: "Priority system not initialized" };
                        const kitTier = gameState.kitTier || "Standard";
                        const startingSilver = (gameState.stats && gameState.stats.wealth) ? gameState.stats.wealth : 10;
                        
                        return '<div style="padding: 15px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 5px; margin-top: 15px;">' +
                            '<div style="color: #f4d03f; font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">Computed Stats & Resources</div>' +
                            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">' +
                                '<div><strong style="color: #d4af37;">Strength:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.strength) ? gameState.stats.strength : 5) + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Agility:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.agility) ? gameState.stats.agility : 5) + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Endurance:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.endurance) ? gameState.stats.endurance : 5) + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Charisma:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.charisma) ? gameState.stats.charisma : 5) + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Wits:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.wits) ? gameState.stats.wits : 5) + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Luck:</strong> <span style="color: #f4d03f;">' + ((gameState.stats && gameState.stats.luck) ? gameState.stats.luck : 5) + '</span></div>' +
                            '</div>' +
                            '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #555;">' +
                                '<div><strong style="color: #d4af37;">Starting Silver:</strong> <span style="color: #f4d03f;">' + startingSilver + '</span></div>' +
                                '<div><strong style="color: #d4af37;">Kit Tier:</strong> <span style="color: #f4d03f;">' + kitTier + '</span></div>' +
                            '</div>' +
                            (!validation.ok ? '<div style="margin-top: 10px; padding: 8px; background: rgba(139, 0, 0, 0.3); border-left: 3px solid #8b0000; color: #ff6666; font-size: 12px;">‚ö†Ô∏è ' + validation.message + '</div>' : '') +
                        '</div>';
                    } catch (e) {
                        return '<div style="padding: 15px; background: rgba(139, 0, 0, 0.2); border: 2px solid #8b0000; border-radius: 5px; margin-top: 15px; color: #ff6666;">Error loading priority system.</div>';
                    }
                })() +
            '</div>';
        }
        
        function renderCharacterCreationStep6() {
            const currentPatronId = gameState.patronId;
            let patronSelectionHtml = '<div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                '<div style="color: #d4af37; font-weight: bold; margin-bottom: 15px; font-size: 16px;">Choose Your Patron</div>' +
                '<p style="color: #888; font-size: 14px; margin-bottom: 15px;">Select a lord or captain to serve under. Your choice affects your starting stats, equipment, and future opportunities.</p>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">';
            
            // Render patron cards
            Object.keys(PATRONS).forEach(function(patronId) {
                const patron = PATRONS[patronId];
                const isSelected = currentPatronId === patronId;
                const statModsText = Object.entries(patron.statMods || {}).map(([stat, mod]) => {
                    return (mod > 0 ? '+' : '') + mod + ' ' + stat;
                }).join(', ');
                
                patronSelectionHtml += '<div id="patron-card-' + patronId + '" onclick="setPatron(\'' + patronId + '\')" ' +
                    'style="padding: 15px; background: ' + (isSelected ? 'rgba(212, 175, 55, 0.3)' : 'rgba(42, 42, 42, 0.8)') + '; ' +
                    'border: 2px solid ' + (isSelected ? '#f4d03f' : '#8b6914') + '; ' +
                    'border-radius: 8px; cursor: pointer; transition: all 0.3s;" ' +
                    'onmouseover="this.style.borderColor=\'#d4af37\'; this.style.background=\'rgba(212, 175, 55, 0.2)\';" ' +
                    'onmouseout="this.style.borderColor=\'' + (isSelected ? '#f4d03f' : '#8b6914') + '\'; this.style.background=\'' + (isSelected ? 'rgba(212, 175, 55, 0.3)' : 'rgba(42, 42, 42, 0.8)') + '\';">' +
                    '<div style="color: ' + (isSelected ? '#f4d03f' : '#d4af37') + '; font-weight: bold; font-size: 15px; margin-bottom: 8px;">' + escapeHTML(patron.name) + '</div>' +
                    '<div style="color: #888; font-size: 12px; margin-bottom: 5px; font-style: italic;">' + escapeHTML(patron.type) + '</div>' +
                    '<div style="color: #aaa; font-size: 13px; margin-bottom: 8px;">' + escapeHTML(patron.blurb) + '</div>' +
                    '<div style="color: #d4af37; font-size: 12px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #555;">' +
                        '<strong>Stat Modifiers:</strong> ' + (statModsText || 'None') +
                    '</div>' +
                    (isSelected ? '<div style="color: #f4d03f; font-size: 12px; margin-top: 5px; font-weight: bold;">‚úì Selected</div>' : '') +
                '</div>';
            });
            
            patronSelectionHtml += '</div></div>';
            
            // Character summary
            const patronName = currentPatronId && PATRONS[currentPatronId] ? PATRONS[currentPatronId].name : 'Not selected';
            
            return '<div style="margin-bottom: 30px; padding: 20px; background: rgba(212, 175, 55, 0.15); border: 2px solid #d4af37; border-radius: 8px;">' +
                '<h3 style="color: #f4d03f; margin-bottom: 20px; border-bottom: 1px solid #d4af37; padding-bottom: 10px;">Step 6 ‚Äî Choose Patron & Review</h3>' +
                patronSelectionHtml +
                '<div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 5px; margin-top: 20px;">' +
                    '<div style="color: #d4af37; font-weight: bold; margin-bottom: 10px;">Character Summary:</div>' +
                    '<div style="color: #f4d03f; margin-bottom: 5px;"><strong>Name:</strong> ' + escapeHTML(gameState.characterName || 'Unnamed') + '</div>' +
                    '<div style="color: #f4d03f; margin-bottom: 5px;"><strong>Region:</strong> ' + escapeHTML(gameState.culture || 'Not selected') + '</div>' +
                    '<div style="color: #f4d03f; margin-bottom: 5px;"><strong>Age Range:</strong> ' + escapeHTML(gameState.ageRange || 'Not selected') + '</div>' +
                    '<div style="color: #f4d03f; margin-bottom: 5px;"><strong>Origin:</strong> ' + escapeHTML(gameState.origin || 'Not selected') + '</div>' +
                    '<div style="color: #f4d03f; margin-bottom: 5px;"><strong>Patron:</strong> ' + escapeHTML(patronName) + '</div>' +
                '</div>' +
            '</div>';
        }
        
        function selectCulture(culture) {
            gameState.culture = culture;
            updateRegionMapHighlight();
            updateDisplay();
        }
        
        // Show tooltip on hover
        function showRegionTooltip(event, regionName) {
            const tooltip = document.getElementById('region-tooltip');
            if (!tooltip) return;
            
            const regionFlavor = {
                "Yorkshire": "You hail from the rugged moors and dales of Yorkshire. The longbow is your birthright, and you know the weight of honest labor. Your northern accent marks you among southerners, but your loyalty to the Crown is unquestioned. You are a Yorkshireman, and you will fight for King Edward and the realm.",
                "Kent": "You come from the fertile fields and bustling ports of Kent. The Channel is your neighbor, and you've seen French ships on the horizon. Your accent carries the weight of the south, and your loyalty to the Crown runs deep. You are a Kentishman, and you will fight for King Edward and the realm.",
                "London": "You are a son of London‚Äîthe great city where merchants and nobles mix. You know the value of coin and the weight of reputation. Your speech marks you as a man of the capital, and your loyalty to the Crown is absolute. You are a Londoner, and you will fight for King Edward and the realm.",
                "Cornwall": "You hail from the wild coasts and tin mines of Cornwall. The sea is in your blood, and you know the ways of both land and water. Your Cornish heritage sets you apart, but your loyalty to the Crown is steadfast. You are a Cornishman, and you will fight for King Edward and the realm.",
                "Lancashire": "You come from the rolling hills and wool towns of Lancashire. The trade routes run through your land, and you know the value of hard work. Your northern roots shape you, and your loyalty to the Crown is unwavering. You are a Lancastrian, and you will fight for King Edward and the realm.",
                "Essex": "You hail from the rich farmlands and ports of Essex. The Thames flows near, and you've seen the wealth of London. Your eastern accent marks you, and your loyalty to the Crown is true. You are an Essex man, and you will fight for King Edward and the realm.",
                "Norfolk": "You come from the fens and ports of Norfolk. The sea and the land are both your home, and you know the ways of both. Your eastern roots shape you, and your loyalty to the Crown is resolute. You are a Norfolk man, and you will fight for King Edward and the realm.",
                "Somerset": "You hail from the green hills and cider country of Somerset. The West Country is your home, and you know the value of honest toil. Your western accent marks you, and your loyalty to the Crown is firm. You are a Somerset man, and you will fight for King Edward and the realm."
            };
            
            tooltip.innerHTML = '<div style="font-weight: bold; color: #f4d03f; margin-bottom: 5px; font-size: 14px;">' + regionName + '</div>' +
                                '<div style="font-style: italic;">' + (regionFlavor[regionName] || '') + '</div>';
            
            tooltip.style.display = 'block';
            
            // Position tooltip near the button marker
            const marker = document.getElementById('region-marker-' + regionName);
            if (!marker) {
                tooltip.style.display = 'none';
                return;
            }
            
            const rect = marker.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Position tooltip above the marker, centered
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 10;
            
            // Adjust if tooltip would go off screen
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) {
                top = rect.bottom + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            
            // Highlight region on hover
            const regionMarker = document.getElementById('region-marker-' + regionName);
            if (regionMarker && gameState.culture !== regionName) {
                regionMarker.style.borderColor = '#8b6914';
                regionMarker.style.background = 'rgba(139, 105, 20, 0.7)';
            }
        }
        
        function hideRegionTooltip() {
            const tooltip = document.getElementById('region-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
            
            // Restore region colors
            updateRegionMapHighlight();
        }
        
        function updateRegionMapHighlight() {
            const regions = ['Yorkshire', 'Kent', 'London', 'Cornwall', 'Lancashire', 'Essex', 'Norfolk', 'Somerset'];
            regions.forEach(function(region) {
                const marker = document.getElementById('region-marker-' + region);
                if (marker) {
                    if (gameState.culture === region) {
                        marker.style.borderColor = '#f4d03f';
                        marker.style.background = 'rgba(244, 208, 63, 0.8)';
                        marker.style.boxShadow = '0 0 12px rgba(244, 208, 63, 1)';
                        marker.style.transform = 'translate(-50%, -50%) scale(1.2)';
                    } else {
                        marker.style.borderColor = '#d4af37';
                        marker.style.background = 'rgba(212, 175, 55, 0.6)';
                        marker.style.boxShadow = '0 0 8px rgba(212, 175, 55, 0.8)';
                        marker.style.transform = 'translate(-50%, -50%) scale(1)';
                    }
                }
            });
        }
        
        function selectAgeRange(ageRangeId) {
            const ageRanges = {
                'youth': { numericAge: 18, statMods: { initiative: 2, agility: 1, endurance: -1, wits: -1 } },
                'young_adult': { numericAge: 22, statMods: { strength: 1, agility: 1, wits: -1 } },
                'prime': { numericAge: 27, statMods: { strength: 1, wits: 1 } },
                'veteran': { numericAge: 33, statMods: { wits: 2, endurance: 1, agility: -1 } },
                'old_hand': { numericAge: 38, statMods: { wits: 2, endurance: 1, charisma: 1, agility: -2, strength: -1 } }
            };
            
            const range = ageRanges[ageRangeId];
            if (!range) return;
            
            // Store the age range ID and numeric age
            gameState.ageRange = ageRangeId;
            gameState.age = range.numericAge;
            
            // Age-based stat modifiers are applied when priorities are recalculated
            // They're stored in gameState.ageRange for reference
            updateDisplay();
        }
        
        // Legacy function for backward compatibility (if called from elsewhere)
        function setAge(age) {
            if (age < 16 || age > 40) return;
            
            // Map numeric age to closest age range
            let ageRangeId = 'prime';
            if (age <= 19) ageRangeId = 'youth';
            else if (age <= 24) ageRangeId = 'young_adult';
            else if (age <= 30) ageRangeId = 'prime';
            else if (age <= 35) ageRangeId = 'veteran';
            else ageRangeId = 'old_hand';
            
            selectAgeRange(ageRangeId);
            
            const oldAge = gameState.age || 18;
            gameState.age = age;
            
            // Remove old age modifiers
            if (oldAge >= 16 && oldAge <= 19) {
                // Remove younger modifiers: -Initiative, +Endurance
                if (gameState.stats.initiative !== undefined) {
                    gameState.stats.initiative = Math.max(5, (gameState.stats.initiative || 5) - 1);
                }
                gameState.stats.endurance = Math.max(5, (gameState.stats.endurance || 5) + 1);
            } else if (oldAge >= 31 && oldAge <= 40) {
                // Remove older modifiers: -Endurance, +Agility
                gameState.stats.endurance = Math.max(5, (gameState.stats.endurance || 5) - 1);
                gameState.stats.agility = Math.max(5, (gameState.stats.agility || 5) + 1);
            }
            
            // Apply new age modifiers
            if (age >= 16 && age <= 19) {
                // Younger: +Initiative, -Endurance
                if (gameState.stats.initiative === undefined) {
                    gameState.stats.initiative = 5;
                }
                gameState.stats.initiative = (gameState.stats.initiative || 5) + 1;
                gameState.stats.endurance = Math.max(5, (gameState.stats.endurance || 5) - 1);
            } else if (age >= 31 && age <= 40) {
                // Older: +Endurance, -Agility
                gameState.stats.endurance = (gameState.stats.endurance || 5) + 1;
                gameState.stats.agility = Math.max(5, (gameState.stats.agility || 5) - 1);
            }
            
            // Clamp stats
            if (gameState.stats.initiative !== undefined) {
                gameState.stats.initiative = clampStat('initiative', gameState.stats.initiative);
            }
            gameState.stats.endurance = clampStat('endurance', gameState.stats.endurance);
            gameState.stats.agility = clampStat('agility', gameState.stats.agility);
            
            updateDisplay();
        }
        
        function selectOrigin(origin) {
            gameState.origin = origin;
            // Update button styles
            const origins = ['rural_peasant', 'manor_retainer', 'craftsman_apprentice', 'squire', 'minor_noble'];
            origins.forEach(o => {
                const btn = document.getElementById(`origin-${o}`);
                if (btn) {
                    if (o === origin) {
                        btn.style.background = '#d4af37';
                        btn.style.color = '#1a0f08';
                    } else {
                        btn.style.background = '#2a2a2a';
                        btn.style.color = '#d4af37';
                    }
                }
            });
            updateDisplay();
        }
        
        function answerBackgroundQuestion(questionId) {
            if (!gameState.backgroundQuestionsAnswered) {
                gameState.backgroundQuestionsAnswered = [];
            }
            
            // Don't allow answering the same question twice
            if (gameState.backgroundQuestionsAnswered.includes(questionId)) {
                return;
            }
            
            // Find the question
            const backgroundQuestions = [
                {
                    id: 'hard_father',
                    effects: { strength: 1, endurance: 1, charisma: -1 }
                },
                {
                    id: 'mangled_hand',
                    effects: { agility: -1, endurance: -1, wits: 3 }
                },
                {
                    id: 'lost_sibling',
                    effects: { wits: 1, endurance: 1, morale: -1 }
                },
                {
                    id: 'village_hero',
                    effects: { charisma: 1, reputation: 2, strength: -1 }
                },
                {
                    id: 'apprentice_master',
                    effects: { wits: 2, agility: 1, stress: 1 }
                },
                {
                    id: 'first_love',
                    effects: { charisma: -1, wits: 1, morale: 1 }
                }
            ];
            
            const question = backgroundQuestions.find(function(q) { return q.id === questionId; });
            if (!question) return;
            
            // Apply stat changes
            Object.entries(question.effects).forEach(function([stat, value]) {
                applyStatChange(stat, value);
            });
            
            // Mark as answered
            gameState.backgroundQuestionsAnswered.push(questionId);
            
            // Show notification
            const effectText = Object.entries(question.effects).map(function([stat, val]) {
                const sign = val > 0 ? '+' : '';
                const statName = stat.charAt(0).toUpperCase() + stat.slice(1);
                return sign + val + ' ' + statName;
            }).join(', ');
            
            showNotification('Background Question', 'Your past shapes you: ' + effectText);
            
            updateDisplay();
        }
        
        // Preset build templates for quick stat allocation
        function applyPresetBuild(presetKey) {
            const buildPresets = {
                balanced: {
                    name: "Balanced Warrior",
                    description: "All-around capable fighter",
                    stats: { strength: 7, agility: 7, endurance: 7, charisma: 6, wits: 6 }
                },
                strong: {
                    name: "Mighty Champion",
                    description: "Unmatched strength and endurance",
                    stats: { strength: 10, agility: 5, endurance: 9, charisma: 5, wits: 5 }
                },
                clever: {
                    name: "Cunning Scout",
                    description: "Quick and perceptive",
                    stats: { strength: 5, agility: 9, endurance: 6, charisma: 6, wits: 9 }
                },
                leader: {
                    name: "Charismatic Leader",
                    description: "Inspires and commands",
                    stats: { strength: 6, agility: 6, endurance: 6, charisma: 10, wits: 7 }
                }
            };
            
            const preset = buildPresets[presetKey];
            if (!preset) return;
            
            // Apply stats (all start at 5, so we add the difference)
            Object.keys(preset.stats).forEach(function(stat) {
                if (['strength', 'agility', 'endurance', 'charisma', 'wits'].includes(stat)) {
                    gameState.stats[stat] = preset.stats[stat];
                    gameState.stats[stat] = clampStat(stat, gameState.stats[stat]);
                }
            });
            
            showNotification('Preset Applied', preset.name + ': ' + preset.description, 'success');
            updateDisplay();
        }
        
        // Make a choice
        function makeChoice(choiceIndex) {
            const scene = scenes[gameState.currentScene];
            if (!scene) return;
            
            // Handle both function and array choices
            let choices = scene.choices;
            if (typeof choices === 'function') {
                try {
                    choices = choices();
                } catch (error) {
                    console.error('Error getting choices from function:', error);
                    showNotification('Error', 'Failed to get choices. Please refresh the page.');
                    return;
                }
            }
            
            if (!Array.isArray(choices) || !choices[choiceIndex]) {
                console.error('Invalid choice index or choices not an array:', choiceIndex, choices);
                return;
            }
            
            const choice = choices[choiceIndex];
            
            // Handle character creation validation
            if (gameState.currentScene === 'character_creation') {
                if (choice.requiresOrigin && !gameState.origin) {
                    showNotification('Character Creation', 'Please select an origin before continuing.');
                    return;
                }
                if (choice.requiresPatron && !gameState.patronId && !gameState.patron) {
                    showNotification('Character Creation', 'Please select a patron before continuing.');
                    return;
                }
                const nameInput = document.getElementById('character-name-input');
                if (nameInput) {
                    const trimmedName = nameInput.value.trim();
                    // Sanitize user input to prevent XSS
                    gameState.characterName = escapeHTML(trimmedName) || "William Thatcher";
                }
                if (!gameState.characterName || gameState.characterName === '') {
                    gameState.characterName = "William Thatcher";
                }
                
                // Validate priorities
                const priorityValidation = validatePrioritiesCompleteAndUnique();
                if (!priorityValidation.ok) {
                    showNotification('Character Creation', priorityValidation.message);
                    return;
                }
                // Validate region is selected
                if (!gameState.culture || gameState.culture === '') {
                    showNotification('Character Creation', 'Please select your region.');
                    return;
                }
                if (!gameState.ageRange) {
                    showNotification('Character Creation', 'Please select your age range.');
                    return;
                }
            }
            
            // Handle reset as direct action
            if (choice.nextScene === 'reset') {
                if (confirm('Are you sure you want to start a new game? All progress will be lost.')) {
                    resetGame();
                }
                return;
            }
            
            // Handle combat type choices
            if (choice.type === 'combat') {
                triggerCombat(choice.enemy, choice.winScene, choice.loseScene).catch(error => {
                    console.error('Combat error:', error);
                    // Fallback to normal scene transition on error
                    gameState.currentScene = choice.winScene;
                    updateDisplay();
                });
                return; // Exit early, combat will handle scene transition
            }
            
            // Apply stress cost for smart actions (BEFORE bad outcome check)
            if (choice.stressCost && choice.stressCost > 0) {
                applyStatChange('stress', choice.stressCost);
            }
            
            // Check for bad outcomes (if choice has bad outcome chance)
            let badOutcomeTriggered = false;
            let badOutcomeScene = null;
            if (choice.badOutcomeChance && choice.badOutcomes && choice.badOutcomes.length > 0) {
                const badChance = calculateBadOutcomeChance(
                    choice.badOutcomeChance,
                    choice.badOutcomeStupidity || 'neutral',
                    gameState.stats.luck,
                    gameState.equipment
                );
                
                const roll = Math.random() * 100;
                if (roll < badChance) {
                    const outcome = selectBadOutcome(choice.badOutcomes, badChance);
                    if (outcome) {
                        applyBadOutcome(outcome);
                        badOutcomeTriggered = true;
                        badOutcomeScene = outcome.nextScene;
                    }
                }
            }
            
            // Handle resolution system
            if (choice.requiresResolution) {
                const result = resolveAction(
                    choice.resolutionStat,
                    choice.resolutionDifficulty,
                    choice.resolutionBonus || 0
                );
                gameState.lastResolution = result;
                
                // Only apply generic consequences if explicitly requested
                // Most scenes handle their own consequences in onEnter
                if (choice.applyGenericResolution) {
                    if (!result.success) {
                        // Failure consequences - worse if margin is large
                        const woundSeverity = result.margin <= -3 ? 'Seriously Wounded' : 'Wounded';
                        if (choice.resolutionStat === 'strength' || choice.resolutionStat === 'endurance') {
                            addCondition(woundSeverity, 'negative', woundSeverity === 'Seriously Wounded' ? 3 : 2);
                            applyStatChange('endurance', woundSeverity === 'Seriously Wounded' ? -2 : -1);
                            gameState.career.wounds++;
                        }
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    } else {
                        // Success bonuses
                        applyStatChange('experience', 10);
                        applyStatChange('reputation', 1);
                        applyStatChange('morale', 1);
                        // NOTE: Success no longer automatically reduces stress
                        // Stress reduction should be explicit in choice effects
                        gameState.career.battles++;
                        // Small chance of patron favor on great success
                        if (result.margin >= 3) {
                            applyStatChange('patronFavor', 1);
                        }
                    }
                }
            }
            
            // Call onChoose callback if present (for kit granting, etc.)
            if (choice.onChoose && typeof choice.onChoose === 'function') {
                choice.onChoose();
            }
            
            // Apply effects with clamping (supports both object and function effects)
            if (choice.effects) {
                if (typeof choice.effects === 'function') {
                    // Function-based effects (used by campfire vignettes)
                    try {
                        choice.effects(gameState);
                        // Notification is handled inside the function for campfire scenes
                    } catch (error) {
                        console.error('Error applying function effects:', error);
                    }
                } else if (typeof choice.effects === 'object') {
                    // Object-based effects (standard format)
                    const effects = [];
                    Object.entries(choice.effects).forEach(([key, value]) => {
                        const actualChange = applyStatChange(key, value);
                        if (actualChange !== 0) {
                            effects.push(`${actualChange > 0 ? '+' : ''}${actualChange} ${key}`);
                        }
                    });
                    
                    if (effects.length > 0) {
                        showNotification('Stat Changes', effects.join(', '));
                    }
                }
            }
            
            // Track scene visited (before moving) - limit to last 100 to prevent unbounded growth
            gameState.scenesVisited.push(gameState.currentScene);
            if (gameState.scenesVisited.length > 100) {
                gameState.scenesVisited = gameState.scenesVisited.slice(-100);
            }
            
            // Move to next scene - bad outcome scene takes priority
            let nextSceneName;
            if (badOutcomeTriggered && badOutcomeScene) {
                // Bad outcome scene overrides normal next scene
                nextSceneName = badOutcomeScene;
            } else if (typeof choice.nextScene === 'function') {
                try {
                    nextSceneName = choice.nextScene();
                    console.log("nextScene function returned:", nextSceneName);
                    console.log("gameState.background:", gameState.background);
                } catch (error) {
                    console.error("Error executing nextScene function:", error);
                    console.error("Error stack:", error.stack);
                    showNotification('Error', 'Failed to determine next scene. Please refresh the page.');
                    return;
                }
            } else {
                nextSceneName = choice.nextScene;
            }
            
            // Validate that the next scene exists
            if (!nextSceneName || typeof nextSceneName !== 'string') {
                console.error("Invalid nextScene value:", nextSceneName);
                console.error("Type:", typeof nextSceneName);
                console.error("Choice:", choice);
                showNotification('Error', 'Invalid scene transition. Please refresh the page.');
                return;
            }
            
            if (!scenes[nextSceneName]) {
                console.error("Scene not found:", nextSceneName);
                console.error("Available scenes:", Object.keys(scenes).slice(0, 20));
                // Reset to safe state instead of breaking
                console.warn("Invalid scene, resetting to character_creation");
                gameState.currentScene = 'character_creation';
                showNotification('Error', 'Invalid scene transition. Resetting to character creation.');
                updateDisplay();
                return;
            }
            
            // Check if we should insert a campfire interlude
            let finalNextScene = maybeInsertCampfire(nextSceneName);
            
            // Check if we should insert a random encounter (only if not inserting campfire)
            if (finalNextScene === nextSceneName) {
                finalNextScene = maybeInsertRandomEncounter(nextSceneName);
            }
            
            gameState.currentScene = finalNextScene;
            
            // Check for arbitrary death events (after scene transition, before display)
            const deathEvent = checkArbitraryDeath();
            if (deathEvent) {
                // Check if player can spend to avoid death (if avoidScene and avoidCost are defined)
                if (deathEvent.avoidScene && deathEvent.avoidCost !== undefined) {
                    const wealth = gameState.stats.wealth || 0;
                    if (wealth >= deathEvent.avoidCost) {
                        // Player can afford to avoid death - go to avoidance scene
                        gameState.currentScene = deathEvent.avoidScene;
                    } else {
                        // Player cannot afford - go to death scene
                        gameState.currentScene = deathEvent.nextScene;
                    }
                } else {
                    // No avoidance option - go straight to death
                    gameState.currentScene = deathEvent.nextScene;
                }
                // Remove fade-in class and re-add for animation
                document.getElementById('story').classList.remove('fade-in');
                setTimeout(() => {
                    updateDisplay();
                }, 100);
                return;
            }
            
            // Check for stress cap psychological disorders
            checkStressCapDisorders();
            
            // Check for chapter transitions
            checkChapterTransition();
            
            // Remove fade-in class and re-add for animation
            document.getElementById('story').classList.remove('fade-in');
            setTimeout(() => {
                updateDisplay();
            }, 100);
        }
        
        // Show notification
        // Enhanced toast notification system with types
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.warn('Notification element not found');
                return;
            }
            
            // Type-based styling
            const typeColors = {
                success: { bg: '#4CAF50', border: '#2e7d32', icon: '‚úì' },
                error: { bg: '#f44336', border: '#c62828', icon: '‚úó' },
                info: { bg: '#2196F3', border: '#1565C0', icon: '‚Ñπ' },
                warning: { bg: '#FF9800', border: '#E65100', icon: '‚ö†' }
            };
            
            const colors = typeColors[type] || typeColors.info;
            
            // Sanitize title and message to prevent XSS
            const safeTitle = escapeHTML(String(title));
            const safeMessage = escapeHTML(String(message));
            notification.innerHTML = `<h3 style="color: white; margin: 0 0 5px 0; display: flex; align-items: center; gap: 8px;"><span style="font-size: 1.2em;">${colors.icon}</span> ${safeTitle}</h3><p style="color: #e0e0e0; margin: 0;">${safeMessage}</p>`;
            notification.style.backgroundColor = colors.bg;
            notification.style.borderColor = colors.border;
            notification.classList.remove('hidden');
            
            // Make it more prominent
            notification.style.display = 'block';
            notification.style.opacity = '1';
            notification.style.zIndex = '10000';
            
            // Auto-hide after 3 seconds with fade
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    notification.classList.add('hidden');
                    notification.style.display = 'none';
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 300);
            }, 3000);
        }
        
        // Save/Load System Constants
        const SAVE_KEY = "manAtArmsGame";
        const SAVE_VERSION = 1;
        
        /** Fresh default state (use this for reset + load fallback) */
        function makeDefaultGameState() {
            return {
                stats: {
                    strength: 5,
                    agility: 5,
                    endurance: 5,
                    charisma: 5,
                    luck: 5,
                    wits: 5,
                    wealth: 10,
                    reputation: 0,
                    morale: 5,
                    stress: 0,
                    experience: 0,
                    patronFavor: 0,
                    initiative: 5
                },
                faction: "English",
                age: 18,
                year: 1337,
                location: "England",
                region: "England", // Add region for equipment system
                currentScene: "character_creation",
                characterName: "William Thatcher",
                culture: "",
                origin: null,
                patronId: null, // Patron selection ID
                patron: null, // Legacy field for backward compatibility
                patronEventPath: null, // Convenience copy of PATRONS[patronId].eventPath
                startingKitTier: null, // Resolved after priorities + patron
                background: null, // Keep for backward compatibility
                backgroundQuestionsAnswered: [],
        scenesVisited: [],
        enteredScenes: new Set(),
        inventory: [], // Starting kit will be granted by priority system
                equipment: {
                    head: {},
                    torso: {},
                    arms: {},
                    legs: {},
                    weapon: {},
                    missile: {},
                    accessory: {},
                    bag: []
                },
                conditions: [],
                flags: {},
                rank: "Common Soldier",
                relationships: { wat: 0, cook: 0 },
                campfire: {
                    cooldownScenes: 2,
                    chance: 0.35,
                    lastInsertedAtIndex: 0,
                    seenIds: [],
                    returnScene: null,
                    currentVignetteId: null,
                    currentStep: 0,
                    stepHistory: [],
                    currentResponse: null
                },
                randomEncounter: {
                    cooldown: 0,
                    lastInsertedAt: -1,
                    returnScene: null
                },
                career: {
                    battles: 0,
                    wounds: 0,
                    promotions: 0
                },
                chapter: null, // Current chapter: "chevauch√©e", "calais", "plague", "poitiers"
                chapterProgress: {
                    chevauch√©e: { started: false, completed: false },
                    calais: { started: false, completed: false },
                    plague: { started: false, completed: false },
                    poitiers: { started: false, completed: false }
                },
                lastResolution: null,
                priorities: {
                    might: null,
                    finesse: null,
                    wits: null,
                    presence: null,
                    fortune: null
                },
                kitTier: "Standard",
                startingKitGranted: false
            };
        }
        
        /** Defensive number parsing */
        function asNumber(v, fallback = 0) {
            const n = Number(v);
            return Number.isFinite(n) ? n : fallback;
        }
        
        /** Merge loaded data into defaults without losing nested defaults */
        function hydrateLoadedState(loaded) {
            const base = makeDefaultGameState();
            
            if (!loaded || typeof loaded !== "object") return base;
            
            // Top-level primitives/arrays/objects (shallow)
            Object.assign(base, loaded);
            
            // Deep-merge nested objects you rely on
            base.stats = { ...base.stats, ...(loaded.stats || {}) };
            base.flags = { ...base.flags, ...(loaded.flags || {}) };
            base.chapterProgress = { ...base.chapterProgress, ...(loaded.chapterProgress || {}) };
            base.relationships = { ...base.relationships, ...(loaded.relationships || {}) };
            base.career = { ...base.career, ...(loaded.career || {}) };
            
            // Equipment (handle both old and new format)
            if (loaded.equipment) {
                // New layered format
                if (loaded.equipment.head && typeof loaded.equipment.head === 'object' && !loaded.equipment.head.id) {
                    base.equipment = {
                        head: { ...base.equipment.head, ...(loaded.equipment.head || {}) },
                        torso: { ...base.equipment.torso, ...(loaded.equipment.torso || {}) },
                        arms: { ...base.equipment.arms, ...(loaded.equipment.arms || {}) },
                        legs: { ...base.equipment.legs, ...(loaded.equipment.legs || {}) },
                        weapon: { ...base.equipment.weapon, ...(loaded.equipment.weapon || {}) },
                        missile: { ...base.equipment.missile, ...(loaded.equipment.missile || {}) },
                        accessory: { ...base.equipment.accessory, ...(loaded.equipment.accessory || {}) },
                        bag: Array.isArray(loaded.equipment.bag) ? loaded.equipment.bag : []
                    };
                } else {
                    // Old format - will be migrated by EquipmentManager
                    base.equipment = { ...base.equipment, ...loaded.equipment };
                }
            }
            
            // Restore Set from array
            base.enteredScenes = new Set(Array.isArray(loaded.enteredScenes) ? loaded.enteredScenes : []);
            
            // Sanitize arrays
            base.scenesVisited = Array.isArray(loaded.scenesVisited) ? loaded.scenesVisited : [];
            base.inventory = Array.isArray(loaded.inventory) ? loaded.inventory : [];
            base.conditions = Array.isArray(loaded.conditions) ? loaded.conditions : [];
            base.backgroundQuestionsAnswered = Array.isArray(loaded.backgroundQuestionsAnswered) ? loaded.backgroundQuestionsAnswered : [];
            
            // Priorities system
            base.priorities = base.priorities || { might: null, finesse: null, wits: null, presence: null, fortune: null };
            if (typeof base.priorities !== "object") {
                base.priorities = { might: null, finesse: null, wits: null, presence: null, fortune: null };
            }
            // Ensure all priority keys exist
            ['might', 'finesse', 'wits', 'presence', 'fortune'].forEach(function(key) {
                if (!(key in base.priorities)) {
                    base.priorities[key] = null;
                }
            });
            
            base.kitTier = typeof base.kitTier === "string" ? base.kitTier : "Standard";
            base.startingKitGranted = typeof base.startingKitGranted === "boolean" ? base.startingKitGranted : false;
            
            // Patron fields hydration
            base.patronId = (typeof base.patronId === "string") ? base.patronId : null;
            // Backward compatibility: if old 'patron' field exists but patronId doesn't, migrate it
            if (!base.patronId && base.patron && typeof base.patron === "string") {
                base.patronId = base.patron;
            }
            base.patronEventPath = (typeof base.patronEventPath === "string") ? base.patronEventPath : null;
            base.startingKitTier = (typeof base.startingKitTier === "string") ? base.startingKitTier : null;
            
            // Relationships hydration
            base.relationships = base.relationships && typeof base.relationships === "object"
                ? { 
                    wat: Math.max(-5, Math.min(5, Number(base.relationships.wat) || 0)),
                    cook: Math.max(-5, Math.min(5, Number(base.relationships.cook) || 0))
                }
                : { wat: 0, cook: 0 };
            
            // Campfire hydration
            base.campfire = base.campfire && typeof base.campfire === "object" ? base.campfire : {};
            base.campfire.cooldownScenes = Number(base.campfire.cooldownScenes) || 2;
            base.campfire.chance = Number(base.campfire.chance) || 0.35;
            base.campfire.lastInsertedAtIndex = Number(base.campfire.lastInsertedAtIndex) || 0;
            base.campfire.seenIds = Array.isArray(base.campfire.seenIds) ? base.campfire.seenIds : [];
            base.campfire.returnScene = (typeof base.campfire.returnScene === "string") ? base.campfire.returnScene : null;
            base.campfire.currentVignetteId = (typeof base.campfire.currentVignetteId === "string") ? base.campfire.currentVignetteId : null;
            
            // Recalculate stats from priorities if priorities are set (for loaded saves)
            if (base.priorities && Object.values(base.priorities).some(function(p) { return p !== null && p !== ''; })) {
                // Temporarily set gameState to base for recalculation
                const tempGameState = gameState;
                gameState = base;
                recalculateFromPriorities();
                // Restore gameState
                gameState = tempGameState;
                // Stats are now updated in base
            }
            
            // Clamp + coerce numeric stats
            for (const key of Object.keys(base.stats)) {
                base.stats[key] = clampStat(key, asNumber(base.stats[key], makeDefaultGameState().stats[key]));
            }
            
            // Coerce other numeric fields that matter
            base.age = asNumber(base.age, 18);
            base.year = asNumber(base.year, 1337);
            
            // Ensure strings
            base.location = typeof base.location === "string" ? base.location : "England";
            base.region = typeof base.region === "string" ? base.region : (base.location ? normalizeRegion(base.location) : "England");
            // Don't reset currentScene to character_creation if we have a valid saved scene
            base.currentScene = typeof base.currentScene === "string" && base.currentScene !== "" ? base.currentScene : "character_creation";
            base.characterName = typeof base.characterName === "string" && base.characterName !== "" ? base.characterName : "William Thatcher";
            base.culture = typeof base.culture === "string" ? base.culture : "";
            base.origin = base.origin || null;
            // Preserve background if it exists (don't reset to null) - backward compatibility
            base.background = base.background || null;
            base.rank = typeof base.rank === "string" ? base.rank : "Common Soldier";
            base.faction = typeof base.faction === "string" ? base.faction : "English";
            
            // Ensure inventory is an array
            if (!Array.isArray(base.inventory)) {
                base.inventory = [];
            }
            
            return base;
        }
        
        /** Normalize location to region (helper for migration) */
        function normalizeRegion(location) {
            if (!location) return 'England';
            const loc = location.toLowerCase();
            if (loc.includes('england') || loc.includes('portsmouth') || loc.includes('london')) return 'England';
            if (loc.includes('france') || loc.includes('normandy') || loc.includes('caen') || loc.includes('calais')) return 'France';
            if (loc.includes('flanders')) return 'Flanders';
            if (loc.includes('italy') || loc.includes('milan')) return 'Northern Italy';
            return 'England';
        }
        
        // Save game
        function saveGame() {
            try {
                // Build a JSON-safe payload (no Sets)
                const saveData = {
                    saveVersion: SAVE_VERSION,
                    ...gameState,
                    enteredScenes: Array.from(gameState.enteredScenes)
                };
                
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
                showNotification("Game Saved", "Your progress has been saved!", "success");
            } catch (err) {
                console.error("Save failed:", err);
                showNotification("Save Failed", "Could not save (storage full or blocked).", "error");
            }
        }
        
        // Load game
        function loadGame() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
                showNotification("No Save Found", "No saved game found.", "error");
                return;
            }
            
            let loaded;
            try {
                loaded = JSON.parse(raw);
            } catch (err) {
                console.error("Corrupt save:", err);
                showNotification("Load Failed", "Save data is corrupted.", "error");
                return;
            }
            
            // Optional: handle future migrations here
            const version = asNumber(loaded.saveVersion, 0);
            if (version > SAVE_VERSION) {
                showNotification("Load Failed", "Save was made by a newer version of the game.", "error");
                return;
            }
            
            const hydrated = hydrateLoadedState(loaded);
            
            console.log("Loaded state hydrated:", hydrated);
            console.log("Current scene:", hydrated.currentScene);
            console.log("Background:", hydrated.background);
            
            // Overwrite the existing live state safely
            Object.keys(gameState).forEach(k => delete gameState[k]);
            Object.assign(gameState, hydrated);
            
            // Ensure enteredScenes is a Set (hydrateLoadedState should handle this, but double-check)
            if (!(gameState.enteredScenes instanceof Set)) {
                gameState.enteredScenes = new Set(Array.isArray(gameState.enteredScenes) ? gameState.enteredScenes : []);
            }
            
            // Sanitize user-controlled fields from save data to prevent XSS
            if (gameState.characterName) {
                gameState.characterName = escapeHTML(String(gameState.characterName));
            }
            
            // Reinitialize equipment manager if it exists (will migrate old format)
            if (typeof EquipmentManager !== 'undefined') {
                try {
                    window.equipmentManager = new EquipmentManager(gameState);
                } catch (e) {
                    console.error("Error reinitializing equipment manager:", e);
                }
            }
            
            // Force update display to ensure UI reflects loaded state
            updateDisplay();
            showNotification("Game Loaded", "Your progress has been restored!", "success");
        }
        
        // Show full stats
        function showStats() {
            try {
                const statLabels = {
                    strength: '‚öîÔ∏è Strength',
                    agility: 'üèÉ Agility',
                    endurance: '‚ù§Ô∏è Endurance',
                    charisma: 'üí¨ Charisma',
                    wits: 'üß† Wits',
                    luck: 'üçÄ Luck',
                    wealth: 'üí∞ Wealth',
                    reputation: '‚≠ê Reputation',
                    morale: 'üí™ Morale',
                    stress: 'üò∞ Stress',
                    experience: 'üìú Experience',
                    patronFavor: 'üëë Patron Favor'
                };
                
                const stats = Object.entries(gameState.stats)
                    .map(([key, value]) => {
                        const effective = getEffectiveStat(key);
                        const label = statLabels[key] || key;
                        return effective !== value 
                            ? `${label}: ${value} (Effective: ${effective})`
                            : `${label}: ${value}`;
                    })
                    .join('\n');
                
                const conditions = gameState.conditions.length > 0 
                    ? gameState.conditions.map(c => `‚Ä¢ ${c.name}${c.duration ? ` (${c.duration} turns remaining)` : ''}`).join('\n')
                    : 'None';
                
                const career = `Battles: ${gameState.career.battles}\nWounds: ${gameState.career.wounds}\nPromotions: ${gameState.career.promotions}`;
                
                // Handle equipment display for both old and new format
                let equipment = 'None equipped';
                try {
                    if (gameState.equipment && gameState.equipment.weapon && gameState.equipment.weapon.name) {
                        // Old format
                        equipment = `Weapon: ${gameState.equipment.weapon.name} (+${gameState.equipment.weapon.quality || 0})\nArmor: ${gameState.equipment.armor?.name || 'None'} (+${gameState.equipment.armor?.quality || 0})`;
                    } else if (gameState.equipment && (gameState.equipment.weapon?.item || gameState.equipment.torso?.plate?.item)) {
                        // New layered format
                        const equipped = [];
                        if (gameState.equipment.weapon?.item) equipped.push(`Weapon: ${gameState.equipment.weapon.item.id}`);
                        if (gameState.equipment.torso?.plate?.item) equipped.push(`Torso: ${gameState.equipment.torso.plate.item.id}`);
                        if (gameState.equipment.head?.plate?.item) equipped.push(`Head: ${gameState.equipment.head.plate.item.id}`);
                        equipment = equipped.length > 0 ? equipped.join('\n') : 'None equipped';
                    }
                } catch (e) {
                    console.error("Error formatting equipment:", e);
                    equipment = 'Error loading equipment';
                }
                
                const inventoryCount = gameState.inventory ? gameState.inventory.length : 0;
                
                // Create modal instead of alert
                const modal = document.createElement('div');
                modal.className = 'stats-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: #1a0f08;
                        border: 3px solid #d4af37;
                        border-radius: 10px;
                        padding: 30px;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                        color: #d4af37;
                        font-family: 'Crimson Text', serif;
                    ">
                        <h2 style="color: #f4d03f; margin-bottom: 20px; text-align: center;">üìä Full Character Stats</h2>
                        <div style="line-height: 1.8; font-size: 1.1em;">
                            <h3 style="color: #f4d03f; margin-top: 15px;">Stats:</h3>
                            <pre style="color: #d4af37; white-space: pre-wrap; font-family: inherit; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">${stats}</pre>
                            
                            <h3 style="color: #f4d03f; margin-top: 15px;">Character Info:</h3>
                            <p>Name: ${escapeHTML(gameState.characterName || 'Unnamed')}</p>
                            <p>Age: ${gameState.age}</p>
                            <p>Year: ${gameState.year}</p>
                            <p>Location: ${gameState.location}</p>
                            <p>Region: ${gameState.region || 'Unknown'}</p>
                            <p>Rank: ${gameState.rank || 'Common Soldier'}</p>
                            <p>Background: ${gameState.background ? gameState.background.charAt(0).toUpperCase() + gameState.background.slice(1) : 'None'}</p>
                            
                            <h3 style="color: #f4d03f; margin-top: 15px;">Equipment:</h3>
                            <pre style="color: #d4af37; white-space: pre-wrap; font-family: inherit; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">${equipment}</pre>
                            <p>Inventory Items: ${inventoryCount}</p>
                            
                            <h3 style="color: #f4d03f; margin-top: 15px;">Conditions:</h3>
                            <pre style="color: #d4af37; white-space: pre-wrap; font-family: inherit; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">${conditions}</pre>
                            
                            <h3 style="color: #f4d03f; margin-top: 15px;">Career:</h3>
                            <pre style="color: #d4af37; white-space: pre-wrap; font-family: inherit; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">${career}</pre>
                        </div>
                        <button onclick="this.closest('.stats-modal').remove()" 
                                style="
                                    margin-top: 20px;
                                    padding: 10px 20px;
                                    background: #8b0000;
                                    border: 2px solid #d4af37;
                                    color: #d4af37;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    font-size: 16px;
                                    font-family: inherit;
                                    width: 100%;
                                ">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
                // Close on Escape key
                const closeHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', closeHandler);
                    }
                };
                document.addEventListener('keydown', closeHandler);
                
            } catch (error) {
                console.error("Error in showStats:", error);
                showNotification('Error', `Error displaying stats: ${error.message}`);
            }
        }
        
        // Reset game
        function resetGame() {
            const fresh = makeDefaultGameState();
            Object.keys(gameState).forEach(k => delete gameState[k]);
            Object.assign(gameState, fresh);
            updateDisplay();
        }
        
        // Equipment UI Integration (declared once at top level)
        var equipmentUI = null;
        var equipmentManager = null;
        
        function initializeEquipmentSystem() {
            // Initialize equipment manager - check if already initialized to prevent duplicates
            if (typeof EquipmentManager !== 'undefined' && 
                typeof EQUIPMENT_DATABASE !== 'undefined' && 
                !equipmentManager && !window.equipmentManager) {
                try {
                    equipmentManager = new EquipmentManager(gameState);
                    window.equipmentManager = equipmentManager; // Ensure window reference
                    
                    // Initialize equipment UI
                    if (typeof EquipmentUI !== 'undefined' && !equipmentUI) {
                        equipmentUI = new EquipmentUI(gameState, equipmentManager);
                        window.equipmentUI = equipmentUI; // Make globally accessible
                    }
                } catch (e) {
                    console.error("Failed to initialize equipment system:", e);
                    // Gracefully degrade - game still playable without equipment
                }
            } else if (window.equipmentManager && !equipmentManager) {
                // If window.equipmentManager exists but local doesn't, sync them
                equipmentManager = window.equipmentManager;
            }
        }
        
        function openEquipmentScreen() {
            console.log('Opening equipment screen...');
            console.log('EquipmentUI available:', typeof EquipmentUI !== 'undefined');
            console.log('EquipmentManager available:', typeof EquipmentManager !== 'undefined');
            console.log('EQUIPMENT_DATABASE available:', typeof EQUIPMENT_DATABASE !== 'undefined');
            console.log('Current inventory:', gameState.inventory);
            
            if (!equipmentUI) {
                console.log('Initializing equipment system...');
                initializeEquipmentSystem();
            }
            if (equipmentUI) {
                try {
                    equipmentUI.open();
                    console.log('Equipment screen opened successfully');
                } catch (error) {
                    console.error('Error opening equipment screen:', error);
                    showNotification('Equipment Error', 'Could not open equipment screen. Check console (F12) for details.');
                }
            } else {
                console.error('Equipment UI not initialized');
                showNotification('Equipment System', 'Equipment system not loaded. Please refresh the page.');
            }
        }
        
        function closeEquipmentScreen() {
            if (equipmentUI) {
                equipmentUI.close();
            }
        }
        
        // Global error handlers for debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error || e.message, e.filename, e.lineno);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
        
        // Initialize on load
        window.addEventListener('load', function() {
            // Hide loading message immediately, even if initialization fails
            try {
                const loadingMsg = document.getElementById('loading-message');
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
            } catch (e) {
                console.error('Error hiding loading message:', e);
            }
            
            // Check required modules before initialization
            function checkRequiredModules() {
                const missing = [];
                
                // Check EquipmentManager
                if (typeof EquipmentManager === 'undefined') {
                    missing.push('Equipment system not loaded');
                }
                
                // Check EquipmentUI
                if (typeof EquipmentUI === 'undefined') {
                    missing.push('Equipment UI not loaded');
                }
                
                // Check EQUIPMENT_DATABASE (global constant)
                try {
                    if (typeof EQUIPMENT_DATABASE === 'undefined') {
                        missing.push('Equipment database not loaded');
                    }
                } catch (e) {
                    missing.push('Equipment database not loaded');
                }
                
                // Check ENEMY_PROFILES (global constant)
                try {
                    if (typeof ENEMY_PROFILES === 'undefined') {
                        missing.push('Enemy profiles not loaded');
                    }
                } catch (e) {
                    missing.push('Enemy profiles not loaded');
                }
                
                if (missing.length > 0) {
                    showNotification('Missing Modules', 
                        'Some game files failed to load:\n' + missing.join('\n') + 
                        '\n\nPlease refresh the page.', 
                        'error'
                    );
                    return false;
                }
                return true;
            }
            
            // Check modules, but still try to initialize (game may be partially playable)
            const modulesOk = checkRequiredModules();
            
            // Initialize game with error handling
            // Even if modules are missing, try to start the game (it may be playable without equipment)
            try {
                // Small delay to ensure DOM is fully ready
                setTimeout(function() {
                    try {
                        initGame();
                    } catch (error) {
                        console.error('Fatal error during initialization:', error);
                        const storyEl = document.getElementById('story');
                        const loadingMsg = document.getElementById('loading-message');
                        if (loadingMsg) {
                            loadingMsg.style.display = 'none';
                        }
                        if (storyEl) {
                            storyEl.innerHTML = '<p style="color: red; padding: 20px;">Error initializing game. Please check the browser console for details.</p><p style="color: #d4af37;">Error: ' + escapeHTML(String(error.message || 'Unknown error')) + '</p><p style="margin-top: 20px;"><button onclick="location.reload()" style="padding: 10px 20px; background: #d4af37; border: none; color: #1a0f08; border-radius: 5px; cursor: pointer; font-weight: bold;">Reload Page</button></p>';
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Fatal error setting up initialization:', error);
                const storyEl = document.getElementById('story');
                const loadingMsg = document.getElementById('loading-message');
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }
                if (storyEl) {
                    storyEl.innerHTML = '<p style="color: red; padding: 20px;">Critical error. Please refresh the page.</p><p>Error: ' + escapeHTML(String(error.message || 'Unknown error')) + '</p>';
                }
            }
            // Equipment system will be initialized by initGame() or on first use
        });
    </script>
</body>
</html>
