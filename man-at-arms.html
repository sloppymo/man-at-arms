<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Man-at-Arms' Life - 100 Years War</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #1a0f08 0%, #2c1810 50%, #1a0f08 100%);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(139, 105, 20, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.05) 0%, transparent 50%);
            color: #d4af37;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid #8b6914;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9), inset 0 0 20px rgba(139, 105, 20, 0.1);
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #8b6914;
            padding-bottom: 20px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .header::after {
            content: '‚öîÔ∏è';
            position: absolute;
            left: 50%;
            bottom: -15px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 0 15px;
            font-size: 1.5em;
        }
        
        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.8em;
            text-shadow: 3px 3px 6px #000, 0 0 10px rgba(212, 175, 55, 0.3);
            margin: 0;
            letter-spacing: 2px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(139, 105, 20, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 1em;
            border: 1px solid rgba(212, 175, 55, 0.2);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .story-text {
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-left: 5px solid #d4af37;
            margin: 25px 0;
            line-height: 1.9;
            font-size: 1.15em;
            min-height: 200px;
            border-radius: 5px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .story-text p {
            margin-bottom: 15px;
        }
        
        .story-text p:last-child {
            margin-bottom: 0;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .stat-item {
            background: rgba(139, 105, 20, 0.15);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .stat-bar {
            background: #1a0f08;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #8b6914;
            position: relative;
        }
        
        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b6914, #d4af37, #f4d03f);
            transition: width 0.5s ease;
            box-shadow: inset 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .stat-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            font-size: 0.9em;
        }
        
        .stat-special {
            font-size: 0.95em;
            margin-top: 5px;
            color: #f4d03f;
        }
        
        .choices {
            margin-top: 30px;
        }
        
        .choices-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px #000;
        }
        
        .choice-button {
            display: block;
            width: 100%;
            background: rgba(139, 105, 20, 0.25);
            border: 2px solid #8b6914;
            color: #d4af37;
            padding: 18px 25px;
            margin: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .choice-button::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: rgba(212, 175, 55, 0.1);
            transition: width 0.3s ease;
        }
        
        .choice-button:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
            transform: translateX(8px);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        .choice-button:hover::before {
            width: 100%;
        }
        
        .choice-button:active {
            transform: translateX(5px);
        }
        
        .choice-effects {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 8px;
            font-style: italic;
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .control-button {
            background: rgba(139, 105, 20, 0.3);
            border: 1px solid #8b6914;
            color: #d4af37;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s;
        }
        
        .control-button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #d4af37;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification h3 {
            margin-bottom: 8px;
            color: #f4d03f;
        }
        
        .hidden {
            display: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .condition-badge {
            display: inline-block;
            background: rgba(139, 69, 19, 0.3);
            border: 1px solid #8b4513;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin: 2px;
        }
        
        .condition-badge.positive {
            background: rgba(34, 139, 34, 0.3);
            border-color: #228b22;
        }
        
        .condition-badge.negative {
            background: rgba(139, 0, 0, 0.3);
            border-color: #8b0000;
        }
        
        .rank-display {
            font-size: 1.1em;
            color: #f4d03f;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .dice-roll {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Cinzel', serif;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-panel {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
            }
        }
        
        /* ===== COMBAT SYSTEM STYLES ===== */
        .action-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-button {
            padding: 20px;
            background: #2a2a2a;
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Crimson Text', serif;
            transition: all 0.2s;
            text-align: center;
        }
        
        .action-button:hover:not(:disabled) {
            background: #3a3a3a;
            border-color: #f4d03f;
            color: #f4d03f;
            transform: translateY(-2px);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-button.selected {
            background: #d4af37;
            color: #1a0f08;
            font-weight: bold;
        }
        
        .action-button.flurry {
            border-color: #f00;
            color: #f00;
        }
        
        .action-button.flurry:hover:not(:disabled) {
            border-color: #f80;
            color: #f80;
        }
        
        .action-button.flurry.selected {
            background: #f00;
            color: white;
        }
        
        .action-details {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        
        .actions-remaining {
            text-align: center;
            color: #f4d03f;
            font-size: 20px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
        }
        
        .combat-log {
            margin-top: 20px;
            padding: 20px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid #d4af37;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .combat-log h3 {
            color: #f4d03f;
            margin-bottom: 15px;
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .log-entry.success {
            border-left: 3px solid #0f0;
        }
        
        .log-entry.failure {
            border-left: 3px solid #f00;
        }
        
        .log-entry.info {
            border-left: 3px solid #d4af37;
        }
        
        /* Combat Overlay - Must be above equipment screen (z-index 2000+) */
        #minigame-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2500;
            align-items: center;
            justify-content: center;
        }
        
        #minigame-content {
            background: #1a0f08;
            border: 3px solid #d4af37;
            padding: 40px;
            border-radius: 10px;
            max-width: 700px;
            text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        }
        
        #minigame-title {
            color: #f4d03f;
            margin-bottom: 10px;
            font-size: 28px;
            font-family: 'Cinzel', serif;
        }
        
        #minigame-subtitle {
            color: #888;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        #minigame-display {
            margin: 20px 0;
        }
        
        #minigame-instructions {
            color: #d4af37;
            margin-top: 20px;
            font-size: 18px;
        }
        
        .combat-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 5px;
        }
        
        .progress-item {
            text-align: center;
        }
        
        .progress-item.active {
            color: #f4d03f;
            font-weight: bold;
        }
        
        /* QTE Styles */
        .qte-bar-container {
            width: 600px;
            height: 50px;
            background: #333;
            border: 3px solid #666;
            position: relative;
            margin: 30px auto;
            border-radius: 5px;
        }
        
        .qte-green-zone {
            position: absolute;
            height: 100%;
            background: rgba(0, 255, 0, 0.4);
            border: 2px solid #0f0;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            transition: left 0.05s linear;
        }
        
        .qte-indicator {
            position: absolute;
            top: 0;
            width: 8px;
            height: 100%;
            background: #f4d03f;
            box-shadow: 0 0 15px #f4d03f;
        }
        
        .health-bars {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .health-bar-container {
            width: 200px;
        }
        
        .health-bar-label {
            color: #d4af37;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .health-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 2px solid #666;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #0f0, #0a0);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .health-fill.low {
            background: linear-gradient(90deg, #f00, #a00);
        }
        
        .health-fill.medium {
            background: linear-gradient(90deg, #fa0, #a50);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>A MAN-AT-ARMS' LIFE</h1>
            <div class="status-bar">
                <div class="status-item">
                    <span>üìÖ</span>
                    <span>Year: <strong id="year">1337</strong></span>
                </div>
                <div class="status-item">
                    <span>üë§</span>
                    <span>Age: <strong id="age">18</strong></span>
                </div>
                <div class="status-item">
                    <span>üìç</span>
                    <span>Location: <strong id="location">France</strong></span>
                </div>
            </div>
        </div>
        
        <div class="story-text" id="story">
            <p id="loading-message">Loading...</p>
        </div>
        
        <div class="stats-panel" id="stats">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <div class="choices">
            <div class="choices-title">What do you do?</div>
            <div id="choices-container">
                <!-- Choices will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="controls">
            <button class="control-button" onclick="saveGame()">üíæ Save Game</button>
            <button class="control-button" onclick="loadGame()">üìÇ Load Game</button>
            <button class="control-button" onclick="showStats()">üìä Full Stats</button>
            <button class="control-button" onclick="openEquipmentScreen()">üõ°Ô∏è Equipment</button>
            <button class="control-button" onclick="toggleEffectsPreview()">üëÅÔ∏è <span id="effects-toggle">Show</span> Effects</button>
        </div>
    </div>
    
    <!-- Equipment Screen -->
    <div id="equipment-screen" class="equipment-screen hidden">
        <div class="equipment-screen-content">
            <div class="equipment-header">
                <h2>Equipment & Inventory</h2>
                <button class="close-button" onclick="closeEquipmentScreen()" aria-label="Close equipment screen">√ó</button>
            </div>
            <div class="equipment-layout">
                <div class="equipment-left">
                    <div id="inventory-container"></div>
                </div>
                <div class="equipment-center">
                    <div id="paper-doll-container"></div>
                </div>
                <div class="equipment-right">
                    <div id="kit-stats-container"></div>
                </div>
            </div>
        </div>
        <div id="equipment-aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    </div>
    
    <div id="notification" class="notification hidden"></div>
    
    <!-- Equipment System Scripts -->
    <script src="man-at-arms-equipment-system.js"></script>
    <script src="man-at-arms-equipment-ui.js"></script>
    <script src="man-at-arms-enemy-profiles.js"></script>
    
    <!-- Combat Overlay -->
    <div id="minigame-overlay">
        <div id="minigame-content">
            <h3 id="minigame-title"></h3>
            <div id="minigame-subtitle"></div>
            <div class="health-bars">
                <div class="health-bar-container">
                    <div class="health-bar-label">Your Health</div>
                    <div class="health-bar">
                        <div class="health-fill" id="player-health-bar" style="width: 100%;">100</div>
                    </div>
                </div>
                <div class="health-bar-container">
                    <div class="health-bar-label">Enemy Health</div>
                    <div class="health-bar">
                        <div class="health-fill" id="enemy-health-bar" style="width: 100%;">100</div>
                    </div>
                </div>
            </div>
            <div class="combat-progress" id="combat-progress"></div>
            <div id="minigame-display"></div>
            <div id="minigame-instructions"></div>
            <div class="combat-log" id="combat-log" style="margin-top: 20px; max-height: 200px; overflow-y: auto;">
                <h3 style="color: #f4d03f; margin-bottom: 10px; font-size: 16px;">Combat Log</h3>
            </div>
        </div>
    </div>

    <script>
        // Settings
        let showEffectsPreview = false;
        
        // Game State
        const gameState = {
            stats: {
                strength: 5,
                agility: 5,
                endurance: 5,
                charisma: 5,
                luck: 5,
                wits: 5, // Intelligence, tactical thinking
                wealth: 10,
                reputation: 0,
                morale: 5,
                stress: 0, // Stress/fatigue meter (separate from conditions)
                experience: 0,
                patronFavor: 0
            },
            faction: "English", // Player faction
            age: 18,
            year: 1337,
            location: "England",
            currentScene: "character_creation",
            characterName: "",
            background: null,
            scenesVisited: [],
            enteredScenes: new Set(), // Track scenes that have had onEnter called
            inventory: [],
            equipment: {
                head: {},
                torso: {},
                arms: {},
                legs: {},
                weapon: {},
                missile: {},
                accessory: {},
                bag: []
            },
            region: "England", // Normalized region for equipment availability
            conditions: [], // wounds, fatigue, etc.
            flags: {}, // story flags: Resentment, Dishonor, Shaken, etc.
            rank: "Common Soldier",
            relationships: {}, // NPC relationships
            career: {
                battles: 0,
                wounds: 0,
                promotions: 0
            }
        };
        
        // Stat limits
        const statLimits = {
            strength: { min: 0, max: 10 },
            agility: { min: 0, max: 10 },
            endurance: { min: 0, max: 10 },
            charisma: { min: 0, max: 10 },
            luck: { min: 0, max: 10 },
            wits: { min: 0, max: 10 },
            morale: { min: 0, max: 10 },
            stress: { min: 0, max: 10 },
            wealth: { min: 0, max: 200 },
            reputation: { min: -20, max: 50 },
            experience: { min: 0, max: 1000 },
            patronFavor: { min: 0, max: 20 }
        };
        
        // Clamp stat to limits
        function clampStat(key, value) {
            const limits = statLimits[key];
            if (!limits) return value;
            return Math.max(limits.min, Math.min(limits.max, value));
        }
        
        // Apply stat change with clamping
        function applyStatChange(key, delta) {
            if (gameState.stats[key] === undefined) return;
            const oldValue = gameState.stats[key];
            gameState.stats[key] = clampStat(key, oldValue + delta);
            return gameState.stats[key] - oldValue; // Return actual change
        }
        
        // Roll dice (1d10 + modifier)
        function rollDice(modifier = 0) {
            const roll = Math.floor(Math.random() * 10) + 1;
            return roll + modifier;
        }
        
        // Resolution system: roll against difficulty (uses effective stat)
        // Morale/stress can modify difficulty instead of stat for clearer feedback
        function resolveAction(stat, difficulty = 7, bonus = 0) {
            const effectiveStat = getEffectiveStat(stat);
            
            // Morale/stress modify difficulty (easier to succeed with high morale, harder with high stress)
            let adjustedDifficulty = difficulty;
            if (gameState.stats.morale >= 8) {
                adjustedDifficulty -= 1; // High morale makes checks easier
            } else if (gameState.stats.morale <= 2) {
                adjustedDifficulty += 1; // Low morale makes checks harder
            }
            if (gameState.stats.stress >= 7) {
                adjustedDifficulty += 1; // High stress makes checks harder
            }
            
            const roll = rollDice(effectiveStat + bonus);
            const success = roll >= adjustedDifficulty;
            return { 
                roll, 
                success, 
                margin: roll - adjustedDifficulty,
                effectiveStat: effectiveStat,
                baseStat: gameState.stats[stat] || 0,
                difficulty: adjustedDifficulty,
                baseDifficulty: difficulty
            };
        }
        
        // Add condition (wound, fatigue, etc.)
        function addCondition(name, type = 'negative', duration = -1) {
            gameState.conditions.push({
                name,
                type,
                duration,
                added: gameState.year
            });
        }
        
        // Remove condition
        function removeCondition(name) {
            gameState.conditions = gameState.conditions.filter(c => c.name !== name);
        }
        
        // Check if has condition
        function hasCondition(name) {
            return gameState.conditions.some(c => c.name === name);
        }
        
        // Update conditions (heal over time, etc.)
        function updateConditions() {
            gameState.conditions = gameState.conditions.filter(condition => {
                if (condition.duration === -1) return true; // Permanent
                const yearsPassed = gameState.year - condition.added;
                return yearsPassed < condition.duration;
            });
        }
        
        // Get condition effects on stats
        function getConditionEffects() {
            let effects = {};
            gameState.conditions.forEach(condition => {
                if (condition.name === 'Wounded') {
                    effects.strength = (effects.strength || 0) - 1;
                    effects.endurance = (effects.endurance || 0) - 1;
                } else if (condition.name === 'Fatigued') {
                    effects.endurance = (effects.endurance || 0) - 1;
                    effects.agility = (effects.agility || 0) - 1;
                } else if (condition.name === 'Inspired') {
                    effects.morale = (effects.morale || 0) + 1;
                } else if (condition.name === 'Seriously Wounded') {
                    effects.strength = (effects.strength || 0) - 2;
                    effects.endurance = (effects.endurance || 0) - 2;
                    effects.agility = (effects.agility || 0) - 1;
                } else if (condition.name === 'Shaken') {
                    effects.morale = (effects.morale || 0) - 1;
                    effects.wits = (effects.wits || 0) - 1;
                } else if (condition.name === 'Sick') {
                    effects.endurance = (effects.endurance || 0) - 2;
                    effects.strength = (effects.strength || 0) - 1;
                }
            });
            return effects;
        }
        
        // Set or clear a story flag
        function setFlag(name, value = true) {
            gameState.flags[name] = value;
        }
        
        // Check if a flag is set
        function hasFlag(name) {
            return gameState.flags[name] === true;
        }
        
        // Get equipment bonuses
        function getEquipmentBonus(stat) {
            let bonus = 0;
            // Weapon quality affects strength/agility in combat
            if (stat === 'strength' || stat === 'agility') {
                bonus += gameState.equipment.weapon.quality || 0;
            }
            // Armor quality affects endurance (protection)
            if (stat === 'endurance') {
                bonus += gameState.equipment.armor.quality || 0;
            }
            return bonus;
        }
        
        // Get effective stat value (base + conditions + equipment + stress/morale modifiers)
        function getEffectiveStat(stat) {
            const baseValue = gameState.stats[stat] || 0;
            const conditionEffects = getConditionEffects();
            const conditionMod = conditionEffects[stat] || 0;
            const equipmentMod = getEquipmentBonus(stat);
            
            // Stress reduces all stats slightly, morale helps
            let stressMod = 0;
            let moraleMod = 0;
            if (gameState.stats.stress >= 7) {
                stressMod = -1; // High stress hurts performance
            }
            if (gameState.stats.morale >= 8) {
                moraleMod = 1; // High morale helps
            } else if (gameState.stats.morale <= 2) {
                moraleMod = -1; // Low morale hurts
            }
            
            return baseValue + conditionMod + equipmentMod + stressMod + moraleMod;
        }
        
        // Game Scenes with explicit timeline
        const scenes = {
            character_creation: {
                title: "Character Creation",
                year: 1337,
                age: 18,
                location: "England",
                text: function() {
                    const pointsRemaining = 20 - (
                        Math.max(0, gameState.stats.strength - 5) +
                        Math.max(0, gameState.stats.agility - 5) +
                        Math.max(0, gameState.stats.endurance - 5) +
                        Math.max(0, gameState.stats.charisma - 5) +
                        Math.max(0, gameState.stats.wits - 5)
                    );
                    const nameDisplay = gameState.characterName || "";
                    return `<div style="max-width: 700px; margin: 0 auto;">
                        <h2 style="color: #f4d03f; text-align: center; margin-bottom: 20px;">Create Your Character</h2>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 5px;">
                            <label style="display: block; color: #d4af37; margin-bottom: 5px; font-weight: bold;">Your Name:</label>
                            <input type="text" id="character-name-input" placeholder="Enter your name" 
                                   value="${nameDisplay}" 
                                   style="width: 100%; padding: 10px; background: #2a2a2a; border: 2px solid #d4af37; color: #d4af37; border-radius: 5px; font-size: 16px; font-family: 'Crimson Text', serif;"
                                   onchange="gameState.characterName = this.value; updateDisplay();">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 5px;">
                            <h3 style="color: #f4d03f; margin-bottom: 15px;">Distribute Stat Points</h3>
                            <p style="color: #888; margin-bottom: 15px;">You have <strong style="color: ${pointsRemaining > 0 ? '#0f0' : pointsRemaining < 0 ? '#f00' : '#f4d03f'}">${pointsRemaining}</strong> points remaining.</p>
                            <p style="color: #888; font-size: 14px; margin-bottom: 15px;">All stats start at 5. You have 20 points to distribute. Each stat can go up to 10.</p>
                            
                            ${(function() {
                                const statLabels = {
                                    strength: '‚öîÔ∏è Strength',
                                    agility: 'üèÉ Agility', 
                                    endurance: '‚ù§Ô∏è Endurance',
                                    charisma: 'üí¨ Charisma',
                                    wits: 'üß† Wits'
                                };
                                return ['strength', 'agility', 'endurance', 'charisma', 'wits'].map(function(stat) {
                                    const value = gameState.stats[stat];
                                    const pointsSpent = Math.max(0, value - 5);
                                    const canDecrease = value > 5;
                                    const canIncrease = value < 10 && pointsRemaining > 0;
                                    return '<div style="display: flex; align-items: center; justify-content: space-between; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">' +
                                        '<div style="flex: 1;">' +
                                            '<div style="color: #d4af37; font-weight: bold;">' + statLabels[stat] + '</div>' +
                                            '<div style="color: #888; font-size: 12px;">Current: ' + value + '/10' + (pointsSpent > 0 ? ' (+' + pointsSpent + ')' : '') + '</div>' +
                                        '</div>' +
                                        '<div style="display: flex; gap: 10px; align-items: center;">' +
                                            '<button onclick="adjustStat(\'' + stat + '\', -1)" ' +
                                                    'style="width: 40px; height: 40px; background: ' + (canDecrease ? '#8b0000' : '#444') + '; border: 2px solid #d4af37; color: white; border-radius: 5px; cursor: ' + (canDecrease ? 'pointer' : 'not-allowed') + '; font-size: 20px; font-weight: bold;"' +
                                                    (!canDecrease ? ' disabled' : '') + '>-</button>' +
                                            '<span style="color: #f4d03f; font-size: 24px; font-weight: bold; min-width: 30px; text-align: center;">' + value + '</span>' +
                                            '<button onclick="adjustStat(\'' + stat + '\', 1)" ' +
                                                    'style="width: 40px; height: 40px; background: ' + (canIncrease ? '#006400' : '#444') + '; border: 2px solid #d4af37; color: white; border-radius: 5px; cursor: ' + (canIncrease ? 'pointer' : 'not-allowed') + '; font-size: 20px; font-weight: bold;"' +
                                                    (!canIncrease ? ' disabled' : '') + '>+</button>' +
                                        '</div>' +
                                    '</div>';
                                }).join('');
                            })()}
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 5px;">
                            <h3 style="color: #f4d03f; margin-bottom: 15px;">Choose Your Background</h3>
                            <p style="color: #888; font-size: 14px; margin-bottom: 15px;">Your background will grant you additional bonuses and shape your starting story.</p>
                            
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                                <button onclick="selectBackground('peasant')" 
                                        id="bg-peasant"
                                        style="padding: 15px; background: ${gameState.background === 'peasant' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${gameState.background === 'peasant' ? '#1a0f08' : '#d4af37'}; border-radius: 5px; cursor: pointer; text-align: left;">
                                    <strong>Peasant's Son</strong>
                                    <div style="font-size: 14px; margin-top: 5px; color: ${gameState.background === 'peasant' ? '#1a0f08' : '#888'};">
                                        +2 Endurance, -5 Wealth<br>
                                        <small>Hard work has made you tough, but you start with little.</small>
                                    </div>
                                </button>
                                
                                <button onclick="selectBackground('merchant')" 
                                        id="bg-merchant"
                                        style="padding: 15px; background: ${gameState.background === 'merchant' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${gameState.background === 'merchant' ? '#1a0f08' : '#d4af37'}; border-radius: 5px; cursor: pointer; text-align: left;">
                                    <strong>Merchant's Son</strong>
                                    <div style="font-size: 14px; margin-top: 5px; color: ${gameState.background === 'merchant' ? '#1a0f08' : '#888'};">
                                        +2 Charisma, +10 Wealth<br>
                                        <small>Your family's trade has taught you to talk and given you coin.</small>
                                    </div>
                                </button>
                                
                                <button onclick="selectBackground('noble')" 
                                        id="bg-noble"
                                        style="padding: 15px; background: ${gameState.background === 'noble' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${gameState.background === 'noble' ? '#1a0f08' : '#d4af37'}; border-radius: 5px; cursor: pointer; text-align: left;">
                                    <strong>Minor Noble's Son</strong>
                                    <div style="font-size: 14px; margin-top: 5px; color: ${gameState.background === 'noble' ? '#1a0f08' : '#888'};">
                                        +1 Strength, +5 Reputation<br>
                                        <small>Your bloodline grants you respect and some training.</small>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>`;
                },
                choices: [
                    {
                        text: "Begin Your Journey",
                        effects: {},
                        nextScene: "start",
                        requiresBackground: true
                    }
                ]
            },
            start: {
                title: "The Beginning",
                year: 1337,
                age: 18,
                location: "England",
                text: function() {
                    const name = gameState.characterName || "Soldier";
                    const background = gameState.background || 'peasant';
                    const bgText = {
                        peasant: "You are the son of a peasant family. Hard work has made you strong, but you have little wealth to your name.",
                        merchant: "You are the son of a merchant family. Your father's trade has taught you to talk and given you coin to start your journey.",
                        noble: "You are the son of a minor noble. Your bloodline grants you respect and some training in arms."
                    };
                    return `<p>It is the year 1337. The war between England and France has just begun.</p>
                           <p><strong>${name}</strong>, ${bgText[background]}</p>
                           <p>You are a young Englishman, ready to make your mark on history. The call to arms has reached you, and you've decided to join a lord's retinue.</p>
                           <p>Your training begins now...</p>`;
                },
                choices: [
                    {
                        text: "Begin Training",
                        effects: {},
                        nextScene: function() {
                            const bg = gameState.background || 'peasant';
                            return {
                                peasant: "training_peasant",
                                merchant: "training_merchant",
                                noble: "training_noble"
                            }[bg];
                        }
                    }
                ],
                onEnter: function() {
                    // Apply background bonuses if not already applied
                    if (!gameState.flags.backgroundApplied) {
                        const bg = gameState.background || 'peasant';
                        if (bg === 'peasant') {
                            applyStatChange('endurance', 2);
                            applyStatChange('wealth', -5);
                        } else if (bg === 'merchant') {
                            applyStatChange('charisma', 2);
                            applyStatChange('wealth', 10);
                        } else if (bg === 'noble') {
                            applyStatChange('strength', 1);
                            applyStatChange('reputation', 5);
                        }
                        gameState.flags.backgroundApplied = true;
                    }
                }
            },
            training_peasant: {
                title: "Training Begins",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>You've joined a lord's retinue. The training is harsh, but you're used to hard work. Your endurance serves you well.</p>
                       <p>After months of training, your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`,
                choices: [
                    {
                        text: "Volunteer for the vanguard",
                        effects: { strength: 1, reputation: 1 },
                        nextScene: "first_battle_brave"
                    },
                    {
                        text: "Stay with the main force",
                        effects: { endurance: 1 },
                        nextScene: "first_battle_cautious"
                    }
                ]
            },
            training_merchant: {
                title: "A Different Path",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>Your family's wealth has secured you better equipment and some education. You understand tactics better than most.</p>
                       <p>Your first campaign approaches. The French are raiding the coast, and your lord prepares to respond.</p>`,
                choices: [
                    {
                        text: "Suggest a tactical approach",
                        effects: { charisma: 1, reputation: 2 },
                        nextScene: "first_battle_tactical"
                    },
                    {
                        text: "Follow orders like everyone else",
                        effects: { strength: 1 },
                        nextScene: "first_battle_cautious"
                    }
                ]
            },
            training_noble: {
                title: "Noble Expectations",
                year: 1338,
                age: 19,
                location: "England",
                text: `<p>As a noble's son, much is expected of you. Your reputation precedes you, but so do the expectations.</p>
                       <p>Your first campaign approaches. The French are raiding the coast, and your lord expects you to lead the response.</p>`,
                choices: [
                    {
                        text: "Lead a small unit",
                        effects: { reputation: 2, strength: 1 },
                        nextScene: "first_battle_leader"
                    },
                    {
                        text: "Prove yourself in the front ranks",
                        effects: { strength: 2, endurance: -1 },
                        nextScene: "first_battle_brave"
                    }
                ]
            },
            first_battle_brave: {
                title: "First Blood",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>You charge into battle with courage. The clash of steel rings in your ears.</p>`,
                choices: [
                    {
                        text: "Fight with all your might",
                        effects: {},
                        nextScene: "first_battle_brave_resolve",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 6
                    }
                ]
            },
            first_battle_brave_resolve: {
                title: "First Blood",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>The battle rages...</p>`;
                    
                    const difficulty = result.baseDifficulty || 6;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    
                    if (result.success) {
                        return `${rollDisplay}<p>You fight well and drive back the French. You take a minor wound, but your bravery is noted. The French retreat.</p>
                               <p>You've survived your first battle. Your comrades respect your courage.</p>`;
                    } else {
                        return `${rollDisplay}<p>The battle is fierce. You take a serious wound but manage to survive. The French retreat, but you're left bleeding.</p>
                               <p>You've learned that war is not as glorious as the songs make it seem.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('experience', 10);
                        applyStatChange('reputation', 1);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1); // Battle is stressful
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('endurance', -1);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_cautious: {
                title: "First Battle",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>You fight in formation, staying close to your comrades. The battle is fierce, but you emerge unscathed.</p>
                       <p>Your caution served you well. You've learned the value of discipline.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 5);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_tactical: {
                title: "A Tactical Mind",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>Your suggestion to flank the French position proves successful. Your lord takes notice of your strategic thinking.</p>
                       <p>You've earned respect through intelligence, not just brute force.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 10);
                    applyStatChange('reputation', 2);
                    applyStatChange('wits', 1);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            first_battle_leader: {
                title: "Leading Men",
                year: 1338,
                age: 19,
                location: "Northern France",
                text: `<p>You lead your unit with skill. Your men follow you into battle, and you emerge victorious.</p>
                       <p>Your leadership abilities are recognized. You're given more responsibility.</p>`,
                onEnter: function() {
                    applyStatChange('experience', 15);
                    applyStatChange('reputation', 2);
                    applyStatChange('patronFavor', 1);
                    applyStatChange('stress', 1);
                    gameState.career.battles++;
                },
                choices: [
                    {
                        text: "Continue to winter quarters",
                        effects: {},
                        nextScene: "winter_quarters"
                    }
                ]
            },
            winter_quarters: {
                title: "Winter Quarters",
                year: 1340,
                age: 21,
                location: "Northern France",
                text: function() {
                    const pay = Math.floor(5 + gameState.stats.reputation / 5);
                    return `<p>The war has quieted for the winter. You're billeted in a small village. Your pay arrives: ${pay} silver coins.</p>
                           <p>The local blacksmith's daughter, Marie, has been bringing you food. She's pretty, and you've noticed she's been making eyes at you. Your comrades joke about settling down.</p>`;
                },
                choices: [
                    {
                        text: "Court Marie seriously",
                        effects: { charisma: 1 },
                        nextScene: "marriage_question"
                    },
                    {
                        text: "Keep it casual",
                        effects: {},
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Focus on training",
                        effects: { strength: 1, agility: 1 },
                        nextScene: "between_years_1341"
                    },
                    {
                        text: "Spend coin on better equipment",
                        effects: { wealth: -10 },
                        nextScene: "equipment_upgrade_1340"
                    }
                ],
                onEnter: function() {
                    // Grant winter pay
                    const pay = Math.floor(5 + gameState.stats.reputation / 5);
                    applyStatChange('wealth', pay);
                    // Rest reduces stress
                    applyStatChange('stress', -2);
                }
            },
            equipment_upgrade_1340: {
                title: "Better Gear",
                year: 1340,
                age: 21,
                text: `<p>You invest in better equipment. The blacksmith crafts you a sturdier sword and reinforced leather armor.</p>
                       <p>Your gear quality improves. This will serve you well in future battles.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "between_years_1341"
                    }
                ],
                onEnter: function() {
                    gameState.equipment.weapon.quality = 1;
                    gameState.equipment.armor.quality = 1;
                }
            },
            between_years_1341: {
                title: "The Years Pass",
                year: 1341,
                age: 22,
                location: "Northern France",
                text: `<p>The years pass in a blur of minor skirmishes and patrols. You've learned the rhythm of war: campaign in spring and summer, winter in quarters.</p>
                       <p>Your experience grows, and your lord takes notice of your service.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { experience: 20, patronFavor: 1 },
                        nextScene: "between_years_1342"
                    }
                ]
            },
            between_years_1342: {
                title: "Rising Through the Ranks",
                year: 1342,
                age: 23,
                location: "Northern France",
                text: `<p>Your consistent service has earned you favor with your lord. You're given command of a small unit of five men.</p>
                       <p>It's not much, but it's a step up. Your pay increases slightly, and you have more responsibility.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { wealth: 5, reputation: 2 },
                        nextScene: "between_years_1343"
                    }
                ],
                onEnter: function() {
                    if (gameState.stats.patronFavor >= 3 && gameState.rank === "Common Soldier") {
                        gameState.rank = "Sergeant";
                        gameState.career.promotions++;
                        showNotification('Promotion!', 'You have been promoted to Sergeant!');
                    }
                }
            },
            between_years_1343: {
                title: "Minor Campaigns",
                year: 1343,
                age: 24,
                location: "Northern France",
                text: `<p>You participate in several minor campaigns. The French raid, you respond. It's become routine, but war is never truly routine.</p>
                       <p>You've seen men die from arrows, disease, and simple accidents. Each year makes you more cautious, or perhaps more fatalistic.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: { experience: 15 },
                        nextScene: "between_years_1344"
                    }
                ]
            },
            between_years_1344: {
                title: "The Calm Before the Storm",
                year: 1344,
                age: 25,
                location: "England",
                text: `<p>Rumors spread of a major invasion being planned. King Edward III is gathering a large army to strike at France.</p>
                       <p>You prepare yourself. This will be no minor skirmish. This will be a real campaign.</p>`,
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "between_years_1345"
                    }
                ]
            },
            between_years_1345: {
                title: "Final Preparations",
                year: 1345,
                age: 26,
                location: "England",
                text: `<p>King Edward's army gathers. You check your equipment one last time.</p>
                       <p>Tomorrow, you sail to France. The biggest campaign of your life awaits.</p>`,
                choices: [
                    {
                        text: "March to battle",
                        effects: {},
                        nextScene: "spring_campaign"
                    }
                ]
            },
            marriage_question: {
                title: "A Proposal",
                year: 1340,
                age: 21,
                text: `<p>Marie's father approves of the match. He offers you his daughter's hand in marriage.</p>
                       <p>Marriage would give you a home, but what if the war calls again? You'd have someone to fight for, but also someone to lose.</p>`,
                choices: [
                    {
                        text: "Marry Marie",
                        effects: { charisma: 2, wealth: 5, reputation: 1 },
                        nextScene: "married_life"
                    },
                    {
                        text: "Not yet - wait until after the next campaign",
                        effects: {},
                        nextScene: "between_years_1341"
                    }
                ]
            },
            married_life: {
                title: "A New Life",
                year: 1340,
                age: 21,
                text: `<p>You've married Marie. You have a home now, a place to return to. But the war continues...</p>
                       <p>Your wife is with child. You have more to lose, but also more to fight for.</p>`,
                choices: [
                    {
                        text: "Continue your service",
                        effects: {},
                        nextScene: "between_years_1341"
                    }
                ]
            },
            spring_campaign: {
                title: "The Campaign of 1346",
                year: 1346,
                age: 27,
                location: "England",
                text: `<p>Spring arrives, and with it, the call to arms. King Edward III prepares to invade France with a large army.</p>
                       <p>Your lord calls for all available men. This will be a major campaign...</p>`,
                choices: [
                    {
                        text: "Prepare for what's coming",
                        effects: {},
                        nextScene: "indenture_table"
                    }
                ]
            },
            indenture_table: {
                title: "The Indenture Table",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: `<p><strong>June 1346 ‚Äî Portsmouth</strong></p>
                       <p>A clerk reads the contract terms aloud while your captain watches faces for hesitation. You're not swearing fealty for life‚Äîyou're signing for a term, a wage, and a share of what can be lawfully taken. The ink smells like iron. Someone nearby is already drunk enough to mis-hear his own name.</p>`,
                choices: [
                    {
                        text: "Negotiate for clarity (not more pay)",
                        effects: {},
                        nextScene: "indenture_negotiate",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Ask what happens to prisoners",
                        effects: {},
                        nextScene: "indenture_prisoners",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Sign fast and shut up",
                        effects: {},
                        nextScene: "indenture_sign",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 5
                    }
                ]
            },
            indenture_negotiate: {
                title: "Negotiating Terms",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the clerk...</p>`;
                    if (result.success) {
                        return `<p>You ask careful questions about payment schedules and prize distribution. The captain nods‚Äîyou're thinking like a professional, not a troublemaker.</p>
                               <p>You've earned respect and clarity. This will serve you well.</p>`;
                    } else {
                        return `<p>Your questions come across as challenging the captain's authority. His expression hardens.</p>
                               <p>You've marked yourself as difficult. This will cost you favor.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        setFlag('Shorted Wages', false); // Clear risk flag
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            indenture_prisoners: {
                title: "Prisoners and Ransoms",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You consider the question...</p>`;
                    if (result.success) {
                        return `<p>You ask about prisoner rights and ransoms. The older hands nod‚Äîyou're learning the real economics of war.</p>
                               <p>You understand the system now. This knowledge could be valuable.</p>`;
                    } else {
                        return `<p>Your question marks you as na√Øve. The veterans exchange knowing looks.</p>
                               <p>You'll learn the hard way, or not at all.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wits', 1);
                        setFlag('Ransom Claim', true);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            indenture_sign: {
                title: "Signing the Contract",
                year: 1346,
                age: 27,
                location: "Portsmouth, England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take the quill...</p>`;
                    if (result.success) {
                        return `<p>You sign with confidence. The terms are what they are‚Äîyou've made your choice and you'll see it through.</p>
                               <p>Your certainty strengthens your resolve.</p>`;
                    } else {
                        return `<p>You sign quickly, but later you realize you missed a clause about wage deductions.</p>
                               <p>This oversight may cost you later.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Shorted Wages', true);
                    }
                },
                choices: [
                    {
                        text: "Continue to muster",
                        effects: {},
                        nextScene: "purveyance"
                    }
                ]
            },
            purveyance: {
                title: "Purveyance",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: `<p><strong>Late June 1346 ‚Äî Southern England</strong></p>
                       <p>Wagons arrive with hard bread and salted meat‚Äîthen stop arriving. A royal warrant appears. "Purveyance," they call it: taking supplies at set prices (or less), and letting villagers complain to someone who isn't here. Your unit is told to "assist."</p>`,
                choices: [
                    {
                        text: "Pay fair and write receipts",
                        effects: {},
                        nextScene: "purveyance_fair",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Take what's needed, quickly",
                        effects: {},
                        nextScene: "purveyance_take",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Refuse and let others do it",
                        effects: {},
                        nextScene: "purveyance_refuse",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    }
                ]
            },
            purveyance_fair: {
                title: "Fair Dealing",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the villagers...</p>`;
                    if (result.success) {
                        return `<p>You pay fair prices and write proper receipts. The villagers are surprised‚Äîand grateful.</p>
                               <p>Your integrity is noted. This will be remembered.</p>`;
                    } else {
                        return `<p>You try to be fair, but you're accused of skimming. The captain questions your honesty.</p>
                               <p>Your reputation suffers.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    const payCost = 5;
                    if (result && result.success) {
                        applyStatChange('wealth', -payCost);
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            purveyance_take: {
                title: "Taking What's Needed",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move quickly...</p>`;
                    if (result.success) {
                        return `<p>You take what's needed efficiently. The unit is fed, and you've secured some extra supplies.</p>
                               <p>But the villagers' eyes follow you. Resentment grows.</p>`;
                    } else {
                        return `<p>You take supplies, but clumsily. The villagers' anger is palpable.</p>
                               <p>You've made enemies. This may come back to haunt you.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 3);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Resentment', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            purveyance_refuse: {
                title: "Refusing the Order",
                year: 1346,
                age: 27,
                location: "Southern England",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You hesitate...</p>`;
                    if (result.success) {
                        return `<p>You refuse politely, letting others handle it. You avoid the moral weight, but the captain notices your reluctance.</p>
                               <p>You've avoided creating resentment, but lost some favor.</p>`;
                    } else {
                        return `<p>The captain forces you to participate anyway. You do it, but something inside you breaks.</p>
                               <p>You're shaken by what you've been made to do.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', -1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "channel_crossing"
                    }
                ]
            },
            channel_crossing: {
                title: "Channel Crossing: Vomit and Rope",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: `<p><strong>Early July 1346 ‚Äî At sea</strong></p>
                       <p>Men retch over the gunwale until there's nothing left to give. Horses scream when the deck shifts. The ship's bilge stinks. Someone drops a bow-case into seawater; someone else pretends not to see.</p>`,
                choices: [
                    {
                        text: "Guard the horses through the night",
                        effects: {},
                        nextScene: "channel_horses",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Secure your gear against salt",
                        effects: {},
                        nextScene: "channel_gear",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Help the sick and keep order",
                        effects: {},
                        nextScene: "channel_help",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7
                    }
                ]
            },
            channel_horses: {
                title: "Tending the Horses",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the horse stalls...</p>`;
                    if (result.success) {
                        return `<p>You guard the horses through the long night, keeping them calm and secure. They'll be ready when you need them.</p>
                               <p>Your dedication is noted. The captain appreciates reliable men.</p>`;
                    } else {
                        return `<p>The night is exhausting. You do your best, but one of the horses injures itself in the rolling ship.</p>
                               <p>You're fatigued, and you'll be without a mount when you need one.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 1);
                        setFlag('Lame Mount', true);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            channel_gear: {
                title: "Securing Your Gear",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You check your equipment...</p>`;
                    if (result.success) {
                        return `<p>You carefully protect your bow and strings from saltwater. Your gear will be ready when you need it.</p>
                               <p>Your foresight preserves your equipment quality.</p>`;
                    } else {
                        return `<p>Despite your efforts, saltwater damages your bowstrings. Your equipment suffers.</p>
                               <p>You'll need to repair or replace gear when you land.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        gameState.equipment.weapon.quality = Math.min(2, gameState.equipment.weapon.quality + 1);
                    } else if (result) {
                        gameState.equipment.weapon.quality = Math.max(0, gameState.equipment.weapon.quality - 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            channel_help: {
                title: "Helping the Sick",
                year: 1346,
                age: 27,
                location: "English Channel",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move among the sick...</p>`;
                    if (result.success) {
                        return `<p>You help the sick and maintain order. Your leadership keeps the men focused despite the misery.</p>
                               <p>Morale improves, and the risk of desertion decreases.</p>`;
                    } else {
                        return `<p>You try to help, but the chaos overwhelms you. The suffering is too much.</p>
                               <p>You're shaken by what you've seen.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "saint_vaast_landing"
                    }
                ]
            },
            saint_vaast_landing: {
                title: "Saint-Vaast Landing",
                year: 1346,
                age: 27,
                location: "Saint-Vaast-la-Hougue, Normandy",
                text: `<p><strong>12 July 1346 ‚Äî Saint-Vaast-la-Hougue / Cotentin</strong></p>
                       <p>The shoreline looks quiet until you notice how many doors are barred. Men spill out and form ranks. The order is simple: move inland, take what can be taken, and keep moving.</p>`,
                choices: [
                    {
                        text: "Scout the first mile inland",
                        effects: {},
                        nextScene: "landing_scout",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Join the first raid party",
                        effects: {},
                        nextScene: "landing_raid",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Stay with the banner",
                        effects: {},
                        nextScene: "landing_banner",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    }
                ]
            },
            landing_scout: {
                title: "Scouting Inland",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move forward cautiously...</p>`;
                    if (result.success) {
                        return `<p>You scout ahead and find a good water source and safe camp site. The unit benefits from your reconnaissance.</p>
                               <p>Your initiative improves morale and keeps everyone safer.</p>`;
                    } else {
                        return `<p>You stumble into a skirmish with French scouts. You fight your way out, but not without cost.</p>
                               <p>You've learned the land is not as empty as it seemed.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        const woundRoll = Math.random();
                        if (woundRoll < 0.4) {
                            addCondition('Wounded', 'negative', 2);
                        }
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            landing_raid: {
                title: "The First Raid",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You join the raiders...</p>`;
                    if (result.success) {
                        return `<p>You join the raid and take what you can. Silver, food, anything of value.</p>
                               <p>You're richer, but the villagers' hatred follows you. Resentment grows.</p>`;
                    } else {
                        return `<p>You get separated from the main party in the chaos. You find your way back, but you're shaken by the experience.</p>
                               <p>The raid was more chaotic than you expected.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 5);
                        setFlag('Resentment', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            landing_banner: {
                title: "Staying with the Banner",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You stay close to the banner...</p>`;
                    if (result.success) {
                        return `<p>You stay disciplined and close to the banner. The captain notices your reliability.</p>
                               <p>You've earned favor and avoided the chaos of the raids.</p>`;
                    } else {
                        return `<p>You're mocked as timid for staying back. The taunts get under your skin.</p>
                               <p>Your morale suffers, even though you made the safe choice.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "chevauch√©e_burn"
                    }
                ]
            },
            chevauch√©e_burn: {
                title: "Chevauch√©e: The Burn Line",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: `<p><strong>Mid-July 1346 ‚Äî Normandy villages</strong></p>
                       <p>You smell smoke before you see it. The raid is not "battle," it's pressure: make the countryside bleed wealth and confidence, force the enemy to respond, and keep the army fed while doing it.</p>`,
                choices: [
                    {
                        text: "Torch barns to deny supplies",
                        effects: {},
                        nextScene: "chevauch√©e_torch",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Take hostages for safe passage",
                        effects: {},
                        nextScene: "chevauch√©e_hostages",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Spare a church and move on",
                        effects: {},
                        nextScene: "chevauch√©e_spare",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    }
                ]
            },
            chevauch√©e_torch: {
                title: "The Burn Line",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the barns...</p>`;
                    if (result.success) {
                        return `<p>You torch the barns efficiently, denying supplies to the enemy. The captain approves.</p>
                               <p>But you watched it burn. The weight of what you've done settles on you. Your morale suffers.</p>`;
                    } else {
                        return `<p>The wind shifts, and your own baggage train catches fire. You've cost the unit supplies.</p>
                               <p>Your mistake is costly, both in wealth and reputation.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('wealth', -3);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            chevauch√©e_hostages: {
                title: "Taking Hostages",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the villagers...</p>`;
                    if (result.success) {
                        return `<p>You take hostages and negotiate safe passage. They'll pay for their freedom.</p>
                               <p>You've established a ransom network. This could be very profitable.</p>`;
                    } else {
                        return `<p>You try to take hostages, but one escapes. He'll tell others about you.</p>
                               <p>The risk of ambush increases. You've made enemies who know your face.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 8);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        setFlag('Ambush Risk', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            chevauch√©e_spare: {
                title: "Sparing the Church",
                year: 1346,
                age: 27,
                location: "Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You look at the church...</p>`;
                    if (result.success) {
                        return `<p>You spare the church and move on. Some of your men respect the gesture.</p>
                               <p>Your mercy improves morale and reduces local resentment.</p>`;
                    } else {
                        return `<p>You try to spare the church, but your squad ignores you and takes what they want anyway.</p>
                               <p>You've lost control and favor. The captain sees you as weak.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        if (hasFlag('Resentment')) {
                            setFlag('Resentment', false);
                        }
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "caen_bridge"
                    }
                ]
            },
            caen_bridge: {
                title: "Caen: The Bridge Rush",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: `<p><strong>26 July 1346 ‚Äî Caen</strong></p>
                       <p>Orders exist. Then the first men sprint, and the town becomes a magnet for hunger, bravado, and unpaid grudges. Bridges choke with bodies. Someone shouts that the castle is still holding. Someone else shouts about silver in the new town.</p>`,
                choices: [
                    {
                        text: "Hold your file and push the bridge",
                        effects: {},
                        nextScene: "caen_bridge_hold",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Break ranks for loot",
                        effects: {},
                        nextScene: "caen_bridge_loot",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Take a noble prisoner instead of killing",
                        effects: {},
                        nextScene: "caen_bridge_prisoner",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    }
                ]
            },
            caen_bridge_hold: {
                title: "Holding the Bridge",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You push forward...</p>`;
                    if (result.success) {
                        return `<p>You hold your file and push the bridge with discipline. Your unit breaks through.</p>
                               <p>Your leadership and courage earn significant favor. Your men respect you.</p>`;
                    } else {
                        return `<p>You push forward, but the crush of bodies and weapons leaves you wounded.</p>
                               <p>You've taken a serious injury in the chaos of the bridge fight.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            caen_bridge_loot: {
                title: "Breaking for Loot",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You break ranks...</p>`;
                    if (result.success) {
                        return `<p>You break ranks and grab what you can. Silver, cloth, anything valuable.</p>
                               <p>You're richer, but you've broken discipline. This will be remembered.</p>`;
                    } else {
                        return `<p>You're caught breaking ranks. The captain is furious, and you may have been injured in the chaos.</p>
                               <p>You've lost significant favor and possibly your health.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 10);
                        setFlag('Discipline', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -2);
                        const woundChance = Math.random();
                        if (woundChance < 0.5) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            caen_bridge_prisoner: {
                title: "Taking a Noble Prisoner",
                year: 1346,
                age: 27,
                location: "Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see a noble in the chaos...</p>`;
                    if (result.success) {
                        return `<p>You take a noble prisoner instead of killing him. He's worth a fortune in ransom.</p>
                               <p>You've secured a valuable captive and established yourself in the ransom trade.</p>`;
                    } else {
                        return `<p>You try to take the prisoner, but he gets dragged away by others in the chaos.</p>
                               <p>You're shaken by the missed opportunity and the violence you witnessed.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 20);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "prisoner_argument"
                    }
                ]
            },
            prisoner_argument: {
                title: "The Prisoner Argument",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: `<p><strong>Late July 1346 ‚Äî Outside Caen</strong></p>
                       <p>A captured man-at-arms sits on the ground, helmet off, eyes flat. Two of your men both claim him. The law here is not clean. The stakes are not abstract: ransoms can change a life, and disputes can end in knives behind tents.</p>`,
                choices: [
                    {
                        text: "Demand a formal witness and division",
                        effects: {},
                        nextScene: "prisoner_formal",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Split the claim",
                        effects: {},
                        nextScene: "prisoner_split",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Steal the purse and walk away",
                        effects: {},
                        nextScene: "prisoner_steal",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            prisoner_formal: {
                title: "Formal Division",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You step forward...</p>`;
                    if (result.success) {
                        return `<p>You demand formal witnesses and a fair division. The dispute is resolved without bloodshed.</p>
                               <p>Your leadership prevents a feud. The captain appreciates your judgment.</p>`;
                    } else {
                        return `<p>Both sides turn on you. Your attempt at fairness makes you enemies.</p>
                               <p>Your morale suffers from the conflict.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            prisoner_split: {
                title: "Splitting the Claim",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You propose a split...</p>`;
                    if (result.success) {
                        return `<p>You split the claim between the two men. Everyone gets something, and the dispute ends.</p>
                               <p>You've avoided escalation and secured a small share for yourself.</p>`;
                    } else {
                        return `<p>The prisoner dies in the scuffle before you can resolve it. You're left with nothing but guilt.</p>
                               <p>You're shaken by the senseless death.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 3);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            prisoner_steal: {
                title: "Stealing the Purse",
                year: 1346,
                age: 27,
                location: "Outside Caen, Normandy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see an opportunity...</p>`;
                    if (result.success) {
                        return `<p>You steal the purse and slip away. You're richer, but you've betrayed your comrades.</p>
                               <p>You've gained wealth but lost honor. This will follow you.</p>`;
                    } else {
                        return `<p>You're caught stealing. The punishment is severe, and your reputation is ruined.</p>
                               <p>You've lost significant favor and the trust of your unit.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 5);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -3);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "denuded_country"
                    }
                ]
            },
            denuded_country: {
                title: "Denuded Country",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: `<p><strong>Early‚ÄìMid August 1346 ‚Äî Northward march</strong></p>
                       <p>The French have stripped the land ahead: grain hauled off, wells fouled, bridges watched or broken. The army gets ragged. Men eat things they won't name. Someone suggests slaughtering baggage horses. Someone else suggests hanging thieves. Both are called "discipline."</p>`,
                choices: [
                    {
                        text: "Forage with restraint (pay or barter)",
                        effects: {},
                        nextScene: "denuded_forage",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Slaughter a horse for the pot",
                        effects: {},
                        nextScene: "denuded_horse",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Make an example of a thief",
                        effects: {},
                        nextScene: "denuded_thief",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    }
                ]
            },
            denuded_forage: {
                title: "Foraging with Restraint",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You approach the villagers...</p>`;
                    if (result.success) {
                        return `<p>You forage with restraint, paying or bartering fairly. The villagers are surprised by your decency.</p>
                               <p>You've reduced local resentment and secured supplies without violence.</p>`;
                    } else {
                        return `<p>The villagers lie about what they have. You find nothing, and your unit goes hungry.</p>
                               <p>Your morale suffers from the failure and the hunger.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        if (hasFlag('Resentment')) {
                            setFlag('Resentment', false);
                        }
                    } else if (result) {
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            denuded_horse: {
                title: "Slaughtering a Horse",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You look at the horse...</p>`;
                    if (result.success) {
                        return `<p>You slaughter a horse for the pot. The men are fed, and morale improves.</p>
                               <p>But you've lost a mount. You'll be on foot when speed matters.</p>`;
                    } else {
                        return `<p>You can't bring yourself to do it, or you watch someone else do it. The sight shakes you.</p>
                               <p>You're shaken by what you've seen or failed to do.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Lame Mount', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            denuded_thief: {
                title: "Making an Example",
                year: 1346,
                age: 27,
                location: "Northern France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see a thief being caught...</p>`;
                    if (result.success) {
                        return `<p>You make an example of the thief. Desertion decreases, and discipline improves.</p>
                               <p>Your harsh justice earns favor with the captain.</p>`;
                    } else {
                        return `<p>Your attempt backfires. The squad turns cold, seeing you as a tyrant.</p>
                               <p>Your morale suffers from the isolation.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "blanchetaque_ford"
                    }
                ]
            },
            blanchetaque_ford: {
                title: "Blanchetaque: Tidal Ford",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: `<p><strong>24 August 1346 ‚Äî Somme crossing at Blanchetaque</strong></p>
                       <p>The ford is wide, the mud grabs ankles, and the tide is a clock you can't argue with. Crossbow bolts skip off the water like stones. Men try to keep powder-dry things dry in a world made of river.</p>`,
                choices: [
                    {
                        text: "Wade first with the forward file",
                        effects: {},
                        nextScene: "blanchetaque_wade",
                        requiresResolution: true,
                        resolutionStat: "endurance",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Hold formation and cover others",
                        effects: {},
                        nextScene: "blanchetaque_cover",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Drag a drowning man out",
                        effects: {},
                        nextScene: "blanchetaque_rescue",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    }
                ]
            },
            blanchetaque_wade: {
                title: "Wading First",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You step into the water...</p>`;
                    if (result.success) {
                        return `<p>You wade first with the forward file, leading the way across the dangerous ford.</p>
                               <p>Your courage earns significant favor and inspires your comrades.</p>`;
                    } else {
                        return `<p>The crossing is brutal. You take a crossbow bolt or fall in the mud, getting injured.</p>
                               <p>You've been wounded in the dangerous crossing.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        const woundRoll = Math.random();
                        if (woundRoll < 0.6) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            blanchetaque_cover: {
                title: "Covering Others",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take position...</p>`;
                    if (result.success) {
                        return `<p>You hold formation and cover others crossing. Your tactical sense reduces squad injuries.</p>
                               <p>Your leadership improves morale and saves lives.</p>`;
                    } else {
                        return `<p>Chaos erupts despite your efforts. The crossing becomes a disaster.</p>
                               <p>You're shaken by the failure and the suffering you couldn't prevent.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            blanchetaque_rescue: {
                title: "Rescuing a Drowning Man",
                year: 1346,
                age: 27,
                location: "Blanchetaque, Somme River",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see a man struggling...</p>`;
                    if (result.success) {
                        return `<p>You drag a drowning man to safety. He'll remember this, and you've gained a potential ally.</p>
                               <p>Your heroism improves morale and may help you later.</p>`;
                    } else {
                        return `<p>You try to rescue him, but the effort exhausts you and you lose time.</p>
                               <p>You're fatigued, and the enemy pressure increases.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Ally', true);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "battle_crecy"
                    }
                ]
            },
            battle_crecy: {
                title: "The Battle of Cr√©cy, 1346",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: `<p><strong>‚ö†Ô∏è HISTORICAL EVENT: The Battle of Cr√©cy - 26 August 1346</strong></p>
                       <p>A sudden rain breaks, then stops. Bowstrings are handled like lifelines. The French come on late, crowded, impatient. You hear the word "oriflamme" and understand what that implies for anyone taken alive. The first line wavers; the second line steps on them.</p>`,
                choices: [
                    {
                        text: "Stay planted in the defensive line",
                        effects: {},
                        nextScene: "crecy_defensive",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Run forward to strip a fallen noble",
                        effects: {},
                        nextScene: "crecy_loot",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Pull wounded back under fire",
                        effects: {},
                        nextScene: "crecy_rescue",
                        requiresResolution: true,
                        resolutionStat: "strength",
                        resolutionDifficulty: 9
                    }
                ]
            },
            crecy_defensive: {
                title: "Holding the Line",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You take your position...</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You stay planted in the defensive line, holding your position with discipline. The English longbowmen do their work, and you survive.</p>
                               <p>Your courage and discipline earn significant favor. Your morale is strong.</p>`;
                    } else {
                        return `${rollDisplay}<p>The battle is fierce. You hold as long as you can, but you take a wound.</p>
                               <p>You've been wounded, but you survived Cr√©cy.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('experience', 20);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_loot: {
                title: "Stripping the Fallen",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see a fallen noble...</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You run forward and strip a fallen noble of his valuables. You're richer, but you've dishonored yourself.</p>
                               <p>You've gained wealth but lost honor. This will follow you.</p>`;
                    } else {
                        return `${rollDisplay}<p>You're nearly hit by arrows or injured in the attempt. You're shaken and possibly wounded.</p>
                               <p>You've risked everything for nothing.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 15);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 2);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        const woundChance = Math.random();
                        if (woundChance < 0.4) {
                            addCondition('Wounded', 'negative', 2);
                            gameState.career.wounds++;
                        }
                        applyStatChange('stress', 3);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_rescue: {
                title: "Pulling Wounded Back",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see wounded men...</p>`;
                    const difficulty = result.baseDifficulty || 9;
                    const neededRoll = difficulty - result.effectiveStat;
                    const successChance = Math.max(0, Math.min(100, ((10 - neededRoll + 1) / 10) * 100));
                    const rollDisplay = `<div class="dice-roll">
                        <strong>Roll:</strong> 1d10 + ${result.effectiveStat} = ${result.roll} (vs ${result.difficulty})
                        <br><em>Chance to succeed: ${Math.round(successChance)}%</em>
                        <br><strong>${result.success ? 'SUCCESS' : 'FAILURE'}</strong>
                    </div>`;
                    if (result.success) {
                        return `${rollDisplay}<p>You pull wounded men back under fire. Your heroism saves lives and reduces squad losses.</p>
                               <p>Your courage improves morale and earns respect.</p>`;
                    } else {
                        return `${rollDisplay}<p>You try to rescue them, but you're wounded and exhausted in the attempt.</p>
                               <p>You've been wounded and fatigued, but you tried to do the right thing.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        applyStatChange('experience', 15);
                        applyStatChange('stress', 2);
                        gameState.career.battles++;
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('stress', 3);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "crecy_night"
                    }
                ]
            },
            crecy_night: {
                title: "Night on the Field",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: `<p><strong>Night of 26 August 1346 ‚Äî Outside Cr√©cy</strong></p>
                       <p>The field isn't quiet; it's busy in a different way. You can hear metal being unbuckled in the dark. Some men look for friends. Some look for profit. Some look for a way to sleep without dreaming.</p>`,
                choices: [
                    {
                        text: "Focus on wounded and water",
                        effects: {},
                        nextScene: "crecy_night_wounded",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Strip gear carefully (not greedily)",
                        effects: {},
                        nextScene: "crecy_night_gear",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Hunt for captives worth ransom",
                        effects: {},
                        nextScene: "crecy_night_ransom",
                        requiresResolution: true,
                        resolutionStat: "charisma",
                        resolutionDifficulty: 9
                    }
                ]
            },
            crecy_night_wounded: {
                title: "Tending the Wounded",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You move among the wounded...</p>`;
                    if (result.success) {
                        return `<p>You focus on the wounded and securing water. Your care helps many, and you find some peace in useful work.</p>
                               <p>You've removed shaken or fatigued conditions and improved morale through service.</p>`;
                    } else {
                        return `<p>You try to help, but you miss a curable wound that becomes infected. Your failure haunts you.</p>
                               <p>Infection spreads. This will cause problems later.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        if (hasCondition('Shaken')) removeCondition('Shaken');
                        if (hasCondition('Fatigued')) removeCondition('Fatigued');
                        applyStatChange('morale', 1);
                        applyStatChange('stress', -1);
                    } else if (result) {
                        setFlag('Infection', true);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            crecy_night_gear: {
                title: "Stripping Gear Carefully",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You search the field...</p>`;
                    if (result.success) {
                        return `<p>You strip gear carefully from the fallen. Your careful approach pays off.</p>`;
                    } else {
                        return `<p>You're accused of theft. Your reputation suffers, even though you meant no harm.</p>
                               <p>You've lost favor through misunderstanding.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        const gearRoll = Math.random();
                        if (gearRoll < 0.5) {
                            gameState.equipment.weapon.quality = Math.min(3, gameState.equipment.weapon.quality + 1);
                        } else {
                            applyStatChange('wealth', 8);
                        }
                    } else if (result) {
                        applyStatChange('patronFavor', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            crecy_night_ransom: {
                title: "Hunting for Captives",
                year: 1346,
                age: 27,
                location: "Cr√©cy, Picardy",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You search for valuable captives...</p>`;
                    if (result.success) {
                        return `<p>You find a captive worth a fortune in ransom. Your network pays off.</p>
                               <p>You've secured significant wealth and established yourself in the ransom trade.</p>`;
                    } else {
                        return `<p>You're threatened by others hunting the same prize. The danger shakes you.</p>
                               <p>You're shaken by the close call.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 25);
                        setFlag('Ransom Network', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_siege"
                    }
                ]
            },
            calais_siege: {
                title: "Calais: The Siege Town",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: `<p><strong>4 September 1346 ‚Äî Calais</strong></p>
                       <p>The work is endless: ditches, stakes, palisades, watch rotations, and the slow mathematics of starvation. A whole little city of tents grows outside the walls. The first weeks feel almost orderly‚Äîuntil the latrines overflow and the water tastes wrong.</p>`,
                choices: [
                    {
                        text: "Dig proper latrines and enforce distance from water",
                        effects: {},
                        nextScene: "calais_latrines",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Volunteer for dangerous night duty",
                        effects: {},
                        nextScene: "calais_night",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Skim from supply wagons",
                        effects: {},
                        nextScene: "calais_skim",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            calais_latrines: {
                title: "Improving Sanitation",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You look at the camp...</p>`;
                    if (result.success) {
                        return `<p>You dig proper latrines and enforce distance from water. Disease decreases in your area.</p>
                               <p>Your foresight reduces sickness events and earns favor.</p>`;
                    } else {
                        return `<p>Others ignore your suggestions. Your efforts go unnoticed, and the camp remains unhealthy.</p>
                               <p>You've tried, but to no effect.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            calais_night: {
                title: "Night Duty",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You volunteer...</p>`;
                    if (result.success) {
                        return `<p>You volunteer for dangerous night duty and perform well. Your courage is noted.</p>
                               <p>You've earned significant favor and improved morale through service.</p>`;
                    } else {
                        return `<p>Night duty is dangerous. You're wounded in a skirmish or accident.</p>
                               <p>You've been wounded, but you tried to serve.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 2);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        addCondition('Wounded', 'negative', 2);
                        applyStatChange('stress', 2);
                        gameState.career.wounds++;
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            calais_skim: {
                title: "Skimming Supplies",
                year: 1346,
                age: 27,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You watch the wagons...</p>`;
                    if (result.success) {
                        return `<p>You skim from supply wagons without being caught. You're richer, but you've dishonored yourself.</p>
                               <p>You've gained wealth but lost honor.</p>`;
                    } else {
                        return `<p>You're caught and punished severely. Your reputation is ruined.</p>
                               <p>You've lost significant favor and trust.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 10);
                        setFlag('Dishonor', true);
                        applyStatChange('stress', 1);
                    } else if (result) {
                        applyStatChange('patronFavor', -3);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "winter_flux"
                    }
                ]
            },
            winter_flux: {
                title: "Winter 1346‚Äì47: The Flux",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p><strong>Winter 1346‚Äì47 ‚Äî Calais lines / Neuville area</strong></p>
                       <p>Men call it "bad water" until it isn't a joke. The camp shrinks. Rotations get longer. A cook is found watering the stew. A man hangs himself from a wagon frame before dawn and no one claims to have heard anything.</p>`,
                choices: [
                    {
                        text: "Boil water, enforce cleanliness",
                        effects: {},
                        nextScene: "flux_clean",
                        requiresResolution: true,
                        resolutionStat: "wits",
                        resolutionDifficulty: 9
                    },
                    {
                        text: "Buy better food at ruinous prices",
                        effects: {},
                        nextScene: "flux_food"
                    },
                    {
                        text: "Look away and survive",
                        effects: {},
                        nextScene: "flux_survive",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    }
                ]
            },
            flux_clean: {
                title: "Enforcing Cleanliness",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You start boiling water...</p>`;
                    if (result.success) {
                        return `<p>You boil water and enforce cleanliness. You avoid the sickness that claims so many.</p>
                               <p>Your discipline saves you from the flux and earns favor.</p>`;
                    } else {
                        return `<p>You try, but you get sick anyway. The flux weakens you.</p>
                               <p>You're fatigued from the illness.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                    } else if (result) {
                        addCondition('Fatigued', 'negative', 2);
                        addCondition('Sick', 'negative', 2);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            flux_food: {
                title: "Buying Better Food",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const cost = 15;
                    if (gameState.stats.wealth >= cost) {
                        return `<p>You buy better food at ruinous prices. You're fed, and your morale improves.</p>
                               <p>You've spent wealth to prevent fatigue and maintain your health.</p>`;
                    } else {
                        return `<p>You can't afford better food. The hunger and despair shake you.</p>
                               <p>You're shaken by your poverty and the suffering around you.</p>`;
                    }
                },
                onEnter: function() {
                    const cost = 15;
                    if (gameState.stats.wealth >= cost) {
                        applyStatChange('wealth', -cost);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', -1);
                    } else {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            flux_survive: {
                title: "Looking Away",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You try to ignore it...</p>`;
                    if (result.success) {
                        return `<p>You look away and survive through numbness. You've hardened yourself.</p>
                               <p>Your emotional distance improves morale, but at a cost to your humanity.</p>`;
                    } else {
                        return `<p>You can't look away. The suffering shakes you to your core.</p>
                               <p>You're shaken by what you've witnessed.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        setFlag('Hardness', true);
                    } else if (result) {
                        addCondition('Shaken', 'negative', 1);
                        applyStatChange('stress', 2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "calais_keys"
                    }
                ]
            },
            calais_keys: {
                title: "The Keys of Calais",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p><strong>3‚Äì4 August 1347 ‚Äî Calais surrenders</strong></p>
                       <p>The gates open on terms. Six citizens step out with the keys. You see what starvation does to a wealthy city: not dramatic collapse, just thinning. The king's anger is a thing you can feel in your teeth‚Äîthen it turns, because a queen speaks.</p>`,
                choices: [
                    {
                        text: "Stay disciplined and silent",
                        effects: {},
                        nextScene: "keys_disciplined",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 7
                    },
                    {
                        text: "Offer water to a citizen",
                        effects: {},
                        nextScene: "keys_water",
                        requiresResolution: true,
                        resolutionStat: "morale",
                        resolutionDifficulty: 5
                    },
                    {
                        text: "Grab a souvenir (keys/cloth/coin)",
                        effects: {},
                        nextScene: "keys_souvenir",
                        requiresResolution: true,
                        resolutionStat: "agility",
                        resolutionDifficulty: 9
                    }
                ]
            },
            keys_disciplined: {
                title: "Staying Disciplined",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You stand at attention...</p>`;
                    if (result.success) {
                        return `<p>You stay disciplined and silent during the surrender. Your professionalism is noted.</p>
                               <p>You've earned favor and maintained your honor.</p>`;
                    } else {
                        return `<p>You join the jeering crowd. Your lack of discipline is noted.</p>
                               <p>You've dishonored yourself through poor behavior.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('patronFavor', 1);
                        applyStatChange('morale', 1);
                    } else if (result) {
                        setFlag('Dishonor', true);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            keys_water: {
                title: "Offering Water",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see a citizen...</p>`;
                    if (result.success) {
                        return `<p>You offer water to a citizen. The small act of mercy improves your morale.</p>
                               <p>You've reduced any hardness penalty and maintained your humanity.</p>`;
                    } else {
                        return `<p>You're mocked for showing mercy. The taunts get under your skin.</p>
                               <p>Your morale suffers from the mockery.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('morale', 1);
                        if (hasFlag('Hardness')) {
                            setFlag('Hardness', false);
                        }
                    } else if (result) {
                        applyStatChange('morale', -1);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            keys_souvenir: {
                title: "Taking a Souvenir",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: function() {
                    const result = gameState.lastResolution;
                    if (!result) return `<p>You see an opportunity...</p>`;
                    if (result.success) {
                        return `<p>You grab a souvenir‚Äîkeys, cloth, or coin. You're richer, but you've dishonored yourself.</p>
                               <p>You've gained wealth but lost honor.</p>`;
                    } else {
                        return `<p>You're caught and punished. Your reputation suffers.</p>
                               <p>You've lost favor through your greed.</p>`;
                    }
                },
                onEnter: function() {
                    const result = gameState.lastResolution;
                    if (result && result.success) {
                        applyStatChange('wealth', 12);
                        setFlag('Dishonor', true);
                    } else if (result) {
                        applyStatChange('patronFavor', -2);
                    }
                },
                choices: [
                    {
                        text: "Continue",
                        effects: {},
                        nextScene: "after_crecy"
                    }
                ]
            },
            after_crecy: {
                title: "After Cr√©cy",
                year: 1347,
                age: 28,
                location: "Calais, France",
                text: `<p>Cr√©cy was a disaster for the French. Thousands fell to English arrows. But you survived.</p>
                       <p>The war continues. You've learned that battles are won not just by courage, but by strategy and sometimes, by knowing when to retreat.</p>
                       <p>Your journey as a man-at-arms continues. The 100 Years War has only just begun...</p>`,
                choices: [
                    {
                        text: "Your story continues...",
                        effects: {},
                        nextScene: "end_game"
                    }
                ]
            },
            end_game: {
                title: "Your Legacy",
                year: 1347,
                age: 28,
                text: `<p>This is but the beginning of your story. The 100 Years War will span your lifetime and beyond.</p>
                       <p>You have survived Cr√©cy, one of history's great battles. Your choices have shaped who you are.</p>
                       <p><strong>Your Final Stats:</strong></p>
                       <p>You have become a veteran of war. Your story is written in the choices you made.</p>`,
                choices: [
                    {
                        text: "Start a New Game",
                        effects: {},
                        nextScene: "restart"
                    }
                ]
            },
            restart: {
                title: "New Beginning",
                year: null,
                age: null,
                text: `<p>Would you like to start a new game?</p>`,
                choices: [
                    {
                        text: "Yes, start over",
                        effects: {},
                        nextScene: "reset"
                    }
                ]
            },
            reset: {
                title: "Starting Over",
                year: 1337,
                age: 18,
                text: `<p>Your journey begins anew...</p>`,
                choices: [
                    {
                        text: "Begin",
                        effects: {},
                        nextScene: "start"
                    }
                ]
            }
        };
        
        // Initialize game
        function initGame() {
            console.log("=== INIT GAME START ===");
            console.log("initGame called");
            console.log("gameState.currentScene:", gameState.currentScene);
            console.log("scenes object exists:", typeof scenes !== 'undefined');
            
            // Ensure we start at character creation if no save exists or if scene is invalid
            if (!gameState.currentScene || gameState.currentScene === 'start') {
                console.log("Forcing character creation scene (no scene or start)");
                gameState.currentScene = 'character_creation';
                gameState.characterName = gameState.characterName || "";
                gameState.background = gameState.background || null;
            } else if (typeof scenes !== 'undefined' && !scenes[gameState.currentScene]) {
                console.log("Forcing character creation scene (invalid scene:", gameState.currentScene + ")");
                gameState.currentScene = 'character_creation';
                gameState.characterName = gameState.characterName || "";
                gameState.background = gameState.background || null;
            }
            
            console.log("Final currentScene:", gameState.currentScene);
            console.log("Scene exists:", typeof scenes !== 'undefined' && scenes[gameState.currentScene] ? 'YES' : 'NO');
            
            // Initialize equipment manager if not already done
            try {
                if (typeof EquipmentManager !== 'undefined' && !window.equipmentManager) {
                    window.equipmentManager = new EquipmentManager(gameState);
                }
            } catch (e) {
                console.error("Error initializing equipment manager:", e);
            }
            
            console.log("Calling updateDisplay");
            try {
                updateDisplay();
                console.log("updateDisplay completed");
            } catch (e) {
                console.error("updateDisplay threw error:", e);
                const storyEl = document.getElementById('story');
                if (storyEl) {
                    storyEl.innerHTML = '<p style="color: red;">Error initializing game. Check console for details.</p><p>Error: ' + e.message + '</p>';
                }
            }
            console.log("=== INIT GAME END ===");
        }
        
        // Update all displays
        function updateDisplay() {
            // Isolate each renderer so one failure doesn't block others
            try {
                updateStory();
            } catch (e) {
                console.error('updateStory failed:', e);
            }
            try {
                updateStats();
            } catch (e) {
                console.error('updateStats failed:', e);
            }
            try {
                updateChoices();
            } catch (e) {
                console.error('updateChoices failed:', e);
            }
            try {
                updateStatusBar();
            } catch (e) {
                console.error('updateStatusBar failed:', e);
            }
        }
        
        // Update story text
        function updateStory() {
            console.log("=== UPDATE STORY START ===");
            // Get story element once at the start
            const storyElement = document.getElementById('story');
            if (!storyElement) {
                console.error("Story element not found!");
                return;
            }
            console.log("Story element found:", storyElement);
            
            // Declare scene in function scope so it's accessible throughout
            let scene;
            
            try {
                console.log("updateStory called, currentScene:", gameState.currentScene);
                console.log("scenes object exists:", typeof scenes !== 'undefined');
                
                if (typeof scenes === 'undefined') {
                    console.error("scenes object is not defined!");
                    storyElement.innerHTML = '<p>Error: Scenes not loaded. Please refresh the page.</p>';
                    return;
                }
                
                console.log("scenes keys:", Object.keys(scenes).slice(0, 5));
                
                // Assign scene (not const, so it's accessible outside try block)
                scene = scenes[gameState.currentScene];
                if (!scene) {
                    console.error("Scene not found:", gameState.currentScene);
                    console.log("Available scenes:", Object.keys(scenes));
                    storyElement.innerHTML = `<p>Error: Scene "${gameState.currentScene}" not found. Available scenes: ${Object.keys(scenes).slice(0, 10).join(', ')}...</p>`;
                    return;
                }
                
                // Debug: log character creation scene
                if (gameState.currentScene === 'character_creation') {
                    console.log("Rendering character creation scene");
                }
            } catch (error) {
                console.error("Error in updateStory:", error);
                storyElement.innerHTML = `<p>Error loading scene: ${error.message}</p><p>Please check the console for details.</p>`;
                return;
            }
            
            // Now scene is guaranteed to be defined (or we've returned)
            // Update timeline if scene specifies it
            if (scene.year !== undefined && scene.year !== null) {
                gameState.year = scene.year;
            }
            if (scene.age !== undefined && scene.age !== null) {
                gameState.age = scene.age;
            }
            if (scene.location !== undefined && scene.location !== null) {
                gameState.location = scene.location;
            }
            
            // Update conditions
            updateConditions();
            
            // Run onEnter callback if present (only once per scene entry)
            if (scene.onEnter && typeof scene.onEnter === 'function') {
                const sceneKey = `${gameState.currentScene}_${gameState.year}`;
                if (!gameState.enteredScenes.has(sceneKey)) {
                    scene.onEnter();
                    gameState.enteredScenes.add(sceneKey);
                }
            }
            
            // Get story text (handle function-based text)
            let storyText = '';
            try {
                if (typeof scene.text === 'function') {
                    storyText = scene.text();
                } else if (typeof scene.text === 'string') {
                    storyText = scene.text;
                } else {
                    console.error("Scene text is neither function nor string:", typeof scene.text);
                    storyText = '<p>Error: Scene text format invalid.</p>';
                }
            } catch (error) {
                console.error("Error rendering scene text:", error);
                console.error("Error stack:", error.stack);
                storyText = `<p>Error loading scene content. Please refresh the page.</p><p>Error: ${error.message}</p><p>Check console for details.</p>`;
            }
            
            // Ensure we have some text to display
            if (!storyText || storyText.trim() === '') {
                console.error("storyText is empty after rendering!");
                storyText = '<p>Error: Scene rendered empty content.</p>';
            }
            
            // Add rank display
            let rankDisplay = '';
            if (gameState.rank) {
                rankDisplay = `<div class="rank-display">Rank: ${gameState.rank}</div>`;
            }
            
            // Add patron favor display
            let favorDisplay = '';
            if (gameState.stats.patronFavor > 0) {
                favorDisplay = `<div style="margin-top: 5px; color: #f4d03f;">Patron Favor: ${gameState.stats.patronFavor}</div>`;
            }
            
            // Add equipment display (skip for character creation)
            let equipmentDisplay = '';
            if (gameState.currentScene !== 'character_creation') {
                // Old equipment format check - skip if using new layered system
                try {
                    if (gameState.equipment && gameState.equipment.weapon && gameState.equipment.weapon.quality > 0) {
                        equipmentDisplay = `<div style="margin-top: 5px; font-size: 0.9em;">
                            Equipment: ${gameState.equipment.weapon.name || 'Weapon'} (Quality +${gameState.equipment.weapon.quality})
                        </div>`;
                    }
                } catch (e) {
                    // Equipment display is optional, ignore errors
                }
            }
            
            // Add conditions display
            let conditionsDisplay = '';
            if (gameState.conditions.length > 0) {
                conditionsDisplay = '<div style="margin-top: 10px;"><strong>Conditions:</strong> ';
                conditionsDisplay += gameState.conditions.map(c => 
                    `<span class="condition-badge ${c.type}">${c.name}</span>`
                ).join('');
                conditionsDisplay += '</div>';
            }
            
            // Render the story - ensure we always set innerHTML even if something is undefined
            try {
                const title = scene.title || 'Untitled Scene';
                storyElement.innerHTML = 
                    `<h2 style="margin-bottom: 15px; color: #f4d03f;">${title}</h2>
                     ${rankDisplay || ''}
                     ${favorDisplay || ''}
                     ${equipmentDisplay || ''}
                     ${storyText || '<p>No content available.</p>'}
                     ${conditionsDisplay || ''}`;
                storyElement.classList.add('fade-in');
                console.log("Successfully rendered story for scene:", gameState.currentScene);
            } catch (error) {
                console.error("Error setting storyElement.innerHTML:", error);
                storyElement.innerHTML = `<p>Error rendering scene: ${error.message}</p><p>Scene: ${gameState.currentScene}</p>`;
            }
        }
        
        // Update stats display
        function updateStats() {
            const statsContainer = document.getElementById('stats');
            const stats = gameState.stats;
            
            // Apply condition effects for display
            const conditionEffects = getConditionEffects();
            
            const statItems = [
                { key: 'strength', label: '‚öîÔ∏è Strength', max: 10 },
                { key: 'agility', label: 'üèÉ Agility', max: 10 },
                { key: 'endurance', label: '‚ù§Ô∏è Endurance', max: 10 },
                { key: 'charisma', label: 'üí¨ Charisma', max: 10 },
                { key: 'luck', label: 'üçÄ Luck', max: 10 },
                { key: 'wits', label: 'üß† Wits', max: 10 },
                { key: 'morale', label: 'üí™ Morale', max: 10 },
                { key: 'stress', label: 'üò∞ Stress', max: 10 },
                { key: 'wealth', label: 'üí∞ Wealth', max: 200, isSpecial: true },
                { key: 'reputation', label: '‚≠ê Reputation', max: 50, isSpecial: true },
                { key: 'experience', label: '‚≠ê Experience', max: 1000, isSpecial: true },
                { key: 'patronFavor', label: 'üëë Patron Favor', max: 20, isSpecial: true }
            ];
            
            statsContainer.innerHTML = statItems.map(stat => {
                let value = stats[stat.key] || 0;
                // Apply condition effects (but not equipment - that's situational)
                if (conditionEffects[stat.key]) {
                    value += conditionEffects[stat.key];
                }
                value = Math.max(0, Math.min(stat.max, value));
                const percentage = (value / stat.max) * 100;
                
                if (stat.isSpecial) {
                    return `
                        <div class="stat-item">
                            <div class="stat-label">${stat.label}</div>
                            <div class="stat-special">${value} ${stat.key === 'wealth' ? 'silver' : stat.key === 'experience' ? 'XP' : 'points'}</div>
                        </div>
                    `;
                }
                
                // Show effective stat if different from base
                const effectiveValue = getEffectiveStat(stat.key);
                const effectiveDisplay = effectiveValue !== value ? ` (Effective: ${effectiveValue})` : '';
                
                return `
                    <div class="stat-item">
                        <div class="stat-label">${stat.label}${effectiveDisplay}</div>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: ${percentage}%"></div>
                            <div class="stat-value">${value}/${stat.max}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update choices
        function updateChoices() {
            const scene = scenes[gameState.currentScene];
            if (!scene) return;
            
            const choicesContainer = document.getElementById('choices-container');
            
            choicesContainer.innerHTML = scene.choices.map((choice, index) => {
                let effectsText = '';
                if (showEffectsPreview && choice.effects) {
                    effectsText = Object.entries(choice.effects)
                        .map(([key, value]) => {
                            const sign = value > 0 ? '+' : '';
                            return `${sign}${value} ${key}`;
                        })
                        .join(', ');
                }
                
                // Check requirements
                let disabled = false;
                let disabledReason = '';
                if (choice.requires) {
                    if (choice.requires.stat) {
                        const statValue = gameState.stats[choice.requires.stat] || 0;
                        if (statValue < choice.requires.min) {
                            disabled = true;
                            disabledReason = `Requires ${choice.requires.stat} ‚â• ${choice.requires.min}`;
                        }
                    }
                }
                
                return `
                    <button class="choice-button" onclick="makeChoice(${index})" ${disabled ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${choice.text}
                        ${effectsText ? `<span class="choice-effects">${effectsText}</span>` : ''}
                        ${disabledReason ? `<span class="choice-effects" style="color: #8b0000;">${disabledReason}</span>` : ''}
                    </button>
                `;
            }).join('');
        }
        
        // Update status bar
        function updateStatusBar() {
            document.getElementById('year').textContent = gameState.year;
            document.getElementById('age').textContent = gameState.age;
            document.getElementById('location').textContent = gameState.location;
        }
        
        // ===== COMBAT SYSTEM FUNCTIONS =====
        
        function updateHealthBars() {
            const playerBar = document.getElementById('player-health-bar');
            const enemyBar = document.getElementById('enemy-health-bar');
            
            if (!playerBar || !enemyBar) return;
            
            playerBar.style.width = combatState.playerHealth + '%';
            playerBar.textContent = Math.max(0, Math.floor(combatState.playerHealth));
            playerBar.className = 'health-fill' + 
                (combatState.playerHealth < 30 ? ' low' : 
                 combatState.playerHealth < 60 ? ' medium' : '');
            
            enemyBar.style.width = combatState.enemyHealth + '%';
            enemyBar.textContent = Math.max(0, Math.floor(combatState.enemyHealth));
            enemyBar.className = 'health-fill' + 
                (combatState.enemyHealth < 30 ? ' low' : 
                 combatState.enemyHealth < 60 ? ' medium' : '');
        }
        
        function addLogEntry(message, type = 'info') {
            // Try to find combat log in overlay, fallback to console
            const log = document.getElementById('combat-log');
            if (log) {
                const entry = document.createElement('div');
                entry.className = 'log-entry ' + type;
                entry.textContent = message;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            } else {
                // Fallback to console if log element doesn't exist
                console.log(`[Combat ${type}]: ${message}`);
            }
        }
        
        function calculateZoneSize(actionType, baseStat, modifiers) {
            let zoneSize = 60 + (baseStat * 12);
            
            if (combatState.playerState.stance === 'aggressive') {
                zoneSize += 10;
            } else if (combatState.playerState.stance === 'guarded') {
                zoneSize -= 5;
            }
            
            const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
            zoneSize -= fatiguePenalty * 3;
            
            if (modifiers.weaponQuality) {
                zoneSize += modifiers.weaponQuality * 8;
            }
            if (modifiers.terrain === 'mud') {
                zoneSize -= 20;
            } else if (modifiers.terrain === 'high_ground') {
                zoneSize += 15;
            }
            if (modifiers.positioning === 'advantage') {
                zoneSize += 15;
            } else if (modifiers.positioning === 'disadvantage') {
                zoneSize -= 20;
            }
            
            zoneSize -= (modifiers.enemyDefense - combatState.enemyState.defenseReduced) * 3;
            
            if (actionType === 'measured') {
                zoneSize += 20;
            } else if (actionType === 'press') {
                zoneSize += 5;
            } else if (actionType === 'flurry') {
                zoneSize -= 15;
            }
            
            if (combatState.playerState.counterReady) {
                zoneSize += 15;
            }
            
            return Math.max(25, Math.min(150, zoneSize));
        }
        
        function calculateFatigueGain(actionType, stance) {
            let fatigue = 0;
            
            if (actionType === 'measured') {
                fatigue = 5;
            } else if (actionType === 'press') {
                fatigue = 12;
            } else if (actionType === 'flurry') {
                fatigue = 25;
            } else if (actionType === 'defend') {
                fatigue = 3;
            } else if (actionType === 'shield_bash') {
                fatigue = 15;
            } else if (actionType === 'dirty_trick') {
                fatigue = 8;
            }
            
            if (stance === 'aggressive') {
                fatigue = Math.floor(fatigue * 1.3);
            } else if (stance === 'guarded') {
                fatigue = Math.floor(fatigue * 0.7);
            }
            
            if (combatState.conditions.terrain === 'mud') {
                fatigue += 5;
            }
            
            return fatigue;
        }
        
        function showInitiativeCheck(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ playerWon: true, margin: 0, bonusActions: 0 });
                return;
            }
            
            title.textContent = '‚ö° Initiative Check';
            subtitle.textContent = 'Who acts first?';
            instructions.textContent = 'Press SPACE when the bar is in the green zone!';
            
            const barWidth = 600;
            const playerInitiative = combatState.playerStats.initiative;
            const enemyInitiative = combatState.enemyStats.initiative;
            
            const initiativeDiff = playerInitiative - enemyInitiative;
            const baseZoneSize = 80;
            const zoneSize = baseZoneSize + (initiativeDiff * 12);
            const greenZoneStart = (barWidth - zoneSize) / 2;
            const difficulty = 7 - Math.floor(initiativeDiff / 2);
            const speed = 2.0;
            
            display.innerHTML = `
                <div class="qte-bar-container">
                    <div class="qte-green-zone" id="green-zone" style="left: ${greenZoneStart}px; width: ${zoneSize}px;"></div>
                    <div class="qte-indicator" id="qte-indicator" style="left: 0;"></div>
                </div>
                <div style="color: #d4af37; margin-top: 20px; font-size: 18px;">
                    <small style="color: #888;">
                        Your Initiative: ${playerInitiative} | Enemy Initiative: ${enemyInitiative}
                        ${initiativeDiff > 0 ? '<br><span style="color: #0f0;">You have the advantage!</span>' : 
                          initiativeDiff < 0 ? '<br><span style="color: #f00;">Enemy is faster!</span>' : 
                          '<br>Equal speed!'}
                    </small>
                </div>
            `;
            
            const indicator = document.getElementById('qte-indicator');
            const greenZone = document.getElementById('green-zone');
            if (!indicator || !greenZone) {
                callback({ playerWon: true, margin: 0, bonusActions: 0 });
                return;
            }
            
            let position = 0;
            let direction = 1;
            let pressed = false;
            let animationId;
            
            const moveIndicator = () => {
                position += speed * direction;
                if (position >= barWidth - 8) {
                    direction = -1;
                    position = barWidth - 8;
                } else if (position <= 0) {
                    direction = 1;
                    position = 0;
                }
                indicator.style.left = position + 'px';
                
                if (!pressed) {
                    animationId = requestAnimationFrame(moveIndicator);
                    combatAnimationId = animationId;
                }
            };
            
            const handlePress = (e) => {
                if (e.code === 'Space' && !pressed) {
                    e.preventDefault();
                    pressed = true;
                    if (animationId) cancelAnimationFrame(animationId);
                    
                    const zoneStart = greenZoneStart;
                    const zoneEnd = zoneStart + zoneSize;
                    const inZone = position >= zoneStart && position <= zoneEnd;
                    const distance = inZone ? 0 : Math.min(
                        Math.abs(position - zoneStart),
                        Math.abs(position - zoneEnd)
                    );
                    
                    let roll = 10;
                    if (!inZone) {
                        roll = Math.max(1, 10 - Math.floor(distance / 20));
                    } else {
                        const center = zoneStart + zoneSize / 2;
                        const distanceFromCenter = Math.abs(position - center);
                        const centerBonus = distanceFromCenter < zoneSize / 4 ? 1 : 0;
                        roll = Math.min(10, 9 + centerBonus);
                    }
                    
                    const finalRoll = roll + playerInitiative;
                    const enemyRollDie = Math.floor(Math.random() * 10) + 1;
                    const enemyRoll = enemyRollDie + enemyInitiative;
                    const playerWon = finalRoll > enemyRoll;
                    const margin = Math.abs(finalRoll - enemyRoll);
                    
                    let bonusActions = 0;
                    if (playerWon && margin >= 5) {
                        bonusActions = 1;
                    }
                    
                    display.innerHTML = `
                        <div style="color: ${playerWon ? '#0f0' : '#f00'}; font-size: 32px; margin: 30px 0;">
                            ${playerWon ? '‚úì You Act First!' : '‚úó Enemy Acts First!'}
                        </div>
                        <div style="color: #d4af37; font-size: 18px;">
                            Your Roll: ${roll} + ${playerInitiative} = ${finalRoll}
                            <br>Enemy Roll: ${enemyRollDie} + ${enemyInitiative} = ${enemyRoll}
                            ${bonusActions > 0 ? `<br><span style="color: #0f0;">Bonus action gained from superior speed!</span>` : ''}
                        </div>
                    `;
                    
                    window.removeEventListener('keydown', handlePress);
                    setTimeout(() => {
                        callback({ 
                            playerWon, 
                            margin,
                            playerRoll: finalRoll,
                            enemyRoll: enemyRoll,
                            bonusActions 
                        });
                    }, 2000);
                }
            };
            
            window.addEventListener('keydown', handlePress);
            moveIndicator();
        }
        
        function showCombatQTE(actionType, attackStyle, stat, modifiers, callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ success: false, roll: 0, margin: 0, inZone: false, actionType, quality: 'miss' });
                return;
            }
            
            const actionNames = {
                'attack': '‚öîÔ∏è Attack',
                'defend': 'üõ°Ô∏è Defend',
                'shield_bash': 'üõ°Ô∏è Shield Bash',
                'dirty_trick': 'üéØ Dirty Trick',
                'flee': 'üèÉ Flee',
                'parry': 'üõ°Ô∏è Parry',
                'dodge': 'üí® Dodge',
                'interrupt': '‚öîÔ∏è Interrupt'
            };
            
            const styleNames = {
                'measured': 'Measured Strike',
                'press': 'Press Attack',
                'flurry': 'Flurry'
            };
            
            title.textContent = actionNames[actionType] || '‚öîÔ∏è Action';
            if (actionType === 'attack') {
                subtitle.textContent = styleNames[attackStyle] || 'Attack';
            } else {
                subtitle.textContent = actionNames[actionType];
            }
            
            instructions.textContent = 'Press SPACE when the bar is in the green zone!';
            
            const barWidth = 600;
            
            let baseZoneSize;
            if (actionType === 'attack') {
                baseZoneSize = calculateZoneSize(attackStyle, stat, modifiers);
            } else if (actionType === 'defend' || actionType === 'parry') {
                baseZoneSize = 80 + (combatState.playerStats.agility * 10);
                if (combatState.playerState.stance === 'guarded') {
                    baseZoneSize += 20;
                } else if (combatState.playerState.stance === 'aggressive') {
                    baseZoneSize -= 15;
                }
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
                baseZoneSize -= fatiguePenalty * 2;
            } else if (actionType === 'dodge') {
                baseZoneSize = 70 + (combatState.playerStats.agility * 12);
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 8);
                baseZoneSize -= fatiguePenalty * 3;
            } else if (actionType === 'interrupt') {
                baseZoneSize = 60 + (combatState.playerStats.strength * 10);
                const fatiguePenalty = Math.floor(combatState.playerState.fatigue / 10);
                baseZoneSize -= fatiguePenalty * 2;
            } else if (actionType === 'shield_bash') {
                baseZoneSize = 70 + (combatState.playerStats.strength * 8);
            } else if (actionType === 'dirty_trick') {
                baseZoneSize = 60 + (combatState.playerStats.agility * 12);
            } else { // flee
                baseZoneSize = 90 + (combatState.playerStats.agility * 15);
                baseZoneSize -= Math.floor(combatState.playerState.fatigue / 5);
            }
            
            const greenZoneStart = (barWidth - baseZoneSize) / 2;
            const difficulty = actionType === 'flee' ? 5 : (7 - Math.floor((baseZoneSize - 60) / 20));
            const speed = 2.0 + (combatState.playerState.fatigue > 50 ? 0.3 : 0);
            
            const useMovingZone = (actionType === 'attack' && attackStyle === 'flurry') || 
                                  actionType === 'dirty_trick';
            const zoneSpeed = 0.5;
            
            display.innerHTML = `
                <div class="qte-bar-container">
                    <div class="qte-green-zone" id="green-zone" style="left: ${greenZoneStart}px; width: ${baseZoneSize}px;"></div>
                    <div class="qte-indicator" id="qte-indicator" style="left: 0;"></div>
                </div>
                <div style="color: #d4af37; margin-top: 20px; font-size: 18px;">
                    ${useMovingZone ? '<span style="color: #f00;">‚ö†Ô∏è The green zone is moving!</span><br>' : ''}
                    <small style="color: #888;">
                        ${actionType === 'attack' ? `Zone size: ${Math.floor(baseZoneSize)}px` : ''} |
                        ${modifiers.terrain === 'mud' ? 'Mud slows you down' : 
                          modifiers.terrain === 'high_ground' ? 'High ground advantage' : 
                          'Normal terrain'} |
                        ${modifiers.positioning === 'advantage' ? 'You have the advantage' : 
                          modifiers.positioning === 'disadvantage' ? 'You are at a disadvantage' : 
                          'Neutral positioning'}
                        ${combatState.conditions.enemyStunned > 0 ? ' | Enemy is stunned!' : ''}
                    </small>
                </div>
            `;
            
            const indicator = document.getElementById('qte-indicator');
            const greenZone = document.getElementById('green-zone');
            if (!indicator || !greenZone) {
                callback({ success: false, roll: 0, margin: 0, inZone: false, actionType, quality: 'miss' });
                return;
            }
            
            let position = 0;
            let direction = 1;
            let pressed = false;
            let animationId;
            let greenZonePosition = greenZoneStart;
            let greenZoneDirection = useMovingZone ? (Math.random() > 0.5 ? 1 : -1) : 0;
            
            const moveIndicator = () => {
                position += speed * direction;
                if (position >= barWidth - 8) {
                    direction = -1;
                    position = barWidth - 8;
                } else if (position <= 0) {
                    direction = 1;
                    position = 0;
                }
                indicator.style.left = position + 'px';
                
                if (useMovingZone) {
                    greenZonePosition += zoneSpeed * greenZoneDirection;
                    if (greenZonePosition + baseZoneSize >= barWidth) {
                        greenZoneDirection = -1;
                        greenZonePosition = barWidth - baseZoneSize;
                    } else if (greenZonePosition <= 0) {
                        greenZoneDirection = 1;
                        greenZonePosition = 0;
                    }
                    greenZone.style.left = greenZonePosition + 'px';
                }
                
                if (!pressed) {
                    animationId = requestAnimationFrame(moveIndicator);
                    combatAnimationId = animationId;
                }
            };
            
            const handlePress = (e) => {
                if (e.code === 'Space' && !pressed) {
                    e.preventDefault();
                    pressed = true;
                    if (animationId) cancelAnimationFrame(animationId);
                    
                    const zoneStart = useMovingZone ? greenZonePosition : greenZoneStart;
                    const zoneEnd = zoneStart + baseZoneSize;
                    const inZone = position >= zoneStart && position <= zoneEnd;
                    const distance = inZone ? 0 : Math.min(
                        Math.abs(position - zoneStart),
                        Math.abs(position - zoneEnd)
                    );
                    
                    let roll = 10;
                    let quality = 'miss';
                    
                    if (!inZone) {
                        roll = Math.max(1, 10 - Math.floor(distance / 20));
                        quality = 'miss';
                    } else {
                        const center = zoneStart + baseZoneSize / 2;
                        const distanceFromCenter = Math.abs(position - center);
                        if (distanceFromCenter < baseZoneSize / 6) {
                            roll = 10;
                            quality = 'perfect';
                        } else if (distanceFromCenter < baseZoneSize / 3) {
                            roll = 9;
                            quality = 'good';
                        } else {
                            roll = 7;
                            quality = 'glancing';
                        }
                    }
                    
                    const finalRoll = roll + stat + combatState.playerState.nextActionBonus;
                    const success = finalRoll >= difficulty;
                    const margin = finalRoll - difficulty;
                    
                    const resultText = {
                        'attack': quality === 'perfect' ? '‚úì PERFECT HIT!' : 
                                 quality === 'good' ? '‚úì SOLID HIT!' :
                                 quality === 'glancing' ? '‚úì GLANCING BLOW!' : '‚úó MISS!',
                        'defend': quality === 'perfect' ? '‚úì PERFECT BLOCK!' :
                                 quality === 'good' ? '‚úì BLOCKED!' : '‚úó FAILED!',
                        'parry': quality === 'perfect' ? '‚úì PERFECT PARRY!' :
                                quality === 'good' ? '‚úì PARRY!' : '‚úó FAILED!',
                        'dodge': quality === 'perfect' ? '‚úì PERFECT DODGE!' :
                                quality === 'good' ? '‚úì DODGED!' : '‚úó HIT!',
                        'interrupt': success ? '‚úì INTERRUPTED!' : '‚úó FAILED!',
                        'shield_bash': success ? '‚úì BASHED!' : '‚úó MISSED!',
                        'dirty_trick': success ? '‚úì TRICKED!' : '‚úó FAILED!',
                        'flee': success ? '‚úì ESCAPED!' : '‚úó TRAPPED!'
                    };
                    
                    display.innerHTML = `
                        <div style="color: ${success ? '#0f0' : '#f00'}; font-size: 32px; margin: 30px 0;">
                            ${resultText[actionType] || (success ? '‚úì SUCCESS!' : '‚úó FAILURE!')}
                        </div>
                        <div style="color: #d4af37; font-size: 18px;">
                            Roll: 1d10 (${roll}) + ${stat}${combatState.playerState.nextActionBonus > 0 ? ` + ${combatState.playerState.nextActionBonus} (counter)` : ''} = ${finalRoll} vs ${difficulty}
                            <br>Quality: ${quality.toUpperCase()}
                        </div>
                    `;
                    
                    window.removeEventListener('keydown', handlePress);
                    setTimeout(() => {
                        callback({ success, roll: finalRoll, margin, inZone, actionType, quality });
                    }, 1500);
                }
            };
            
            window.addEventListener('keydown', handlePress);
            moveIndicator();
        }
        
        function showActionSelection(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                console.error('Combat overlay elements not found');
                callback({ action: 'attack', attackStyle: 'measured', stance: 'balanced', actionsUsed: 1 });
                return;
            }
            
            title.textContent = `‚öîÔ∏è Round ${combatState.currentRound} - Choose Your Actions`;
            subtitle.textContent = `${combatState.actionsRemaining} action${combatState.actionsRemaining !== 1 ? 's' : ''} remaining`;
            
            let selectedAction = null;
            let attackStyle = 'measured';
            let selectedStance = combatState.playerState.stance || 'balanced';
            let actionsUsed = 0;
            
            const updateDisplay = () => {
                const actionsText = combatState.actionsRemaining - actionsUsed > 0 
                    ? `${combatState.actionsRemaining - actionsUsed} action${combatState.actionsRemaining - actionsUsed !== 1 ? 's' : ''} remaining`
                    : 'No actions remaining';
                
                instructions.innerHTML = `
                    <div class="actions-remaining">${actionsText}</div>
                    <div style="margin: 15px 0; padding: 10px; background: rgba(212,175,55,0.1); border-radius: 5px;">
                        <div style="color: #d4af37; margin-bottom: 10px;">Stance: 
                            <button onclick="window.selectStance('aggressive')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'aggressive' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'aggressive' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Aggressive (+damage, +fatigue)
                            </button>
                            <button onclick="window.selectStance('balanced')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'balanced' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'balanced' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Balanced
                            </button>
                            <button onclick="window.selectStance('guarded')" style="margin: 0 5px; padding: 5px 10px; background: ${selectedStance === 'guarded' ? '#d4af37' : '#2a2a2a'}; border: 1px solid #d4af37; color: ${selectedStance === 'guarded' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 3px;">
                                Guarded (-damage, -fatigue, +defense)
                            </button>
                        </div>
                        <div style="color: #888; font-size: 12px;">
                            Fatigue: ${combatState.playerState.fatigue}/100
                            ${combatState.playerState.fatigue > 70 ? ' <span style="color: #f00;">(High fatigue - smaller zones!)</span>' : ''}
                            ${combatState.playerState.counterReady ? ' <span style="color: #0f0;">Counter ready!</span>' : ''}
                        </div>
                    </div>
                    ${selectedAction === 'attack' ? `
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="color: #d4af37; margin-bottom: 10px;">Attack Style:</div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="window.selectAttackStyle('measured')" style="padding: 15px 20px; background: ${attackStyle === 'measured' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${attackStyle === 'measured' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Measured<br><small>Big zone, moderate damage</small>
                                </button>
                                <button onclick="window.selectAttackStyle('press')" style="padding: 15px 20px; background: ${attackStyle === 'press' ? '#d4af37' : '#2a2a2a'}; border: 2px solid #d4af37; color: ${attackStyle === 'press' ? '#1a0f08' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Press<br><small>Smaller zone, higher damage</small>
                                </button>
                                <button onclick="window.selectAttackStyle('flurry')" style="padding: 15px 20px; background: ${attackStyle === 'flurry' ? '#f00' : '#2a2a2a'}; border: 2px solid ${attackStyle === 'flurry' ? '#f00' : '#d4af37'}; color: ${attackStyle === 'flurry' ? 'white' : '#d4af37'}; cursor: pointer; border-radius: 5px; font-size: 16px;">
                                    Flurry<br><small>Smallest zone, multi-hit, high fatigue</small>
                                </button>
                            </div>
                            <div style="color: #888; margin-top: 10px; font-size: 14px;">
                                ${attackStyle === 'flurry' ? '<span style="color: #f00;">Uses both actions!</span>' : 'Uses 1 action'}
                            </div>
                        </div>
                    ` : ''}
                `;
            };
            
            display.innerHTML = `
                <div class="action-selection">
                    <button class="action-button" onclick="window.selectAction('attack')">
                        ‚öîÔ∏è Attack
                        <div class="action-details">Strike your enemy</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('defend')">
                        üõ°Ô∏è Defend
                        <div class="action-details">Block incoming attacks</div>
                    </button>
                    <button class="action-button ${!combatState.playerStats.shield ? 'disabled' : ''}" 
                            onclick="window.selectAction('shield_bash')" ${!combatState.playerStats.shield ? 'disabled' : ''}>
                        üõ°Ô∏è Shield Bash
                        <div class="action-details">Stun enemy (requires shield)</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('dirty_trick')">
                        üéØ Dirty Trick
                        <div class="action-details">Disorient your enemy</div>
                    </button>
                    <button class="action-button" onclick="window.selectAction('flee')">
                        üèÉ Flee
                        <div class="action-details">Attempt to escape</div>
                    </button>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="start-button" onclick="window.confirmAction()" style="max-width: 300px; padding: 15px;">
                        Confirm Action
                    </button>
                </div>
            `;
            
            window.selectAction = (action) => {
                selectedAction = action;
                attackStyle = 'measured';
                actionsUsed = 0;
                
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Find the button that was clicked by checking onclick attribute
                const buttons = document.querySelectorAll('.action-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${action}'`)) {
                        btn.classList.add('selected');
                    }
                });
                
                if (action === 'attack') {
                    actionsUsed = 1;
                } else {
                    actionsUsed = 1;
                }
                
                updateDisplay();
            };
            
            window.selectAttackStyle = (style) => {
                attackStyle = style;
                actionsUsed = style === 'flurry' ? 2 : 1;
                
                document.querySelectorAll('[onclick*="selectAttackStyle"]').forEach(btn => {
                    btn.style.background = '#2a2a2a';
                    btn.style.color = '#d4af37';
                    btn.style.borderColor = '#d4af37';
                });
                // Find and highlight the clicked button
                document.querySelectorAll('[onclick*="selectAttackStyle"]').forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${style}'`)) {
                        btn.style.background = style === 'flurry' ? '#f00' : '#d4af37';
                        btn.style.color = 'white';
                        btn.style.borderColor = style === 'flurry' ? '#f00' : '#d4af37';
                    }
                });
                
                updateDisplay();
            };
            
            window.selectStance = (stance) => {
                selectedStance = stance;
                updateDisplay();
            };
            
            window.confirmAction = () => {
                if (!selectedAction) {
                    alert('Please select an action!');
                    return;
                }
                
                if (selectedAction === 'attack' && (combatState.actionsRemaining - actionsUsed) < 0) {
                    alert('Not enough actions remaining!');
                    return;
                }
                
                if (selectedAction !== 'attack' && combatState.actionsRemaining < 1) {
                    alert('No actions remaining!');
                    return;
                }
                
                delete window.selectAction;
                delete window.selectAttackStyle;
                delete window.selectStance;
                delete window.confirmAction;
                
                callback({
                    action: selectedAction,
                    attackStyle: selectedAction === 'attack' ? attackStyle : null,
                    stance: selectedStance,
                    actionsUsed: selectedAction === 'attack' ? actionsUsed : 1
                });
            };
            
            updateDisplay();
        }
        
        function determineEnemyIntent() {
            const archetype = combatState.enemyStats.archetype;
            let intent;
            
            if (archetype === 'aggressive') {
                intent = Math.random() > 0.4 ? 'heavy' : 'quick';
            } else if (archetype === 'cautious') {
                if (combatState.playerState.fatigue > 60) {
                    intent = 'heavy';
                } else {
                    intent = Math.random() > 0.6 ? 'defend' : 'quick';
                }
            } else { // skilled
                const rand = Math.random();
                intent = rand > 0.6 ? 'heavy' : rand > 0.3 ? 'quick' : 'defend';
            }
            
            combatState.enemyState.nextIntent = intent;
            combatState.enemyState.intentTelegraphed = true;
            
            const intentText = {
                'heavy': 'winds up a heavy cut',
                'quick': 'probes with quick jabs',
                'defend': 'raises guard defensively'
            };
            
            return intentText[intent];
        }
        
        async function enemyAttack() {
            const intentText = determineEnemyIntent();
            addLogEntry(`Enemy ${intentText}!`, 'info');
            
            const response = await new Promise((resolve) => {
                showEnemyResponseSelection(resolve);
            });
            
            const defenseResult = await new Promise((resolve) => {
                showCombatQTE(
                    response.action,
                    null,
                    combatState.playerStats.agility,
                    combatState.conditions,
                    resolve
                );
            });
            
            const intent = combatState.enemyState.nextIntent;
            const baseDamage = intent === 'heavy' ? 25 : 12;
            
            if (response.action === 'parry') {
                if (defenseResult.quality === 'perfect') {
                    combatState.playerState.counterReady = true;
                    combatState.playerState.nextActionBonus = 3;
                    addLogEntry('Perfect parry! Counter ready!', 'success');
                } else if (defenseResult.success) {
                    const damage = Math.floor(baseDamage * 0.3);
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                    addLogEntry(`Parried! (${damage} damage)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Parry failed! (${baseDamage} damage)`, 'failure');
                }
            } else if (response.action === 'dodge') {
                if (defenseResult.quality === 'perfect') {
                    addLogEntry('Perfect dodge! No damage!', 'success');
                } else if (defenseResult.success) {
                    const damage = Math.floor(baseDamage * 0.5);
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                    addLogEntry(`Dodged! (${damage} damage)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Dodge failed! (${baseDamage} damage)`, 'failure');
                }
            } else if (response.action === 'interrupt') {
                if (defenseResult.success) {
                    const damage = 15;
                    combatState.enemyHealth = Math.max(0, combatState.enemyHealth - damage);
                    addLogEntry(`Interrupted enemy! (${damage} damage to enemy)`, 'success');
                } else {
                    combatState.playerHealth = Math.max(0, combatState.playerHealth - baseDamage);
                    addLogEntry(`Interrupt failed! (${baseDamage} damage)`, 'failure');
                }
            }
            
            if (defenseResult.success === false || defenseResult.quality === 'glancing') {
                combatState.playerState.fatigue += 5;
            }
            
            updateHealthBars();
        }
        
        function showEnemyResponseSelection(callback) {
            const title = document.getElementById('minigame-title');
            const subtitle = document.getElementById('minigame-subtitle');
            const display = document.getElementById('minigame-display');
            const instructions = document.getElementById('minigame-instructions');
            
            if (!title || !subtitle || !display || !instructions) {
                callback({ action: 'parry' });
                return;
            }
            
            const intent = combatState.enemyState.nextIntent;
            const intentText = {
                'heavy': 'Heavy Cut',
                'quick': 'Quick Jabs',
                'defend': 'Defensive Stance'
            };
            
            title.textContent = `‚öîÔ∏è Enemy ${intentText[intent]}!`;
            subtitle.textContent = 'Choose your response';
            instructions.textContent = 'How do you respond?';
            
            display.innerHTML = `
                <div class="action-selection">
                    <button class="action-button" onclick="window.selectResponse('parry')">
                        üõ°Ô∏è Parry
                        <div class="action-details">Block and counter (perfect = counter ready)</div>
                    </button>
                    <button class="action-button" onclick="window.selectResponse('dodge')">
                        üí® Dodge
                        <div class="action-details">Avoid the attack (perfect = no damage)</div>
                    </button>
                    <button class="action-button" onclick="window.selectResponse('interrupt')">
                        ‚öîÔ∏è Interrupt
                        <div class="action-details">Strike first (risky but rewarding)</div>
                    </button>
                </div>
            `;
            
            let selectedResponse = null;
            
            window.selectResponse = (action) => {
                selectedResponse = action;
                document.querySelectorAll('.action-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Find the button that was clicked
                const buttons = document.querySelectorAll('.action-button');
                buttons.forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(`'${action}'`)) {
                        btn.classList.add('selected');
                    }
                });
                
                setTimeout(() => {
                    delete window.selectResponse;
                    callback({ action: selectedResponse });
                }, 300);
            };
        }
        
        async function startCombat() {
            // Reset combat state
            combatState.playerHealth = 100;
            combatState.enemyHealth = combatState.enemyStats.health || 100;
            combatState.currentRound = 1;
            combatState.actionsRemaining = 2;
            combatState.conditions.defending = false;
            combatState.conditions.enemyStunned = 0;
            combatState.conditions.playerStunned = 0;
            combatState.combatHistory = [];
            combatState.turnOrder = 'player';
            combatState.playerState.counterReady = false;
            combatState.playerState.nextActionBonus = 0;
            
            // Clear log (if exists)
            const log = document.getElementById('combat-log');
            if (log) {
                log.innerHTML = '<h3>Combat Log</h3>';
            }
            addLogEntry('Combat begins!', 'info');
            
            // Show overlay
            const overlay = document.getElementById('minigame-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
            updateHealthBars();
            
            // Initiative check
            addLogEntry('--- Initiative Check ---', 'info');
            const initiativeResult = await new Promise((resolve) => {
                showInitiativeCheck(resolve);
            });
            
            combatState.initiative.playerWon = initiativeResult.playerWon;
            combatState.initiative.margin = initiativeResult.margin;
            combatState.initiative.playerActions = 2 + initiativeResult.bonusActions;
            combatState.turnOrder = initiativeResult.playerWon ? 'player' : 'enemy';
            
            if (initiativeResult.playerWon) {
                addLogEntry(`You win initiative! (${initiativeResult.bonusActions > 0 ? '+1 bonus action' : ''})`, 'success');
            } else {
                addLogEntry('Enemy wins initiative!', 'failure');
            }
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Combat loop
            while (combatState.playerHealth > 0 && combatState.enemyHealth > 0) {
                // Reset actions for new round
                combatState.actionsRemaining = combatState.initiative.playerActions;
                combatState.conditions.defending = false;
                
                // Reduce fatigue slightly each round (recovery)
                combatState.playerState.fatigue = Math.max(0, combatState.playerState.fatigue - 3);
                
                // Reduce stun counters
                if (combatState.conditions.enemyStunned > 0) {
                    combatState.conditions.enemyStunned--;
                }
                if (combatState.conditions.playerStunned > 0) {
                    combatState.conditions.playerStunned--;
                }
                
                addLogEntry(`--- Round ${combatState.currentRound} ---`, 'info');
                
                // Turn order based on initiative
                if (combatState.turnOrder === 'enemy' && combatState.conditions.playerStunned === 0) {
                    await enemyAttack();
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                }
                
                // Player actions
                while (combatState.actionsRemaining > 0 && combatState.playerHealth > 0 && combatState.enemyHealth > 0) {
                    const actionChoice = await new Promise((resolve) => {
                        showActionSelection(resolve);
                    });
                    
                    combatState.actionsRemaining -= actionChoice.actionsUsed;
                    combatState.playerState.stance = actionChoice.stance;
                    
                    if (actionChoice.action === 'attack') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'attack',
                                actionChoice.attackStyle,
                                combatState.playerStats.strength + combatState.playerStats.weaponQuality,
                                {
                                    weaponQuality: combatState.playerStats.weaponQuality,
                                    terrain: combatState.conditions.terrain,
                                    enemyDefense: combatState.conditions.enemyDefense - combatState.enemyState.defenseReduced - (combatState.conditions.enemyStunned > 0 ? 2 : 0),
                                    positioning: combatState.conditions.positioning
                                },
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain(actionChoice.attackStyle, actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        let damage = 0;
                        let hits = 1;
                        
                        if (result.success) {
                            if (actionChoice.attackStyle === 'measured') {
                                damage = result.quality === 'perfect' ? 20 : result.quality === 'good' ? 15 : 10;
                            } else if (actionChoice.attackStyle === 'press') {
                                damage = result.quality === 'perfect' ? 30 : result.quality === 'good' ? 22 : 12;
                            } else if (actionChoice.attackStyle === 'flurry') {
                                hits = result.quality === 'perfect' ? 3 : result.quality === 'good' ? 2 : 1;
                                damage = hits * 12;
                            }
                            
                            if (result.quality === 'perfect' && actionChoice.attackStyle !== 'flurry') {
                                combatState.conditions.enemyStunned = 1;
                                addLogEntry('Perfect hit! Enemy stunned!', 'success');
                            }
                            
                            combatState.enemyHealth = Math.max(0, combatState.enemyHealth - damage);
                            addLogEntry(`${result.quality === 'perfect' ? 'Perfect' : result.quality === 'good' ? 'Solid' : 'Glancing'} hit! (${damage} damage${hits > 1 ? `, ${hits} hits` : ''})`, 'success');
                        } else {
                            addLogEntry('Attack missed!', 'failure');
                        }
                        
                        combatState.playerState.counterReady = false;
                        combatState.playerState.nextActionBonus = 0;
                        updateHealthBars();
                    } else if (actionChoice.action === 'defend') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'defend',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('defend', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.quality === 'perfect') {
                            combatState.playerState.counterReady = true;
                            combatState.playerState.nextActionBonus = 3;
                            addLogEntry('Perfect defense! Counter ready!', 'success');
                        } else if (result.success) {
                            combatState.conditions.defending = true;
                            addLogEntry('Defensive stance ready!', 'success');
                        } else {
                            addLogEntry('Defense failed!', 'failure');
                        }
                        updateHealthBars();
                    } else if (actionChoice.action === 'shield_bash') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'shield_bash',
                                null,
                                combatState.playerStats.strength,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('shield_bash', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.success) {
                            combatState.conditions.enemyStunned = 2;
                            addLogEntry('Shield bash! Enemy stunned!', 'success');
                        } else {
                            combatState.conditions.positioning = 'disadvantage';
                            addLogEntry('Shield bash missed! You are off-balance!', 'failure');
                        }
                        updateHealthBars();
                    } else if (actionChoice.action === 'dirty_trick') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'dirty_trick',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        const fatigueGain = calculateFatigueGain('dirty_trick', actionChoice.stance);
                        combatState.playerState.fatigue = Math.min(100, combatState.playerState.fatigue + fatigueGain);
                        
                        if (result.success) {
                            combatState.enemyState.defenseReduced = 2;
                            combatState.conditions.positioning = 'advantage';
                            addLogEntry('Dirty trick! Enemy defense reduced, advantage gained!', 'success');
                        } else {
                            addLogEntry('Dirty trick failed!', 'failure');
                        }
                    } else if (actionChoice.action === 'flee') {
                        const result = await new Promise((resolve) => {
                            showCombatQTE(
                                'flee',
                                null,
                                combatState.playerStats.agility,
                                combatState.conditions,
                                resolve
                            );
                        });
                        
                        if (result.success) {
                            addLogEntry('You successfully flee!', 'success');
                            setTimeout(() => {
                                if (overlay) overlay.style.display = 'none';
                            }, 2000);
                            return { victory: false, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue, fled: true };
                        } else {
                            combatState.conditions.positioning = 'disadvantage';
                            const damage = 15 + Math.abs(result.margin) * 2;
                            combatState.playerHealth = Math.max(0, combatState.playerHealth - damage);
                            addLogEntry(`Escape failed! Enemy strikes! (${damage} damage, positioning lost)`, 'failure');
                            updateHealthBars();
                        }
                    }
                    
                    // Check for victory/defeat
                    if (combatState.enemyHealth <= 0) {
                        addLogEntry('Victory! You have defeated your enemy!', 'success');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: true, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
                    }
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                }
                
                // Enemy turn (if player acted first)
                if (combatState.turnOrder === 'player' && combatState.enemyHealth > 0 && combatState.conditions.enemyStunned === 0) {
                    await enemyAttack();
                    if (combatState.playerHealth <= 0) {
                        addLogEntry('Defeat! You have been struck down...', 'failure');
                        setTimeout(() => {
                            if (overlay) overlay.style.display = 'none';
                        }, 2000);
                        return { victory: false, playerHealth: 0, fatigue: combatState.playerState.fatigue };
                    }
                } else if (combatState.conditions.enemyStunned > 0) {
                    addLogEntry('Enemy is stunned and cannot attack!', 'info');
                } else if (combatState.conditions.playerStunned > 0) {
                    addLogEntry('You are stunned and cannot act!', 'failure');
                }
                
                // Check for victory/defeat after enemy turn
                if (combatState.enemyHealth <= 0) {
                    addLogEntry('Victory! You have defeated your enemy!', 'success');
                    setTimeout(() => {
                        if (overlay) overlay.style.display = 'none';
                    }, 2000);
                    return { victory: true, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
                }
                
                combatState.currentRound++;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Fallback return (shouldn't reach here)
            return { victory: combatState.enemyHealth <= 0, playerHealth: combatState.playerHealth, fatigue: combatState.playerState.fatigue };
        }
        
        // Combat bridge function
        async function triggerCombat(enemyProfile, winScene, loseScene) {
            try {
                // Handle enemy profile as string ID or object
                if (typeof enemyProfile === 'string' && typeof getEnemyProfile !== 'undefined') {
                    const profile = getEnemyProfile(enemyProfile);
                    if (profile) {
                        enemyProfile = {
                            name: profile.name,
                            health: profile.health,
                            initiative: profile.initiative,
                            strength: profile.strength,
                            agility: profile.agility,
                            archetype: profile.archetype
                        };
                    }
                }
                
                // Hide main story container
                const gameContainer = document.querySelector('.game-container');
                if (gameContainer) gameContainer.style.display = 'none';
                
                // Map stress to fatigue
                const stressMax = statLimits.stress?.max || 10;
                combatState.playerState.fatigue = Math.floor((gameState.stats.stress / stressMax) * 100);
                
                // Set player stats from effective stats
                combatState.playerStats.strength = getEffectiveStat('strength');
                combatState.playerStats.agility = getEffectiveStat('agility');
                combatState.playerStats.initiative = getEffectiveStat('agility');
                
                // Get weapon stats from equipment manager
                if (window.equipmentManager) {
                    const weaponStats = window.equipmentManager.getWeaponStats();
                    combatState.playerStats.weaponQuality = weaponStats.quality || 0;
                    // Check for shield - check accessory slot or weapon secondary slot
                    const accessory = gameState.equipment.accessory || {};
                    const weaponSecondary = (gameState.equipment.weapon || {}).secondary;
                    // Shield could be in accessory or as secondary weapon
                    const hasShield = (accessory.item && accessory.item.id) || 
                                     (weaponSecondary && weaponSecondary.id) ||
                                     false;
                    // Check if it's actually a shield by looking up the item
                    if (hasShield) {
                        const shieldId = accessory.item?.id || weaponSecondary?.id;
                        // Simple check: if item ID contains shield-related terms, it's a shield
                        combatState.playerStats.shield = shieldId && (
                            shieldId.includes('shield') || 
                            shieldId.includes('buckler') || 
                            shieldId.includes('pavise') ||
                            shieldId.includes('targe')
                        );
                    } else {
                        combatState.playerStats.shield = false;
                    }
                } else {
                    combatState.playerStats.weaponQuality = 0;
                    combatState.playerStats.shield = false;
                }
                
                // Map enemy profile to combat state
                combatState.enemyStats = {
                    initiative: enemyProfile.initiative || 5,
                    strength: enemyProfile.strength || 5,
                    agility: enemyProfile.agility || 5,
                    archetype: enemyProfile.archetype || 'balanced',
                    health: enemyProfile.health || 100
                };
                combatState.enemyHealth = enemyProfile.health || 100;
                
                // Reset combat state
                combatState.playerHealth = 100;
                combatState.currentRound = 1;
                combatState.actionsRemaining = 2;
                combatState.playerState.stance = 'balanced';
                combatState.playerState.counterReady = false;
                combatState.playerState.nextActionBonus = 0;
                combatState.conditions.enemyStunned = 0;
                combatState.conditions.playerStunned = 0;
                combatState.conditions.terrain = 'open';
                combatState.conditions.enemyDefense = 5;
                combatState.conditions.positioning = 'neutral';
                combatState.combatHistory = [];
                combatState.turnOrder = 'player';
                
                // Start combat and await result
                const result = await startCombat();
                
                // Clean up animations
                if (combatAnimationId) {
                    cancelAnimationFrame(combatAnimationId);
                    combatAnimationId = null;
                }
                
                // Restore story container
                if (gameContainer) gameContainer.style.display = 'block';
                
                // Update game state based on combat result
                const stressMax2 = statLimits.stress?.max || 10;
                gameState.stats.stress = Math.min(stressMax2, Math.floor((result.fatigue / 100) * stressMax2));
                gameState.stats.stress = clampStat('stress', gameState.stats.stress);
                
                // Apply wounds
                if (result.playerHealth < 50) {
                    addCondition('Wounded', 'negative', 2);
                }
                if (result.playerHealth <= 0) {
                    addCondition('Seriously Wounded', 'negative', 3);
                }
                
                // Track combat
                gameState.career.battles++;
                if (result.victory) {
                    applyStatChange('experience', 1);
                }
                
                // Transition to appropriate scene
                if (result.fled) {
                    // Flee doesn't transition to win/lose scenes
                    return;
                }
                
                gameState.currentScene = result.victory ? winScene : loseScene;
                updateDisplay();
                
            } catch (error) {
                console.error('Combat error:', error);
                // Fallback: restore UI and transition to lose scene
                const gameContainer = document.querySelector('.game-container');
                if (gameContainer) gameContainer.style.display = 'block';
                const overlay = document.getElementById('minigame-overlay');
                if (overlay) overlay.style.display = 'none';
                gameState.currentScene = loseScene;
                updateDisplay();
            }
        }
        
        // Character creation helpers
        function adjustStat(stat, delta) {
            const currentValue = gameState.stats[stat];
            const totalPointsSpent = Object.keys(gameState.stats).reduce((sum, s) => {
                if (['strength', 'agility', 'endurance', 'charisma', 'wits'].includes(s)) {
                    return sum + Math.max(0, gameState.stats[s] - 5);
                }
                return sum;
            }, 0);
            
            if (delta > 0) {
                // Increasing stat
                if (currentValue >= 10) return; // Already at max
                if (totalPointsSpent >= 20) return; // No points left
                gameState.stats[stat] = Math.min(10, currentValue + 1);
            } else {
                // Decreasing stat
                if (currentValue <= 5) return; // Already at minimum
                gameState.stats[stat] = Math.max(5, currentValue - 1);
            }
            
            gameState.stats[stat] = clampStat(stat, gameState.stats[stat]);
            updateDisplay();
        }
        
        function selectBackground(bg) {
            gameState.background = bg;
            // Update button styles
            ['peasant', 'merchant', 'noble'].forEach(b => {
                const btn = document.getElementById(`bg-${b}`);
                if (btn) {
                    if (b === bg) {
                        btn.style.background = '#d4af37';
                        btn.style.color = '#1a0f08';
                    } else {
                        btn.style.background = '#2a2a2a';
                        btn.style.color = '#d4af37';
                    }
                }
            });
            updateDisplay();
        }
        
        // Make a choice
        function makeChoice(choiceIndex) {
            const scene = scenes[gameState.currentScene];
            if (!scene || !scene.choices[choiceIndex]) return;
            
            const choice = scene.choices[choiceIndex];
            
            // Handle character creation validation
            if (gameState.currentScene === 'character_creation') {
                if (choice.requiresBackground && !gameState.background) {
                    showNotification('Character Creation', 'Please select a background before continuing.');
                    return;
                }
                const nameInput = document.getElementById('character-name-input');
                if (nameInput) {
                    gameState.characterName = nameInput.value.trim();
                }
                if (!gameState.characterName || gameState.characterName === '') {
                    showNotification('Character Creation', 'Please enter your name.');
                    return;
                }
                const totalPointsSpent = Object.keys(gameState.stats).reduce((sum, s) => {
                    if (['strength', 'agility', 'endurance', 'charisma', 'wits'].includes(s)) {
                        return sum + Math.max(0, gameState.stats[s] - 5);
                    }
                    return sum;
                }, 0);
                if (totalPointsSpent !== 20) {
                    showNotification('Character Creation', `You must spend exactly 20 points. You have spent ${totalPointsSpent}.`);
                    return;
                }
            }
            
            // Handle reset as direct action
            if (choice.nextScene === 'reset') {
                if (confirm('Are you sure you want to start a new game? All progress will be lost.')) {
                    resetGame();
                }
                return;
            }
            
            // Handle combat type choices
            if (choice.type === 'combat') {
                triggerCombat(choice.enemy, choice.winScene, choice.loseScene).catch(error => {
                    console.error('Combat error:', error);
                    // Fallback to normal scene transition on error
                    gameState.currentScene = choice.winScene;
                    updateDisplay();
                });
                return; // Exit early, combat will handle scene transition
            }
            
            // Handle resolution system
            if (choice.requiresResolution) {
                const result = resolveAction(
                    choice.resolutionStat,
                    choice.resolutionDifficulty,
                    choice.resolutionBonus || 0
                );
                gameState.lastResolution = result;
                
                // Only apply generic consequences if explicitly requested
                // Most scenes handle their own consequences in onEnter
                if (choice.applyGenericResolution) {
                    if (!result.success) {
                        // Failure consequences - worse if margin is large
                        const woundSeverity = result.margin <= -3 ? 'Seriously Wounded' : 'Wounded';
                        if (choice.resolutionStat === 'strength' || choice.resolutionStat === 'endurance') {
                            addCondition(woundSeverity, 'negative', woundSeverity === 'Seriously Wounded' ? 3 : 2);
                            applyStatChange('endurance', woundSeverity === 'Seriously Wounded' ? -2 : -1);
                            gameState.career.wounds++;
                        }
                        addCondition('Fatigued', 'negative', 1);
                        applyStatChange('morale', -1);
                        applyStatChange('stress', 1);
                    } else {
                        // Success bonuses
                        applyStatChange('experience', 10);
                        applyStatChange('reputation', 1);
                        applyStatChange('morale', 1);
                        applyStatChange('stress', -1); // Success reduces stress
                        gameState.career.battles++;
                        // Small chance of patron favor on great success
                        if (result.margin >= 3) {
                            applyStatChange('patronFavor', 1);
                        }
                    }
                }
            }
            
            // Apply effects with clamping
            if (choice.effects) {
                const effects = [];
                Object.entries(choice.effects).forEach(([key, value]) => {
                    const actualChange = applyStatChange(key, value);
                    if (actualChange !== 0) {
                        effects.push(`${actualChange > 0 ? '+' : ''}${actualChange} ${key}`);
                    }
                });
                
                if (effects.length > 0 && showEffectsPreview) {
                    showNotification('Stat Changes', effects.join(', '));
                }
            }
            
            // Track scene visited (before moving)
            gameState.scenesVisited.push(gameState.currentScene);
            
            // Move to next scene - handle both function and string nextScene
            let nextSceneName;
            if (typeof choice.nextScene === 'function') {
                try {
                    nextSceneName = choice.nextScene();
                    console.log("nextScene function returned:", nextSceneName);
                    console.log("gameState.background:", gameState.background);
                } catch (error) {
                    console.error("Error executing nextScene function:", error);
                    console.error("Error stack:", error.stack);
                    showNotification('Error', 'Failed to determine next scene. Please refresh the page.');
                    return;
                }
            } else {
                nextSceneName = choice.nextScene;
            }
            
            // Validate that the next scene exists
            if (!nextSceneName || typeof nextSceneName !== 'string') {
                console.error("Invalid nextScene value:", nextSceneName);
                console.error("Type:", typeof nextSceneName);
                console.error("Choice:", choice);
                showNotification('Error', 'Invalid scene transition. Please refresh the page.');
                return;
            }
            
            if (!scenes[nextSceneName]) {
                console.error("Scene not found:", nextSceneName);
                console.error("Available scenes:", Object.keys(scenes).slice(0, 20));
                showNotification('Error', `Scene "${nextSceneName}" not found. Please refresh the page.`);
                return;
            }
            
            gameState.currentScene = nextSceneName;
            
            // Remove fade-in class and re-add for animation
            document.getElementById('story').classList.remove('fade-in');
            setTimeout(() => {
                updateDisplay();
            }, 100);
        }
        
        // Show notification
        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            notification.innerHTML = `<h3>${title}</h3><p>${message}</p>`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // Save/Load System Constants
        const SAVE_KEY = "manAtArmsGame";
        const SAVE_VERSION = 1;
        
        /** Fresh default state (use this for reset + load fallback) */
        function makeDefaultGameState() {
            return {
                stats: {
                    strength: 5,
                    agility: 5,
                    endurance: 5,
                    charisma: 5,
                    luck: 5,
                    wits: 5,
                    wealth: 10,
                    reputation: 0,
                    morale: 5,
                    stress: 0,
                    experience: 0,
                    patronFavor: 0
                },
                faction: "English",
                age: 18,
                year: 1337,
                location: "England",
                region: "England", // Add region for equipment system
                currentScene: "character_creation",
                characterName: "",
                background: null,
        scenesVisited: [],
        enteredScenes: new Set(),
        inventory: [
            { id: 'arming_sword', condition: 100, fit: 'off-the-rack', stackCount: 1 },
            { id: 'padded_jack', condition: 100, fit: 'off-the-rack', stackCount: 1 },
            { id: 'kettle_hat', condition: 100, fit: 'off-the-rack', stackCount: 1 },
            { id: 'buckler', condition: 100, fit: 'off-the-rack', stackCount: 1 },
            { id: 'rondel_dagger', condition: 100, fit: 'off-the-rack', stackCount: 1 }
        ],
                equipment: {
                    head: {},
                    torso: {},
                    arms: {},
                    legs: {},
                    weapon: {},
                    missile: {},
                    accessory: {},
                    bag: []
                },
                conditions: [],
                flags: {},
                rank: "Common Soldier",
                relationships: {},
                career: {
                    battles: 0,
                    wounds: 0,
                    promotions: 0
                },
                lastResolution: null
            };
        }
        
        /** Defensive number parsing */
        function asNumber(v, fallback = 0) {
            const n = Number(v);
            return Number.isFinite(n) ? n : fallback;
        }
        
        /** Merge loaded data into defaults without losing nested defaults */
        function hydrateLoadedState(loaded) {
            const base = makeDefaultGameState();
            
            if (!loaded || typeof loaded !== "object") return base;
            
            // Top-level primitives/arrays/objects (shallow)
            Object.assign(base, loaded);
            
            // Deep-merge nested objects you rely on
            base.stats = { ...base.stats, ...(loaded.stats || {}) };
            base.flags = { ...base.flags, ...(loaded.flags || {}) };
            base.relationships = { ...base.relationships, ...(loaded.relationships || {}) };
            base.career = { ...base.career, ...(loaded.career || {}) };
            
            // Equipment (handle both old and new format)
            if (loaded.equipment) {
                // New layered format
                if (loaded.equipment.head && typeof loaded.equipment.head === 'object' && !loaded.equipment.head.id) {
                    base.equipment = {
                        head: { ...base.equipment.head, ...(loaded.equipment.head || {}) },
                        torso: { ...base.equipment.torso, ...(loaded.equipment.torso || {}) },
                        arms: { ...base.equipment.arms, ...(loaded.equipment.arms || {}) },
                        legs: { ...base.equipment.legs, ...(loaded.equipment.legs || {}) },
                        weapon: { ...base.equipment.weapon, ...(loaded.equipment.weapon || {}) },
                        missile: { ...base.equipment.missile, ...(loaded.equipment.missile || {}) },
                        accessory: { ...base.equipment.accessory, ...(loaded.equipment.accessory || {}) },
                        bag: Array.isArray(loaded.equipment.bag) ? loaded.equipment.bag : []
                    };
                } else {
                    // Old format - will be migrated by EquipmentManager
                    base.equipment = { ...base.equipment, ...loaded.equipment };
                }
            }
            
            // Restore Set from array
            base.enteredScenes = new Set(Array.isArray(loaded.enteredScenes) ? loaded.enteredScenes : []);
            
            // Sanitize arrays
            base.scenesVisited = Array.isArray(loaded.scenesVisited) ? loaded.scenesVisited : [];
            base.inventory = Array.isArray(loaded.inventory) ? loaded.inventory : [];
            base.conditions = Array.isArray(loaded.conditions) ? loaded.conditions : [];
            
            // Clamp + coerce numeric stats
            for (const key of Object.keys(base.stats)) {
                base.stats[key] = clampStat(key, asNumber(base.stats[key], makeDefaultGameState().stats[key]));
            }
            
            // Coerce other numeric fields that matter
            base.age = asNumber(base.age, 18);
            base.year = asNumber(base.year, 1337);
            
            // Ensure strings
            base.location = typeof base.location === "string" ? base.location : "England";
            base.region = typeof base.region === "string" ? base.region : (base.location ? normalizeRegion(base.location) : "England");
            // Don't reset currentScene to character_creation if we have a valid saved scene
            base.currentScene = typeof base.currentScene === "string" && base.currentScene !== "" ? base.currentScene : "character_creation";
            base.characterName = typeof base.characterName === "string" ? base.characterName : "";
            // Preserve background if it exists (don't reset to null)
            base.background = base.background || null;
            base.rank = typeof base.rank === "string" ? base.rank : "Common Soldier";
            base.faction = typeof base.faction === "string" ? base.faction : "English";
            
            // Ensure inventory is an array
            if (!Array.isArray(base.inventory)) {
                base.inventory = [];
            }
            
            return base;
        }
        
        /** Normalize location to region (helper for migration) */
        function normalizeRegion(location) {
            if (!location) return 'England';
            const loc = location.toLowerCase();
            if (loc.includes('england') || loc.includes('portsmouth') || loc.includes('london')) return 'England';
            if (loc.includes('france') || loc.includes('normandy') || loc.includes('caen') || loc.includes('calais')) return 'France';
            if (loc.includes('flanders')) return 'Flanders';
            if (loc.includes('italy') || loc.includes('milan')) return 'Northern Italy';
            return 'England';
        }
        
        // Save game
        function saveGame() {
            try {
                // Build a JSON-safe payload (no Sets)
                const saveData = {
                    saveVersion: SAVE_VERSION,
                    ...gameState,
                    enteredScenes: Array.from(gameState.enteredScenes)
                };
                
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
                showNotification("Game Saved", "Your progress has been saved!");
            } catch (err) {
                console.error("Save failed:", err);
                showNotification("Save Failed", "Could not save (storage full or blocked).");
            }
        }
        
        // Load game
        function loadGame() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) {
                showNotification("No Save Found", "No saved game found.");
                return;
            }
            
            let loaded;
            try {
                loaded = JSON.parse(raw);
            } catch (err) {
                console.error("Corrupt save:", err);
                showNotification("Load Failed", "Save data is corrupted.");
                return;
            }
            
            // Optional: handle future migrations here
            const version = asNumber(loaded.saveVersion, 0);
            if (version > SAVE_VERSION) {
                showNotification("Load Failed", "Save was made by a newer version of the game.");
                return;
            }
            
            const hydrated = hydrateLoadedState(loaded);
            
            console.log("Loaded state hydrated:", hydrated);
            console.log("Current scene:", hydrated.currentScene);
            console.log("Background:", hydrated.background);
            
            // Overwrite the existing live state safely
            Object.keys(gameState).forEach(k => delete gameState[k]);
            Object.assign(gameState, hydrated);
            
            // Ensure enteredScenes is a Set (hydrateLoadedState should handle this, but double-check)
            if (!(gameState.enteredScenes instanceof Set)) {
                gameState.enteredScenes = new Set(Array.isArray(gameState.enteredScenes) ? gameState.enteredScenes : []);
            }
            
            // Reinitialize equipment manager if it exists (will migrate old format)
            if (typeof EquipmentManager !== 'undefined') {
                try {
                    window.equipmentManager = new EquipmentManager(gameState);
                } catch (e) {
                    console.error("Error reinitializing equipment manager:", e);
                }
            }
            
            // Force update display to ensure UI reflects loaded state
            updateDisplay();
            showNotification("Game Loaded", "Your progress has been restored!");
        }
        
        // Toggle effects preview
        function toggleEffectsPreview() {
            showEffectsPreview = !showEffectsPreview;
            document.getElementById('effects-toggle').textContent = showEffectsPreview ? 'Hide' : 'Show';
            updateChoices();
        }
        
        // Show full stats
        function showStats() {
            try {
                const stats = Object.entries(gameState.stats)
                    .map(([key, value]) => {
                        const effective = getEffectiveStat(key);
                        return effective !== value 
                            ? `${key}: ${value} (Effective: ${effective})`
                            : `${key}: ${value}`;
                    })
                    .join('\n');
                const conditions = gameState.conditions.length > 0 
                    ? gameState.conditions.map(c => c.name).join(', ')
                    : 'None';
                const career = `Battles: ${gameState.career.battles}, Wounds: ${gameState.career.wounds}, Promotions: ${gameState.career.promotions}`;
                
                // Handle equipment display for both old and new format
                let equipment = 'None equipped';
                try {
                    if (gameState.equipment && gameState.equipment.weapon && gameState.equipment.weapon.name) {
                        // Old format
                        equipment = `Weapon: ${gameState.equipment.weapon.name} (+${gameState.equipment.weapon.quality || 0}), Armor: ${gameState.equipment.armor?.name || 'None'} (+${gameState.equipment.armor?.quality || 0})`;
                    } else if (gameState.equipment && (gameState.equipment.weapon?.item || gameState.equipment.torso?.plate?.item)) {
                        // New layered format
                        const equipped = [];
                        if (gameState.equipment.weapon?.item) equipped.push(`Weapon: ${gameState.equipment.weapon.item.id}`);
                        if (gameState.equipment.torso?.plate?.item) equipped.push(`Torso: ${gameState.equipment.torso.plate.item.id}`);
                        if (gameState.equipment.head?.plate?.item) equipped.push(`Head: ${gameState.equipment.head.plate.item.id}`);
                        equipment = equipped.length > 0 ? equipped.join(', ') : 'None equipped';
                    }
                } catch (e) {
                    console.error("Error formatting equipment:", e);
                    equipment = 'Error loading equipment';
                }
                
                const inventoryCount = gameState.inventory ? gameState.inventory.length : 0;
                
                alert(`Full Game Stats:\n\n${stats}\n\nAge: ${gameState.age}\nYear: ${gameState.year}\nLocation: ${gameState.location}\nRegion: ${gameState.region || 'Unknown'}\nRank: ${gameState.rank}\n\nEquipment:\n${equipment}\n\nInventory Items: ${inventoryCount}\n\nConditions: ${conditions}\n\nCareer: ${career}`);
            } catch (error) {
                console.error("Error in showStats:", error);
                alert(`Error displaying stats: ${error.message}\n\nCheck console for details.`);
            }
        }
        
        // Reset game
        function resetGame() {
            const fresh = makeDefaultGameState();
            Object.keys(gameState).forEach(k => delete gameState[k]);
            Object.assign(gameState, fresh);
            updateDisplay();
        }
        
        // Equipment UI Integration (declared once at top level)
        var equipmentUI = null;
        var equipmentManager = null;
        
        function initializeEquipmentSystem() {
            // Initialize equipment manager
            if (typeof EquipmentManager !== 'undefined') {
                equipmentManager = new EquipmentManager(gameState);
                
                // Initialize equipment UI
                if (typeof EquipmentUI !== 'undefined') {
                    equipmentUI = new EquipmentUI(gameState, equipmentManager);
                    window.equipmentUI = equipmentUI; // Make globally accessible
                }
            }
        }
        
        function openEquipmentScreen() {
            console.log('Opening equipment screen...');
            console.log('EquipmentUI available:', typeof EquipmentUI !== 'undefined');
            console.log('EquipmentManager available:', typeof EquipmentManager !== 'undefined');
            console.log('EQUIPMENT_DATABASE available:', typeof EQUIPMENT_DATABASE !== 'undefined');
            console.log('Current inventory:', gameState.inventory);
            
            if (!equipmentUI) {
                console.log('Initializing equipment system...');
                initializeEquipmentSystem();
            }
            if (equipmentUI) {
                try {
                    equipmentUI.open();
                    console.log('Equipment screen opened successfully');
                } catch (error) {
                    console.error('Error opening equipment screen:', error);
                    showNotification('Equipment Error', 'Could not open equipment screen. Check console (F12) for details.');
                }
            } else {
                console.error('Equipment UI not initialized');
                showNotification('Equipment System', 'Equipment system not loaded. Please refresh the page.');
            }
        }
        
        function closeEquipmentScreen() {
            if (equipmentUI) {
                equipmentUI.close();
            }
        }
        
        // Global error handlers for debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error || e.message, e.filename, e.lineno);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
        
        // Initialize on load
        window.addEventListener('load', function() {
            initGame();
            initializeEquipmentSystem();
        });
    </script>
</body>
</html>
